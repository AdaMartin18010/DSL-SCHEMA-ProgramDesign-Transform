# Workflow Engine Schemaå®è·µæ¡ˆä¾‹

## ğŸ“‘ ç›®å½•

- [Workflow Engine Schemaå®è·µæ¡ˆä¾‹](#workflow-engine-schemaå®è·µæ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¡ˆä¾‹æ¦‚è¿°](#1-æ¡ˆä¾‹æ¦‚è¿°)
  - [2. æ¡ˆä¾‹1ï¼šé“¶è¡Œä¿¡è´·å®¡æ‰¹å·¥ä½œæµç³»ç»Ÿ](#2-æ¡ˆä¾‹1é“¶è¡Œä¿¡è´·å®¡æ‰¹å·¥ä½œæµç³»ç»Ÿ)
    - [2.1 ä¸šåŠ¡èƒŒæ™¯](#21-ä¸šåŠ¡èƒŒæ™¯)
    - [2.2 ä¸šåŠ¡ç—›ç‚¹](#22-ä¸šåŠ¡ç—›ç‚¹)
    - [2.3 ä¸šåŠ¡ç›®æ ‡](#23-ä¸šåŠ¡ç›®æ ‡)
    - [2.4 æŠ€æœ¯æŒ‘æˆ˜](#24-æŠ€æœ¯æŒ‘æˆ˜)
    - [2.5 Schemaå®šä¹‰](#25-schemaå®šä¹‰)
    - [2.6 å®Œæ•´ä»£ç å®ç°](#26-å®Œæ•´ä»£ç å®ç°)
    - [2.7 æ•ˆæœè¯„ä¼°](#27-æ•ˆæœè¯„ä¼°)
  - [3. æ¡ˆä¾‹2ï¼šä¿é™©ç†èµ”å¤„ç†å·¥ä½œæµ](#3-æ¡ˆä¾‹2ä¿é™©ç†èµ”å¤„ç†å·¥ä½œæµ)
    - [3.1 ä¸šåŠ¡èƒŒæ™¯](#31-ä¸šåŠ¡èƒŒæ™¯)
    - [3.2 ä¸šåŠ¡ç—›ç‚¹](#32-ä¸šåŠ¡ç—›ç‚¹)
    - [3.3 ä¸šåŠ¡ç›®æ ‡](#33-ä¸šåŠ¡ç›®æ ‡)
    - [3.4 æŠ€æœ¯æŒ‘æˆ˜](#34-æŠ€æœ¯æŒ‘æˆ˜)
    - [3.5 å®Œæ•´ä»£ç å®ç°](#35-å®Œæ•´ä»£ç å®ç°)
    - [3.6 æ•ˆæœè¯„ä¼°](#36-æ•ˆæœè¯„ä¼°)
  - [4. æ¡ˆä¾‹æ€»ç»“](#4-æ¡ˆä¾‹æ€»ç»“)

---

## 1. æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›Workflow Engine Schemaåœ¨å®é™…ä¼ä¸šåº”ç”¨ä¸­çš„å®è·µæ¡ˆä¾‹ï¼Œå±•ç¤ºå·¥ä½œæµå¼•æ“åœ¨ä¸åŒè¡Œä¸šåœºæ™¯ä¸‹çš„ä»·å€¼å’Œä½œç”¨ã€‚

**æ¡ˆä¾‹ç±»å‹**ï¼š

1. **é“¶è¡Œä¿¡è´·å®¡æ‰¹å·¥ä½œæµ**ï¼šå¤æ‚ä¸šåŠ¡æµç¨‹è‡ªåŠ¨åŒ–
2. **ä¿é™©ç†èµ”å¤„ç†å·¥ä½œæµ**ï¼šè·¨éƒ¨é—¨åä½œæµç¨‹ä¼˜åŒ–

---

## 2. æ¡ˆä¾‹1ï¼šé“¶è¡Œä¿¡è´·å®¡æ‰¹å·¥ä½œæµç³»ç»Ÿ

### 2.1 ä¸šåŠ¡èƒŒæ™¯

**ä¼ä¸šæ¦‚å†µ**ï¼šæŸå…¨å›½æ€§è‚¡ä»½åˆ¶å•†ä¸šé“¶è¡Œï¼ˆä»¥ä¸‹ç®€ç§°"Aé“¶è¡Œ"ï¼‰ï¼Œæˆç«‹äº1995å¹´ï¼Œæ€»éƒ¨ä½äºä¸Šæµ·ï¼Œåœ¨å…¨å›½è®¾æœ‰è¶…è¿‡500å®¶åˆ†æ”¯æœºæ„ï¼Œå‘˜å·¥æ€»æ•°è¶…è¿‡3ä¸‡äººã€‚é“¶è¡Œä¸»è¥ä¸šåŠ¡æ¶µç›–å…¬å¸é‡‘èã€ä¸ªäººé‡‘èã€åŒä¸šé‡‘èç­‰é¢†åŸŸï¼Œå¹´ä¿¡è´·æŠ•æ”¾è§„æ¨¡è¶…è¿‡5000äº¿å…ƒã€‚

è¯¥é“¶è¡Œçš„ä¿¡è´·å®¡æ‰¹æµç¨‹æ¶‰åŠå®¢æˆ·ç”³è¯·ã€èµ„æ–™å®¡æ ¸ã€é£æ§è¯„ä¼°ã€é¢åº¦å®¡æ‰¹ã€åˆåŒç­¾è®¢ã€æ”¾æ¬¾æ‰§è¡Œç­‰å…­å¤§ç¯èŠ‚ï¼Œæ¶‰åŠå®¢æˆ·ç»ç†ã€é£æ§ä¸“å‘˜ã€å®¡æ‰¹å®˜ã€æ³•åŠ¡äººå‘˜ã€è´¢åŠ¡äººå‘˜ç­‰äº”ä¸ªå²—ä½è§’è‰²ã€‚åœ¨æ•°å­—åŒ–è½¬å‹å‰ï¼Œä¿¡è´·å®¡æ‰¹å¹³å‡è€—æ—¶15ä¸ªå·¥ä½œæ—¥ï¼Œä¸¥é‡å½±å“å®¢æˆ·ä½“éªŒå’Œä¸šåŠ¡ç«äº‰åŠ›ã€‚

### 2.2 ä¸šåŠ¡ç—›ç‚¹

1. **å®¡æ‰¹æµç¨‹å†—é•¿**ï¼šä¼ ç»Ÿçº¸è´¨å®¡æ‰¹æµç¨‹éœ€è¦ç»è¿‡12ä¸ªå®¡æ‰¹èŠ‚ç‚¹ï¼Œå¹³å‡æµè½¬æ—¶é—´é•¿è¾¾15ä¸ªå·¥ä½œæ—¥ï¼Œç´§æ€¥ä¸šåŠ¡ä¹Ÿæ— æ³•åŠ é€Ÿå¤„ç†ï¼Œå¯¼è‡´ä¼˜è´¨å®¢æˆ·æµå¤±ç‡é«˜è¾¾18%ã€‚

2. **ä¿¡æ¯å­¤å²›ä¸¥é‡**ï¼šå®¢æˆ·ä¿¡æ¯åˆ†æ•£åœ¨æ ¸å¿ƒç³»ç»Ÿã€ä¿¡è´·ç³»ç»Ÿã€é£æ§ç³»ç»Ÿã€æ³•åŠ¡ç³»ç»Ÿç­‰8ä¸ªç‹¬ç«‹ç³»ç»Ÿä¸­ï¼Œå®¡æ‰¹äººå‘˜éœ€è¦åœ¨å¤šä¸ªç³»ç»Ÿé—´åˆ‡æ¢æŸ¥è¯¢ï¼Œå•æˆ·ä¿¡è´·èµ„æ–™æ”¶é›†å¹³å‡è€—æ—¶4å°æ—¶ã€‚

3. **é£æ§æ ‡å‡†ä¸ç»Ÿä¸€**ï¼šä¸åŒåˆ†è¡Œã€ä¸åŒå®¡æ‰¹äººå‘˜å¯¹é£æ§æ ‡å‡†çš„ç†è§£å’Œæ‰§è¡Œå­˜åœ¨å·®å¼‚ï¼Œå¯¼è‡´åŒç±»å®¢æˆ·åœ¨ä¸åŒåœ°åŒºçš„å®¡æ‰¹ç»“æœä¸ä¸€è‡´ï¼Œå¼•å‘ç›‘ç®¡å…³æ³¨å’Œå®¢æˆ·æŠ•è¯‰ã€‚

4. **æµç¨‹é€æ˜åº¦ä½**ï¼šå®¢æˆ·å’Œä¸šåŠ¡å‘˜æ— æ³•å®æ—¶äº†è§£å®¡æ‰¹è¿›åº¦ï¼Œç”µè¯å’¨è¯¢é‡æ—¥å‡è¶…è¿‡3000é€šï¼Œå®¢æˆ·æ»¡æ„åº¦ä»…ä¸º72%ï¼ŒNPSè¯„åˆ†é•¿æœŸå¤„äºè¡Œä¸šä¸‹æ¸¸æ°´å¹³ã€‚

5. **åˆè§„å®¡è®¡å›°éš¾**ï¼šçº¸è´¨æ¡£æ¡ˆç®¡ç†æˆæœ¬é«˜ï¼Œå†å²æµç¨‹è¿½æº¯å›°éš¾ï¼Œç›‘ç®¡æ£€æŸ¥æ—¶éœ€è¦æŠ½è°ƒ20äººè€—æ—¶2å‘¨å‡†å¤‡ææ–™ï¼Œä¸”ä»å­˜åœ¨é—æ¼é£é™©ã€‚

### 2.3 ä¸šåŠ¡ç›®æ ‡

1. **ç¼©çŸ­å®¡æ‰¹å‘¨æœŸ**ï¼šå°†å¹³å‡å®¡æ‰¹æ—¶é—´ä»15ä¸ªå·¥ä½œæ—¥ç¼©çŸ­è‡³3ä¸ªå·¥ä½œæ—¥ä»¥å†…ï¼Œç´§æ€¥ä¸šåŠ¡å®ç°T+0å®¡æ‰¹ï¼Œæå‡å¸‚åœºç«äº‰åŠ›ã€‚

2. **ç»Ÿä¸€é£æ§æ ‡å‡†**ï¼šå»ºç«‹å…¨è¡Œç»Ÿä¸€çš„é£æ§è¯„ä¼°æ¨¡å‹å’Œå®¡æ‰¹è§„åˆ™å¼•æ“ï¼Œå®ç°"åŒæˆ·åŒç­–"ï¼Œæ¶ˆé™¤åœ°åŒºå·®å¼‚å’Œäººä¸ºåå·®ã€‚

3. **æå‡å®¢æˆ·ä½“éªŒ**ï¼šæä¾›å®¡æ‰¹è¿›åº¦å®æ—¶æŸ¥è¯¢åŠŸèƒ½ï¼Œå®¢æˆ·æ»¡æ„åº¦æå‡è‡³90%ä»¥ä¸Šï¼ŒNPSè¯„åˆ†è¿›å…¥è¡Œä¸šå‰20%ã€‚

4. **é™ä½è¿è¥æˆæœ¬**ï¼šé€šè¿‡æµç¨‹è‡ªåŠ¨åŒ–å‡å°‘äººå·¥å¹²é¢„ç¯èŠ‚50%ä»¥ä¸Šï¼Œå¹´åº¦è¿è¥æˆæœ¬èŠ‚çº¦2000ä¸‡å…ƒä»¥ä¸Šã€‚

5. **å¼ºåŒ–åˆè§„ç®¡ç†**ï¼šå®ç°å…¨æµç¨‹ç”µå­åŒ–ç•™ç—•ï¼Œæ”¯æŒä¸€é”®ç”Ÿæˆå®¡è®¡æŠ¥å‘Šï¼Œç›‘ç®¡æ£€æŸ¥å‡†å¤‡æ—¶é—´ä»2å‘¨ç¼©çŸ­è‡³2å°æ—¶ã€‚

### 2.4 æŠ€æœ¯æŒ‘æˆ˜

**æŒ‘æˆ˜1ï¼šå¤æ‚æµç¨‹ç¼–æ’**

- ä¿¡è´·å®¡æ‰¹æµç¨‹åŒ…å«æ¡ä»¶åˆ†æ”¯ï¼ˆå¦‚ä¸åŒé¢åº¦èµ°ä¸åŒå®¡æ‰¹è·¯å¾„ï¼‰ã€å¹¶è¡Œå®¡æ‰¹ï¼ˆé£æ§å’Œæ³•åŠ¡åŒæ—¶å®¡æ ¸ï¼‰ã€ä¼šç­¾å®¡æ‰¹ï¼ˆå¤šéƒ¨é—¨è”ç­¾ï¼‰ç­‰å¤æ‚æ¨¡å¼
- éœ€è¦æ”¯æŒæµç¨‹çš„åŠ¨æ€è°ƒæ•´å’Œç‰ˆæœ¬ç®¡ç†ï¼Œç¡®ä¿æ–°æ—§æµç¨‹å¹³æ»‘è¿‡æ¸¡
- æµç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦å¤„ç†å¤§é‡å¼‚å¸¸æƒ…å†µå’Œäººå·¥å¹²é¢„åœºæ™¯

**æŒ‘æˆ˜2ï¼šé«˜å¹¶å‘æ€§èƒ½ä¿éšœ**

- é“¶è¡Œæ—¥å‡ä¿¡è´·ç”³è¯·é‡è¶…è¿‡5000ç¬”ï¼Œé«˜å³°æœŸå¯è¾¾15000ç¬”/æ—¥
- å·¥ä½œæµå¼•æ“éœ€è¦æ”¯æŒæ°´å¹³æ‰©å±•ï¼Œé¿å…å•ç‚¹æ€§èƒ½ç“¶é¢ˆ
- æµç¨‹çŠ¶æ€å˜æ›´éœ€è¦ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´å¯¼è‡´çš„èµ„é‡‘é£é™©

**æŒ‘æˆ˜3ï¼šé—ç•™ç³»ç»Ÿé›†æˆ**

- éœ€è¦ä¸é“¶è¡Œç°æœ‰çš„æ ¸å¿ƒç³»ç»Ÿã€ä¿¡è´·ç³»ç»Ÿã€é£æ§ç³»ç»Ÿã€å½±åƒç³»ç»Ÿã€çŸ­ä¿¡å¹³å°ç­‰15ä¸ªç³»ç»Ÿè¿›è¡Œé›†æˆ
- å„ç³»ç»Ÿé‡‡ç”¨ä¸åŒçš„æŠ€æœ¯æ ˆï¼ˆCOBOLã€Javaã€.NETç­‰ï¼‰å’Œé€šä¿¡åè®®ï¼ˆSocketã€MQã€HTTPç­‰ï¼‰
- é›†æˆè¿‡ç¨‹ä¸­éœ€è¦ä¿è¯äº¤æ˜“çš„åŸå­æ€§å’Œæ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§

**æŒ‘æˆ˜4ï¼šå®‰å…¨ä¸åˆè§„è¦æ±‚**

- é‡‘èçº§å®‰å…¨è¦æ±‚ï¼Œéœ€è¦æ”¯æŒå›½å¯†ç®—æ³•ã€åŒå› ç´ è®¤è¯ã€æ“ä½œç•™ç—•ç­‰å®‰å…¨æœºåˆ¶
- æ»¡è¶³é“¶ä¿ç›‘ä¼šã€Šå•†ä¸šé“¶è¡Œä¿¡æ¯ç§‘æŠ€é£é™©ç®¡ç†æŒ‡å¼•ã€‹ç­‰ç›‘ç®¡è¦æ±‚
- æ”¯æŒå¤šçº§å®¡æ‰¹æƒé™æ§åˆ¶å’Œæ•æ„Ÿæ•°æ®è„±æ•å±•ç¤º

**æŒ‘æˆ˜5ï¼šç›‘æ§ä¸è¿ç»´**

- éœ€è¦å»ºç«‹å®Œå–„çš„æµç¨‹ç›‘æ§ä½“ç³»ï¼Œå®æ—¶å‘ç°æµç¨‹å¡ç‚¹ã€è¶…æ—¶ç­‰å¼‚å¸¸æƒ…å†µ
- æ”¯æŒæµç¨‹å®ä¾‹çš„æ•…éšœè½¬ç§»å’Œè‡ªåŠ¨æ¢å¤
- æä¾›å¯è§†åŒ–çš„æµç¨‹è¿ç»´å·¥å…·ï¼Œé™ä½è¿ç»´å¤æ‚åº¦

### 2.5 Schemaå®šä¹‰

**é“¶è¡Œä¿¡è´·å®¡æ‰¹å·¥ä½œæµSchema**ï¼š

```dsl
schema CreditApprovalWorkflow {
  process_definition: ProcessDefinition {
    process_id: String @value("credit_approval_process_v2")
    process_name: String @value("ä¿¡è´·å®¡æ‰¹æµç¨‹")
    process_key: String @value("creditApproval")
    version: Int @value(2)
    category: String @value("Credit")
  }

  process_elements: List[ProcessElement] {
    start_event: ProcessElement {
      element_id: String @value("start_application")
      element_type: Enum @value("StartEvent")
      element_name: String @value("å®¢æˆ·ç”³è¯·")
    }

    data_collection_task: ProcessElement {
      element_id: String @value("collect_data")
      element_type: Enum @value("ServiceTask")
      element_name: String @value("èµ„æ–™æ”¶é›†")
      assignee: String @value("${customer_manager}")
    }

    auto_assessment_task: ProcessElement {
      element_id: String @value("auto_assessment")
      element_type: Enum @value("ServiceTask")
      element_name: String @value("è‡ªåŠ¨è¯„ä¼°")
      delegate_expression: String @value("${riskAssessmentDelegate}")
    }

    risk_review_task: ProcessElement {
      element_id: String @value("risk_review")
      element_type: Enum @value("UserTask")
      element_name: String @value("é£æ§å®¡æ ¸")
      candidate_groups: List[String] @value(["risk_control"])
      due_date: Duration @value("PT4H")
    }

    legal_review_task: ProcessElement {
      element_id: String @value("legal_review")
      element_type: Enum @value("UserTask")
      element_name: String @value("æ³•åŠ¡å®¡æ ¸")
      candidate_groups: List[String] @value(["legal"])
      due_date: Duration @value("PT4H")
    }

    approval_gateway: ProcessElement {
      element_id: String @value("approval_gateway")
      element_type: Enum @value("ExclusiveGateway")
      element_name: String @value("é¢åº¦åˆ¤æ–­")
    }

    senior_approval_task: ProcessElement {
      element_id: String @value("senior_approval")
      element_type: Enum @value("UserTask")
      element_name: String @value("é«˜çº§å®¡æ‰¹")
      candidate_groups: List[String] @value(["senior_approver"])
    }

    contract_sign_task: ProcessElement {
      element_id: String @value("contract_sign")
      element_type: Enum @value("UserTask")
      element_name: String @value("åˆåŒç­¾è®¢")
      candidate_groups: List[String] @value(["contract_manager"])
    }

    disbursement_task: ProcessElement {
      element_id: String @value("disbursement")
      element_type: Enum @value("ServiceTask")
      element_name: String @value("æ”¾æ¬¾æ‰§è¡Œ")
      delegate_expression: String @value("${disbursementDelegate}")
    }

    end_event: ProcessElement {
      element_id: String @value("end_process")
      element_type: Enum @value("EndEvent")
      element_name: String @value("æµç¨‹ç»“æŸ")
    }
  }

  task_assignment_rules: List[TaskAssignmentRule] {
    risk_review_rule: TaskAssignmentRule {
      rule_id: String @value("risk_review_rule")
      task_definition_key: String @value("risk_review")
      assignment_type: Enum @value("Group")
      candidate_groups: List[String] @value(["risk_control"])
      priority: Int @value(1)
    }
  }

  process_variables: List[ProcessVariable] {
    application_id: ProcessVariable {
      variable_name: String @value("applicationId")
      variable_type: String @value("String")
      required: Bool @value(true)
    }
    
    credit_amount: ProcessVariable {
      variable_name: String @value("creditAmount")
      variable_type: String @value("BigDecimal")
      required: Bool @value(true)
    }
    
    customer_rating: ProcessVariable {
      variable_name: String @value("customerRating")
      variable_type: String @value("String")
      required: Bool @value(false)
    }
    
    risk_score: ProcessVariable {
      variable_name: String @value("riskScore")
      variable_type: String @value("Integer")
      required: Bool @value(false)
    }
  }
} @standard("BPMN_2.0")
```

### 2.6 å®Œæ•´ä»£ç å®ç°

**é“¶è¡Œä¿¡è´·å®¡æ‰¹å·¥ä½œæµå¼•æ“ç³»ç»Ÿï¼ˆçº¦480è¡Œï¼‰**ï¼š

```python
#!/usr/bin/env python3
"""
é“¶è¡Œä¿¡è´·å®¡æ‰¹å·¥ä½œæµå¼•æ“ç³»ç»Ÿ
åŠŸèƒ½ï¼šæµç¨‹å®šä¹‰ã€ä»»åŠ¡åˆ†é…ã€æµç¨‹æ‰§è¡Œã€ç›‘æ§åˆ†æ
"""

import uuid
import json
import logging
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Callable, Any
from dataclasses import dataclass, field, asdict
from enum import Enum
from collections import defaultdict
import threading
import sqlite3
import hashlib

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


class TaskStatus(str, Enum):
    """ä»»åŠ¡çŠ¶æ€"""
    PENDING = "pending"
    ASSIGNED = "assigned"
    IN_PROGRESS = "in_progress"
    COMPLETED = "completed"
    CANCELLED = "cancelled"


class ProcessStatus(str, Enum):
    """æµç¨‹çŠ¶æ€"""
    RUNNING = "running"
    SUSPENDED = "suspended"
    COMPLETED = "completed"
    TERMINATED = "terminated"


@dataclass
class ProcessDefinition:
    """æµç¨‹å®šä¹‰"""
    process_id: str
    process_name: str
    process_key: str
    version: int
    category: str
    created_at: datetime = field(default_factory=datetime.now)
    elements: List[Dict] = field(default_factory=list)


@dataclass
class ProcessInstance:
    """æµç¨‹å®ä¾‹"""
    instance_id: str
    process_id: str
    business_key: str
    status: ProcessStatus
    start_time: datetime
    end_time: Optional[datetime] = None
    variables: Dict[str, Any] = field(default_factory=dict)
    current_element_id: Optional[str] = None


@dataclass
class Task:
    """ä»»åŠ¡"""
    task_id: str
    instance_id: str
    task_definition_key: str
    task_name: str
    assignee: Optional[str] = None
    candidate_groups: List[str] = field(default_factory=list)
    status: TaskStatus = TaskStatus.PENDING
    create_time: datetime = field(default_factory=datetime.now)
    due_date: Optional[datetime] = None
    complete_time: Optional[datetime] = None
    form_data: Dict[str, Any] = field(default_factory=dict)


class WorkflowEngine:
    """å·¥ä½œæµå¼•æ“æ ¸å¿ƒ"""
    
    def __init__(self, db_path: str = "workflow.db"):
        self.db_path = db_path
        self.process_definitions: Dict[str, ProcessDefinition] = {}
        self.process_instances: Dict[str, ProcessInstance] = {}
        self.tasks: Dict[str, Task] = {}
        self._lock = threading.RLock()
        self._init_database()
        self._load_process_definitions()
    
    def _init_database(self):
        """åˆå§‹åŒ–æ•°æ®åº“"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # æµç¨‹å®šä¹‰è¡¨
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS process_definitions (
                process_id TEXT PRIMARY KEY,
                process_name TEXT NOT NULL,
                process_key TEXT NOT NULL,
                version INTEGER NOT NULL,
                category TEXT,
                elements TEXT,
                created_at TIMESTAMP
            )
        ''')
        
        # æµç¨‹å®ä¾‹è¡¨
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS process_instances (
                instance_id TEXT PRIMARY KEY,
                process_id TEXT NOT NULL,
                business_key TEXT,
                status TEXT,
                start_time TIMESTAMP,
                end_time TIMESTAMP,
                variables TEXT,
                current_element_id TEXT
            )
        ''')
        
        # ä»»åŠ¡è¡¨
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS tasks (
                task_id TEXT PRIMARY KEY,
                instance_id TEXT NOT NULL,
                task_definition_key TEXT NOT NULL,
                task_name TEXT,
                assignee TEXT,
                candidate_groups TEXT,
                status TEXT,
                create_time TIMESTAMP,
                due_date TIMESTAMP,
                complete_time TIMESTAMP,
                form_data TEXT
            )
        ''')
        
        conn.commit()
        conn.close()
    
    def _load_process_definitions(self):
        """ä»æ•°æ®åº“åŠ è½½æµç¨‹å®šä¹‰"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM process_definitions")
        
        for row in cursor.fetchall():
            process_def = ProcessDefinition(
                process_id=row[0],
                process_name=row[1],
                process_key=row[2],
                version=row[3],
                category=row[4],
                elements=json.loads(row[5]) if row[5] else [],
                created_at=datetime.fromisoformat(row[6])
            )
            self.process_definitions[process_def.process_id] = process_def
        
        conn.close()
    
    def deploy_process_definition(self, process_def: ProcessDefinition) -> str:
        """éƒ¨ç½²æµç¨‹å®šä¹‰"""
        with self._lock:
            self.process_definitions[process_def.process_id] = process_def
            
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            cursor.execute('''
                INSERT OR REPLACE INTO process_definitions 
                (process_id, process_name, process_key, version, category, elements, created_at)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            ''', (
                process_def.process_id,
                process_def.process_name,
                process_def.process_key,
                process_def.version,
                process_def.category,
                json.dumps(process_def.elements),
                process_def.created_at.isoformat()
            ))
            conn.commit()
            conn.close()
            
            logger.info(f"Deployed process definition: {process_def.process_id}")
            return process_def.process_id
    
    def start_process_instance(self, process_id: str, business_key: str,
                               variables: Dict[str, Any] = None) -> str:
        """å¯åŠ¨æµç¨‹å®ä¾‹"""
        with self._lock:
            if process_id not in self.process_definitions:
                raise ValueError(f"Process definition not found: {process_id}")
            
            instance_id = f"INST-{uuid.uuid4().hex[:12].upper()}"
            instance = ProcessInstance(
                instance_id=instance_id,
                process_id=process_id,
                business_key=business_key,
                status=ProcessStatus.RUNNING,
                start_time=datetime.now(),
                variables=variables or {}
            )
            
            self.process_instances[instance_id] = instance
            
            # ä¿å­˜åˆ°æ•°æ®åº“
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            cursor.execute('''
                INSERT INTO process_instances 
                (instance_id, process_id, business_key, status, start_time, variables)
                VALUES (?, ?, ?, ?, ?, ?)
            ''', (
                instance_id, process_id, business_key, instance.status.value,
                instance.start_time.isoformat(), json.dumps(instance.variables)
            ))
            conn.commit()
            conn.close()
            
            # å¯åŠ¨ç¬¬ä¸€ä¸ªä»»åŠ¡
            self._execute_next_element(instance_id)
            
            logger.info(f"Started process instance: {instance_id}")
            return instance_id
    
    def _execute_next_element(self, instance_id: str):
        """æ‰§è¡Œä¸‹ä¸€ä¸ªæµç¨‹å…ƒç´ """
        instance = self.process_instances.get(instance_id)
        if not instance or instance.status != ProcessStatus.RUNNING:
            return
        
        process_def = self.process_definitions.get(instance.process_id)
        if not process_def:
            return
        
        # æ‰¾åˆ°å½“å‰å…ƒç´ æˆ–ç¬¬ä¸€ä¸ªå…ƒç´ 
        current_index = 0
        if instance.current_element_id:
            for i, elem in enumerate(process_def.elements):
                if elem.get('element_id') == instance.current_element_id:
                    current_index = i + 1
                    break
        
        if current_index >= len(process_def.elements):
            # æµç¨‹ç»“æŸ
            self._complete_process_instance(instance_id)
            return
        
        element = process_def.elements[current_index]
        element_type = element.get('element_type')
        
        if element_type in ['StartEvent', 'EndEvent']:
            # å¼€å§‹/ç»“æŸäº‹ä»¶ç›´æ¥è·³è¿‡
            instance.current_element_id = element.get('element_id')
            self._execute_next_element(instance_id)
        elif element_type == 'UserTask':
            # åˆ›å»ºç”¨æˆ·ä»»åŠ¡
            self._create_task(instance_id, element)
        elif element_type == 'ServiceTask':
            # æ‰§è¡ŒæœåŠ¡ä»»åŠ¡
            self._execute_service_task(instance_id, element)
        elif element_type == 'ExclusiveGateway':
            # å¤„ç†ç½‘å…³
            self._handle_gateway(instance_id, element)
    
    def _create_task(self, instance_id: str, element: Dict):
        """åˆ›å»ºä»»åŠ¡"""
        task_id = f"TASK-{uuid.uuid4().hex[:12].upper()}"
        due_minutes = element.get('due_minutes', 240)  # é»˜è®¤4å°æ—¶
        
        task = Task(
            task_id=task_id,
            instance_id=instance_id,
            task_definition_key=element.get('element_id'),
            task_name=element.get('element_name'),
            candidate_groups=element.get('candidate_groups', []),
            due_date=datetime.now() + timedelta(minutes=due_minutes)
        )
        
        self.tasks[task_id] = task
        
        # æ›´æ–°æµç¨‹å®ä¾‹å½“å‰å…ƒç´ 
        instance = self.process_instances[instance_id]
        instance.current_element_id = element.get('element_id')
        
        # ä¿å­˜åˆ°æ•°æ®åº“
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO tasks 
            (task_id, instance_id, task_definition_key, task_name, candidate_groups,
             status, create_time, due_date)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            task_id, instance_id, task.task_definition_key, task.task_name,
            json.dumps(task.candidate_groups), task.status.value,
            task.create_time.isoformat(), task.due_date.isoformat()
        ))
        cursor.execute('''
            UPDATE process_instances SET current_element_id = ? WHERE instance_id = ?
        ''', (element.get('element_id'), instance_id))
        conn.commit()
        conn.close()
        
        logger.info(f"Created task: {task_id} - {task.task_name}")
    
    def _execute_service_task(self, instance_id: str, element: Dict):
        """æ‰§è¡ŒæœåŠ¡ä»»åŠ¡"""
        logger.info(f"Executing service task: {element.get('element_name')}")
        # æ¨¡æ‹ŸæœåŠ¡ä»»åŠ¡æ‰§è¡Œ
        import time
        time.sleep(0.1)
        
        # ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªå…ƒç´ 
        instance = self.process_instances[instance_id]
        instance.current_element_id = element.get('element_id')
        self._execute_next_element(instance_id)
    
    def _handle_gateway(self, instance_id: str, element: Dict):
        """å¤„ç†ç½‘å…³"""
        # ç®€åŒ–å¤„ç†ï¼Œç›´æ¥æ‰§è¡Œä¸‹ä¸€ä¸ªå…ƒç´ 
        instance = self.process_instances[instance_id]
        instance.current_element_id = element.get('element_id')
        self._execute_next_element(instance_id)
    
    def _complete_process_instance(self, instance_id: str):
        """å®Œæˆæµç¨‹å®ä¾‹"""
        instance = self.process_instances.get(instance_id)
        if instance:
            instance.status = ProcessStatus.COMPLETED
            instance.end_time = datetime.now()
            
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            cursor.execute('''
                UPDATE process_instances 
                SET status = ?, end_time = ?
                WHERE instance_id = ?
            ''', (ProcessStatus.COMPLETED.value, instance.end_time.isoformat(), instance_id))
            conn.commit()
            conn.close()
            
            logger.info(f"Completed process instance: {instance_id}")
    
    def complete_task(self, task_id: str, form_data: Dict[str, Any] = None,
                      assignee: str = None) -> bool:
        """å®Œæˆä»»åŠ¡"""
        with self._lock:
            task = self.tasks.get(task_id)
            if not task:
                return False
            
            task.status = TaskStatus.COMPLETED
            task.complete_time = datetime.now()
            task.assignee = assignee or task.assignee
            task.form_data = form_data or {}
            
            # æ›´æ–°æ•°æ®åº“
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            cursor.execute('''
                UPDATE tasks 
                SET status = ?, complete_time = ?, assignee = ?, form_data = ?
                WHERE task_id = ?
            ''', (
                task.status.value,
                task.complete_time.isoformat(),
                task.assignee,
                json.dumps(task.form_data),
                task_id
            ))
            conn.commit()
            conn.close()
            
            logger.info(f"Completed task: {task_id}")
            
            # ç»§ç»­æ‰§è¡Œæµç¨‹
            self._execute_next_element(task.instance_id)
            return True
    
    def get_tasks_for_user(self, user_id: str, groups: List[str] = None) -> List[Task]:
        """è·å–ç”¨æˆ·çš„å¾…åŠä»»åŠ¡"""
        result = []
        groups = groups or []
        
        for task in self.tasks.values():
            if task.status != TaskStatus.PENDING and task.status != TaskStatus.ASSIGNED:
                continue
            
            if task.assignee == user_id:
                result.append(task)
            elif not task.assignee and any(g in groups for g in task.candidate_groups):
                result.append(task)
        
        return sorted(result, key=lambda t: t.create_time)
    
    def claim_task(self, task_id: str, user_id: str) -> bool:
        """è®¤é¢†ä»»åŠ¡"""
        task = self.tasks.get(task_id)
        if not task or task.status != TaskStatus.PENDING:
            return False
        
        task.assignee = user_id
        task.status = TaskStatus.ASSIGNED
        
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute('''
            UPDATE tasks SET assignee = ?, status = ? WHERE task_id = ?
        ''', (user_id, task.status.value, task_id))
        conn.commit()
        conn.close()
        
        return True
    
    def get_process_statistics(self, process_id: str = None) -> Dict[str, Any]:
        """è·å–æµç¨‹ç»Ÿè®¡ä¿¡æ¯"""
        instances = list(self.process_instances.values())
        
        if process_id:
            instances = [i for i in instances if i.process_id == process_id]
        
        total = len(instances)
        running = sum(1 for i in instances if i.status == ProcessStatus.RUNNING)
        completed = sum(1 for i in instances if i.status == ProcessStatus.COMPLETED)
        
        # è®¡ç®—å¹³å‡å®Œæˆæ—¶é—´
        completed_instances = [i for i in instances if i.status == ProcessStatus.COMPLETED and i.end_time]
        avg_duration = 0
        if completed_instances:
            durations = [(i.end_time - i.start_time).total_seconds() / 3600 for i in completed_instances]
            avg_duration = sum(durations) / len(durations)
        
        return {
            'total_instances': total,
            'running': running,
            'completed': completed,
            'completion_rate': completed / total if total > 0 else 0,
            'avg_duration_hours': round(avg_duration, 2)
        }


# é“¶è¡Œä¸šåŠ¡æ‰©å±•ç±»
class BankingWorkflowService:
    """é“¶è¡Œå·¥ä½œæµæœåŠ¡"""
    
    def __init__(self, engine: WorkflowEngine):
        self.engine = engine
    
    def submit_credit_application(self, customer_id: str, amount: float,
                                   customer_manager: str) -> str:
        """æäº¤ä¿¡è´·ç”³è¯·"""
        variables = {
            'customerId': customer_id,
            'creditAmount': amount,
            'customerManager': customer_manager,
            'submitTime': datetime.now().isoformat()
        }
        
        business_key = f"APP-{customer_id}-{datetime.now().strftime('%Y%m%d%H%M%S')}"
        instance_id = self.engine.start_process_instance(
            'credit_approval_process_v2',
            business_key,
            variables
        )
        return instance_id
    
    def get_pending_approvals(self, user_id: str, department: str) -> List[Dict]:
        """è·å–å¾…å®¡æ‰¹åˆ—è¡¨"""
        tasks = self.engine.get_tasks_for_user(user_id, [department])
        
        result = []
        for task in tasks:
            instance = self.engine.process_instances.get(task.instance_id)
            variables = instance.variables if instance else {}
            
            result.append({
                'taskId': task.task_id,
                'taskName': task.task_name,
                'businessKey': instance.business_key if instance else '',
                'customerId': variables.get('customerId'),
                'creditAmount': variables.get('creditAmount'),
                'createTime': task.create_time.isoformat(),
                'dueDate': task.due_date.isoformat() if task.due_date else None
            })
        
        return result


# ä½¿ç”¨ç¤ºä¾‹
def main():
    """ä¸»å‡½æ•° - æ¼”ç¤ºå®Œæ•´æµç¨‹"""
    
    # åˆå§‹åŒ–å·¥ä½œæµå¼•æ“
    engine = WorkflowEngine("bank_workflow.db")
    
    # å®šä¹‰æµç¨‹å…ƒç´ 
    elements = [
        {'element_id': 'start', 'element_type': 'StartEvent', 'element_name': 'å¼€å§‹'},
        {'element_id': 'collect_data', 'element_type': 'UserTask', 'element_name': 'èµ„æ–™æ”¶é›†',
         'candidate_groups': ['customer_manager'], 'due_minutes': 120},
        {'element_id': 'auto_assessment', 'element_type': 'ServiceTask', 'element_name': 'è‡ªåŠ¨è¯„ä¼°'},
        {'element_id': 'risk_review', 'element_type': 'UserTask', 'element_name': 'é£æ§å®¡æ ¸',
         'candidate_groups': ['risk_control'], 'due_minutes': 240},
        {'element_id': 'legal_review', 'element_type': 'UserTask', 'element_name': 'æ³•åŠ¡å®¡æ ¸',
         'candidate_groups': ['legal'], 'due_minutes': 240},
        {'element_id': 'gateway', 'element_type': 'ExclusiveGateway', 'element_name': 'é¢åº¦åˆ¤æ–­'},
        {'element_id': 'senior_approval', 'element_type': 'UserTask', 'element_name': 'é«˜çº§å®¡æ‰¹',
         'candidate_groups': ['senior_approver'], 'due_minutes': 480},
        {'element_id': 'contract_sign', 'element_type': 'UserTask', 'element_name': 'åˆåŒç­¾è®¢',
         'candidate_groups': ['contract_manager'], 'due_minutes': 120},
        {'element_id': 'disbursement', 'element_type': 'ServiceTask', 'element_name': 'æ”¾æ¬¾æ‰§è¡Œ'},
        {'element_id': 'end', 'element_type': 'EndEvent', 'element_name': 'ç»“æŸ'}
    ]
    
    # éƒ¨ç½²æµç¨‹å®šä¹‰
    process_def = ProcessDefinition(
        process_id='credit_approval_process_v2',
        process_name='ä¿¡è´·å®¡æ‰¹æµç¨‹',
        process_key='creditApproval',
        version=2,
        category='Credit',
        elements=elements
    )
    engine.deploy_process_definition(process_def)
    
    # åˆ›å»ºé“¶è¡ŒæœåŠ¡
    banking_service = BankingWorkflowService(engine)
    
    # æäº¤ä¿¡è´·ç”³è¯·
    print("=" * 60)
    print("æäº¤ä¿¡è´·ç”³è¯·")
    print("=" * 60)
    instance_id = banking_service.submit_credit_application(
        customer_id='CUST202501001',
        amount=5000000.00,
        customer_manager='zhangsan'
    )
    print(f"æµç¨‹å®ä¾‹ID: {instance_id}")
    
    # æ¨¡æ‹Ÿå®¢æˆ·ç»ç†å®Œæˆä»»åŠ¡
    tasks = engine.get_tasks_for_user('zhangsan', ['customer_manager'])
    if tasks:
        task = tasks[0]
        print(f"\nå®¢æˆ·ç»ç†å¾…åŠä»»åŠ¡: {task.task_name}")
        engine.claim_task(task.task_id, 'zhangsan')
        engine.complete_task(task.task_id, {'documents': 'complete'})
        print("èµ„æ–™æ”¶é›†ä»»åŠ¡å·²å®Œæˆ")
    
    # æ¨¡æ‹Ÿé£æ§å®¡æ ¸
    tasks = engine.get_tasks_for_user('lisi', ['risk_control'])
    if tasks:
        task = tasks[0]
        print(f"\né£æ§äººå‘˜å¾…åŠä»»åŠ¡: {task.task_name}")
        engine.claim_task(task.task_id, 'lisi')
        engine.complete_task(task.task_id, {'riskLevel': 'low', 'suggestion': 'approve'})
        print("é£æ§å®¡æ ¸ä»»åŠ¡å·²å®Œæˆ")
    
    # è·å–æµç¨‹ç»Ÿè®¡
    print("\n" + "=" * 60)
    print("æµç¨‹ç»Ÿè®¡")
    print("=" * 60)
    stats = engine.get_process_statistics('credit_approval_process_v2')
    print(f"æ€»å®ä¾‹æ•°: {stats['total_instances']}")
    print(f"è¿è¡Œä¸­: {stats['running']}")
    print(f"å·²å®Œæˆ: {stats['completed']}")
    print(f"å®Œæˆç‡: {stats['completion_rate']:.1%}")
    print(f"å¹³å‡å¤„ç†æ—¶é•¿: {stats['avg_duration_hours']:.2f}å°æ—¶")


if __name__ == "__main__":
    main()
```

### 2.7 æ•ˆæœè¯„ä¼°

**æ€§èƒ½æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | åŸºçº¿å€¼ | ç›®æ ‡å€¼ | å®é™…å€¼ | è¾¾æˆç‡ |
|------|--------|--------|--------|--------|
| å¹³å‡å®¡æ‰¹æ—¶é—´ | 15å·¥ä½œæ—¥ | â‰¤3å·¥ä½œæ—¥ | 2.3å·¥ä½œæ—¥ | 130% |
| ç´§æ€¥ä¸šåŠ¡å®¡æ‰¹ | 5å·¥ä½œæ—¥ | T+0 | 4å°æ—¶ | 300% |
| å®¢æˆ·æ»¡æ„åº¦ | 72% | â‰¥90% | 93% | 103% |
| æµç¨‹è‡ªåŠ¨åŒ–ç‡ | 30% | â‰¥50% | 68% | 136% |
| ç³»ç»Ÿå¯ç”¨æ€§ | 99.5% | â‰¥99.9% | 99.95% | 100% |

**ROIåˆ†æ**ï¼š

1. **ç›´æ¥æˆæœ¬èŠ‚çº¦**
   - äººå·¥æˆæœ¬èŠ‚çº¦ï¼šæµç¨‹è‡ªåŠ¨åŒ–å‡å°‘å®¡æ‰¹äººå‘˜å·¥ä½œé‡ï¼Œå¹´èŠ‚çº¦äººåŠ›æˆæœ¬1200ä¸‡å…ƒ
   - è¿è¥æˆæœ¬èŠ‚çº¦ï¼šçº¸è´¨æ–‡æ¡£ç”µå­åŒ–ï¼Œå¹´èŠ‚çº¦å°åˆ·ã€å­˜å‚¨ã€è¿è¾“æˆæœ¬300ä¸‡å…ƒ
   - ç³»ç»Ÿç»´æŠ¤æˆæœ¬ï¼šç»Ÿä¸€å¹³å°æ›¿ä»£åŸæœ‰8ä¸ªå­ç³»ç»Ÿï¼Œå¹´èŠ‚çº¦ç»´æŠ¤æˆæœ¬500ä¸‡å…ƒ
   - **å¹´åº¦ç›´æ¥èŠ‚çº¦åˆè®¡ï¼š2000ä¸‡å…ƒ**

2. **é—´æ¥æ”¶ç›Š**
   - ä¸šåŠ¡å¢é•¿ï¼šå®¡æ‰¹æ•ˆç‡æå‡å¸¦æ¥å®¢æˆ·ç•™å­˜ç‡æå‡12%ï¼Œå¹´æ–°å¢ä¿¡è´·ä¸šåŠ¡æ”¶ç›Š3500ä¸‡å…ƒ
   - é£é™©é™ä½ï¼šæ ‡å‡†åŒ–é£æ§æ¨¡å‹å‡å°‘ä¸è‰¯è´·æ¬¾ç‡0.3ä¸ªç™¾åˆ†ç‚¹ï¼Œå¹´é¿å…æŸå¤±2800ä¸‡å…ƒ
   - ç›‘ç®¡åˆè§„ï¼šè‡ªåŠ¨åŒ–åˆè§„æ£€æŸ¥å‡å°‘ç›‘ç®¡ç½šæ¬¾é£é™©ï¼Œé¢„è®¡å¹´é¿å…æŸå¤±500ä¸‡å…ƒ
   - **å¹´åº¦é—´æ¥æ”¶ç›Šåˆè®¡ï¼š6800ä¸‡å…ƒ**

3. **æŠ•èµ„å›æŠ¥**
   - é¡¹ç›®æ€»æŠ•èµ„ï¼š4500ä¸‡å…ƒï¼ˆå«è½¯ä»¶å¼€å‘ã€ç¡¬ä»¶é‡‡è´­ã€ç³»ç»Ÿé›†æˆã€åŸ¹è®­ç­‰ï¼‰
   - å¹´åº¦æ€»æ”¶ç›Šï¼š8800ä¸‡å…ƒ
   - **æŠ•èµ„å›æ”¶æœŸï¼š6.1ä¸ªæœˆ**
   - **3å¹´ROIï¼š486%**

**æˆåŠŸç»éªŒ**ï¼š

1. **æµç¨‹æ ‡å‡†åŒ–å…ˆè¡Œ**ï¼šåœ¨ç³»ç»Ÿå®æ–½å‰ï¼Œå…ˆç»„ç»‡ä¸šåŠ¡ä¸“å®¶å®Œæˆå…¨è¡Œä¿¡è´·å®¡æ‰¹æµç¨‹æ ‡å‡†åŒ–ï¼Œæ¶ˆé™¤åœ°åŒºå·®å¼‚
2. **åˆ†é˜¶æ®µæ¨è¿›**ï¼šæŒ‰ç…§"é›¶å”®ä¸šåŠ¡â†’å°å¾®ä¼ä¸šâ†’å¤§ä¸­ä¼ä¸š"çš„é¡ºåºåˆ†ä¸‰é˜¶æ®µä¸Šçº¿ï¼Œé™ä½å®æ–½é£é™©
3. **ç”¨æˆ·å‚ä¸è®¾è®¡**ï¼šåœ¨éœ€æ±‚åˆ†æå’ŒUATé˜¶æ®µå……åˆ†å¬å–ä¸€çº¿ä¸šåŠ¡äººå‘˜æ„è§ï¼Œç¡®ä¿ç³»ç»Ÿæ˜“ç”¨æ€§
4. **æ•°æ®è´¨é‡æ²»ç†**ï¼šåŒæ­¥å¼€å±•ä¸»æ•°æ®æ²»ç†ï¼Œç¡®ä¿å®¢æˆ·ä¿¡æ¯åœ¨å„ç³»ç»Ÿé—´çš„ä¸€è‡´æ€§

---

## 3. æ¡ˆä¾‹2ï¼šä¿é™©ç†èµ”å¤„ç†å·¥ä½œæµ

### 3.1 ä¸šåŠ¡èƒŒæ™¯

**ä¼ä¸šæ¦‚å†µ**ï¼šæŸå¤§å‹è´¢äº§ä¿é™©å…¬å¸ï¼ˆä»¥ä¸‹ç®€ç§°"Bä¿é™©"ï¼‰ï¼Œæˆç«‹äº2003å¹´ï¼Œæ³¨å†Œèµ„æœ¬100äº¿å…ƒï¼Œåœ¨å…¨å›½è®¾æœ‰35å®¶çœçº§åˆ†å…¬å¸ï¼Œå¹´ä¿è´¹æ”¶å…¥è¶…è¿‡800äº¿å…ƒã€‚å…¬å¸è½¦é™©ã€è´¢äº§é™©ã€è´£ä»»é™©ç­‰ä¸šåŠ¡å‡è¡¡å‘å±•ï¼ŒæœåŠ¡ä¸ªäººå®¢æˆ·è¶…è¿‡2000ä¸‡ï¼Œä¼ä¸šå®¢æˆ·è¶…è¿‡50ä¸‡å®¶ã€‚

ä¿é™©ç†èµ”æ˜¯ä¿é™©å…¬å¸çš„æ ¸å¿ƒæœåŠ¡ç¯èŠ‚ï¼Œç›´æ¥å½±å“å®¢æˆ·æ»¡æ„åº¦å’Œå…¬å¸å“ç‰Œå½¢è±¡ã€‚è¯¥å…¬å¸å¹´å¤„ç†ç†èµ”æ¡ˆä»¶è¶…è¿‡500ä¸‡ä»¶ï¼Œæ¶‰åŠæŸ¥å‹˜ã€å®šæŸã€æ ¸èµ”ã€èµ”ä»˜ç­‰å¤šä¸ªç¯èŠ‚ï¼ŒåŸæœ‰ç†èµ”æµç¨‹ä¾èµ–å¤§é‡äººå·¥æ“ä½œï¼Œæ•ˆç‡ä½ä¸‹ä¸”å®¹æ˜“å‡ºç°äººä¸ºå·®é”™ã€‚

### 3.2 ä¸šåŠ¡ç—›ç‚¹

1. **ç†èµ”å‘¨æœŸé•¿**ï¼šä»å®¢æˆ·æŠ¥æ¡ˆåˆ°æœ€ç»ˆèµ”ä»˜å¹³å‡éœ€è¦12ä¸ªå·¥ä½œæ—¥ï¼Œè¿œè¶…è¡Œä¸šé¢†å…ˆæ°´å¹³ï¼ˆ5ä¸ªå·¥ä½œæ—¥ï¼‰ï¼Œå°é¢å¿«é€Ÿç†èµ”æ¡ˆä»¶ä¹Ÿæ— æ³•å®ç°å¿«é€Ÿå¤„ç†ã€‚

2. **äººå·¥ä¾èµ–åº¦é«˜**ï¼šæŸ¥å‹˜å®šæŸç¯èŠ‚éœ€è¦å¤§é‡ç°åœºæŸ¥å‹˜äººå‘˜ï¼Œå•æ¡ˆæŸ¥å‹˜æˆæœ¬å¹³å‡280å…ƒï¼Œä¸”å—äº¤é€šã€å¤©æ°”ç­‰å› ç´ å½±å“å¤§ï¼Œåè¿œåœ°åŒºæŸ¥å‹˜æ—¶æ•ˆéš¾ä»¥ä¿è¯ã€‚

3. **æ¬ºè¯ˆè¯†åˆ«å›°éš¾**ï¼šæ¯å¹´ç–‘ä¼¼æ¬ºè¯ˆæ¡ˆä»¶è¶…è¿‡3ä¸‡ä»¶ï¼Œä½†äººå·¥å®¡æ ¸åªèƒ½è¦†ç›–ä¸åˆ°10%ï¼Œæ¬ºè¯ˆæŸå¤±é‡‘é¢ä¼°ç®—è¶…è¿‡2äº¿å…ƒ/å¹´ã€‚

4. **å®¢æˆ·ä½“éªŒå·®**ï¼šç†èµ”è¿›åº¦ä¸é€æ˜ï¼Œå®¢æˆ·éœ€è¦åå¤è‡´ç”µå®¢æœæŸ¥è¯¢ï¼Œç†èµ”äº‰è®®å¤„ç†æµç¨‹å¤æ‚ï¼Œå®¢æˆ·æŠ•è¯‰ç‡é«˜è¾¾8%ã€‚

5. **è·¨éƒ¨é—¨åä½œä½æ•ˆ**ï¼šç†èµ”æ¶‰åŠå®¢æœã€æŸ¥å‹˜ã€å®šæŸã€æ ¸èµ”ã€è´¢åŠ¡ç­‰7ä¸ªéƒ¨é—¨ï¼Œä¿¡æ¯ä¼ é€’ä¾èµ–é‚®ä»¶å’Œç”µè¯ï¼Œç»å¸¸å‡ºç°ä¿¡æ¯é—æ¼å’Œå»¶è¿Ÿã€‚

### 3.3 ä¸šåŠ¡ç›®æ ‡

1. **ç¼©çŸ­ç†èµ”å‘¨æœŸ**ï¼šå°†å¹³å‡ç†èµ”å‘¨æœŸä»12å¤©ç¼©çŸ­è‡³5å¤©ä»¥å†…ï¼Œå°é¢æ¡ˆä»¶å®ç°"é—ªèµ”"ï¼ˆ24å°æ—¶å†…åˆ°è´¦ï¼‰ã€‚

2. **æå‡è‡ªåŠ¨åŒ–ç‡**ï¼šé€šè¿‡å›¾åƒè¯†åˆ«ã€è¿œç¨‹è§†é¢‘ç­‰æŠ€æœ¯ï¼Œå®ç°50%ä»¥ä¸Šå°é¢æ¡ˆä»¶çš„è‡ªåŠ¨åŒ–å¤„ç†ï¼Œæ— éœ€äººå·¥ç°åœºæŸ¥å‹˜ã€‚

3. **å¼ºåŒ–æ¬ºè¯ˆé˜²æ§**ï¼šå»ºç«‹æ™ºèƒ½é£æ§æ¨¡å‹ï¼Œå®ç°80%ä»¥ä¸Šå¯ç–‘æ¡ˆä»¶çš„è‡ªåŠ¨è¯†åˆ«å’Œæ‹¦æˆªï¼Œå¹´å‡å°‘æ¬ºè¯ˆæŸå¤±5000ä¸‡å…ƒä»¥ä¸Šã€‚

4. **æå‡å®¢æˆ·ä½“éªŒ**ï¼šæä¾›ç†èµ”å…¨æµç¨‹å¯è§†åŒ–æŸ¥è¯¢ï¼Œå®¢æˆ·æ»¡æ„åº¦æå‡è‡³95%ä»¥ä¸Šï¼ŒæŠ•è¯‰ç‡é™ä½è‡³3%ä»¥ä¸‹ã€‚

5. **ä¼˜åŒ–èµ„æºé…ç½®**ï¼šé€šè¿‡æµç¨‹ä¼˜åŒ–å’ŒæŠ€æœ¯æ‰‹æ®µï¼ŒæŸ¥å‹˜äººå‘˜æ•ˆç‡æå‡50%ï¼Œç†èµ”è¿è¥æˆæœ¬é™ä½25%ã€‚

### 3.4 æŠ€æœ¯æŒ‘æˆ˜

**æŒ‘æˆ˜1ï¼šæ™ºèƒ½å›¾åƒè¯†åˆ«é›†æˆ**

- éœ€è¦é›†æˆè½¦è¾†æŸä¼¤è¯†åˆ«ã€åŒ»ç–—ç¥¨æ®è¯†åˆ«ã€è´¢äº§æŸå¤±è¯„ä¼°ç­‰å¤šç§AIæ¨¡å‹
- è¯†åˆ«å‡†ç¡®ç‡éœ€è¦è¾¾åˆ°95%ä»¥ä¸Šæ‰èƒ½æŠ•å…¥ç”Ÿäº§ä½¿ç”¨
- éœ€è¦å¤„ç†æµ·é‡å›¾ç‰‡å’Œè§†é¢‘æ•°æ®ï¼Œå¯¹å­˜å‚¨å’Œè®¡ç®—èµ„æºè¦æ±‚é«˜

**æŒ‘æˆ˜2ï¼šå¤æ‚è§„åˆ™å¼•æ“è®¾è®¡**

- ä¿é™©æ¡æ¬¾å¤æ‚ï¼Œä¸åŒé™©ç§ã€ä¸åŒä¿å•çš„ç†èµ”è§„åˆ™å·®å¼‚å¤§
- éœ€è¦æ”¯æŒè§„åˆ™çš„åŠ¨æ€é…ç½®å’Œçƒ­æ›´æ–°ï¼Œä¸å½±å“æ­£åœ¨å¤„ç†çš„æ¡ˆä»¶
- è§„åˆ™æ‰§è¡Œéœ€è¦é«˜æ€§èƒ½ï¼Œæ”¯æŒæ¯ç§’ä¸‡çº§æ¡ˆä»¶çš„è§„åˆ™åŒ¹é…

**æŒ‘æˆ˜3ï¼šå¤šæ¸ é“æ¥å…¥æ•´åˆ**

- éœ€è¦æ”¯æŒAPPã€å¾®ä¿¡å°ç¨‹åºã€å®˜ç½‘ã€ç”µè¯ã€çº¿ä¸‹ç½‘ç‚¹ç­‰å¤šæ¸ é“æŠ¥æ¡ˆ
- å„æ¸ é“æ•°æ®æ ¼å¼å’Œæµç¨‹å­˜åœ¨å·®å¼‚ï¼Œéœ€è¦ç»Ÿä¸€æŠ½è±¡å’Œè½¬æ¢
- éœ€è¦ä¿è¯å¤šæ¸ é“ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§å’ŒçŠ¶æ€åŒæ­¥

**æŒ‘æˆ˜4ï¼šå¤–éƒ¨ç³»ç»Ÿå¯¹æ¥**

- éœ€è¦å¯¹æ¥äº¤è­¦ç³»ç»Ÿã€åŒ»é™¢ç³»ç»Ÿã€ç»´ä¿®å‚ç³»ç»Ÿã€é“¶è¡Œæ”¯ä»˜ç³»ç»Ÿç­‰å¤–éƒ¨ç³»ç»Ÿ
- å¤–éƒ¨ç³»ç»Ÿçš„æ¥å£æ ‡å‡†å’Œç¨³å®šæ€§å‚å·®ä¸é½ï¼Œéœ€è¦è®¾è®¡å¥å£®çš„å®¹é”™æœºåˆ¶
- æ•°æ®äº¤æ¢éœ€è¦ç¬¦åˆé‡‘èç›‘ç®¡è¦æ±‚ï¼Œä¿è¯ä¿¡æ¯å®‰å…¨

### 3.5 å®Œæ•´ä»£ç å®ç°

**ä¿é™©ç†èµ”å·¥ä½œæµç³»ç»Ÿï¼ˆçº¦450è¡Œï¼‰**ï¼š

```python
#!/usr/bin/env python3
"""
ä¿é™©ç†èµ”å·¥ä½œæµç³»ç»Ÿ
åŠŸèƒ½ï¼šæŠ¥æ¡ˆå—ç†ã€æ™ºèƒ½æŸ¥å‹˜ã€è‡ªåŠ¨æ ¸èµ”ã€èµ”ä»˜æ‰§è¡Œ
"""

import uuid
import json
import random
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Any
from dataclasses import dataclass, field
from enum import Enum
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class ClaimStatus(str, Enum):
    """ç†èµ”çŠ¶æ€"""
    REPORTED = "reported"           # å·²æŠ¥æ¡ˆ
    SCHEDULED = "scheduled"         # å·²è°ƒåº¦
    SURVEYING = "surveying"         # æŸ¥å‹˜ä¸­
    ASSESSING = "assessing"         # å®šæŸä¸­
    APPROVING = "approving"         # æ ¸èµ”ä¸­
    APPROVED = "approved"           # å·²æ ¸èµ”
    PAYING = "paying"               # æ”¯ä»˜ä¸­
    COMPLETED = "completed"         # å·²å®Œæˆ
    REJECTED = "rejected"           # å·²æ‹’èµ”


class ClaimType(str, Enum):
    """ç†èµ”ç±»å‹"""
    VEHICLE = "vehicle"             # è½¦é™©
    PROPERTY = "property"           # è´¢äº§é™©
    LIABILITY = "liability"         # è´£ä»»é™©
    HEALTH = "health"               # å¥åº·é™©


@dataclass
class Claim:
    """ç†èµ”æ¡ˆä»¶"""
    claim_id: str
    claim_no: str
    policy_no: str
    claim_type: ClaimType
    customer_name: str
    customer_phone: str
    incident_time: datetime
    incident_location: str
    description: str
    estimated_amount: float
    status: ClaimStatus
    create_time: datetime = field(default_factory=datetime.now)
    surveyor_id: Optional[str] = None
    assessor_id: Optional[str] = None
    approver_id: Optional[str] = None
    actual_amount: Optional[float] = None
    pay_time: Optional[datetime] = None


@dataclass
class SurveyTask:
    """æŸ¥å‹˜ä»»åŠ¡"""
    task_id: str
    claim_id: str
    surveyor_id: Optional[str]
    task_status: str  # pending, assigned, in_progress, completed
    assign_time: Optional[datetime] = None
    complete_time: Optional[datetime] = None
    survey_result: Dict[str, Any] = field(default_factory=dict)


class AIImageRecognitionService:
    """AIå›¾åƒè¯†åˆ«æœåŠ¡ï¼ˆæ¨¡æ‹Ÿï¼‰"""
    
    def recognize_vehicle_damage(self, image_urls: List[str]) -> Dict[str, Any]:
        """è¯†åˆ«è½¦è¾†æŸä¼¤"""
        # æ¨¡æ‹ŸAIè¯†åˆ«ç»“æœ
        logger.info(f"AIè¯†åˆ«è½¦è¾†æŸä¼¤ï¼Œå›¾ç‰‡æ•°é‡: {len(image_urls)}")
        
        # æ¨¡æ‹Ÿè¯†åˆ«å»¶è¿Ÿ
        import time
        time.sleep(0.5)
        
        # éšæœºç”Ÿæˆè¯†åˆ«ç»“æœ
        damage_parts = random.sample(["å‰ä¿é™©æ ", "å·¦å‰ç¯", "å¼•æ“ç›–", "å·¦å‰é—¨", "åä¿é™©æ "], 
                                      random.randint(1, 3))
        
        return {
            "success": True,
            "damage_detected": True,
            "damage_parts": damage_parts,
            "severity": random.choice(["è½»å¾®", "ä¸­åº¦", "ä¸¥é‡"]),
            "estimated_cost": random.randint(1000, 15000),
            "confidence": round(random.uniform(0.85, 0.99), 2)
        }
    
    def recognize_invoice(self, image_url: str) -> Dict[str, Any]:
        """è¯†åˆ«åŒ»ç–—/ç»´ä¿®å‘ç¥¨"""
        logger.info(f"AIè¯†åˆ«å‘ç¥¨: {image_url}")
        
        return {
            "success": True,
            "invoice_type": random.choice(["ç»´ä¿®å‘ç¥¨", "åŒ»ç–—è´¹å‘ç¥¨", "æ–½æ•‘è´¹å‘ç¥¨"]),
            "amount": random.randint(500, 50000),
            "invoice_no": f"INV{random.randint(100000, 999999)}",
            "invoice_date": datetime.now().strftime("%Y-%m-%d"),
            "confidence": round(random.uniform(0.90, 0.99), 2)
        }


class FraudDetectionService:
    """æ¬ºè¯ˆæ£€æµ‹æœåŠ¡"""
    
    def analyze_claim(self, claim: Claim) -> Dict[str, Any]:
        """åˆ†ææ¡ˆä»¶æ¬ºè¯ˆé£é™©"""
        logger.info(f"åˆ†ææ¡ˆä»¶æ¬ºè¯ˆé£é™©: {claim.claim_id}")
        
        # æ¨¡æ‹Ÿé£é™©è¯„åˆ†
        risk_score = random.randint(0, 100)
        
        risk_level = "low"
        if risk_score >= 80:
            risk_level = "high"
        elif risk_score >= 50:
            risk_level = "medium"
        
        return {
            "risk_score": risk_score,
            "risk_level": risk_level,
            "risk_factors": random.sample([
                "å‡ºé™©æ—¶é—´å¼‚å¸¸", "ä¿®ç†å‚å…³è”", "å†å²å‡ºé™©é¢‘ç¹", "é…ä»¶ä»·æ ¼å¼‚å¸¸"
            ], random.randint(0, 2)) if risk_score > 50 else [],
            "suggestion": "manual_review" if risk_score >= 50 else "auto_process"
        }


class ClaimWorkflowEngine:
    """ç†èµ”å·¥ä½œæµå¼•æ“"""
    
    def __init__(self):
        self.claims: Dict[str, Claim] = {}
        self.tasks: Dict[str, SurveyTask] = {}
        self.ai_service = AIImageRecognitionService()
        self.fraud_service = FraudDetectionService()
        self.staff_pool = {
            "surveyors": ["S001", "S002", "S003", "S004", "S005"],
            "assessors": ["A001", "A002", "A003"],
            "approvers": ["P001", "P002"]
        }
    
    def submit_claim(self, policy_no: str, claim_type: ClaimType,
                     customer_name: str, customer_phone: str,
                     incident_time: datetime, incident_location: str,
                     description: str, estimated_amount: float) -> Claim:
        """æäº¤ç†èµ”ç”³è¯·"""
        claim_id = f"CLM{uuid.uuid4().hex[:10].upper()}"
        claim_no = f"{datetime.now().strftime('%Y%m%d')}{random.randint(10000, 99999)}"
        
        claim = Claim(
            claim_id=claim_id,
            claim_no=claim_no,
            policy_no=policy_no,
            claim_type=claim_type,
            customer_name=customer_name,
            customer_phone=customer_phone,
            incident_time=incident_time,
            incident_location=incident_location,
            description=description,
            estimated_amount=estimated_amount,
            status=ClaimStatus.REPORTED
        )
        
        self.claims[claim_id] = claim
        logger.info(f"æäº¤ç†èµ”ç”³è¯·: {claim_no}, æ¡ˆä»¶ID: {claim_id}")
        
        # å¯åŠ¨ç†èµ”æµç¨‹
        self._start_claim_process(claim)
        
        return claim
    
    def _start_claim_process(self, claim: Claim):
        """å¯åŠ¨ç†èµ”å¤„ç†æµç¨‹"""
        # 1. æ¬ºè¯ˆé£é™©åˆ†æ
        fraud_result = self.fraud_service.analyze_claim(claim)
        logger.info(f"æ¡ˆä»¶ {claim.claim_id} æ¬ºè¯ˆé£é™©: {fraud_result['risk_level']}")
        
        if fraud_result["risk_level"] == "high":
            # é«˜é£é™©æ¡ˆä»¶è½¬äººå·¥å®¡æ ¸
            claim.status = ClaimStatus.APPROVING
            claim.approver_id = random.choice(self.staff_pool["approvers"])
            logger.info(f"é«˜é£é™©æ¡ˆä»¶è½¬äººå·¥å®¡æ ¸ï¼Œæ ¸èµ”å‘˜: {claim.approver_id}")
            return
        
        # 2. å°é¢å¿«é€Ÿç†èµ”é€šé“
        if claim.estimated_amount <= 5000 and fraud_result["risk_level"] == "low":
            # å°é¢æ¡ˆä»¶è‡ªåŠ¨å¤„ç†
            claim.status = ClaimStatus.APPROVING
            self._auto_approve(claim)
            return
        
        # 3. æ­£å¸¸æµç¨‹ï¼šåˆ›å»ºæŸ¥å‹˜ä»»åŠ¡
        claim.status = ClaimStatus.SCHEDULED
        self._create_survey_task(claim)
    
    def _create_survey_task(self, claim: Claim):
        """åˆ›å»ºæŸ¥å‹˜ä»»åŠ¡"""
        task_id = f"TSK{uuid.uuid4().hex[:8].upper()}"
        
        # æ™ºèƒ½è°ƒåº¦ï¼šé€‰æ‹©æŸ¥å‹˜å‘˜
        surveyor_id = random.choice(self.staff_pool["surveyors"])
        
        task = SurveyTask(
            task_id=task_id,
            claim_id=claim.claim_id,
            surveyor_id=surveyor_id,
            task_status="assigned",
            assign_time=datetime.now()
        )
        
        self.tasks[task_id] = task
        claim.surveyor_id = surveyor_id
        claim.status = ClaimStatus.SURVEYING
        
        logger.info(f"åˆ›å»ºæŸ¥å‹˜ä»»åŠ¡: {task_id}, æŸ¥å‹˜å‘˜: {surveyor_id}")
    
    def complete_survey(self, task_id: str, survey_result: Dict[str, Any],
                        image_urls: List[str] = None):
        """å®ŒæˆæŸ¥å‹˜"""
        task = self.tasks.get(task_id)
        if not task:
            raise ValueError(f"Task not found: {task_id}")
        
        claim = self.claims.get(task.claim_id)
        
        # AIå›¾åƒè¯†åˆ«è¾…åŠ©å®šæŸ
        ai_result = None
        if image_urls and claim.claim_type == ClaimType.VEHICLE:
            ai_result = self.ai_service.recognize_vehicle_damage(image_urls)
            logger.info(f"AIå®šæŸç»“æœ: {ai_result}")
        
        task.task_status = "completed"
        task.complete_time = datetime.now()
        task.survey_result = {
            "survey_data": survey_result,
            "ai_result": ai_result
        }
        
        claim.status = ClaimStatus.ASSESSING
        claim.assessor_id = random.choice(self.staff_pool["assessors"])
        
        logger.info(f"æŸ¥å‹˜å®Œæˆ: {task_id}, è¿›å…¥å®šæŸç¯èŠ‚")
        
        # è‡ªåŠ¨å®šæŸ
        self._auto_assess(claim, ai_result)
    
    def _auto_assess(self, claim: Claim, ai_result: Optional[Dict]):
        """è‡ªåŠ¨å®šæŸ"""
        # æ ¹æ®AIç»“æœæˆ–ä¼°ç®—é‡‘é¢ç¡®å®šå®šæŸé‡‘é¢
        if ai_result and ai_result.get("success"):
            claim.actual_amount = ai_result["estimated_cost"]
        else:
            claim.actual_amount = claim.estimated_amount * random.uniform(0.9, 1.1)
        
        claim.actual_amount = round(claim.actual_amount, 2)
        
        # å°é¢æ¡ˆä»¶è‡ªåŠ¨æ ¸èµ”
        if claim.actual_amount <= 10000:
            self._auto_approve(claim)
        else:
            claim.status = ClaimStatus.APPROVING
            claim.approver_id = random.choice(self.staff_pool["approvers"])
            logger.info(f"è¿›å…¥æ ¸èµ”ç¯èŠ‚ï¼Œæ ¸èµ”å‘˜: {claim.approver_id}")
    
    def _auto_approve(self, claim: Claim):
        """è‡ªåŠ¨æ ¸èµ”"""
        logger.info(f"æ¡ˆä»¶ {claim.claim_id} è‡ªåŠ¨æ ¸èµ”é€šè¿‡")
        claim.status = ClaimStatus.APPROVED
        self._execute_payment(claim)
    
    def approve_claim(self, claim_id: str, approver_id: str,
                      approved: bool, actual_amount: float = None):
        """æ ¸èµ”"""
        claim = self.claims.get(claim_id)
        if not claim:
            raise ValueError(f"Claim not found: {claim_id}")
        
        if approved:
            claim.status = ClaimStatus.APPROVED
            claim.actual_amount = actual_amount or claim.actual_amount
            claim.approver_id = approver_id
            logger.info(f"æ¡ˆä»¶ {claim_id} æ ¸èµ”é€šè¿‡ï¼Œé‡‘é¢: {claim.actual_amount}")
            self._execute_payment(claim)
        else:
            claim.status = ClaimStatus.REJECTED
            logger.info(f"æ¡ˆä»¶ {claim_id} å·²æ‹’èµ”")
    
    def _execute_payment(self, claim: Claim):
        """æ‰§è¡Œèµ”ä»˜"""
        claim.status = ClaimStatus.PAYING
        logger.info(f"æ¡ˆä»¶ {claim.claim_id} æ‰§è¡Œèµ”ä»˜ï¼Œé‡‘é¢: {claim.actual_amount}")
        
        # æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†
        import time
        time.sleep(0.1)
        
        claim.status = ClaimStatus.COMPLETED
        claim.pay_time = datetime.now()
        
        duration = (claim.pay_time - claim.create_time).total_seconds() / 3600
        logger.info(f"æ¡ˆä»¶ {claim.claim_id} èµ”ä»˜å®Œæˆï¼Œæ€»è€—æ—¶: {duration:.2f}å°æ—¶")
    
    def get_claim_status(self, claim_id: str) -> Dict[str, Any]:
        """è·å–æ¡ˆä»¶çŠ¶æ€"""
        claim = self.claims.get(claim_id)
        if not claim:
            return None
        
        return {
            "claim_no": claim.claim_no,
            "status": claim.status.value,
            "status_desc": self._get_status_description(claim.status),
            "actual_amount": claim.actual_amount,
            "surveyor_id": claim.surveyor_id,
            "approver_id": claim.approver_id,
            "create_time": claim.create_time.isoformat(),
            "pay_time": claim.pay_time.isoformat() if claim.pay_time else None
        }
    
    def _get_status_description(self, status: ClaimStatus) -> str:
        """è·å–çŠ¶æ€æè¿°"""
        descriptions = {
            ClaimStatus.REPORTED: "å·²æŠ¥æ¡ˆï¼Œç­‰å¾…è°ƒåº¦",
            ClaimStatus.SCHEDULED: "å·²è°ƒåº¦ï¼Œç­‰å¾…æŸ¥å‹˜",
            ClaimStatus.SURVEYING: "æŸ¥å‹˜ä¸­",
            ClaimStatus.ASSESSING: "å®šæŸä¸­",
            ClaimStatus.APPROVING: "æ ¸èµ”ä¸­",
            ClaimStatus.APPROVED: "å·²æ ¸èµ”ï¼Œç­‰å¾…æ”¯ä»˜",
            ClaimStatus.PAYING: "æ”¯ä»˜ä¸­",
            ClaimStatus.COMPLETED: "å·²å®Œæˆ",
            ClaimStatus.REJECTED: "å·²æ‹’èµ”"
        }
        return descriptions.get(status, "æœªçŸ¥çŠ¶æ€")
    
    def get_statistics(self) -> Dict[str, Any]:
        """è·å–ç»Ÿè®¡ä¿¡æ¯"""
        claims = list(self.claims.values())
        
        total = len(claims)
        completed = sum(1 for c in claims if c.status == ClaimStatus.COMPLETED)
        rejected = sum(1 for c in claims if c.status == ClaimStatus.REJECTED)
        
        completed_claims = [c for c in claims if c.status == ClaimStatus.COMPLETED]
        avg_duration = 0
        if completed_claims:
            durations = [(c.pay_time - c.create_time).total_seconds() / 3600 
                        for c in completed_claims if c.pay_time]
            avg_duration = sum(durations) / len(durations) if durations else 0
        
        total_amount = sum(c.actual_amount for c in claims if c.actual_amount)
        
        return {
            "total_claims": total,
            "completed": completed,
            "rejected": rejected,
            "in_progress": total - completed - rejected,
            "completion_rate": completed / total if total > 0 else 0,
            "avg_duration_hours": round(avg_duration, 2),
            "total_paid_amount": round(total_amount, 2)
        }


# ä½¿ç”¨ç¤ºä¾‹
def main():
    """æ¼”ç¤ºä¿é™©ç†èµ”æµç¨‹"""
    
    engine = ClaimWorkflowEngine()
    
    print("=" * 60)
    print("ä¿é™©ç†èµ”å·¥ä½œæµç³»ç»Ÿæ¼”ç¤º")
    print("=" * 60)
    
    # æäº¤å¤šä¸ªç†èµ”ç”³è¯·
    claims = []
    for i in range(5):
        claim = engine.submit_claim(
            policy_no=f"POL{2025}{random.randint(10000, 99999)}",
            claim_type=ClaimType.VEHICLE,
            customer_name=f"å®¢æˆ·{i+1}",
            customer_phone=f"138{random.randint(10000000, 99999999)}",
            incident_time=datetime.now() - timedelta(hours=random.randint(1, 24)),
            incident_location="ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº",
            description="è½¦è¾†ç¢°æ’äº‹æ•…",
            estimated_amount=random.choice([3000, 8000, 15000, 50000])
        )
        claims.append(claim)
        print(f"\næäº¤ç†èµ”ç”³è¯· {i+1}: {claim.claim_no}, ä¼°æŸé‡‘é¢: {claim.estimated_amount}å…ƒ")
    
    # æ¨¡æ‹ŸæŸ¥å‹˜å®Œæˆ
    for task in list(engine.tasks.values()):
        image_urls = ["http://example.com/img1.jpg", "http://example.com/img2.jpg"]
        engine.complete_survey(
            task_id=task.task_id,
            survey_result={"scene": "å·²æ ¸å®", "liability": "å…¨è´£"},
            image_urls=image_urls
        )
    
    # æ¨¡æ‹Ÿæ ¸èµ”ï¼ˆå¯¹äºéœ€è¦äººå·¥æ ¸èµ”çš„æ¡ˆä»¶ï¼‰
    for claim in claims:
        if claim.status == ClaimStatus.APPROVING:
            engine.approve_claim(
                claim_id=claim.claim_id,
                approver_id="P001",
                approved=True,
                actual_amount=claim.actual_amount
            )
    
    # æŸ¥çœ‹æ¡ˆä»¶çŠ¶æ€
    print("\n" + "=" * 60)
    print("æ¡ˆä»¶å¤„ç†ç»“æœ")
    print("=" * 60)
    for claim in claims:
        status = engine.get_claim_status(claim.claim_id)
        print(f"æ¡ˆä»¶ {status['claim_no']}: {status['status_desc']}, "
              f"èµ”ä»˜é‡‘é¢: {status['actual_amount']}å…ƒ")
    
    # ç»Ÿè®¡ä¿¡æ¯
    print("\n" + "=" * 60)
    print("ç†èµ”ç»Ÿè®¡")
    print("=" * 60)
    stats = engine.get_statistics()
    print(f"æ€»æ¡ˆä»¶æ•°: {stats['total_claims']}")
    print(f"å·²å®Œæˆ: {stats['completed']}")
    print(f"å®Œæˆç‡: {stats['completion_rate']:.1%}")
    print(f"å¹³å‡å¤„ç†æ—¶é•¿: {stats['avg_duration_hours']:.2f}å°æ—¶")
    print(f"æ€»èµ”ä»˜é‡‘é¢: {stats['total_paid_amount']}å…ƒ")


if __name__ == "__main__":
    main()
```

### 3.6 æ•ˆæœè¯„ä¼°

**æ€§èƒ½æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | åŸºçº¿å€¼ | ç›®æ ‡å€¼ | å®é™…å€¼ | è¾¾æˆç‡ |
|------|--------|--------|--------|--------|
| å¹³å‡ç†èµ”å‘¨æœŸ | 12å¤© | â‰¤5å¤© | 4.2å¤© | 119% |
| å°é¢æ¡ˆä»¶å¤„ç†æ—¶æ•ˆ | 3å¤© | â‰¤24å°æ—¶ | 8å°æ—¶ | 300% |
| è‡ªåŠ¨åŒ–å¤„ç†ç‡ | 15% | â‰¥50% | 62% | 124% |
| å®¢æˆ·æ»¡æ„åº¦ | 82% | â‰¥95% | 96% | 101% |
| æŠ•è¯‰ç‡ | 8% | â‰¤3% | 2.1% | 143% |

**ROIåˆ†æ**ï¼š

1. **ç›´æ¥æˆæœ¬èŠ‚çº¦**
   - æŸ¥å‹˜æˆæœ¬èŠ‚çº¦ï¼šè¿œç¨‹æŸ¥å‹˜æ›¿ä»£ç°åœºæŸ¥å‹˜æ¯”ä¾‹è¾¾åˆ°40%ï¼Œå¹´èŠ‚çº¦æŸ¥å‹˜æˆæœ¬4500ä¸‡å…ƒ
   - äººå·¥æˆæœ¬èŠ‚çº¦ï¼šè‡ªåŠ¨åŒ–å¤„ç†å‡å°‘ç†èµ”äººå‘˜éœ€æ±‚ï¼Œå¹´èŠ‚çº¦äººåŠ›æˆæœ¬2800ä¸‡å…ƒ
   - æ¬ºè¯ˆæŸå¤±å‡å°‘ï¼šæ™ºèƒ½é£æ§å¹´å‡å°‘æ¬ºè¯ˆèµ”ä»˜5000ä¸‡å…ƒ
   - **å¹´åº¦ç›´æ¥æ”¶ç›Šåˆè®¡ï¼š12300ä¸‡å…ƒ**

2. **é—´æ¥æ”¶ç›Š**
   - å®¢æˆ·ç•™å­˜æå‡ï¼šç†èµ”ä½“éªŒæ”¹å–„å¸¦æ¥å®¢æˆ·ç»­ä¿ç‡æå‡8%ï¼Œå¹´æ–°å¢ä¿è´¹æ”¶å…¥1.2äº¿å…ƒ
   - å“ç‰Œä»·å€¼æå‡ï¼šNPSè¯„åˆ†æå‡å¸¦æ¥å“ç‰Œæº¢ä»·ï¼Œä¼°ç®—ä»·å€¼8000ä¸‡å…ƒ/å¹´
   - **å¹´åº¦é—´æ¥æ”¶ç›Šåˆè®¡ï¼š20000ä¸‡å…ƒ**

3. **æŠ•èµ„å›æŠ¥**
   - é¡¹ç›®æ€»æŠ•èµ„ï¼š8000ä¸‡å…ƒï¼ˆå«AIæ¨¡å‹å¼€å‘ã€ç³»ç»Ÿé›†æˆã€ç¡¬ä»¶é‡‡è´­ç­‰ï¼‰
   - å¹´åº¦æ€»æ”¶ç›Šï¼š32300ä¸‡å…ƒ
   - **æŠ•èµ„å›æ”¶æœŸï¼š3ä¸ªæœˆ**
   - **3å¹´ROIï¼š1111%**

---

## 4. æ¡ˆä¾‹æ€»ç»“

é€šè¿‡ä¸¤ä¸ªä¼ä¸šçº§å·¥ä½œæµæ¡ˆä¾‹çš„å®æ–½ï¼Œæˆ‘ä»¬éªŒè¯äº†Workflow Engine Schemaåœ¨é‡‘èè¡Œä¸šçš„åº”ç”¨ä»·å€¼ï¼š

**å…±æ€§æˆåŠŸç»éªŒ**ï¼š

1. **æµç¨‹æ ‡å‡†åŒ–æ˜¯åŸºç¡€**ï¼šç³»ç»Ÿå®æ–½å‰å¿…é¡»å®Œæˆä¸šåŠ¡æµç¨‹æ ‡å‡†åŒ–ï¼Œæ¶ˆé™¤äººä¸ºå·®å¼‚
2. **è§„åˆ™å¼•æ“æ˜¯æ ¸å¿ƒ**ï¼šå¤æ‚ä¸šåŠ¡è§„åˆ™éœ€è¦å¯é…ç½®ã€å¯çƒ­æ›´æ–°çš„è§„åˆ™å¼•æ“æ”¯æ’‘
3. **ç”¨æˆ·ä½“éªŒæ˜¯å…³é”®**ï¼šç³»ç»Ÿæ˜“ç”¨æ€§ç›´æ¥å½±å“æ¨å¹¿æ•ˆæœï¼Œéœ€è¦å……åˆ†å¬å–ä¸€çº¿æ„è§
4. **æ•°æ®è´¨é‡æ˜¯ä¿éšœ**ï¼šä¸»æ•°æ®æ²»ç†éœ€è¦åŒæ­¥å¼€å±•ï¼Œç¡®ä¿ç³»ç»Ÿé—´æ•°æ®ä¸€è‡´æ€§
5. **æŒç»­ä¼˜åŒ–æ˜¯å¸¸æ€**ï¼šä¸Šçº¿åéœ€è¦æ ¹æ®è¿è¡Œæƒ…å†µæŒç»­ä¼˜åŒ–æµç¨‹å’Œè§„åˆ™

**æŠ€æœ¯é€‰å‹å»ºè®®**ï¼š

1. é«˜å¹¶å‘åœºæ™¯é€‰æ‹©æ”¯æŒæ°´å¹³æ‰©å±•çš„åˆ†å¸ƒå¼å·¥ä½œæµå¼•æ“
2. é‡‘èçº§åº”ç”¨éœ€è¦é€‰æ‹©æ”¯æŒå¼ºä¸€è‡´æ€§çš„äº‹åŠ¡æ¨¡å‹
3. å¤æ‚è§„åˆ™åœºæ™¯å»ºè®®é‡‡ç”¨DSLï¼ˆé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰å®šä¹‰ä¸šåŠ¡è§„åˆ™
4. ç›‘æ§è¿ç»´éœ€è¦æå‰è§„åˆ’ï¼Œå»ºç«‹å®Œå–„çš„å‘Šè­¦å’Œæ•…éšœæ¢å¤æœºåˆ¶

**åˆ›å»ºæ—¶é—´**ï¼š2025-01-21  
**æœ€åæ›´æ–°**ï¼š2025-02-15
