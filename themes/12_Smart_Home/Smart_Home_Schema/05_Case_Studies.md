# æ™ºæ…§å®¶å±…Schemaå®è·µæ¡ˆä¾‹

## ğŸ“‘ ç›®å½•

- [æ™ºæ…§å®¶å±…Schemaå®è·µæ¡ˆä¾‹](#æ™ºæ…§å®¶å±…schemaå®è·µæ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¡ˆä¾‹æ¦‚è¿°](#1-æ¡ˆä¾‹æ¦‚è¿°)
  - [2. æ¡ˆä¾‹1ï¼šæ™ºèƒ½ç…§æ˜æ§åˆ¶](#2-æ¡ˆä¾‹1æ™ºèƒ½ç…§æ˜æ§åˆ¶)
    - [2.1 åœºæ™¯æè¿°](#21-åœºæ™¯æè¿°)
    - [2.2 Schemaå®šä¹‰](#22-schemaå®šä¹‰)
  - [3. æ¡ˆä¾‹2ï¼šæ™ºèƒ½é—¨é”ç®¡ç†](#3-æ¡ˆä¾‹2æ™ºèƒ½é—¨é”ç®¡ç†)
    - [3.1 åœºæ™¯æè¿°](#31-åœºæ™¯æè¿°)
    - [3.2 Schemaå®šä¹‰](#32-schemaå®šä¹‰)
  - [4. æ¡ˆä¾‹3ï¼šæ™ºèƒ½ç©ºè°ƒæ§åˆ¶](#4-æ¡ˆä¾‹3æ™ºèƒ½ç©ºè°ƒæ§åˆ¶)
    - [4.1 åœºæ™¯æè¿°](#41-åœºæ™¯æè¿°)
    - [4.2 Schemaå®šä¹‰](#42-schemaå®šä¹‰)
  - [5. æ¡ˆä¾‹4ï¼šå›å®¶åœºæ™¯è”åŠ¨](#5-æ¡ˆä¾‹4å›å®¶åœºæ™¯è”åŠ¨)
    - [5.1 åœºæ™¯æè¿°](#51-åœºæ™¯æè¿°)
    - [5.2 Schemaå®šä¹‰](#52-schemaå®šä¹‰)
    - [5.3 å®ç°ä»£ç ](#53-å®ç°ä»£ç )
  - [6. æ¡ˆä¾‹5ï¼šç¡çœ åœºæ™¯è”åŠ¨](#6-æ¡ˆä¾‹5ç¡çœ åœºæ™¯è”åŠ¨)
    - [6.1 åœºæ™¯æè¿°](#61-åœºæ™¯æè¿°)
    - [6.2 Schemaå®šä¹‰](#62-schemaå®šä¹‰)
    - [6.3 å®ç°ä»£ç ](#63-å®ç°ä»£ç )
  - [7. æ¡ˆä¾‹6ï¼šèƒ½è€—ä¼˜åŒ–åœºæ™¯](#7-æ¡ˆä¾‹6èƒ½è€—ä¼˜åŒ–åœºæ™¯)
    - [7.1 åœºæ™¯æè¿°](#71-åœºæ™¯æè¿°)
    - [7.2 Schemaå®šä¹‰](#72-schemaå®šä¹‰)
    - [7.3 å®ç°ä»£ç ](#73-å®ç°ä»£ç )
  - [8. æ¡ˆä¾‹7ï¼šæ•…éšœè¯Šæ–­åœºæ™¯](#8-æ¡ˆä¾‹7æ•…éšœè¯Šæ–­åœºæ™¯)
    - [8.1 åœºæ™¯æè¿°](#81-åœºæ™¯æè¿°)
    - [8.2 Schemaå®šä¹‰](#82-schemaå®šä¹‰)
    - [8.3 å®ç°ä»£ç ](#83-å®ç°ä»£ç )
  - [9. æ¡ˆä¾‹8ï¼šæ™ºæ…§å®¶å±…æ•°æ®å­˜å‚¨ç³»ç»Ÿ](#9-æ¡ˆä¾‹8æ™ºæ…§å®¶å±…æ•°æ®å­˜å‚¨ç³»ç»Ÿ)
    - [9.1 åœºæ™¯æè¿°](#91-åœºæ™¯æè¿°)
    - [9.2 å®ç°ä»£ç ](#92-å®ç°ä»£ç )

---

## 1. æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›æ™ºæ…§å®¶å±…Schemaåœ¨å®é™…åº”ç”¨ä¸­çš„å®è·µæ¡ˆä¾‹ã€‚

---

## 2. æ¡ˆä¾‹1ï¼šæ™ºèƒ½ç…§æ˜æ§åˆ¶

### 2.1 åœºæ™¯æè¿°

**åº”ç”¨åœºæ™¯**ï¼š
ä½¿ç”¨Matteråè®®æ§åˆ¶æ™ºèƒ½ç¯å…‰ï¼Œå®ç°äº®åº¦è°ƒèŠ‚å’Œè‰²æ¸©æ§åˆ¶ã€‚

### 2.2 Schemaå®šä¹‰

**æ™ºèƒ½ç…§æ˜Schema**ï¼š

```json
{
  "device_id": "LIGHT001",
  "device_type": "ExtendedColorLight",
  "device_name": "å®¢å…ä¸»ç¯",
  "state": {
    "power": "On",
    "brightness": 80,
    "color_temperature": 4000,
    "color_rgb": {
      "red": 255,
      "green": 200,
      "blue": 150
    },
    "scene_mode": "Reading"
  },
  "location": {
    "room": "å®¢å…",
    "zone": "ä¸»åŒºåŸŸ"
  }
}
```

---

## 3. æ¡ˆä¾‹2ï¼šæ™ºèƒ½é—¨é”ç®¡ç†

### 3.1 åœºæ™¯æè¿°

**åº”ç”¨åœºæ™¯**ï¼š
ä½¿ç”¨Matteråè®®ç®¡ç†æ™ºèƒ½é—¨é”ï¼Œå®ç°è¿œç¨‹å¼€é”å’ŒçŠ¶æ€ç›‘æ§ã€‚

### 3.2 Schemaå®šä¹‰

**æ™ºèƒ½é—¨é”Schema**ï¼š

```json
{
  "device_id": "LOCK001",
  "device_type": "DoorLock",
  "device_name": "å‰é—¨æ™ºèƒ½é”",
  "state": {
    "power": "On",
    "battery_level": 85,
    "signal_strength": 90
  },
  "door_lock_state": {
    "lock_state": "Locked",
    "auto_lock_enabled": true,
    "auto_lock_delay": 30
  },
  "event_log": [
    {
      "event_type": "Lock",
      "event_time": "2025-01-21T10:30:00Z",
      "event_details": "ç”¨æˆ·é€šè¿‡æ‰‹æœºAPPé”å®š"
    }
  ]
}
```

---

## 4. æ¡ˆä¾‹3ï¼šæ™ºèƒ½ç©ºè°ƒæ§åˆ¶

### 4.1 åœºæ™¯æè¿°

**åº”ç”¨åœºæ™¯**ï¼š
ä½¿ç”¨Matteråè®®æ§åˆ¶æ™ºèƒ½ç©ºè°ƒï¼Œå®ç°æ¸©åº¦è°ƒèŠ‚å’Œæ¨¡å¼åˆ‡æ¢ã€‚

### 4.2 Schemaå®šä¹‰

**æ™ºèƒ½ç©ºè°ƒSchema**ï¼š

```json
{
  "device_id": "AC001",
  "device_type": "AirConditioner",
  "device_name": "å®¢å…ç©ºè°ƒ",
  "state": {
    "power": "On",
    "operation_mode": "Cool",
    "target_temperature": 26.0,
    "current_temperature": 28.5,
    "fan_speed": "Auto"
  },
  "energy_consumption": {
    "current_power": 1500.0,
    "daily_consumption": 12.5,
    "monthly_consumption": 375.0,
    "energy_rating": "A"
  }
}
```

---

## 5. æ¡ˆä¾‹4ï¼šå›å®¶åœºæ™¯è”åŠ¨

### 5.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
ç”¨æˆ·å¸Œæœ›å½“æ£€æµ‹åˆ°æœ‰äººå›å®¶æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œä¸€ç³»åˆ—è®¾å¤‡æ§åˆ¶æ“ä½œï¼Œ
åŒ…æ‹¬æ‰“å¼€ç¯å…‰ã€è°ƒèŠ‚ç©ºè°ƒæ¸©åº¦ã€æ’­æ”¾æ¬¢è¿éŸ³ä¹ç­‰ã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦å®æ—¶æ£€æµ‹è¿åŠ¨ä¼ æ„Ÿå™¨çŠ¶æ€å˜åŒ–
- éœ€è¦åè°ƒå¤šä¸ªè®¾å¤‡çš„æ§åˆ¶å‘½ä»¤
- éœ€è¦å¤„ç†è®¾å¤‡æ§åˆ¶å¤±è´¥çš„æƒ…å†µ
- éœ€è¦è®°å½•åœºæ™¯æ‰§è¡Œå†å²

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨åœºæ™¯è”åŠ¨ç³»ç»Ÿï¼Œå®šä¹‰å›å®¶åœºæ™¯çš„è§¦å‘æ¡ä»¶å’Œæ‰§è¡ŒåŠ¨ä½œï¼Œ
å½“è¿åŠ¨ä¼ æ„Ÿå™¨æ£€æµ‹åˆ°è¿åŠ¨æ—¶è‡ªåŠ¨è§¦å‘åœºæ™¯æ‰§è¡Œã€‚

### 5.2 Schemaå®šä¹‰

**å›å®¶åœºæ™¯Schema**ï¼š

```json
{
  "scene_id": "scene_home_arrival",
  "scene_name": "å›å®¶åœºæ™¯",
  "scene_description": "æ£€æµ‹åˆ°å›å®¶æ—¶è‡ªåŠ¨æ‰§è¡Œ",
  "enabled": true,
  "conditions": [
    {
      "device_id": "SENSOR001",
      "attribute": "motion_detected",
      "operator": "==",
      "value": true
    },
    {
      "device_id": "SENSOR001",
      "attribute": "location",
      "operator": "==",
      "value": "entrance"
    }
  ],
  "actions": [
    {
      "device_id": "LIGHT001",
      "command": "turn_on",
      "parameters": {
        "brightness": 80,
        "color_temperature": 4000
      }
    },
    {
      "device_id": "LIGHT002",
      "command": "turn_on",
      "parameters": {
        "brightness": 60
      }
    },
    {
      "device_id": "AC001",
      "command": "set_temperature",
      "parameters": {
        "temperature": 26,
        "mode": "Cool"
      }
    },
    {
      "device_id": "MUSIC001",
      "command": "play",
      "parameters": {
        "playlist": "welcome",
        "volume": 30
      }
    }
  ]
}
```

### 5.3 å®ç°ä»£ç 

**åœºæ™¯ç®¡ç†å™¨å®ç°**ï¼š

```python
from matter_to_zigbee_converter import MatterToZigbeeConverter
from smart_home_storage import SmartHomeStorage
from scene_manager import SceneManager, SmartHomeScene
import time

# åˆå§‹åŒ–å­˜å‚¨å’Œåœºæ™¯ç®¡ç†å™¨
storage = SmartHomeStorage("postgresql://user:pass@localhost/smarthome")
scene_manager = SceneManager(storage)

# åˆ›å»ºå›å®¶åœºæ™¯
scene_manager.create_scene(
    scene_id="scene_home_arrival",
    scene_name="å›å®¶åœºæ™¯",
    conditions=[
        {
            "device_id": "SENSOR001",
            "attribute": "motion_detected",
            "operator": "==",
            "value": True
        },
        {
            "device_id": "SENSOR001",
            "attribute": "location",
            "operator": "==",
            "value": "entrance"
        }
    ],
    actions=[
        {
            "device_id": "LIGHT001",
            "command": "turn_on",
            "parameters": {"brightness": 80, "color_temperature": 4000}
        },
        {
            "device_id": "LIGHT002",
            "command": "turn_on",
            "parameters": {"brightness": 60}
        },
        {
            "device_id": "AC001",
            "command": "set_temperature",
            "parameters": {"temperature": 26, "mode": "Cool"}
        },
        {
            "device_id": "MUSIC001",
            "command": "play",
            "parameters": {"playlist": "welcome", "volume": 30}
        }
    ]
)

# æ¨¡æ‹Ÿä¼ æ„Ÿå™¨çŠ¶æ€æ›´æ–°
def simulate_motion_detection():
    """æ¨¡æ‹Ÿè¿åŠ¨æ£€æµ‹"""
    # æ›´æ–°ä¼ æ„Ÿå™¨çŠ¶æ€
    scene_manager.update_device_state("SENSOR001", {
        "motion_detected": True,
        "location": "entrance",
        "timestamp": datetime.now().isoformat()
    })

    # åœºæ™¯ç®¡ç†å™¨ä¼šè‡ªåŠ¨æ£€æŸ¥å¹¶è§¦å‘åœºæ™¯

# æµ‹è¯•åœºæ™¯æ‰§è¡Œ
if __name__ == "__main__":
    simulate_motion_detection()
    time.sleep(1)

    # æŸ¥è¯¢åœºæ™¯æ‰§è¡Œå†å²
    executions = storage.get_scene_execution_statistics("scene_home_arrival", days=1)
    print(f"åœºæ™¯æ‰§è¡Œæ¬¡æ•°: {executions}")
```

---

## 6. æ¡ˆä¾‹5ï¼šç¡çœ åœºæ™¯è”åŠ¨

### 6.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
ç”¨æˆ·å¸Œæœ›æ™šä¸Š10ç‚¹åï¼Œå½“æ£€æµ‹åˆ°å§å®¤ç¯å…‰å…³é—­æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œç¡çœ åœºæ™¯ï¼Œ
åŒ…æ‹¬å…³é—­æ‰€æœ‰ç¯å…‰ã€è°ƒèŠ‚ç©ºè°ƒæ¸©åº¦ã€å¼€å¯å®‰é˜²ç³»ç»Ÿã€å…³é—­çª—å¸˜ç­‰ã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦åŸºäºæ—¶é—´æ¡ä»¶è§¦å‘
- éœ€è¦æ£€æµ‹å¤šä¸ªè®¾å¤‡çŠ¶æ€
- éœ€è¦å»¶è¿Ÿæ‰§è¡ŒæŸäº›åŠ¨ä½œ
- éœ€è¦å¤„ç†åœºæ™¯å†²çª

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨åœºæ™¯è”åŠ¨ç³»ç»Ÿï¼Œå®šä¹‰ç¡çœ åœºæ™¯çš„è§¦å‘æ¡ä»¶ï¼ˆæ—¶é—´+ç¯å…‰çŠ¶æ€ï¼‰ï¼Œ
å½“æ¡ä»¶æ»¡è¶³æ—¶è‡ªåŠ¨æ‰§è¡Œç¡çœ åœºæ™¯ã€‚

### 6.2 Schemaå®šä¹‰

**ç¡çœ åœºæ™¯Schema**ï¼š

```json
{
  "scene_id": "scene_sleep",
  "scene_name": "ç¡çœ åœºæ™¯",
  "scene_description": "æ™šä¸Š10ç‚¹åç¯å…‰å…³é—­æ—¶è‡ªåŠ¨æ‰§è¡Œ",
  "enabled": true,
  "conditions": [
    {
      "device_id": "TIME",
      "attribute": "hour",
      "operator": ">=",
      "value": 22
    },
    {
      "device_id": "LIGHT003",
      "attribute": "power",
      "operator": "==",
      "value": "Off"
    }
  ],
  "actions": [
    {
      "device_id": "LIGHT001",
      "command": "turn_off",
      "parameters": {}
    },
    {
      "device_id": "LIGHT002",
      "command": "turn_off",
      "parameters": {}
    },
    {
      "device_id": "AC001",
      "command": "set_temperature",
      "parameters": {
        "temperature": 24,
        "mode": "Auto"
      }
    },
    {
      "device_id": "CURTAIN001",
      "command": "close",
      "parameters": {}
    },
    {
      "device_id": "SECURITY001",
      "command": "arm",
      "parameters": {
        "mode": "Night"
      }
    }
  ]
}
```

### 6.3 å®ç°ä»£ç 

**ç¡çœ åœºæ™¯å®ç°**ï¼š

```python
from datetime import datetime, time

# åˆ›å»ºç¡çœ åœºæ™¯
scene_manager.create_scene(
    scene_id="scene_sleep",
    scene_name="ç¡çœ åœºæ™¯",
    conditions=[
        {
            "device_id": "TIME",
            "attribute": "hour",
            "operator": ">=",
            "value": 22
        },
        {
            "device_id": "LIGHT003",
            "attribute": "power",
            "operator": "==",
            "value": "Off"
        }
    ],
    actions=[
        {"device_id": "LIGHT001", "command": "turn_off", "parameters": {}},
        {"device_id": "LIGHT002", "command": "turn_off", "parameters": {}},
        {
            "device_id": "AC001",
            "command": "set_temperature",
            "parameters": {"temperature": 24, "mode": "Auto"}
        },
        {"device_id": "CURTAIN001", "command": "close", "parameters": {}},
        {
            "device_id": "SECURITY001",
            "command": "arm",
            "parameters": {"mode": "Night"}
        }
    ]
)

# æ—¶é—´æ¡ä»¶æ£€æŸ¥å‡½æ•°
def check_time_condition(hour_threshold: int) -> bool:
    """æ£€æŸ¥æ—¶é—´æ¡ä»¶"""
    current_hour = datetime.now().hour
    return current_hour >= hour_threshold

# æ¨¡æ‹Ÿç¯å…‰å…³é—­äº‹ä»¶
def simulate_bedroom_light_off():
    """æ¨¡æ‹Ÿå§å®¤ç¯å…‰å…³é—­"""
    current_hour = datetime.now().hour

    # æ›´æ–°ç¯å…‰çŠ¶æ€
    scene_manager.update_device_state("LIGHT003", {
        "power": "Off",
        "timestamp": datetime.now().isoformat()
    })

    # æ£€æŸ¥æ—¶é—´æ¡ä»¶
    if check_time_condition(22):
        # æ‰‹åŠ¨è§¦å‘ç¡çœ åœºæ™¯
        scene_manager.execute_scene("scene_sleep")
```

---

## 7. æ¡ˆä¾‹6ï¼šèƒ½è€—ä¼˜åŒ–åœºæ™¯

### 7.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
ç”¨æˆ·å¸Œæœ›æ ¹æ®å®æ—¶ç”µä»·å’Œèƒ½è€—æ•°æ®ï¼Œè‡ªåŠ¨ä¼˜åŒ–è®¾å¤‡è¿è¡Œç­–ç•¥ï¼Œ
åœ¨ç”µä»·é«˜å³°æ—¶æ®µé™ä½éå¿…è¦è®¾å¤‡çš„èƒ½è€—ï¼Œåœ¨ç”µä»·ä½è°·æ—¶æ®µå¢åŠ è®¾å¤‡è¿è¡Œã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦å®æ—¶è·å–ç”µä»·ä¿¡æ¯
- éœ€è¦è®¡ç®—è®¾å¤‡èƒ½è€—
- éœ€è¦ä¼˜åŒ–è®¾å¤‡è¿è¡Œç­–ç•¥
- éœ€è¦å¹³è¡¡èˆ’é€‚åº¦å’Œèƒ½è€—

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨è‡ªåŠ¨åŒ–è§„åˆ™ç³»ç»Ÿï¼Œå®šä¹‰åŸºäºç”µä»·çš„èƒ½è€—ä¼˜åŒ–è§„åˆ™ï¼Œ
è‡ªåŠ¨è°ƒæ•´è®¾å¤‡è¿è¡Œå‚æ•°ä»¥é™ä½èƒ½è€—æˆæœ¬ã€‚

### 7.2 Schemaå®šä¹‰

**èƒ½è€—ä¼˜åŒ–è§„åˆ™Schema**ï¼š

```json
{
  "rule_id": "rule_energy_optimization",
  "rule_name": "èƒ½è€—ä¼˜åŒ–è§„åˆ™",
  "rule_description": "æ ¹æ®ç”µä»·è‡ªåŠ¨ä¼˜åŒ–è®¾å¤‡èƒ½è€—",
  "enabled": true,
  "trigger_device_id": "PRICE001",
  "trigger_attribute": "price_level",
  "trigger_operator": ">",
  "trigger_value": 0.8,
  "actions": [
    {
      "device_id": "AC001",
      "command": "set_temperature",
      "parameters": {
        "temperature": 28,
        "mode": "Eco"
      }
    },
    {
      "device_id": "LIGHT001",
      "command": "set_brightness",
      "parameters": {
        "brightness": 50
      }
    },
    {
      "device_id": "WASHER001",
      "command": "delay_start",
      "parameters": {
        "delay_hours": 2
      }
    }
  ]
}
```

### 7.3 å®ç°ä»£ç 

**èƒ½è€—ä¼˜åŒ–å®ç°**ï¼š

```python
# åˆ›å»ºèƒ½è€—ä¼˜åŒ–è§„åˆ™
storage.store_automation_rule({
    "rule_id": "rule_energy_optimization",
    "rule_name": "èƒ½è€—ä¼˜åŒ–è§„åˆ™",
    "rule_description": "æ ¹æ®ç”µä»·è‡ªåŠ¨ä¼˜åŒ–è®¾å¤‡èƒ½è€—",
    "trigger_device_id": "PRICE001",
    "trigger_attribute": "price_level",
    "trigger_operator": ">",
    "trigger_value": 0.8,
    "actions": [
        {
            "device_id": "AC001",
            "command": "set_temperature",
            "parameters": {"temperature": 28, "mode": "Eco"}
        },
        {
            "device_id": "LIGHT001",
            "command": "set_brightness",
            "parameters": {"brightness": 50}
        },
        {
            "device_id": "WASHER001",
            "command": "delay_start",
            "parameters": {"delay_hours": 2}
        }
    ]
})

# æ¨¡æ‹Ÿç”µä»·æ›´æ–°
def simulate_price_update(price_level: float):
    """æ¨¡æ‹Ÿç”µä»·æ›´æ–°"""
    scene_manager.update_device_state("PRICE001", {
        "price_level": price_level,
        "timestamp": datetime.now().isoformat()
    })

    # æ£€æŸ¥è‡ªåŠ¨åŒ–è§„åˆ™
    # è§„åˆ™ç®¡ç†å™¨ä¼šè‡ªåŠ¨æ£€æŸ¥å¹¶æ‰§è¡Œè§„åˆ™

# æŸ¥è¯¢èƒ½è€—ç»Ÿè®¡
def get_energy_savings():
    """æŸ¥è¯¢èƒ½è€—èŠ‚çœç»Ÿè®¡"""
    # æŸ¥è¯¢ä¼˜åŒ–å‰åçš„èƒ½è€—å¯¹æ¯”
    before_optimization = storage.get_energy_consumption_by_room(days=7)
    # æ¨¡æ‹Ÿä¼˜åŒ–åçš„æ•°æ®
    after_optimization = storage.get_energy_consumption_by_room(days=7)

    savings = {}
    for room_data in before_optimization:
        room = room_data[0]
        before_consumption = room_data[1]
        # è®¡ç®—èŠ‚çœï¼ˆå‡è®¾ä¼˜åŒ–åé™ä½20%ï¼‰
        savings[room] = before_consumption * 0.2

    return savings
```

---

## 8. æ¡ˆä¾‹7ï¼šæ•…éšœè¯Šæ–­åœºæ™¯

### 8.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
ç³»ç»Ÿéœ€è¦è‡ªåŠ¨æ£€æµ‹è®¾å¤‡æ•…éšœï¼Œå½“æ£€æµ‹åˆ°è®¾å¤‡å¼‚å¸¸æ—¶ï¼Œ
è‡ªåŠ¨æ‰§è¡Œæ•…éšœè¯Šæ–­æµç¨‹ï¼Œè®°å½•æ•…éšœä¿¡æ¯ï¼Œå¹¶å°è¯•è‡ªåŠ¨æ¢å¤ã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦å®æ—¶ç›‘æ§è®¾å¤‡çŠ¶æ€
- éœ€è¦è¯†åˆ«å¼‚å¸¸æ¨¡å¼
- éœ€è¦æ•…éšœåˆ†ç±»å’Œè¯Šæ–­
- éœ€è¦è‡ªåŠ¨æ¢å¤ç­–ç•¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨è‡ªåŠ¨åŒ–è§„åˆ™ç³»ç»Ÿï¼Œå®šä¹‰æ•…éšœæ£€æµ‹è§„åˆ™ï¼Œ
å½“æ£€æµ‹åˆ°è®¾å¤‡å¼‚å¸¸æ—¶è‡ªåŠ¨è§¦å‘æ•…éšœè¯Šæ–­å’Œæ¢å¤æµç¨‹ã€‚

### 8.2 Schemaå®šä¹‰

**æ•…éšœæ£€æµ‹è§„åˆ™Schema**ï¼š

```json
{
  "rule_id": "rule_device_fault_detection",
  "rule_name": "è®¾å¤‡æ•…éšœæ£€æµ‹è§„åˆ™",
  "rule_description": "æ£€æµ‹è®¾å¤‡æ•…éšœå¹¶è‡ªåŠ¨è¯Šæ–­",
  "enabled": true,
  "trigger_device_id": "DEVICE_MONITOR",
  "trigger_attribute": "fault_detected",
  "trigger_operator": "==",
  "trigger_value": true,
  "actions": [
    {
      "device_id": "LOGGER001",
      "command": "log_fault",
      "parameters": {
        "severity": "High",
        "category": "DeviceFault"
      }
    },
    {
      "device_id": "DIAGNOSTIC001",
      "command": "run_diagnosis",
      "parameters": {
        "diagnosis_type": "Auto"
      }
    },
    {
      "device_id": "NOTIFICATION001",
      "command": "send_alert",
      "parameters": {
        "alert_type": "DeviceFault",
        "recipients": ["admin@example.com"]
      }
    }
  ]
}
```

### 8.3 å®ç°ä»£ç 

**æ•…éšœè¯Šæ–­å®ç°**ï¼š

```python
# åˆ›å»ºæ•…éšœæ£€æµ‹è§„åˆ™
storage.store_automation_rule({
    "rule_id": "rule_device_fault_detection",
    "rule_name": "è®¾å¤‡æ•…éšœæ£€æµ‹è§„åˆ™",
    "trigger_device_id": "DEVICE_MONITOR",
    "trigger_attribute": "fault_detected",
    "trigger_operator": "==",
    "trigger_value": True,
    "actions": [
        {
            "device_id": "LOGGER001",
            "command": "log_fault",
            "parameters": {"severity": "High", "category": "DeviceFault"}
        },
        {
            "device_id": "DIAGNOSTIC001",
            "command": "run_diagnosis",
            "parameters": {"diagnosis_type": "Auto"}
        },
        {
            "device_id": "NOTIFICATION001",
            "command": "send_alert",
            "parameters": {
                "alert_type": "DeviceFault",
                "recipients": ["admin@example.com"]
            }
        }
    ]
})

# è®¾å¤‡æ•…éšœæ£€æµ‹å‡½æ•°
def detect_device_fault(device_id: str, device_state: Dict) -> bool:
    """æ£€æµ‹è®¾å¤‡æ•…éšœ"""
    # æ£€æŸ¥è®¾å¤‡çŠ¶æ€å¼‚å¸¸
    if device_state.get("status") == "Error":
        return True

    # æ£€æŸ¥è®¾å¤‡å“åº”è¶…æ—¶
    last_update = device_state.get("last_update")
    if last_update:
        time_diff = (datetime.now() - datetime.fromisoformat(last_update)).total_seconds()
        if time_diff > 300:  # 5åˆ†é’Ÿæ— å“åº”
            return True

    # æ£€æŸ¥è®¾å¤‡å‚æ•°å¼‚å¸¸
    if device_state.get("temperature", 0) > 80:  # æ¸©åº¦è¿‡é«˜
        return True

    return False

# æ¨¡æ‹Ÿæ•…éšœæ£€æµ‹
def monitor_devices():
    """ç›‘æ§è®¾å¤‡çŠ¶æ€"""
    devices = storage.get_all_devices()

    for device in devices:
        device_id = device["device_id"]
        device_state = storage.get_device_state(device_id)

        if detect_device_fault(device_id, device_state):
            # è§¦å‘æ•…éšœæ£€æµ‹è§„åˆ™
            scene_manager.update_device_state("DEVICE_MONITOR", {
                "fault_detected": True,
                "fault_device_id": device_id,
                "fault_type": "DeviceError",
                "timestamp": datetime.now().isoformat()
            })
```

---

## 9. æ¡ˆä¾‹8ï¼šæ™ºæ…§å®¶å±…æ•°æ®å­˜å‚¨ç³»ç»Ÿ

### 9.1 åœºæ™¯æè¿°

**åº”ç”¨åœºæ™¯**ï¼š
ä½¿ç”¨PostgreSQLå­˜å‚¨æ™ºæ…§å®¶å±…è®¾å¤‡æ•°æ®ï¼Œæ”¯æŒè®¾å¤‡çŠ¶æ€æŸ¥è¯¢ã€
èƒ½è€—åˆ†æã€åœºæ™¯æ‰§è¡Œç»Ÿè®¡ç­‰åŠŸèƒ½ã€‚

### 9.2 å®ç°ä»£ç 

è¯¦è§ `04_Transformation.md` ç¬¬7ç« ã€‚

---

**å‚è€ƒæ–‡æ¡£**ï¼š

- `01_Overview.md` - æ¦‚è¿°
- `02_Formal_Definition.md` - å½¢å¼åŒ–å®šä¹‰
- `03_Standards.md` - æ ‡å‡†å¯¹æ ‡
- `04_Transformation.md` - è½¬æ¢ä½“ç³»

**åˆ›å»ºæ—¶é—´**ï¼š2025-01-21
**æœ€åæ›´æ–°**ï¼š2025-01-21
