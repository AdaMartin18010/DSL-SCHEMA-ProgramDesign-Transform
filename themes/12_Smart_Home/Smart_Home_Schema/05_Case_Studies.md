# æ™ºæ…§å®¶å±…Schemaå®è·µæ¡ˆä¾‹

## ğŸ“‘ ç›®å½•

- [æ™ºæ…§å®¶å±…Schemaå®è·µæ¡ˆä¾‹](#æ™ºæ…§å®¶å±…schemaå®è·µæ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¡ˆä¾‹æ¦‚è¿°](#1-æ¡ˆä¾‹æ¦‚è¿°)
  - [2. æ¡ˆä¾‹1ï¼šæ™ºèƒ½ç…§æ˜æ§åˆ¶](#2-æ¡ˆä¾‹1æ™ºèƒ½ç…§æ˜æ§åˆ¶)
    - [2.1 åœºæ™¯æè¿°](#21-åœºæ™¯æè¿°)
    - [2.2 Schemaå®šä¹‰](#22-schemaå®šä¹‰)
  - [3. æ¡ˆä¾‹2ï¼šæ™ºèƒ½é—¨é”ç®¡ç†](#3-æ¡ˆä¾‹2æ™ºèƒ½é—¨é”ç®¡ç†)
    - [3.1 åœºæ™¯æè¿°](#31-åœºæ™¯æè¿°)
    - [3.2 Schemaå®šä¹‰](#32-schemaå®šä¹‰)
  - [4. æ¡ˆä¾‹3ï¼šæ™ºèƒ½ç©ºè°ƒæ§åˆ¶](#4-æ¡ˆä¾‹3æ™ºèƒ½ç©ºè°ƒæ§åˆ¶)
    - [4.1 åœºæ™¯æè¿°](#41-åœºæ™¯æè¿°)
    - [4.2 Schemaå®šä¹‰](#42-schemaå®šä¹‰)
  - [5. æ¡ˆä¾‹4ï¼šå›å®¶åœºæ™¯è”åŠ¨](#5-æ¡ˆä¾‹4å›å®¶åœºæ™¯è”åŠ¨)
    - [5.1 åœºæ™¯æè¿°](#51-åœºæ™¯æè¿°)
    - [5.2 Schemaå®šä¹‰](#52-schemaå®šä¹‰)
    - [5.3 å®ç°ä»£ç ](#53-å®ç°ä»£ç )
  - [6. æ¡ˆä¾‹5ï¼šç¡çœ åœºæ™¯è”åŠ¨](#6-æ¡ˆä¾‹5ç¡çœ åœºæ™¯è”åŠ¨)
    - [6.1 åœºæ™¯æè¿°](#61-åœºæ™¯æè¿°)
    - [6.2 Schemaå®šä¹‰](#62-schemaå®šä¹‰)
    - [6.3 å®ç°ä»£ç ](#63-å®ç°ä»£ç )
  - [7. æ¡ˆä¾‹6ï¼šèƒ½è€—ä¼˜åŒ–åœºæ™¯](#7-æ¡ˆä¾‹6èƒ½è€—ä¼˜åŒ–åœºæ™¯)
    - [7.1 åœºæ™¯æè¿°](#71-åœºæ™¯æè¿°)
    - [7.2 Schemaå®šä¹‰](#72-schemaå®šä¹‰)
    - [7.3 å®ç°ä»£ç ](#73-å®ç°ä»£ç )
  - [8. æ¡ˆä¾‹7ï¼šæ•…éšœè¯Šæ–­åœºæ™¯](#8-æ¡ˆä¾‹7æ•…éšœè¯Šæ–­åœºæ™¯)
    - [8.1 åœºæ™¯æè¿°](#81-åœºæ™¯æè¿°)
    - [8.2 Schemaå®šä¹‰](#82-schemaå®šä¹‰)
    - [8.3 å®ç°ä»£ç ](#83-å®ç°ä»£ç )
  - [8. æ¡ˆä¾‹8ï¼šç¦»å®¶åœºæ™¯ï¼ˆå®‰é˜²ã€èƒ½è€—ç®¡ç†ï¼‰](#8-æ¡ˆä¾‹8ç¦»å®¶åœºæ™¯å®‰é˜²èƒ½è€—ç®¡ç†)
    - [8.1 åœºæ™¯æè¿°](#81-åœºæ™¯æè¿°-1)
    - [8.2 Schemaå®šä¹‰](#82-schemaå®šä¹‰-1)
    - [8.3 å®ç°ä»£ç ](#83-å®ç°ä»£ç -1)
  - [9. æ¡ˆä¾‹9ï¼šæ™ºæ…§å®¶å±…æ•°æ®å­˜å‚¨ç³»ç»Ÿ](#9-æ¡ˆä¾‹9æ™ºæ…§å®¶å±…æ•°æ®å­˜å‚¨ç³»ç»Ÿ)
    - [9.1 åœºæ™¯æè¿°](#91-åœºæ™¯æè¿°)
    - [9.2 å®ç°ä»£ç ](#92-å®ç°ä»£ç )
  - [10. æ¡ˆä¾‹10ï¼šæ™ºèƒ½å®‰é˜²ç³»ç»Ÿ](#10-æ¡ˆä¾‹10æ™ºèƒ½å®‰é˜²ç³»ç»Ÿ)
    - [10.1 åœºæ™¯æè¿°](#101-åœºæ™¯æè¿°)
    - [10.2 Schemaå®šä¹‰](#102-schemaå®šä¹‰)
    - [10.3 å®ç°ä»£ç ](#103-å®ç°ä»£ç )
  - [11. æ¡ˆä¾‹11ï¼šæ™ºèƒ½å¥åº·ç›‘æµ‹ç³»ç»Ÿ](#11-æ¡ˆä¾‹11æ™ºèƒ½å¥åº·ç›‘æµ‹ç³»ç»Ÿ)
    - [11.1 åœºæ™¯æè¿°](#111-åœºæ™¯æè¿°)
    - [11.2 Schemaå®šä¹‰](#112-schemaå®šä¹‰)
    - [11.3 å®ç°ä»£ç ](#113-å®ç°ä»£ç )

---

## 1. æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›æ™ºæ…§å®¶å±…Schemaåœ¨å®é™…åº”ç”¨ä¸­çš„å®è·µæ¡ˆä¾‹ã€‚

---

## 2. æ¡ˆä¾‹1ï¼šæ™ºèƒ½ç…§æ˜æ§åˆ¶

### 2.1 åœºæ™¯æè¿°

**åº”ç”¨åœºæ™¯**ï¼š
ä½¿ç”¨Matteråè®®æ§åˆ¶æ™ºèƒ½ç¯å…‰ï¼Œå®ç°äº®åº¦è°ƒèŠ‚å’Œè‰²æ¸©æ§åˆ¶ã€‚

### 2.2 Schemaå®šä¹‰

**æ™ºèƒ½ç…§æ˜Schema**ï¼š

```json
{
  "device_id": "LIGHT001",
  "device_type": "ExtendedColorLight",
  "device_name": "å®¢å…ä¸»ç¯",
  "state": {
    "power": "On",
    "brightness": 80,
    "color_temperature": 4000,
    "color_rgb": {
      "red": 255,
      "green": 200,
      "blue": 150
    },
    "scene_mode": "Reading"
  },
  "location": {
    "room": "å®¢å…",
    "zone": "ä¸»åŒºåŸŸ"
  }
}
```

---

## 3. æ¡ˆä¾‹2ï¼šæ™ºèƒ½é—¨é”ç®¡ç†

### 3.1 åœºæ™¯æè¿°

**åº”ç”¨åœºæ™¯**ï¼š
ä½¿ç”¨Matteråè®®ç®¡ç†æ™ºèƒ½é—¨é”ï¼Œå®ç°è¿œç¨‹å¼€é”å’ŒçŠ¶æ€ç›‘æ§ã€‚

### 3.2 Schemaå®šä¹‰

**æ™ºèƒ½é—¨é”Schema**ï¼š

```json
{
  "device_id": "LOCK001",
  "device_type": "DoorLock",
  "device_name": "å‰é—¨æ™ºèƒ½é”",
  "state": {
    "power": "On",
    "battery_level": 85,
    "signal_strength": 90
  },
  "door_lock_state": {
    "lock_state": "Locked",
    "auto_lock_enabled": true,
    "auto_lock_delay": 30
  },
  "event_log": [
    {
      "event_type": "Lock",
      "event_time": "2025-01-21T10:30:00Z",
      "event_details": "ç”¨æˆ·é€šè¿‡æ‰‹æœºAPPé”å®š"
    }
  ]
}
```

---

## 4. æ¡ˆä¾‹3ï¼šæ™ºèƒ½ç©ºè°ƒæ§åˆ¶

### 4.1 åœºæ™¯æè¿°

**åº”ç”¨åœºæ™¯**ï¼š
ä½¿ç”¨Matteråè®®æ§åˆ¶æ™ºèƒ½ç©ºè°ƒï¼Œå®ç°æ¸©åº¦è°ƒèŠ‚å’Œæ¨¡å¼åˆ‡æ¢ã€‚

### 4.2 Schemaå®šä¹‰

**æ™ºèƒ½ç©ºè°ƒSchema**ï¼š

```json
{
  "device_id": "AC001",
  "device_type": "AirConditioner",
  "device_name": "å®¢å…ç©ºè°ƒ",
  "state": {
    "power": "On",
    "operation_mode": "Cool",
    "target_temperature": 26.0,
    "current_temperature": 28.5,
    "fan_speed": "Auto"
  },
  "energy_consumption": {
    "current_power": 1500.0,
    "daily_consumption": 12.5,
    "monthly_consumption": 375.0,
    "energy_rating": "A"
  }
}
```

---

## 5. æ¡ˆä¾‹4ï¼šå›å®¶åœºæ™¯è”åŠ¨

### 5.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
ç”¨æˆ·å¸Œæœ›å½“æ£€æµ‹åˆ°æœ‰äººå›å®¶æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œä¸€ç³»åˆ—è®¾å¤‡æ§åˆ¶æ“ä½œï¼Œ
åŒ…æ‹¬æ‰“å¼€ç¯å…‰ã€è°ƒèŠ‚ç©ºè°ƒæ¸©åº¦ã€æ’­æ”¾æ¬¢è¿éŸ³ä¹ç­‰ã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦å®æ—¶æ£€æµ‹è¿åŠ¨ä¼ æ„Ÿå™¨çŠ¶æ€å˜åŒ–
- éœ€è¦åè°ƒå¤šä¸ªè®¾å¤‡çš„æ§åˆ¶å‘½ä»¤
- éœ€è¦å¤„ç†è®¾å¤‡æ§åˆ¶å¤±è´¥çš„æƒ…å†µ
- éœ€è¦è®°å½•åœºæ™¯æ‰§è¡Œå†å²

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨åœºæ™¯è”åŠ¨ç³»ç»Ÿï¼Œå®šä¹‰å›å®¶åœºæ™¯çš„è§¦å‘æ¡ä»¶å’Œæ‰§è¡ŒåŠ¨ä½œï¼Œ
å½“è¿åŠ¨ä¼ æ„Ÿå™¨æ£€æµ‹åˆ°è¿åŠ¨æ—¶è‡ªåŠ¨è§¦å‘åœºæ™¯æ‰§è¡Œã€‚

### 5.2 Schemaå®šä¹‰

**å›å®¶åœºæ™¯Schema**ï¼š

```json
{
  "scene_id": "scene_home_arrival",
  "scene_name": "å›å®¶åœºæ™¯",
  "scene_description": "æ£€æµ‹åˆ°å›å®¶æ—¶è‡ªåŠ¨æ‰§è¡Œ",
  "enabled": true,
  "conditions": [
    {
      "device_id": "SENSOR001",
      "attribute": "motion_detected",
      "operator": "==",
      "value": true
    },
    {
      "device_id": "SENSOR001",
      "attribute": "location",
      "operator": "==",
      "value": "entrance"
    }
  ],
  "actions": [
    {
      "device_id": "LIGHT001",
      "command": "turn_on",
      "parameters": {
        "brightness": 80,
        "color_temperature": 4000
      }
    },
    {
      "device_id": "LIGHT002",
      "command": "turn_on",
      "parameters": {
        "brightness": 60
      }
    },
    {
      "device_id": "AC001",
      "command": "set_temperature",
      "parameters": {
        "temperature": 26,
        "mode": "Cool"
      }
    },
    {
      "device_id": "MUSIC001",
      "command": "play",
      "parameters": {
        "playlist": "welcome",
        "volume": 30
      }
    }
  ]
}
```

### 5.3 å®ç°ä»£ç 

**åœºæ™¯ç®¡ç†å™¨å®ç°**ï¼š

```python
from matter_to_zigbee_converter import MatterToZigbeeConverter
from smart_home_storage import SmartHomeStorage
from scene_manager import SceneManager, SmartHomeScene
import time

# åˆå§‹åŒ–å­˜å‚¨å’Œåœºæ™¯ç®¡ç†å™¨
storage = SmartHomeStorage("postgresql://user:pass@localhost/smarthome")
scene_manager = SceneManager(storage)

# åˆ›å»ºå›å®¶åœºæ™¯
scene_manager.create_scene(
    scene_id="scene_home_arrival",
    scene_name="å›å®¶åœºæ™¯",
    conditions=[
        {
            "device_id": "SENSOR001",
            "attribute": "motion_detected",
            "operator": "==",
            "value": True
        },
        {
            "device_id": "SENSOR001",
            "attribute": "location",
            "operator": "==",
            "value": "entrance"
        }
    ],
    actions=[
        {
            "device_id": "LIGHT001",
            "command": "turn_on",
            "parameters": {"brightness": 80, "color_temperature": 4000}
        },
        {
            "device_id": "LIGHT002",
            "command": "turn_on",
            "parameters": {"brightness": 60}
        },
        {
            "device_id": "AC001",
            "command": "set_temperature",
            "parameters": {"temperature": 26, "mode": "Cool"}
        },
        {
            "device_id": "MUSIC001",
            "command": "play",
            "parameters": {"playlist": "welcome", "volume": 30}
        }
    ]
)

# æ¨¡æ‹Ÿä¼ æ„Ÿå™¨çŠ¶æ€æ›´æ–°
def simulate_motion_detection():
    """æ¨¡æ‹Ÿè¿åŠ¨æ£€æµ‹"""
    # æ›´æ–°ä¼ æ„Ÿå™¨çŠ¶æ€
    scene_manager.update_device_state("SENSOR001", {
        "motion_detected": True,
        "location": "entrance",
        "timestamp": datetime.now().isoformat()
    })

    # åœºæ™¯ç®¡ç†å™¨ä¼šè‡ªåŠ¨æ£€æŸ¥å¹¶è§¦å‘åœºæ™¯

# æµ‹è¯•åœºæ™¯æ‰§è¡Œ
if __name__ == "__main__":
    simulate_motion_detection()
    time.sleep(1)

    # æŸ¥è¯¢åœºæ™¯æ‰§è¡Œå†å²
    executions = storage.get_scene_execution_statistics("scene_home_arrival", days=1)
    print(f"åœºæ™¯æ‰§è¡Œæ¬¡æ•°: {executions}")
```

---

## 6. æ¡ˆä¾‹5ï¼šç¡çœ åœºæ™¯è”åŠ¨

### 6.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
ç”¨æˆ·å¸Œæœ›æ™šä¸Š10ç‚¹åï¼Œå½“æ£€æµ‹åˆ°å§å®¤ç¯å…‰å…³é—­æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œç¡çœ åœºæ™¯ï¼Œ
åŒ…æ‹¬å…³é—­æ‰€æœ‰ç¯å…‰ã€è°ƒèŠ‚ç©ºè°ƒæ¸©åº¦ã€å¼€å¯å®‰é˜²ç³»ç»Ÿã€å…³é—­çª—å¸˜ç­‰ã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦åŸºäºæ—¶é—´æ¡ä»¶è§¦å‘
- éœ€è¦æ£€æµ‹å¤šä¸ªè®¾å¤‡çŠ¶æ€
- éœ€è¦å»¶è¿Ÿæ‰§è¡ŒæŸäº›åŠ¨ä½œ
- éœ€è¦å¤„ç†åœºæ™¯å†²çª

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨åœºæ™¯è”åŠ¨ç³»ç»Ÿï¼Œå®šä¹‰ç¡çœ åœºæ™¯çš„è§¦å‘æ¡ä»¶ï¼ˆæ—¶é—´+ç¯å…‰çŠ¶æ€ï¼‰ï¼Œ
å½“æ¡ä»¶æ»¡è¶³æ—¶è‡ªåŠ¨æ‰§è¡Œç¡çœ åœºæ™¯ã€‚

### 6.2 Schemaå®šä¹‰

**ç¡çœ åœºæ™¯Schema**ï¼š

```json
{
  "scene_id": "scene_sleep",
  "scene_name": "ç¡çœ åœºæ™¯",
  "scene_description": "æ™šä¸Š10ç‚¹åç¯å…‰å…³é—­æ—¶è‡ªåŠ¨æ‰§è¡Œ",
  "enabled": true,
  "conditions": [
    {
      "device_id": "TIME",
      "attribute": "hour",
      "operator": ">=",
      "value": 22
    },
    {
      "device_id": "LIGHT003",
      "attribute": "power",
      "operator": "==",
      "value": "Off"
    }
  ],
  "actions": [
    {
      "device_id": "LIGHT001",
      "command": "turn_off",
      "parameters": {}
    },
    {
      "device_id": "LIGHT002",
      "command": "turn_off",
      "parameters": {}
    },
    {
      "device_id": "AC001",
      "command": "set_temperature",
      "parameters": {
        "temperature": 24,
        "mode": "Auto"
      }
    },
    {
      "device_id": "CURTAIN001",
      "command": "close",
      "parameters": {}
    },
    {
      "device_id": "SECURITY001",
      "command": "arm",
      "parameters": {
        "mode": "Night"
      }
    }
  ]
}
```

### 6.3 å®ç°ä»£ç 

**ç¡çœ åœºæ™¯å®ç°**ï¼š

```python
from datetime import datetime, time

# åˆ›å»ºç¡çœ åœºæ™¯
scene_manager.create_scene(
    scene_id="scene_sleep",
    scene_name="ç¡çœ åœºæ™¯",
    conditions=[
        {
            "device_id": "TIME",
            "attribute": "hour",
            "operator": ">=",
            "value": 22
        },
        {
            "device_id": "LIGHT003",
            "attribute": "power",
            "operator": "==",
            "value": "Off"
        }
    ],
    actions=[
        {"device_id": "LIGHT001", "command": "turn_off", "parameters": {}},
        {"device_id": "LIGHT002", "command": "turn_off", "parameters": {}},
        {
            "device_id": "AC001",
            "command": "set_temperature",
            "parameters": {"temperature": 24, "mode": "Auto"}
        },
        {"device_id": "CURTAIN001", "command": "close", "parameters": {}},
        {
            "device_id": "SECURITY001",
            "command": "arm",
            "parameters": {"mode": "Night"}
        }
    ]
)

# æ—¶é—´æ¡ä»¶æ£€æŸ¥å‡½æ•°
def check_time_condition(hour_threshold: int) -> bool:
    """æ£€æŸ¥æ—¶é—´æ¡ä»¶"""
    current_hour = datetime.now().hour
    return current_hour >= hour_threshold

# æ¨¡æ‹Ÿç¯å…‰å…³é—­äº‹ä»¶
def simulate_bedroom_light_off():
    """æ¨¡æ‹Ÿå§å®¤ç¯å…‰å…³é—­"""
    current_hour = datetime.now().hour

    # æ›´æ–°ç¯å…‰çŠ¶æ€
    scene_manager.update_device_state("LIGHT003", {
        "power": "Off",
        "timestamp": datetime.now().isoformat()
    })

    # æ£€æŸ¥æ—¶é—´æ¡ä»¶
    if check_time_condition(22):
        # æ‰‹åŠ¨è§¦å‘ç¡çœ åœºæ™¯
        scene_manager.execute_scene("scene_sleep")
```

---

## 7. æ¡ˆä¾‹6ï¼šèƒ½è€—ä¼˜åŒ–åœºæ™¯

### 7.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
ç”¨æˆ·å¸Œæœ›æ ¹æ®å®æ—¶ç”µä»·å’Œèƒ½è€—æ•°æ®ï¼Œè‡ªåŠ¨ä¼˜åŒ–è®¾å¤‡è¿è¡Œç­–ç•¥ï¼Œ
åœ¨ç”µä»·é«˜å³°æ—¶æ®µé™ä½éå¿…è¦è®¾å¤‡çš„èƒ½è€—ï¼Œåœ¨ç”µä»·ä½è°·æ—¶æ®µå¢åŠ è®¾å¤‡è¿è¡Œã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦å®æ—¶è·å–ç”µä»·ä¿¡æ¯
- éœ€è¦è®¡ç®—è®¾å¤‡èƒ½è€—
- éœ€è¦ä¼˜åŒ–è®¾å¤‡è¿è¡Œç­–ç•¥
- éœ€è¦å¹³è¡¡èˆ’é€‚åº¦å’Œèƒ½è€—

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨è‡ªåŠ¨åŒ–è§„åˆ™ç³»ç»Ÿï¼Œå®šä¹‰åŸºäºç”µä»·çš„èƒ½è€—ä¼˜åŒ–è§„åˆ™ï¼Œ
è‡ªåŠ¨è°ƒæ•´è®¾å¤‡è¿è¡Œå‚æ•°ä»¥é™ä½èƒ½è€—æˆæœ¬ã€‚

### 7.2 Schemaå®šä¹‰

**èƒ½è€—ä¼˜åŒ–è§„åˆ™Schema**ï¼š

```json
{
  "rule_id": "rule_energy_optimization",
  "rule_name": "èƒ½è€—ä¼˜åŒ–è§„åˆ™",
  "rule_description": "æ ¹æ®ç”µä»·è‡ªåŠ¨ä¼˜åŒ–è®¾å¤‡èƒ½è€—",
  "enabled": true,
  "trigger_device_id": "PRICE001",
  "trigger_attribute": "price_level",
  "trigger_operator": ">",
  "trigger_value": 0.8,
  "actions": [
    {
      "device_id": "AC001",
      "command": "set_temperature",
      "parameters": {
        "temperature": 28,
        "mode": "Eco"
      }
    },
    {
      "device_id": "LIGHT001",
      "command": "set_brightness",
      "parameters": {
        "brightness": 50
      }
    },
    {
      "device_id": "WASHER001",
      "command": "delay_start",
      "parameters": {
        "delay_hours": 2
      }
    }
  ]
}
```

### 7.3 å®ç°ä»£ç 

**èƒ½è€—ä¼˜åŒ–å®ç°**ï¼š

```python
# åˆ›å»ºèƒ½è€—ä¼˜åŒ–è§„åˆ™
storage.store_automation_rule({
    "rule_id": "rule_energy_optimization",
    "rule_name": "èƒ½è€—ä¼˜åŒ–è§„åˆ™",
    "rule_description": "æ ¹æ®ç”µä»·è‡ªåŠ¨ä¼˜åŒ–è®¾å¤‡èƒ½è€—",
    "trigger_device_id": "PRICE001",
    "trigger_attribute": "price_level",
    "trigger_operator": ">",
    "trigger_value": 0.8,
    "actions": [
        {
            "device_id": "AC001",
            "command": "set_temperature",
            "parameters": {"temperature": 28, "mode": "Eco"}
        },
        {
            "device_id": "LIGHT001",
            "command": "set_brightness",
            "parameters": {"brightness": 50}
        },
        {
            "device_id": "WASHER001",
            "command": "delay_start",
            "parameters": {"delay_hours": 2}
        }
    ]
})

# æ¨¡æ‹Ÿç”µä»·æ›´æ–°
def simulate_price_update(price_level: float):
    """æ¨¡æ‹Ÿç”µä»·æ›´æ–°"""
    scene_manager.update_device_state("PRICE001", {
        "price_level": price_level,
        "timestamp": datetime.now().isoformat()
    })

    # æ£€æŸ¥è‡ªåŠ¨åŒ–è§„åˆ™
    # è§„åˆ™ç®¡ç†å™¨ä¼šè‡ªåŠ¨æ£€æŸ¥å¹¶æ‰§è¡Œè§„åˆ™

# æŸ¥è¯¢èƒ½è€—ç»Ÿè®¡
def get_energy_savings():
    """æŸ¥è¯¢èƒ½è€—èŠ‚çœç»Ÿè®¡"""
    # æŸ¥è¯¢ä¼˜åŒ–å‰åçš„èƒ½è€—å¯¹æ¯”
    before_optimization = storage.get_energy_consumption_by_room(days=7)
    # æ¨¡æ‹Ÿä¼˜åŒ–åçš„æ•°æ®
    after_optimization = storage.get_energy_consumption_by_room(days=7)

    savings = {}
    for room_data in before_optimization:
        room = room_data[0]
        before_consumption = room_data[1]
        # è®¡ç®—èŠ‚çœï¼ˆå‡è®¾ä¼˜åŒ–åé™ä½20%ï¼‰
        savings[room] = before_consumption * 0.2

    return savings
```

---

## 8. æ¡ˆä¾‹7ï¼šæ•…éšœè¯Šæ–­åœºæ™¯

### 8.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
ç³»ç»Ÿéœ€è¦è‡ªåŠ¨æ£€æµ‹è®¾å¤‡æ•…éšœï¼Œå½“æ£€æµ‹åˆ°è®¾å¤‡å¼‚å¸¸æ—¶ï¼Œ
è‡ªåŠ¨æ‰§è¡Œæ•…éšœè¯Šæ–­æµç¨‹ï¼Œè®°å½•æ•…éšœä¿¡æ¯ï¼Œå¹¶å°è¯•è‡ªåŠ¨æ¢å¤ã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦å®æ—¶ç›‘æ§è®¾å¤‡çŠ¶æ€
- éœ€è¦è¯†åˆ«å¼‚å¸¸æ¨¡å¼
- éœ€è¦æ•…éšœåˆ†ç±»å’Œè¯Šæ–­
- éœ€è¦è‡ªåŠ¨æ¢å¤ç­–ç•¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨è‡ªåŠ¨åŒ–è§„åˆ™ç³»ç»Ÿï¼Œå®šä¹‰æ•…éšœæ£€æµ‹è§„åˆ™ï¼Œ
å½“æ£€æµ‹åˆ°è®¾å¤‡å¼‚å¸¸æ—¶è‡ªåŠ¨è§¦å‘æ•…éšœè¯Šæ–­å’Œæ¢å¤æµç¨‹ã€‚

### 8.2 Schemaå®šä¹‰

**æ•…éšœæ£€æµ‹è§„åˆ™Schema**ï¼š

```json
{
  "rule_id": "rule_device_fault_detection",
  "rule_name": "è®¾å¤‡æ•…éšœæ£€æµ‹è§„åˆ™",
  "rule_description": "æ£€æµ‹è®¾å¤‡æ•…éšœå¹¶è‡ªåŠ¨è¯Šæ–­",
  "enabled": true,
  "trigger_device_id": "DEVICE_MONITOR",
  "trigger_attribute": "fault_detected",
  "trigger_operator": "==",
  "trigger_value": true,
  "actions": [
    {
      "device_id": "LOGGER001",
      "command": "log_fault",
      "parameters": {
        "severity": "High",
        "category": "DeviceFault"
      }
    },
    {
      "device_id": "DIAGNOSTIC001",
      "command": "run_diagnosis",
      "parameters": {
        "diagnosis_type": "Auto"
      }
    },
    {
      "device_id": "NOTIFICATION001",
      "command": "send_alert",
      "parameters": {
        "alert_type": "DeviceFault",
        "recipients": ["admin@example.com"]
      }
    }
  ]
}
```

### 8.3 å®ç°ä»£ç 

**æ•…éšœè¯Šæ–­å®ç°**ï¼š

```python
# åˆ›å»ºæ•…éšœæ£€æµ‹è§„åˆ™
storage.store_automation_rule({
    "rule_id": "rule_device_fault_detection",
    "rule_name": "è®¾å¤‡æ•…éšœæ£€æµ‹è§„åˆ™",
    "trigger_device_id": "DEVICE_MONITOR",
    "trigger_attribute": "fault_detected",
    "trigger_operator": "==",
    "trigger_value": True,
    "actions": [
        {
            "device_id": "LOGGER001",
            "command": "log_fault",
            "parameters": {"severity": "High", "category": "DeviceFault"}
        },
        {
            "device_id": "DIAGNOSTIC001",
            "command": "run_diagnosis",
            "parameters": {"diagnosis_type": "Auto"}
        },
        {
            "device_id": "NOTIFICATION001",
            "command": "send_alert",
            "parameters": {
                "alert_type": "DeviceFault",
                "recipients": ["admin@example.com"]
            }
        }
    ]
})

# è®¾å¤‡æ•…éšœæ£€æµ‹å‡½æ•°
def detect_device_fault(device_id: str, device_state: Dict) -> bool:
    """æ£€æµ‹è®¾å¤‡æ•…éšœ"""
    # æ£€æŸ¥è®¾å¤‡çŠ¶æ€å¼‚å¸¸
    if device_state.get("status") == "Error":
        return True

    # æ£€æŸ¥è®¾å¤‡å“åº”è¶…æ—¶
    last_update = device_state.get("last_update")
    if last_update:
        time_diff = (datetime.now() - datetime.fromisoformat(last_update)).total_seconds()
        if time_diff > 300:  # 5åˆ†é’Ÿæ— å“åº”
            return True

    # æ£€æŸ¥è®¾å¤‡å‚æ•°å¼‚å¸¸
    if device_state.get("temperature", 0) > 80:  # æ¸©åº¦è¿‡é«˜
        return True

    return False

# æ¨¡æ‹Ÿæ•…éšœæ£€æµ‹
def monitor_devices():
    """ç›‘æ§è®¾å¤‡çŠ¶æ€"""
    devices = storage.get_all_devices()

    for device in devices:
        device_id = device["device_id"]
        device_state = storage.get_device_state(device_id)

        if detect_device_fault(device_id, device_state):
            # è§¦å‘æ•…éšœæ£€æµ‹è§„åˆ™
            scene_manager.update_device_state("DEVICE_MONITOR", {
                "fault_detected": True,
                "fault_device_id": device_id,
                "fault_type": "DeviceError",
                "timestamp": datetime.now().isoformat()
            })
```

---

## 8. æ¡ˆä¾‹8ï¼šç¦»å®¶åœºæ™¯ï¼ˆå®‰é˜²ã€èƒ½è€—ç®¡ç†ï¼‰

### 8.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
ç”¨æˆ·å¸Œæœ›å½“æ£€æµ‹åˆ°ç”¨æˆ·ç¦»å¼€å®¶æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œç¦»å®¶åœºæ™¯ï¼ŒåŒ…æ‹¬ï¼š

- å…³é—­æ‰€æœ‰ç¯å…‰å’Œç”µå™¨è®¾å¤‡
- å¯åŠ¨å®‰é˜²ç³»ç»Ÿï¼ˆé—¨çª—ä¼ æ„Ÿå™¨ã€æ‘„åƒå¤´ï¼‰
- è°ƒèŠ‚ç©ºè°ƒåˆ°èŠ‚èƒ½æ¨¡å¼
- å…³é—­çª—å¸˜
- è®°å½•ç¦»å¼€æ—¶é—´ç”¨äºèƒ½è€—åˆ†æ

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦å‡†ç¡®æ£€æµ‹ç”¨æˆ·ç¦»å¼€ï¼ˆå¤šç§ä¼ æ„Ÿå™¨ç»„åˆåˆ¤æ–­ï¼‰
- éœ€è¦ç¡®ä¿æ‰€æœ‰è®¾å¤‡æ­£ç¡®å…³é—­
- éœ€è¦å¯åŠ¨å®‰é˜²ç³»ç»Ÿå¹¶éªŒè¯çŠ¶æ€
- éœ€è¦è®°å½•èƒ½è€—æ•°æ®ç”¨äºåˆ†æ

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨åœºæ™¯è”åŠ¨ç³»ç»Ÿï¼Œå®šä¹‰ç¦»å®¶åœºæ™¯çš„è§¦å‘æ¡ä»¶ï¼ˆé—¨é”çŠ¶æ€+è¿åŠ¨ä¼ æ„Ÿå™¨+æ—¶é—´ï¼‰ï¼Œ
å½“æ¡ä»¶æ»¡è¶³æ—¶è‡ªåŠ¨æ‰§è¡Œç¦»å®¶åœºæ™¯ï¼Œå¹¶è®°å½•æ‰§è¡Œç»“æœç”¨äºåç»­åˆ†æã€‚

### 8.2 Schemaå®šä¹‰

**ç¦»å®¶åœºæ™¯Schema**ï¼š

```json
{
  "scene_id": "scene_away",
  "scene_name": "ç¦»å®¶åœºæ™¯",
  "scene_description": "ç”¨æˆ·ç¦»å¼€å®¶æ—¶è‡ªåŠ¨æ‰§è¡Œï¼Œå…³é—­è®¾å¤‡å¹¶å¯åŠ¨å®‰é˜²",
  "enabled": true,
  "condition_logic": "AND",
  "conditions": [
    {
      "device_id": "LOCK001",
      "attribute": "lock_state",
      "operator": "==",
      "value": "Locked"
    },
    {
      "device_id": "MOTION001",
      "attribute": "motion_detected",
      "operator": "==",
      "value": false
    },
    {
      "device_id": "MOTION002",
      "attribute": "motion_detected",
      "operator": "==",
      "value": false
    }
  ],
  "time_conditions": [
    {
      "time_type": "time_of_day",
      "value": "08:00:00"
    }
  ],
  "actions": [
    {
      "device_id": "LIGHT001",
      "command": "turn_off",
      "parameters": {},
      "delay": 0.0
    },
    {
      "device_id": "LIGHT002",
      "command": "turn_off",
      "parameters": {},
      "delay": 0.0
    },
    {
      "device_id": "AC001",
      "command": "set_temperature",
      "parameters": {
        "temperature": 28,
        "mode": "Eco"
      },
      "delay": 0.0
    },
    {
      "device_id": "CURTAIN001",
      "command": "close",
      "parameters": {},
      "delay": 0.0
    },
    {
      "device_id": "CURTAIN002",
      "command": "close",
      "parameters": {},
      "delay": 0.0
    },
    {
      "device_id": "SECURITY001",
      "command": "arm",
      "parameters": {
        "mode": "Away",
        "zones": ["all"]
      },
      "delay": 5.0
    },
    {
      "device_id": "CAMERA001",
      "command": "start_recording",
      "parameters": {
        "mode": "motion_detection"
      },
      "delay": 5.0
    }
  ]
}
```

### 8.3 å®ç°ä»£ç 

**ç¦»å®¶åœºæ™¯å®Œæ•´å®ç°**ï¼š

```python
import logging
from datetime import datetime, time
from smart_home_storage import SmartHomeStorage
from scene_manager import SceneManager, DeviceController
from matter_sdk_wrapper import MatterSDKWrapper
from zigbee2mqtt_wrapper import Zigbee2MQTTWrapper

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# åˆå§‹åŒ–ç»„ä»¶
storage = SmartHomeStorage("postgresql://user:pass@localhost/smarthome")
matter_sdk = MatterSDKWrapper(node_id=0x12344321)
zigbee_api = Zigbee2MQTTWrapper(base_url="http://localhost:8080")
device_controller = DeviceController(matter_sdk=matter_sdk, zigbee_api=zigbee_api)
scene_manager = SceneManager(storage, device_controller)

# åˆ›å»ºç¦»å®¶åœºæ™¯
def create_away_scene():
    """åˆ›å»ºç¦»å®¶åœºæ™¯"""
    scene_manager.create_scene(
        scene_id="scene_away",
        scene_name="ç¦»å®¶åœºæ™¯",
        conditions=[
            {
                "device_id": "LOCK001",
                "attribute": "lock_state",
                "operator": "==",
                "value": "Locked"
            },
            {
                "device_id": "MOTION001",
                "attribute": "motion_detected",
                "operator": "==",
                "value": False
            },
            {
                "device_id": "MOTION002",
                "attribute": "motion_detected",
                "operator": "==",
                "value": False
            }
        ],
        actions=[
            {
                "device_id": "LIGHT001",
                "command": "turn_off",
                "parameters": {},
                "delay": 0.0
            },
            {
                "device_id": "LIGHT002",
                "command": "turn_off",
                "parameters": {},
                "delay": 0.0
            },
            {
                "device_id": "AC001",
                "command": "set_temperature",
                "parameters": {"temperature": 28, "mode": "Eco"},
                "delay": 0.0
            },
            {
                "device_id": "CURTAIN001",
                "command": "close",
                "parameters": {},
                "delay": 0.0
            },
            {
                "device_id": "SECURITY001",
                "command": "arm",
                "parameters": {"mode": "Away", "zones": ["all"]},
                "delay": 5.0
            },
            {
                "device_id": "CAMERA001",
                "command": "start_recording",
                "parameters": {"mode": "motion_detection"},
                "delay": 5.0
            }
        ],
        time_conditions=[
            {
                "time_type": "time_of_day",
                "value": time(8, 0, 0)  # 8:00 AMä¹‹å
            }
        ],
        condition_logic="AND"
    )
    logger.info("ç¦»å®¶åœºæ™¯åˆ›å»ºæˆåŠŸ")

# æ¨¡æ‹Ÿç”¨æˆ·ç¦»å¼€
def simulate_user_leaving():
    """æ¨¡æ‹Ÿç”¨æˆ·ç¦»å¼€åœºæ™¯"""
    # 1. ç”¨æˆ·é”é—¨
    scene_manager.update_device_state("LOCK001", {
        "lock_state": "Locked",
        "timestamp": datetime.now().isoformat()
    })

    # 2. ç­‰å¾…5ç§’ï¼Œç¡®ä¿ç”¨æˆ·ç¦»å¼€
    import time
    time.sleep(5)

    # 3. æ›´æ–°è¿åŠ¨ä¼ æ„Ÿå™¨çŠ¶æ€ï¼ˆæ— è¿åŠ¨ï¼‰
    scene_manager.update_device_state("MOTION001", {
        "motion_detected": False,
        "timestamp": datetime.now().isoformat()
    })

    scene_manager.update_device_state("MOTION002", {
        "motion_detected": False,
        "timestamp": datetime.now().isoformat()
    })

    logger.info("ç”¨æˆ·ç¦»å¼€æ£€æµ‹å®Œæˆï¼Œåœºæ™¯åº”è‡ªåŠ¨è§¦å‘")

# éªŒè¯åœºæ™¯æ‰§è¡Œç»“æœ
def verify_away_scene_execution():
    """éªŒè¯ç¦»å®¶åœºæ™¯æ‰§è¡Œç»“æœ"""
    # æŸ¥è¯¢åœºæ™¯æ‰§è¡Œå†å²
    executions = storage.get_scene_execution_statistics("scene_away", days=1)
    logger.info(f"ç¦»å®¶åœºæ™¯æ‰§è¡Œç»Ÿè®¡: {executions}")

    # éªŒè¯è®¾å¤‡çŠ¶æ€
    devices_to_check = ["LIGHT001", "LIGHT002", "AC001", "SECURITY001"]
    for device_id in devices_to_check:
        state = storage.get_latest_device_state(device_id)
        if state:
            logger.info(f"è®¾å¤‡ {device_id} çŠ¶æ€: {state}")
        else:
            logger.warning(f"è®¾å¤‡ {device_id} çŠ¶æ€æœªæ‰¾åˆ°")

    # æŸ¥è¯¢èƒ½è€—æ•°æ®
    energy_stats = storage.get_device_energy_statistics("AC001", datetime.now())
    logger.info(f"ç©ºè°ƒèƒ½è€—ç»Ÿè®¡: {energy_stats}")

# æµ‹è¯•ç”¨ä¾‹
def test_away_scene():
    """æµ‹è¯•ç¦»å®¶åœºæ™¯"""
    # æµ‹è¯•1: æ­£å¸¸ç¦»å¼€åœºæ™¯
    logger.info("æµ‹è¯•1: æ­£å¸¸ç¦»å¼€åœºæ™¯")
    create_away_scene()
    simulate_user_leaving()
    verify_away_scene_execution()

    # æµ‹è¯•2: éƒ¨åˆ†æ¡ä»¶ä¸æ»¡è¶³ï¼ˆè¿åŠ¨ä¼ æ„Ÿå™¨ä»æ£€æµ‹åˆ°è¿åŠ¨ï¼‰
    logger.info("æµ‹è¯•2: éƒ¨åˆ†æ¡ä»¶ä¸æ»¡è¶³")
    scene_manager.update_device_state("MOTION001", {
        "motion_detected": True,  # ä»æœ‰è¿åŠ¨
        "timestamp": datetime.now().isoformat()
    })
    # åœºæ™¯ä¸åº”è§¦å‘

    # æµ‹è¯•3: æ‰‹åŠ¨æ‰§è¡Œåœºæ™¯
    logger.info("æµ‹è¯•3: æ‰‹åŠ¨æ‰§è¡Œåœºæ™¯")
    result = scene_manager.execute_scene("scene_away", manual=True)
    logger.info(f"æ‰‹åŠ¨æ‰§è¡Œç»“æœ: {result}")

if __name__ == "__main__":
    test_away_scene()
```

**è¿è¡Œç»“æœç¤ºä¾‹**ï¼š

```text
INFO:__main__:ç¦»å®¶åœºæ™¯åˆ›å»ºæˆåŠŸ
INFO:__main__:ç”¨æˆ·ç¦»å¼€æ£€æµ‹å®Œæˆï¼Œåœºæ™¯åº”è‡ªåŠ¨è§¦å‘
INFO:__main__:Scenes triggered: ['scene_away']
INFO:__main__:Action executed: LIGHT001 -> turn_off
INFO:__main__:Action executed: LIGHT002 -> turn_off
INFO:__main__:Action executed: AC001 -> set_temperature
INFO:__main__:Action executed: CURTAIN001 -> close
INFO:__main__:Action executed: SECURITY001 -> arm
INFO:__main__:Action executed: CAMERA001 -> start_recording
INFO:__main__:ç¦»å®¶åœºæ™¯æ‰§è¡Œç»Ÿè®¡: [('auto', 1, 1, 0, None)]
INFO:__main__:è®¾å¤‡ LIGHT001 çŠ¶æ€: {'state': {'power': 'Off'}, 'recorded_at': '2025-01-21 10:30:00'}
INFO:__main__:è®¾å¤‡ AC001 çŠ¶æ€: {'state': {'temperature': 28, 'mode': 'Eco'}, 'recorded_at': '2025-01-21 10:30:00'}
```

---

## 9. æ¡ˆä¾‹9ï¼šæ™ºæ…§å®¶å±…æ•°æ®å­˜å‚¨ç³»ç»Ÿ

### 9.1 åœºæ™¯æè¿°

**åº”ç”¨åœºæ™¯**ï¼š
ä½¿ç”¨PostgreSQLå­˜å‚¨æ™ºæ…§å®¶å±…è®¾å¤‡æ•°æ®ï¼Œæ”¯æŒè®¾å¤‡çŠ¶æ€æŸ¥è¯¢ã€
èƒ½è€—åˆ†æã€åœºæ™¯æ‰§è¡Œç»Ÿè®¡ç­‰åŠŸèƒ½ã€‚

### 9.2 å®ç°ä»£ç 

è¯¦è§ `04_Transformation.md` ç¬¬7ç« ã€‚

---

## 10. æ¡ˆä¾‹10ï¼šæ™ºèƒ½å®‰é˜²ç³»ç»Ÿ

### 10.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
æ™ºèƒ½å®‰é˜²ç³»ç»Ÿé›†æˆé—¨é”ã€æ‘„åƒå¤´ã€ä¼ æ„Ÿå™¨ç­‰è®¾å¤‡ï¼Œ
å®ç°å…¥ä¾µæ£€æµ‹ã€å¼‚å¸¸è¡Œä¸ºè¯†åˆ«ã€è‡ªåŠ¨æŠ¥è­¦ç­‰åŠŸèƒ½ã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦å¤šè®¾å¤‡è”åŠ¨
- éœ€è¦å®æ—¶ç›‘æ§
- éœ€è¦å¼‚å¸¸æ£€æµ‹ç®—æ³•
- éœ€è¦æŠ¥è­¦æœºåˆ¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨Smart_Home_Schemaæ•´åˆå®‰é˜²è®¾å¤‡ï¼Œ
ä½¿ç”¨AIç®—æ³•è¿›è¡Œå¼‚å¸¸æ£€æµ‹ï¼Œ
ä½¿ç”¨SmartHomeStorageå­˜å‚¨å®‰é˜²æ•°æ®ã€‚

### 10.2 Schemaå®šä¹‰

**æ™ºèƒ½å®‰é˜²Schema**ï¼š

```dsl
schema SmartSecurity {
  security_session_id: String @value("SEC-20250121-001") @required
  timestamp: DateTime @value("2025-01-21T22:00:00") @required

  security_devices: {
    door_lock: {
      device_id: String @value("LOCK-001")
      status: Enum { Locked } @value(Locked)
      last_unlock_time: DateTime @value("2025-01-21T18:00:00")
    }
    camera: {
      device_id: String @value("CAM-001")
      status: Enum { Active } @value(Active)
      motion_detected: Boolean @value(false)
    }
    motion_sensor: {
      device_id: String @value("MOTION-001")
      status: Enum { Active } @value(Active)
      motion_detected: Boolean @value(false)
    }
    window_sensor: {
      device_id: String @value("WINDOW-001")
      status: Enum { Closed } @value(Closed)
    }
  } @required

  security_status: {
    overall_status: Enum { Secure } @value(Secure)
    alert_level: Enum { Normal } @value(Normal)
    active_alerts: Integer @value(0)
  } @required

  security_rules: [
    {
      rule_id: String @value("RULE-001")
      rule_name: String @value("å¤œé—´å…¥ä¾µæ£€æµ‹")
      trigger_condition: String @value("motion_detected AND time > 22:00")
      action: String @value("send_alert AND turn_on_lights")
      enabled: Boolean @value(true)
    }
  ] @required
} @standard("Matter")
```

### 10.3 å®ç°ä»£ç 

```python
from smart_home_storage import SmartHomeStorage
from datetime import datetime, time

def smart_security_system():
    """æ™ºèƒ½å®‰é˜²ç³»ç»Ÿç¤ºä¾‹"""
    storage = SmartHomeStorage("postgresql://user:password@localhost/smart_home")

    # å®‰é˜²è®¾å¤‡çŠ¶æ€
    security_devices = {
        "door_lock": {
            "device_id": "LOCK-001",
            "status": "Locked",
            "last_unlock_time": datetime(2025, 1, 21, 18, 0, 0)
        },
        "camera": {
            "device_id": "CAM-001",
            "status": "Active",
            "motion_detected": False
        },
        "motion_sensor": {
            "device_id": "MOTION-001",
            "status": "Active",
            "motion_detected": False
        },
        "window_sensor": {
            "device_id": "WINDOW-001",
            "status": "Closed"
        }
    }

    # å®‰é˜²è§„åˆ™
    security_rules = [
        {
            "rule_id": "RULE-001",
            "rule_name": "å¤œé—´å…¥ä¾µæ£€æµ‹",
            "trigger_condition": "motion_detected AND time > 22:00",
            "action": "send_alert AND turn_on_lights",
            "enabled": True
        }
    ]

    # æ£€æŸ¥å®‰é˜²çŠ¶æ€
    def check_security_status(devices, current_time):
        """æ£€æŸ¥å®‰é˜²çŠ¶æ€"""
        overall_status = "Secure"
        alert_level = "Normal"
        active_alerts = 0

        # æ£€æŸ¥é—¨é”çŠ¶æ€
        if devices["door_lock"]["status"] != "Locked":
            overall_status = "Warning"
            alert_level = "Medium"
            active_alerts += 1

        # æ£€æŸ¥è¿åŠ¨æ£€æµ‹
        if devices["motion_sensor"]["motion_detected"]:
            if current_time.hour >= 22 or current_time.hour < 6:
                overall_status = "Alert"
                alert_level = "High"
                active_alerts += 1

        # æ£€æŸ¥çª—æˆ·ä¼ æ„Ÿå™¨
        if devices["window_sensor"]["status"] != "Closed":
            overall_status = "Warning"
            alert_level = "Medium"
            active_alerts += 1

        return {
            "overall_status": overall_status,
            "alert_level": alert_level,
            "active_alerts": active_alerts
        }

    # æ‰§è¡Œå®‰é˜²æ£€æŸ¥
    current_time = datetime.now()
    security_status = check_security_status(security_devices, current_time)

    # å­˜å‚¨å®‰é˜²æ•°æ®
    security_data = {
        "security_session_id": "SEC-20250121-001",
        "timestamp": current_time,
        "door_lock_status": security_devices["door_lock"]["status"],
        "camera_status": security_devices["camera"]["status"],
        "motion_sensor_status": security_devices["motion_sensor"]["status"],
        "window_sensor_status": security_devices["window_sensor"]["status"],
        "overall_status": security_status["overall_status"],
        "alert_level": security_status["alert_level"],
        "active_alerts": security_status["active_alerts"]
    }

    # å­˜å‚¨åˆ°æ•°æ®åº“
    security_id = storage.store_device_data(security_data)
    print(f"Security data stored: {security_id}")

    print(f"\nSmart Security Status:")
    print(f"  Overall status: {security_status['overall_status']}")
    print(f"  Alert level: {security_status['alert_level']}")
    print(f"  Active alerts: {security_status['active_alerts']}")
    print(f"  Door lock: {security_devices['door_lock']['status']}")
    print(f"  Motion sensor: {'Motion detected' if security_devices['motion_sensor']['motion_detected'] else 'No motion'}")

    return security_data

if __name__ == "__main__":
    smart_security_system()
```

---

## 11. æ¡ˆä¾‹11ï¼šæ™ºèƒ½å¥åº·ç›‘æµ‹ç³»ç»Ÿ

### 11.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
æ™ºèƒ½å¥åº·ç›‘æµ‹ç³»ç»Ÿé›†æˆå¥åº·ä¼ æ„Ÿå™¨ã€æ™ºèƒ½åºŠå«ã€æ™ºèƒ½ä½“é‡ç§¤ç­‰è®¾å¤‡ï¼Œ
ç›‘æµ‹ç”¨æˆ·å¥åº·æŒ‡æ ‡ï¼Œæä¾›å¥åº·å»ºè®®å’Œé¢„è­¦ã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦å¤šä¼ æ„Ÿå™¨æ•°æ®èåˆ
- éœ€è¦å¥åº·æ•°æ®åˆ†æ
- éœ€è¦å¼‚å¸¸æ£€æµ‹
- éœ€è¦å¥åº·æŠ¥å‘Šç”Ÿæˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨Smart_Home_Schemaæ•´åˆå¥åº·è®¾å¤‡ï¼Œ
ä½¿ç”¨AIç®—æ³•è¿›è¡Œå¥åº·åˆ†æï¼Œ
ä½¿ç”¨SmartHomeStorageå­˜å‚¨å¥åº·æ•°æ®ã€‚

### 11.2 Schemaå®šä¹‰

**æ™ºèƒ½å¥åº·ç›‘æµ‹Schema**ï¼š

```dsl
schema SmartHealthMonitoring {
  health_session_id: String @value("HEALTH-20250121-001") @required
  user_id: String @value("USER-001") @required
  timestamp: DateTime @value("2025-01-21T08:00:00") @required

  health_metrics: {
    weight: Decimal @value(70.5) @unit("kg")
    bmi: Decimal @value(22.5)
    heart_rate: Integer @value(72) @unit("bpm")
    blood_pressure: {
      systolic: Integer @value(120) @unit("mmHg")
      diastolic: Integer @value(80) @unit("mmHg")
    }
    sleep_quality: {
      sleep_duration: Decimal @value(7.5) @unit("hours")
      deep_sleep_ratio: Decimal @value(0.25)
      sleep_score: Decimal @value(0.85) @range(0.0, 1.0)
    }
    activity_level: {
      steps: Integer @value(8500)
      calories_burned: Integer @value(2200)
      active_minutes: Integer @value(45)
    }
  } @required

  health_analysis: {
    overall_health_score: Decimal @value(0.82) @range(0.0, 1.0)
    health_status: Enum { Good } @value(Good)
    risk_factors: [
      {
        factor: String @value("Sedentary lifestyle")
        severity: Enum { Low } @value(Low)
        recommendation: String @value("å¢åŠ æ—¥å¸¸æ´»åŠ¨é‡")
      }
    ]
    recommendations: [
      {
        recommendation: String @value("ä¿æŒå½“å‰è¿åŠ¨é‡")
        priority: Enum { Medium } @value(Medium)
      }
    ]
  } @required
} @standard("Matter")
```

### 11.3 å®ç°ä»£ç 

```python
from smart_home_storage import SmartHomeStorage
from datetime import datetime

def smart_health_monitoring():
    """æ™ºèƒ½å¥åº·ç›‘æµ‹ç³»ç»Ÿç¤ºä¾‹"""
    storage = SmartHomeStorage("postgresql://user:password@localhost/smart_home")

    # å¥åº·æŒ‡æ ‡æ•°æ®
    health_metrics = {
        "weight": 70.5,
        "bmi": 22.5,
        "heart_rate": 72,
        "blood_pressure": {
            "systolic": 120,
            "diastolic": 80
        },
        "sleep_quality": {
            "sleep_duration": 7.5,
            "deep_sleep_ratio": 0.25,
            "sleep_score": 0.85
        },
        "activity_level": {
            "steps": 8500,
            "calories_burned": 2200,
            "active_minutes": 45
        }
    }

    # å¥åº·åˆ†æç®—æ³•
    def analyze_health(metrics):
        """åˆ†æå¥åº·çŠ¶æ€"""
        overall_score = 0.0
        risk_factors = []
        recommendations = []

        # BMIè¯„åˆ†
        bmi = metrics["bmi"]
        if 18.5 <= bmi <= 24.9:
            bmi_score = 1.0
        elif 25.0 <= bmi <= 29.9:
            bmi_score = 0.7
            risk_factors.append({
                "factor": "Overweight",
                "severity": "Medium",
                "recommendation": "æ§åˆ¶é¥®é£Ÿï¼Œå¢åŠ è¿åŠ¨"
            })
        else:
            bmi_score = 0.5
            risk_factors.append({
                "factor": "BMIå¼‚å¸¸",
                "severity": "High",
                "recommendation": "å’¨è¯¢åŒ»ç”Ÿ"
            })

        # å¿ƒç‡è¯„åˆ†
        heart_rate = metrics["heart_rate"]
        if 60 <= heart_rate <= 100:
            hr_score = 1.0
        else:
            hr_score = 0.7
            risk_factors.append({
                "factor": "å¿ƒç‡å¼‚å¸¸",
                "severity": "Medium",
                "recommendation": "ç›‘æµ‹å¿ƒç‡å˜åŒ–"
            })

        # ç¡çœ è¯„åˆ†
        sleep_score = metrics["sleep_quality"]["sleep_score"]

        # æ´»åŠ¨è¯„åˆ†
        steps = metrics["activity_level"]["steps"]
        if steps >= 10000:
            activity_score = 1.0
        elif steps >= 5000:
            activity_score = 0.8
            recommendations.append({
                "recommendation": "å¢åŠ æ—¥å¸¸æ´»åŠ¨é‡",
                "priority": "Low"
            })
        else:
            activity_score = 0.6
            risk_factors.append({
                "factor": "Sedentary lifestyle",
                "severity": "Low",
                "recommendation": "å¢åŠ æ—¥å¸¸æ´»åŠ¨é‡"
            })
            recommendations.append({
                "recommendation": "å¢åŠ æ—¥å¸¸æ´»åŠ¨é‡",
                "priority": "Medium"
            })

        # ç»¼åˆè¯„åˆ†
        overall_score = (
            bmi_score * 0.2 +
            hr_score * 0.2 +
            sleep_score * 0.3 +
            activity_score * 0.3
        )

        # ç¡®å®šå¥åº·çŠ¶æ€
        if overall_score >= 0.8:
            health_status = "Excellent"
        elif overall_score >= 0.7:
            health_status = "Good"
        elif overall_score >= 0.6:
            health_status = "Fair"
        else:
            health_status = "Poor"

        return {
            "overall_health_score": overall_score,
            "health_status": health_status,
            "risk_factors": risk_factors,
            "recommendations": recommendations
        }

    # æ‰§è¡Œå¥åº·åˆ†æ
    health_analysis = analyze_health(health_metrics)

    # å­˜å‚¨å¥åº·æ•°æ®
    health_data = {
        "health_session_id": "HEALTH-20250121-001",
        "user_id": "USER-001",
        "timestamp": datetime.now(),
        "weight": health_metrics["weight"],
        "bmi": health_metrics["bmi"],
        "heart_rate": health_metrics["heart_rate"],
        "blood_pressure_systolic": health_metrics["blood_pressure"]["systolic"],
        "blood_pressure_diastolic": health_metrics["blood_pressure"]["diastolic"],
        "sleep_duration": health_metrics["sleep_quality"]["sleep_duration"],
        "sleep_score": health_metrics["sleep_quality"]["sleep_score"],
        "steps": health_metrics["activity_level"]["steps"],
        "calories_burned": health_metrics["activity_level"]["calories_burned"],
        "overall_health_score": health_analysis["overall_health_score"],
        "health_status": health_analysis["health_status"],
        "risk_factors": health_analysis["risk_factors"],
        "recommendations": health_analysis["recommendations"]
    }

    # å­˜å‚¨åˆ°æ•°æ®åº“
    health_id = storage.store_device_data(health_data)
    print(f"Health data stored: {health_id}")

    print(f"\nSmart Health Monitoring Results:")
    print(f"  Overall health score: {health_analysis['overall_health_score']:.2f}")
    print(f"  Health status: {health_analysis['health_status']}")
    print(f"  Risk factors: {len(health_analysis['risk_factors'])}")
    print(f"  Recommendations: {len(health_analysis['recommendations'])}")

    return health_data

if __name__ == "__main__":
    smart_health_monitoring()
```

---

**å‚è€ƒæ–‡æ¡£**ï¼š

- `01_Overview.md` - æ¦‚è¿°
- `02_Formal_Definition.md` - å½¢å¼åŒ–å®šä¹‰
- `03_Standards.md` - æ ‡å‡†å¯¹æ ‡
- `04_Transformation.md` - è½¬æ¢ä½“ç³»

**åˆ›å»ºæ—¶é—´**ï¼š2025-01-21
**æœ€åæ›´æ–°**ï¼š2025-01-21


---

## 12. æ¡ˆä¾‹12ï¼šæ™ºèƒ½çª—å¸˜ä¸å…‰ç…§è°ƒèŠ‚ç³»ç»Ÿ

### 12.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
ç°ä»£æ™ºèƒ½å®¶å±…éœ€è¦æ ¹æ®è‡ªç„¶å…‰ç…§æ¡ä»¶è‡ªåŠ¨è°ƒèŠ‚çª—å¸˜å¼€åˆåº¦å’Œå®¤å†…ç¯å…‰ï¼Œå®ç°èŠ‚èƒ½å’Œèˆ’é€‚çš„å±…ä½ç¯å¢ƒã€‚ç³»ç»Ÿéœ€è¦é›†æˆå…‰ç…§ä¼ æ„Ÿå™¨ã€æ™ºèƒ½çª—å¸˜ç”µæœºã€æ™ºèƒ½ç¯å…‰ï¼Œæ ¹æ®æ—¶é—´ã€å¤©æ°”ã€ç”¨æˆ·ä¹ æƒ¯è‡ªåŠ¨è°ƒèŠ‚ã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦å®æ—¶ç›‘æµ‹å®¤å†…å¤–å…‰ç…§å¼ºåº¦
- éœ€è¦æ ¹æ®å­£èŠ‚å’Œæ—¶é—´åŠ¨æ€è°ƒæ•´ç­–ç•¥
- éœ€è¦æ”¯æŒæ‰‹åŠ¨è¦†ç›–å’Œè‡ªåŠ¨æ¨¡å¼çš„åˆ‡æ¢
- éœ€è¦å­¦ä¹ ç”¨æˆ·åå¥½å¹¶ä¼˜åŒ–æ§åˆ¶ç­–ç•¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨Smart_Home_Schemaå®šä¹‰å…‰ç…§è°ƒèŠ‚åœºæ™¯ï¼Œç»“åˆæœºå™¨å­¦ä¹ ç®—æ³•å­¦ä¹ ç”¨æˆ·ä¹ æƒ¯ï¼Œä½¿ç”¨PostgreSQLå­˜å‚¨å†å²æ•°æ®ç”¨äºåˆ†æå’Œä¼˜åŒ–ã€‚

### 12.2 Schemaå®šä¹‰

**æ™ºèƒ½å…‰ç…§è°ƒèŠ‚Schema**ï¼š

```json
{
  "scene_id": "scene_lighting_adjustment",
  "scene_name": "æ™ºèƒ½å…‰ç…§è°ƒèŠ‚",
  "sensors": {
    "outdoor_light_sensor": {
      "device_id": "LIGHT_SENSOR_001",
      "current_lux": 45000,
      "location": "balcony"
    },
    "indoor_light_sensor": {
      "device_id": "LIGHT_SENSOR_002",
      "current_lux": 350,
      "location": "living_room"
    }
  },
  "actuators": {
    "smart_curtain": {
      "device_id": "CURTAIN_001",
      "current_position": 30,
      "target_position": 60
    },
    "smart_light": {
      "device_id": "LIGHT_001",
      "current_brightness": 80,
      "target_brightness": 50
    }
  },
  "control_rules": [
    {
      "condition": "outdoor_lux > 30000 AND time BETWEEN 09:00 AND 17:00",
      "action": "open_curtain_to(60) AND dim_light_to(30)"
    },
    {
      "condition": "outdoor_lux < 10000 OR time BETWEEN 17:00 AND 09:00",
      "action": "close_curtain_to(0) AND brighten_light_to(80)"
    }
  ]
}
```

### 12.3 å®ç°ä»£ç 

```python
from smart_home_storage import SmartHomeStorage
from datetime import datetime, time
import logging

logger = logging.getLogger(__name__)

class SmartLightingController:
    """æ™ºèƒ½å…‰ç…§è°ƒèŠ‚æ§åˆ¶å™¨"""

    def __init__(self, storage: SmartHomeStorage):
        self.storage = storage
        self.outdoor_lux_threshold_high = 30000
        self.outdoor_lux_threshold_low = 10000

    def evaluate_lighting_conditions(self, outdoor_lux: int, indoor_lux: int) -> Dict:
        """è¯„ä¼°å…‰ç…§æ¡ä»¶å¹¶å†³å®šæ§åˆ¶ç­–ç•¥"""
        current_time = datetime.now().time()
        is_daytime = time(9, 0) <= current_time <= time(17, 0)

        if outdoor_lux > self.outdoor_lux_threshold_high and is_daytime:
            return {
                "curtain_position": 70,  # æ‰“å¼€70%
                "light_brightness": 30,   # è°ƒæš—åˆ°30%
                "reason": "å……è¶³è‡ªç„¶å…‰"
            }
        elif outdoor_lux < self.outdoor_lux_threshold_low or not is_daytime:
            return {
                "curtain_position": 0,    # å…³é—­çª—å¸˜
                "light_brightness": 80,   # è°ƒäº®åˆ°80%
                "reason": "è‡ªç„¶å…‰ä¸è¶³"
            }
        else:
            return {
                "curtain_position": 40,
                "light_brightness": 60,
                "reason": "é€‚ä¸­å…‰ç…§"
            }

    def adjust_lighting(self, outdoor_sensor_id: str, indoor_sensor_id: str,
                       curtain_id: str, light_id: str):
        """æ‰§è¡Œå…‰ç…§è°ƒèŠ‚"""
        # è·å–ä¼ æ„Ÿå™¨æ•°æ®
        outdoor_state = self.storage.get_latest_device_state(outdoor_sensor_id)
        indoor_state = self.storage.get_latest_device_state(indoor_sensor_id)

        outdoor_lux = outdoor_state.get("state", {}).get("lux", 0) if outdoor_state else 0
        indoor_lux = indoor_state.get("state", {}).get("lux", 0) if indoor_state else 0

        # è¯„ä¼°å¹¶å†³å®šæ§åˆ¶ç­–ç•¥
        strategy = self.evaluate_lighting_conditions(outdoor_lux, indoor_lux)

        # å­˜å‚¨æ§åˆ¶å‘½ä»¤
        curtain_cmd = self.storage.store_control_command(
            curtain_id, "set_position",
            {"position": strategy["curtain_position"]}
        )
        light_cmd = self.storage.store_control_command(
            light_id, "set_brightness",
            {"brightness": strategy["light_brightness"]}
        )

        # è®°å½•åœºæ™¯æ‰§è¡Œ
        self.storage.record_scene_execution(
            "scene_lighting_adjustment",
            "auto",
            True,
            {"strategy": strategy, "outdoor_lux": outdoor_lux, "indoor_lux": indoor_lux}
        )

        logger.info(f"Lighting adjusted: curtain={strategy['curtain_position']}%, "
                   f"light={strategy['light_brightness']}%, reason={strategy['reason']}")

        return strategy

# ä½¿ç”¨ç¤ºä¾‹
def demo_smart_lighting():
    storage = SmartHomeStorage("postgresql://user:pass@localhost/smarthome")
    controller = SmartLightingController(storage)

    # æ¨¡æ‹Ÿä¸åŒå…‰ç…§æ¡ä»¶ä¸‹çš„è°ƒèŠ‚
    strategies = [
        {"outdoor_lux": 45000, "indoor_lux": 200, "time": "10:00"},
        {"outdoor_lux": 8000, "indoor_lux": 150, "time": "19:00"},
        {"outdoor_lux": 25000, "indoor_lux": 400, "time": "14:00"}
    ]

    for condition in strategies:
        result = controller.evaluate_lighting_conditions(
            condition["outdoor_lux"],
            condition["indoor_lux"]
        )
        print(f"Time: {condition['time']}, Outdoor: {condition['outdoor_lux']}lux, "
              f"Indoor: {condition['indoor_lux']}lux -> {result}")
```

---

## 13. æ¡ˆä¾‹13ï¼šæ™ºèƒ½ç©ºè°ƒä¸æ–°é£ç³»ç»Ÿè”åŠ¨

### 13.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
æ™ºèƒ½ç©ºè°ƒä¸æ–°é£ç³»ç»Ÿçš„è”åŠ¨å¯ä»¥å®ç°å®¤å†…æ¸©åº¦å’Œç©ºæ°”è´¨é‡çš„åŒé‡ä¼˜åŒ–ã€‚å½“å®¤å¤–ç©ºæ°”è´¨é‡è‰¯å¥½æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨æ–°é£ç³»ç»Ÿï¼›å½“å®¤å¤–æ¸©åº¦é€‚å®œæ—¶ï¼Œå‡å°‘ç©ºè°ƒä½¿ç”¨ï¼Œå®ç°èŠ‚èƒ½ã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦å®æ—¶ç›‘æµ‹å®¤å†…å¤–æ¸©åº¦ã€æ¹¿åº¦ã€ç©ºæ°”è´¨é‡
- éœ€è¦åè°ƒç©ºè°ƒå’Œæ–°é£ç³»ç»Ÿçš„å·¥ä½œæ¨¡å¼
- éœ€è¦æ ¹æ®ç”¨æˆ·èˆ’é€‚åº¦åå¥½åŠ¨æ€è°ƒæ•´
- éœ€è¦å®ç°èŠ‚èƒ½ä¸èˆ’é€‚çš„å¹³è¡¡

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨åœºæ™¯è”åŠ¨ç³»ç»Ÿå®šä¹‰ç©ºè°ƒä¸æ–°é£ç³»ç»Ÿçš„è”åŠ¨è§„åˆ™ï¼Œæ ¹æ®ç¯å¢ƒæ¡ä»¶è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜è¿è¡Œæ¨¡å¼ã€‚

### 13.2 Schemaå®šä¹‰

**ç©ºè°ƒæ–°é£è”åŠ¨Schema**ï¼š

```json
{
  "scene_id": "scene_hvac_air_quality",
  "scene_name": "ç©ºè°ƒæ–°é£æ™ºèƒ½è”åŠ¨",
  "sensors": {
    "outdoor_air": {
      "temperature": 26.5,
      "humidity": 65,
      "aqi": 45,
      "pm25": 12
    },
    "indoor_air": {
      "temperature": 28.0,
      "humidity": 70,
      "co2": 800,
      "pm25": 8
    }
  },
  "hvac_system": {
    "air_conditioner": {
      "device_id": "AC_001",
      "mode": "Cool",
      "target_temp": 26,
      "fan_speed": "Auto"
    },
    "fresh_air_system": {
      "device_id": "FRESH_AIR_001",
      "mode": "Auto",
      "fan_speed": 2,
      "filter_status": "Good"
    }
  },
  "control_strategy": {
    "priority": "comfort",
    "eco_mode": true,
    "auto_switch": true
  }
}
```

### 13.3 å®ç°ä»£ç 

```python
class HVACAirQualityController:
    """ç©ºè°ƒæ–°é£ç³»ç»Ÿè”åŠ¨æ§åˆ¶å™¨"""

    def __init__(self, storage: SmartHomeStorage):
        self.storage = storage

    def calculate_comfort_index(self, temp: float, humidity: float) -> float:
        """è®¡ç®—èˆ’é€‚åº¦æŒ‡æ•°(0-100)"""
        # åŸºäºæ¸©æ¹¿åº¦çš„èˆ’é€‚åº¦è®¡ç®—
        temp_score = max(0, 100 - abs(temp - 24) * 5)  # 24Â°Cä¸ºæœ€ä½³æ¸©åº¦
        humidity_score = max(0, 100 - abs(humidity - 50) * 2)  # 50%ä¸ºæœ€ä½³æ¹¿åº¦
        return (temp_score + humidity_score) / 2

    def determine_hvac_strategy(self, outdoor: Dict, indoor: Dict,
                                user_preference: str = "comfort") -> Dict:
        """ç¡®å®šç©ºè°ƒæ–°é£æ§åˆ¶ç­–ç•¥"""
        strategy = {
            "ac_mode": "Off",
            "ac_target_temp": 26,
            "fresh_air_mode": "Off",
            "fresh_air_speed": 0,
            "reason": ""
        }

        indoor_comfort = self.calculate_comfort_index(
            indoor["temperature"], indoor["humidity"]
        )

        # CO2æµ“åº¦é«˜ï¼Œä¼˜å…ˆå¼€å¯æ–°é£
        if indoor.get("co2", 400) > 1000:
            strategy["fresh_air_mode"] = "On"
            strategy["fresh_air_speed"] = 3
            strategy["reason"] = "CO2æµ“åº¦è¿‡é«˜ï¼Œéœ€è¦é€šé£"

        # å®¤å¤–ç©ºæ°”è´¨é‡å¥½ä¸”æ¸©åº¦é€‚å®œï¼Œä½¿ç”¨æ–°é£é™æ¸©
        elif (outdoor.get("aqi", 100) < 50 and
              outdoor["temperature"] < indoor["temperature"] - 2):
            strategy["fresh_air_mode"] = "On"
            strategy["fresh_air_speed"] = 2
            strategy["reason"] = "å®¤å¤–ç©ºæ°”å¥½ä¸”å‡‰çˆ½ï¼Œä½¿ç”¨æ–°é£"

        # å®¤å†…èˆ’é€‚åº¦ä½ï¼Œä½¿ç”¨ç©ºè°ƒ
        elif indoor_comfort < 60:
            if indoor["temperature"] > 26:
                strategy["ac_mode"] = "Cool"
                strategy["ac_target_temp"] = 25
            else:
                strategy["ac_mode"] = "Heat"
                strategy["ac_target_temp"] = 22
            strategy["reason"] = f"èˆ’é€‚åº¦ä½({indoor_comfort:.1f})ï¼Œéœ€è¦ç©ºè°ƒè°ƒèŠ‚"

        else:
            strategy["reason"] = "å®¤å†…ç¯å¢ƒèˆ’é€‚ï¼Œä¿æŒå½“å‰çŠ¶æ€"

        return strategy

    def execute_hvac_control(self, ac_id: str, fresh_air_id: str,
                            outdoor_data: Dict, indoor_data: Dict):
        """æ‰§è¡Œç©ºè°ƒæ–°é£æ§åˆ¶"""
        strategy = self.determine_hvac_strategy(outdoor_data, indoor_data)

        # å­˜å‚¨æ§åˆ¶å‘½ä»¤
        if strategy["ac_mode"] != "Off":
            self.storage.store_control_command(ac_id, "set_mode", {
                "mode": strategy["ac_mode"],
                "target_temperature": strategy["ac_target_temp"]
            })

        if strategy["fresh_air_mode"] != "Off":
            self.storage.store_control_command(fresh_air_id, "set_fresh_air", {
                "mode": strategy["fresh_air_mode"],
                "fan_speed": strategy["fresh_air_speed"]
            })

        logger.info(f"HVAC control executed: AC={strategy['ac_mode']}, "
                   f"FreshAir={strategy['fresh_air_mode']}, Reason={strategy['reason']}")

        return strategy
```

---

## 14. æ¡ˆä¾‹14ï¼šæ™ºèƒ½çŒæº‰ä¸èŠ±å›­ç®¡ç†ç³»ç»Ÿ

### 14.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
æ™ºèƒ½èŠ±å›­ç®¡ç†ç³»ç»Ÿæ ¹æ®åœŸå£¤æ¹¿åº¦ã€å¤©æ°”é¢„æŠ¥ã€æ¤ç‰©ç±»å‹è‡ªåŠ¨æ‰§è¡ŒçŒæº‰ï¼ŒåŒæ—¶ç›‘æµ‹èŠ±å›­ç¯å¢ƒï¼ˆå…‰ç…§ã€æ¸©åº¦ï¼‰ï¼Œä¸ºæ¤ç‰©æä¾›æœ€ä½³ç”Ÿé•¿æ¡ä»¶ã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦å®æ—¶ç›‘æµ‹å¤šç‚¹åœŸå£¤æ¹¿åº¦
- éœ€è¦è·å–å¹¶è§£æå¤©æ°”é¢„æŠ¥æ•°æ®
- éœ€è¦æ ¹æ®ä¸åŒæ¤ç‰©ç±»å‹åˆ¶å®šçŒæº‰ç­–ç•¥
- éœ€è¦è€ƒè™‘é™é›¨é¢„æµ‹é¿å…è¿‡åº¦çŒæº‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨å¤šä¼ æ„Ÿå™¨èåˆå’Œå¤©æ°”é¢„æŠ¥APIï¼Œç»“åˆæ¤ç‰©æ•°æ®åº“ï¼Œå®ç°ç²¾å‡†çŒæº‰æ§åˆ¶ã€‚

### 14.2 Schemaå®šä¹‰

**æ™ºèƒ½èŠ±å›­ç®¡ç†Schema**ï¼š

```json
{
  "scene_id": "scene_garden_irrigation",
  "scene_name": "æ™ºèƒ½èŠ±å›­çŒæº‰",
  "garden_zones": [
    {
      "zone_id": "zone_001",
      "zone_name": "è‰åªåŒº",
      "plant_type": "grass",
      "soil_moisture": 35,
      "moisture_threshold": 40,
      "irrigation_duration": 15
    },
    {
      "zone_id": "zone_002",
      "zone_name": "èŠ±å‰åŒº",
      "plant_type": "flowers",
      "soil_moisture": 55,
      "moisture_threshold": 50,
      "irrigation_duration": 10
    }
  ],
  "weather_forecast": {
    "today_rain_probability": 20,
    "next_24h_rain": false,
    "temperature_high": 32,
    "temperature_low": 24
  },
  "irrigation_schedule": {
    "morning_time": "06:00",
    "evening_time": "18:00",
    "max_daily_cycles": 2
  }
}
```

### 14.3 å®ç°ä»£ç 

```python
class SmartGardenController:
    """æ™ºèƒ½èŠ±å›­æ§åˆ¶å™¨"""

    PLANT_PROFILES = {
        "grass": {"moisture_optimal": 45, "moisture_min": 35, "moisture_max": 60},
        "flowers": {"moisture_optimal": 55, "moisture_min": 45, "moisture_max": 70},
        "vegetables": {"moisture_optimal": 65, "moisture_min": 55, "moisture_max": 80},
        "succulents": {"moisture_optimal": 25, "moisture_min": 15, "moisture_max": 35}
    }

    def __init__(self, storage: SmartHomeStorage):
        self.storage = storage

    def should_irrigate(self, zone: Dict, weather: Dict) -> Tuple[bool, str]:
        """åˆ¤æ–­æ˜¯å¦éœ€è¦çŒæº‰"""
        plant_type = zone.get("plant_type", "grass")
        current_moisture = zone.get("soil_moisture", 0)
        profile = self.PLANT_PROFILES.get(plant_type, self.PLANT_PROFILES["grass"])

        # æ£€æŸ¥é™é›¨é¢„æµ‹
        if weather.get("next_24h_rain", False):
            return False, "24å°æ—¶å†…æœ‰é™é›¨é¢„æµ‹ï¼Œè·³è¿‡çŒæº‰"

        if weather.get("today_rain_probability", 0) > 70:
            return False, f"é™é›¨æ¦‚ç‡{weather['today_rain_probability']}%ï¼Œè·³è¿‡çŒæº‰"

        # æ£€æŸ¥åœŸå£¤æ¹¿åº¦
        if current_moisture < profile["moisture_min"]:
            return True, f"åœŸå£¤æ¹¿åº¦{current_moisture}%ä½äºæœ€å°å€¼{profile['moisture_min']}%ï¼Œéœ€è¦çŒæº‰"

        if current_moisture < profile["moisture_optimal"]:
            return True, f"åœŸå£¤æ¹¿åº¦{current_moisture}%ä½äºæœ€ä½³å€¼{profile['moisture_optimal']}%ï¼Œå»ºè®®çŒæº‰"

        return False, f"åœŸå£¤æ¹¿åº¦{current_moisture}%é€‚å®œï¼Œæ— éœ€çŒæº‰"

    def calculate_irrigation_duration(self, zone: Dict, weather: Dict) -> int:
        """è®¡ç®—çŒæº‰æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰"""
        base_duration = zone.get("irrigation_duration", 10)
        plant_type = zone.get("plant_type", "grass")
        profile = self.PLANT_PROFILES.get(plant_type, self.PLANT_PROFILES["grass"])

        # æ ¹æ®æ¹¿åº¦ç¼ºå£è°ƒæ•´
        moisture_gap = profile["moisture_optimal"] - zone.get("soil_moisture", 0)
        adjustment = min(max(moisture_gap / 10, 0), 2)  # æœ€å¤šå¢åŠ 2å€æ—¶é•¿

        # æ ¹æ®æ¸©åº¦è°ƒæ•´
        temp = weather.get("temperature_high", 25)
        if temp > 35:
            temp_factor = 1.3
        elif temp > 30:
            temp_factor = 1.1
        else:
            temp_factor = 1.0

        duration = int(base_duration * (1 + adjustment) * temp_factor)
        return min(duration, 30)  # æœ€é•¿30åˆ†é’Ÿ

    def execute_irrigation(self, zones: List[Dict], weather: Dict):
        """æ‰§è¡ŒçŒæº‰"""
        results = []

        for zone in zones:
            should_water, reason = self.should_irrigate(zone, weather)

            if should_water:
                duration = self.calculate_irrigation_duration(zone, weather)
                valve_id = f"VALVE_{zone['zone_id']}"

                # å­˜å‚¨çŒæº‰å‘½ä»¤
                self.storage.store_control_command(valve_id, "irrigate", {
                    "duration_minutes": duration,
                    "zone_name": zone["zone_name"],
                    "reason": reason
                })

                results.append({
                    "zone_id": zone["zone_id"],
                    "action": "irrigate",
                    "duration": duration,
                    "reason": reason
                })

                logger.info(f"Zone {zone['zone_name']}: irrigation started for {duration}min, {reason}")
            else:
                results.append({
                    "zone_id": zone["zone_id"],
                    "action": "skip",
                    "reason": reason
                })
                logger.info(f"Zone {zone['zone_name']}: irrigation skipped, {reason}")

        return results

# ä½¿ç”¨ç¤ºä¾‹
def demo_garden_irrigation():
    storage = SmartHomeStorage("postgresql://user:pass@localhost/smarthome")
    controller = SmartGardenController(storage)

    zones = [
        {"zone_id": "zone_001", "zone_name": "è‰åªåŒº", "plant_type": "grass", "soil_moisture": 32},
        {"zone_id": "zone_002", "zone_name": "èŠ±å‰åŒº", "plant_type": "flowers", "soil_moisture": 58}
    ]

    weather = {
        "today_rain_probability": 10,
        "next_24h_rain": False,
        "temperature_high": 33
    }

    results = controller.execute_irrigation(zones, weather)
    for result in results:
        print(f"Zone {result['zone_id']}: {result['action']} - {result['reason']}")
```

---

## 15. æ¡ˆä¾‹15ï¼šè€äººå±…å®¶å®‰å…¨ç›‘æŠ¤ç³»ç»Ÿ

### 15.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
é’ˆå¯¹ç‹¬å±…è€äººçš„æ™ºèƒ½ç›‘æŠ¤ç³»ç»Ÿï¼Œé€šè¿‡è¿åŠ¨ä¼ æ„Ÿå™¨ã€ç´§æ€¥å‘¼å«æŒ‰é’®ã€ç¡çœ ç›‘æµ‹è®¾å¤‡ç­‰ï¼Œå®æ—¶ç›‘æµ‹è€äººæ´»åŠ¨çŠ¶æ€ï¼Œæ£€æµ‹å¼‚å¸¸æƒ…å†µï¼ˆå¦‚é•¿æ—¶é—´æ— æ´»åŠ¨ã€å¤œé—´å¼‚å¸¸æ´»åŠ¨ç­‰ï¼‰ï¼Œå¹¶åŠæ—¶é€šçŸ¥å®¶å±æˆ–æŠ¤ç†äººå‘˜ã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦åŒºåˆ†æ­£å¸¸æ´»åŠ¨å’Œå¼‚å¸¸æƒ…å†µ
- éœ€è¦å¤„ç†è¯¯æŠ¥ï¼ˆå¦‚è€äººå¤–å‡ºï¼‰
- éœ€è¦ä¿æŠ¤éšç§çš„åŒæ—¶å®ç°æœ‰æ•ˆç›‘æŠ¤
- éœ€è¦å¤šçº§åˆ«çš„å‘Šè­¦æœºåˆ¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨å¤šä¼ æ„Ÿå™¨æ•°æ®èåˆå’Œè¡Œä¸ºæ¨¡å¼åˆ†æï¼Œå»ºç«‹è€äººæ—¥å¸¸è¡Œä¸ºåŸºçº¿ï¼Œæ£€æµ‹å¼‚å¸¸å¹¶åŠæ—¶å‘Šè­¦ã€‚

### 15.2 Schemaå®šä¹‰

**è€äººç›‘æŠ¤ç³»ç»ŸSchema**ï¼š

```json
{
  "scene_id": "scene_elderly_care",
  "scene_name": "è€äººå±…å®¶å®‰å…¨ç›‘æŠ¤",
  "resident": {
    "user_id": "elderly_001",
    "name": "å¼ çˆ·çˆ·",
    "age": 78,
    "emergency_contacts": [
      {"name": "å„¿å­", "phone": "13800138000", "relation": "son"},
      {"name": "ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ", "phone": "120", "relation": "medical"}
    ]
  },
  "monitoring_devices": {
    "motion_sensors": ["MOTION_BEDROOM", "MOTION_LIVING", "MOTION_KITCHEN"],
    "emergency_button": "EMERGENCY_001",
    "sleep_monitor": "SLEEP_001",
    "door_sensor": "DOOR_MAIN"
  },
  "alert_rules": [
    {
      "rule_id": "no_activity_12h",
      "condition": "no_motion_detected > 12 hours",
      "severity": "critical",
      "action": "notify_emergency_contacts"
    },
    {
      "rule_id": "bathroom_fall_risk",
      "condition": "bathroom_motion > 30min AND nighttime",
      "severity": "warning",
      "action": "send_check_reminder"
    }
  ]
}
```

### 15.3 å®ç°ä»£ç 

```python
from datetime import datetime, timedelta
import logging

logger = logging.getLogger(__name__)

class ElderlyCareMonitor:
    """è€äººå±…å®¶å®‰å…¨ç›‘æŠ¤ç³»ç»Ÿ"""

    def __init__(self, storage: SmartHomeStorage):
        self.storage = storage
        self.alert_cooldown = {}  # å‘Šè­¦å†·å´æ—¶é—´

    def check_activity_status(self, user_id: str, motion_sensors: List[str],
                             hours: int = 12) -> Dict:
        """æ£€æŸ¥æ´»åŠ¨çŠ¶æ€"""
        latest_activity = None
        sensor_with_activity = None

        for sensor_id in motion_sensors:
            events = self.storage.get_recent_events(sensor_id, "motion_detected", limit=1)
            if events:
                event_time = events[0].get("event_time")
                if latest_activity is None or event_time > latest_activity:
                    latest_activity = event_time
                    sensor_with_activity = sensor_id

        if latest_activity is None:
            return {
                "status": "unknown",
                "last_activity": None,
                "hours_since_activity": None,
                "alert_needed": False
            }

        hours_since = (datetime.now() - latest_activity).total_seconds() / 3600

        status = "normal"
        alert_needed = False

        if hours_since > 24:
            status = "critical"
            alert_needed = True
        elif hours_since > 12:
            status = "warning"
            alert_needed = True
        elif hours_since > 6:
            status = "attention"

        return {
            "status": status,
            "last_activity": latest_activity,
            "hours_since_activity": round(hours_since, 2),
            "last_sensor": sensor_with_activity,
            "alert_needed": alert_needed
        }

    def check_sleep_pattern(self, sleep_monitor_id: str, days: int = 7) -> Dict:
        """æ£€æŸ¥ç¡çœ æ¨¡å¼"""
        # è·å–ç¡çœ ç›‘æµ‹æ•°æ®
        sleep_data = self.storage.get_sensor_statistics(
            sleep_monitor_id, "sleep_quality", hours=days*24
        )

        avg_sleep_duration = sleep_data.get("avg_value", 0)

        pattern_analysis = {
            "avg_sleep_hours": round(avg_sleep_duration, 1),
            "pattern": "normal"
        }

        if avg_sleep_duration < 5:
            pattern_analysis["pattern"] = "insufficient_sleep"
            pattern_analysis["alert"] = "ç¡çœ æ—¶é—´ä¸è¶³ï¼Œå»ºè®®å…³æ³¨å¥åº·çŠ¶å†µ"
        elif avg_sleep_duration > 10:
            pattern_analysis["pattern"] = "excessive_sleep"
            pattern_analysis["alert"] = "ç¡çœ æ—¶é—´è¿‡é•¿ï¼Œå»ºè®®å…³æ³¨å¥åº·çŠ¶å†µ"

        return pattern_analysis

    def process_emergency_button(self, button_id: str, user_id: str):
        """å¤„ç†ç´§æ€¥æŒ‰é’®äº‹ä»¶"""
        logger.critical(f"EMERGENCY BUTTON PRESSED: {button_id}, User: {user_id}")

        # è·å–ç´§æ€¥è”ç³»äºº
        user_prefs = self.storage.get_user_preferences(user_id)
        emergency_contacts = user_prefs.get("emergency_contacts", [])

        # å­˜å‚¨ç´§æ€¥äº‹ä»¶
        self.storage.store_event(button_id, "emergency_alert", {
            "user_id": user_id,
            "alert_type": "emergency_button",
            "contacts_notified": len(emergency_contacts)
        })

        # è§¦å‘å‘Šè­¦
        alert_result = {
            "timestamp": datetime.now().isoformat(),
            "severity": "critical",
            "message": "ç´§æ€¥æŒ‰é’®è¢«æŒ‰ä¸‹",
            "contacts_notified": [c["name"] for c in emergency_contacts]
        }

        return alert_result

    def run_daily_check(self, user_id: str, config: Dict):
        """æ‰§è¡Œæ¯æ—¥æ£€æŸ¥"""
        results = {
            "user_id": user_id,
            "check_time": datetime.now().isoformat(),
            "checks": []
        }

        # æ£€æŸ¥æ´»åŠ¨çŠ¶æ€
        activity_status = self.check_activity_status(
            user_id, config.get("motion_sensors", [])
        )
        results["checks"].append({"type": "activity", "result": activity_status})

        # æ£€æŸ¥ç¡çœ æ¨¡å¼
        if "sleep_monitor" in config:
            sleep_pattern = self.check_sleep_pattern(config["sleep_monitor"])
            results["checks"].append({"type": "sleep", "result": sleep_pattern})

        # æ±‡æ€»å¥åº·çŠ¶æ€
        critical_alerts = [c for c in results["checks"]
                          if c["result"].get("status") == "critical" or
                          c["result"].get("alert_needed")]

        results["overall_status"] = "critical" if critical_alerts else "normal"
        results["alert_count"] = len(critical_alerts)

        return results

# ä½¿ç”¨ç¤ºä¾‹
def demo_elderly_care():
    storage = SmartHomeStorage("postgresql://user:pass@localhost/smarthome")
    monitor = ElderlyCareMonitor(storage)

    config = {
        "motion_sensors": ["MOTION_BEDROOM", "MOTION_LIVING"],
        "sleep_monitor": "SLEEP_001"
    }

    # æ¨¡æ‹Ÿæ¯æ—¥æ£€æŸ¥
    results = monitor.run_daily_check("elderly_001", config)
    print(f"Daily check for {results['user_id']}: {results['overall_status']}")
    for check in results["checks"]:
        print(f"  - {check['type']}: {check['result']}")
```

---

## 16. æ¡ˆä¾‹16ï¼šå…¨å±‹æ™ºèƒ½èƒ½è€—ä¼˜åŒ–ç³»ç»Ÿ

### 16.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
å…¨å±‹æ™ºèƒ½èƒ½è€—ä¼˜åŒ–ç³»ç»Ÿé€šè¿‡åˆ†æå„è®¾å¤‡çš„èƒ½è€—æ¨¡å¼ã€ç”µä»·æ—¶æ®µã€ç”¨æˆ·ç”Ÿæ´»ä¹ æƒ¯ï¼Œè‡ªåŠ¨ä¼˜åŒ–è®¾å¤‡è¿è¡Œæ—¶é—´ï¼Œåœ¨ä¸å½±å“ç”¨æˆ·ä½“éªŒçš„å‰æä¸‹å®ç°æœ€å¤§èŠ‚èƒ½æ•ˆæœã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦å®æ—¶ç›‘æµ‹å„è®¾å¤‡èƒ½è€—
- éœ€è¦è·å–åˆ†æ—¶ç”µä»·ä¿¡æ¯
- éœ€è¦å­¦ä¹ ç”¨æˆ·ç”Ÿæ´»ä¹ æƒ¯
- éœ€è¦å¹³è¡¡èŠ‚èƒ½ä¸èˆ’é€‚åº¦

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨æœºå™¨å­¦ä¹ é¢„æµ‹èƒ½è€—æ¨¡å¼ï¼Œç»“åˆç”µä»·æ—¶æ®µè‡ªåŠ¨è°ƒæ•´é«˜è€—èƒ½è®¾å¤‡çš„è¿è¡Œæ—¶é—´ï¼Œå®ç°æ™ºèƒ½èŠ‚èƒ½ã€‚

### 16.2 Schemaå®šä¹‰

**èƒ½è€—ä¼˜åŒ–ç³»ç»ŸSchema**ï¼š

```json
{
  "scene_id": "scene_energy_optimization",
  "scene_name": "å…¨å±‹èƒ½è€—æ™ºèƒ½ä¼˜åŒ–",
  "energy_tariff": {
    "peak_hours": ["08:00-11:00", "18:00-22:00"],
    "peak_price": 0.85,
    "valley_hours": ["23:00-07:00"],
    "valley_price": 0.35,
    "normal_price": 0.55
  },
  "controllable_devices": {
    "water_heater": {
      "device_id": "HEATER_001",
      "power_kw": 2.5,
      "flexible_hours": ["23:00-06:00"],
      "priority": "medium"
    },
    "dishwasher": {
      "device_id": "DISHWASHER_001",
      "power_kw": 1.8,
      "flexible": true,
      "max_delay_hours": 4
    },
    "washing_machine": {
      "device_id": "WASHER_001",
      "power_kw": 2.0,
      "flexible": true,
      "max_delay_hours": 6
    }
  },
  "optimization_goal": {
    "target_savings_percent": 20,
    "comfort_threshold": 0.9,
    "max_inconvenience_minutes": 30
  }
}
```

### 16.3 å®ç°ä»£ç 

```python
class EnergyOptimizationController:
    """èƒ½è€—ä¼˜åŒ–æ§åˆ¶å™¨"""

    def __init__(self, storage: SmartHomeStorage):
        self.storage = storage

    def get_current_tariff(self, tariff_config: Dict) -> Tuple[str, float]:
        """è·å–å½“å‰ç”µä»·æ—¶æ®µ"""
        current_time = datetime.now()
        current_hour = current_time.hour
        current_minute = current_time.minute
        current_minutes = current_hour * 60 + current_minute

        # è§£æå³°è°·æ—¶æ®µ
        def parse_time_range(time_str):
            start, end = time_str.split("-")
            start_h, start_m = map(int, start.split(":"))
            end_h, end_m = map(int, end.split(":"))
            return start_h * 60 + start_m, end_h * 60 + end_m

        # æ£€æŸ¥å³°æ—¶
        for period in tariff_config.get("peak_hours", []):
            start, end = parse_time_range(period)
            if start <= current_minutes < end:
                return "peak", tariff_config["peak_price"]

        # æ£€æŸ¥è°·æ—¶
        for period in tariff_config.get("valley_hours", []):
            start, end = parse_time_range(period)
            if start <= current_minutes < end:
                return "valley", tariff_config["valley_price"]

        return "normal", tariff_config["normal_price"]

    def calculate_optimal_schedule(self, device: Dict, tariff_config: Dict,
                                   user_schedule: Dict) -> Dict:
        """è®¡ç®—è®¾å¤‡æœ€ä¼˜è¿è¡Œæ—¶é—´"""
        current_period, current_price = self.get_current_tariff(tariff_config)

        # å¦‚æœå½“å‰æ˜¯è°·æ—¶ä¸”è®¾å¤‡çµæ´»å¯è°ƒï¼Œç«‹å³è¿è¡Œ
        if current_period == "valley" and device.get("flexible", False):
            return {
                "action": "run_now",
                "reason": "å½“å‰ä¸ºè°·æ—¶ç”µä»·ï¼Œæ˜¯æœ€ä¼˜è¿è¡Œæ—¶æœº",
                "estimated_cost": device["power_kw"] * current_price
            }

        # å¦‚æœæ˜¯å³°æ—¶ï¼Œæ¨è¿Ÿåˆ°è°·æ—¶
        if current_period == "peak" and device.get("flexible", False):
            next_valley_start = None
            for period in tariff_config.get("valley_hours", []):
                start, _ = map(lambda x: int(x.split(":")[0]) * 60 + int(x.split(":")[1]),
                              period.split("-"))
                if start > datetime.now().hour * 60 + datetime.now().minute:
                    next_valley_start = start
                    break

            if next_valley_start:
                valley_price = tariff_config["valley_price"]
                savings = device["power_kw"] * (current_price - valley_price)
                return {
                    "action": "delay",
                    "delay_until": f"{next_valley_start // 60:02d}:{next_valley_start % 60:02d}",
                    "reason": "å³°æ—¶ç”µä»·é«˜ï¼Œå»ºè®®æ¨è¿Ÿåˆ°è°·æ—¶è¿è¡Œ",
                    "estimated_savings": round(savings, 2)
                }

        return {
            "action": "run_now",
            "reason": "è®¾å¤‡ä¸å¯çµæ´»è°ƒåº¦æˆ–å·²åˆ°æœ€ä¼˜æ—¶æ®µ"
        }

    def optimize_daily_energy(self, devices: List[Dict], tariff_config: Dict):
        """ä¼˜åŒ–å…¨å¤©èƒ½è€—"""
        optimization_results = []
        total_potential_savings = 0

        for device in devices:
            schedule = self.calculate_optimal_schedule(device, tariff_config, {})
            optimization_results.append({
                "device_id": device["device_id"],
                "device_name": device.get("device_name", device["device_id"]),
                "schedule": schedule
            })

            if schedule.get("estimated_savings"):
                total_potential_savings += schedule["estimated_savings"]

            # å­˜å‚¨ä¼˜åŒ–å†³ç­–
            self.storage.store_control_command(
                device["device_id"],
                "energy_optimization",
                schedule
            )

        logger.info(f"Energy optimization completed. Potential daily savings: ${total_potential_savings:.2f}")

        return {
            "results": optimization_results,
            "total_potential_savings": round(total_potential_savings, 2)
        }

    def generate_energy_report(self, days: int = 30) -> Dict:
        """ç”Ÿæˆèƒ½è€—æŠ¥å‘Š"""
        # è·å–å†å²èƒ½è€—æ•°æ®
        room_energy = self.storage.get_energy_consumption_by_room(days=days)

        total_consumption = sum(row[1] for row in room_energy) if room_energy else 0

        return {
            "report_period_days": days,
            "total_consumption_kwh": round(total_consumption, 2),
            "room_breakdown": [
                {"room": row[0], "consumption": round(row[1], 2), "percentage": round(row[1]/total_consumption*100, 1)}
                for row in room_energy
            ] if total_consumption > 0 else [],
            "generated_at": datetime.now().isoformat()
        }

# ä½¿ç”¨ç¤ºä¾‹
def demo_energy_optimization():
    storage = SmartHomeStorage("postgresql://user:pass@localhost/smarthome")
    controller = EnergyOptimizationController(storage)

    tariff_config = {
        "peak_hours": ["08:00-11:00", "18:00-22:00"],
        "peak_price": 0.85,
        "valley_hours": ["23:00-07:00"],
        "valley_price": 0.35,
        "normal_price": 0.55
    }

    devices = [
        {"device_id": "DISHWASHER_001", "device_name": "æ´—ç¢—æœº", "power_kw": 1.8, "flexible": True},
        {"device_id": "WASHER_001", "device_name": "æ´—è¡£æœº", "power_kw": 2.0, "flexible": True}
    ]

    result = controller.optimize_daily_energy(devices, tariff_config)
    print(f"Optimization potential: ${result['total_potential_savings']}/day")
```

---

**å‚è€ƒæ–‡æ¡£**ï¼š

- `01_Overview.md` - æ¦‚è¿°
- `02_Formal_Definition.md` - å½¢å¼åŒ–å®šä¹‰
- `03_Standards.md` - æ ‡å‡†å¯¹æ ‡
- `04_Transformation.md` - è½¬æ¢ä½“ç³»

**åˆ›å»ºæ—¶é—´**ï¼š2025-01-21
**æœ€åæ›´æ–°**ï¼š2025-02-14ï¼ˆæ–°å¢5ä¸ªçœŸå®åœºæ™¯æ¡ˆä¾‹ï¼‰
