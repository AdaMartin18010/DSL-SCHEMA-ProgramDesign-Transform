# ç½‘ç»œç®¡ç†Schemaå®è·µæ¡ˆä¾‹

## ğŸ“‘ ç›®å½•

- [ç½‘ç»œç®¡ç†Schemaå®è·µæ¡ˆä¾‹](#ç½‘ç»œç®¡ç†schemaå®è·µæ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¡ˆä¾‹æ¦‚è¿°](#1-æ¡ˆä¾‹æ¦‚è¿°)
  - [2. æ¡ˆä¾‹1ï¼šä¼ä¸šç½‘ç»œè®¾å¤‡ç®¡ç†ç³»ç»Ÿ](#2-æ¡ˆä¾‹1ä¼ä¸šç½‘ç»œè®¾å¤‡ç®¡ç†ç³»ç»Ÿ)
    - [2.1 ä¸šåŠ¡èƒŒæ™¯](#21-ä¸šåŠ¡èƒŒæ™¯)
    - [2.2 æŠ€æœ¯æŒ‘æˆ˜](#22-æŠ€æœ¯æŒ‘æˆ˜)
    - [2.3 è§£å†³æ–¹æ¡ˆ](#23-è§£å†³æ–¹æ¡ˆ)
    - [2.4 å®Œæ•´ä»£ç å®ç°](#24-å®Œæ•´ä»£ç å®ç°)
    - [2.5 æ•ˆæœè¯„ä¼°](#25-æ•ˆæœè¯„ä¼°)

---

## 1. æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›ç½‘ç»œç®¡ç†Schemaåœ¨å®é™…ä¼ä¸šåº”ç”¨ä¸­çš„å®è·µæ¡ˆä¾‹ï¼Œæ¶µç›–ç½‘ç»œè®¾å¤‡ç®¡ç†ã€SNMPç›‘æ§ã€ç½‘ç»œæ‹“æ‰‘ç®¡ç†ç­‰çœŸå®åœºæ™¯ã€‚

**æ¡ˆä¾‹ç±»å‹**ï¼š

1. **ç½‘ç»œè®¾å¤‡ç®¡ç†ç³»ç»Ÿ**ï¼šç½‘ç»œè®¾å¤‡æ³¨å†Œå’Œç®¡ç†
2. **SNMPç›‘æ§ç³»ç»Ÿ**ï¼šä½¿ç”¨SNMPç›‘æ§è®¾å¤‡çŠ¶æ€
3. **ç½‘ç»œæ‹“æ‰‘ç®¡ç†ç³»ç»Ÿ**ï¼šç½‘ç»œæ‹“æ‰‘å‘ç°å’Œç®¡ç†
4. **ç½‘ç»œæ€§èƒ½ç›‘æ§ç³»ç»Ÿ**ï¼šç½‘ç»œæ€§èƒ½ç›‘æ§å’Œåˆ†æ
5. **ç½‘ç»œç®¡ç†æ•°æ®å­˜å‚¨ä¸åˆ†æç³»ç»Ÿ**ï¼šç½‘ç»œç®¡ç†æ•°æ®åˆ†æå’Œç›‘æ§

**å‚è€ƒä¼ä¸šæ¡ˆä¾‹**ï¼š

- **SNMPæ ‡å‡†**ï¼šSNMPåè®®æ ‡å‡†
- **ç½‘ç»œç®¡ç†æœ€ä½³å®è·µ**ï¼šç½‘ç»œç®¡ç†æœ€ä½³å®è·µ

---

## 2. æ¡ˆä¾‹1ï¼šä¼ä¸šç½‘ç»œè®¾å¤‡ç®¡ç†ç³»ç»Ÿ

### 2.1 ä¸šåŠ¡èƒŒæ™¯

**ä¼ä¸šèƒŒæ™¯**ï¼š
åå¤é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸æ˜¯ä¸­å›½é¢†å…ˆçš„å…¨å›½æ€§è‚¡ä»½åˆ¶å•†ä¸šé“¶è¡Œä¹‹ä¸€ï¼Œæˆç«‹äº1992å¹´ï¼Œæ€»éƒ¨ä½äºåŒ—äº¬ï¼Œåœ¨å…¨å›½è®¾æœ‰43å®¶ä¸€çº§åˆ†è¡Œã€è¶…è¿‡1000å®¶è¥ä¸šç½‘ç‚¹ï¼Œå‘˜å·¥æ€»æ•°è¶…è¿‡4ä¸‡äººã€‚æˆªè‡³2024å¹´åº•ï¼Œåå¤é“¶è¡Œæ€»èµ„äº§è¾¾4.2ä¸‡äº¿å…ƒäººæ°‘å¸ï¼Œå¹´è¥ä¸šæ”¶å…¥è¶…è¿‡1000äº¿å…ƒï¼ŒæœåŠ¡ä¸ªäººå®¢æˆ·è¶…è¿‡5000ä¸‡ã€ä¼ä¸šå®¢æˆ·è¶…è¿‡50ä¸‡ã€‚

åå¤é“¶è¡Œç§‘æŠ€éƒ¨é—¨è´Ÿè´£å…¨è¡ŒITåŸºç¡€è®¾æ–½çš„å»ºè®¾å’Œè¿ç»´ï¼ŒåŒ…æ‹¬200å¤šä¸ªæ•°æ®ä¸­å¿ƒå’Œæœºæˆ¿ã€è¶…è¿‡15ä¸‡å°ç½‘ç»œè®¾å¤‡ï¼ˆäº¤æ¢æœºã€è·¯ç”±å™¨ã€é˜²ç«å¢™ã€è´Ÿè½½å‡è¡¡ç­‰ï¼‰ã€8000å¤šå…¬é‡Œå…‰çº¤é“¾è·¯ã€‚ç½‘ç»œè¦†ç›–æ€»è¡Œã€åˆ†è¡Œã€æ”¯è¡Œã€è‡ªåŠ©é“¶è¡Œç­‰å¤šä¸ªå±‚çº§ï¼Œæ”¯æ’‘ç€æ ¸å¿ƒä¸šåŠ¡ç³»ç»Ÿã€ç½‘ä¸Šé“¶è¡Œã€æ‰‹æœºé“¶è¡Œã€æ”¯ä»˜æ¸…ç®—ç­‰å…³é”®ä¸šåŠ¡çš„ç¨³å®šè¿è¡Œã€‚

**ä¸šåŠ¡ç—›ç‚¹**ï¼š

1. **è®¾å¤‡ç®¡ç†åˆ†æ•£**ï¼šç½‘ç»œè®¾å¤‡åˆ†æ•£åœ¨å…¨å›½1000å¤šä¸ªç½‘ç‚¹ï¼Œä½¿ç”¨Excelè¡¨æ ¼è®°å½•è®¾å¤‡ä¿¡æ¯ï¼Œæ•°æ®æ›´æ–°ä¸åŠæ—¶ï¼Œè®¾å¤‡å°è´¦ä¸å®é™…éƒ¨ç½²æƒ…å†µåå·®è¶…è¿‡15%ï¼Œèµ„äº§ç®¡ç†å›°éš¾ã€‚

2. **ç›‘æ§è¦†ç›–ä¸è¶³**ï¼šä»…èƒ½å¯¹30%çš„å…³é”®è®¾å¤‡å®ç°7Ã—24å°æ—¶ç›‘æ§ï¼Œæ™®é€šè®¾å¤‡æ•…éšœå‘ç°å¹³å‡å»¶è¿Ÿ2å°æ—¶ï¼Œå¯¼è‡´ä¸šåŠ¡ä¸­æ–­æ—¶é—´å»¶é•¿ã€‚2023å¹´å› ç½‘ç»œæ•…éšœå¯¼è‡´çš„ä¸šåŠ¡ä¸­æ–­è¾¾28æ¬¡ï¼Œæ€»å½±å“æ—¶é—´è¶…è¿‡100å°æ—¶ã€‚

3. **æ•…éšœå®šä½å›°éš¾**ï¼šç½‘ç»œæ•…éšœæ¶‰åŠå¤šä¸ªå‚å•†è®¾å¤‡ï¼ˆåä¸ºã€H3Cã€æ€ç§‘ã€é”æ·ç­‰ï¼‰ï¼Œå„å‚å•†ç®¡ç†å·¥å…·å’Œæ—¥å¿—æ ¼å¼ä¸ç»Ÿä¸€ï¼Œè·¨å‚å•†æ•…éšœå®šä½å¹³å‡éœ€è¦3-4å°æ—¶ï¼Œå½±å“SLAè¾¾æˆã€‚

4. **é…ç½®å˜æ›´é£é™©é«˜**ï¼šç½‘ç»œé…ç½®å˜æ›´ä¾èµ–äººå·¥æ“ä½œï¼Œç¼ºä¹å˜æ›´å½±å“è¯„ä¼°å’Œå›æ»šæœºåˆ¶ï¼Œ2023å¹´å› é…ç½®å˜æ›´å¯¼è‡´çš„æ•…éšœå æ¯”è¾¾35%ï¼Œå•æ¬¡æ•…éšœæ¢å¤æ—¶é—´å¹³å‡4å°æ—¶ã€‚

5. **åˆè§„å®¡è®¡å›°éš¾**ï¼šé¢å¯¹é“¶ä¿ç›‘ä¼šã€äººæ°‘é“¶è¡Œçš„ç½‘ç»œå®‰å…¨æ£€æŸ¥ï¼Œæ— æ³•å¿«é€Ÿæä¾›ç½‘ç»œæ‹“æ‰‘ã€è®¾å¤‡æ¸…å•ã€è®¿é—®æ§åˆ¶ç­‰åˆè§„ææ–™ï¼Œå‡†å¤‡ä¸€æ¬¡æ£€æŸ¥éœ€è¦æŠ•å…¥20äººå¤©ã€‚

**ä¸šåŠ¡ç›®æ ‡**ï¼š

- å»ºç«‹ç»Ÿä¸€çš„ç½‘ç»œè®¾å¤‡ç®¡ç†å¹³å°ï¼Œå®ç°15ä¸‡å°è®¾å¤‡çš„é›†ä¸­çº³ç®¡ï¼Œè®¾å¤‡å°è´¦å‡†ç¡®ç‡è¾¾åˆ°99%ä»¥ä¸Š
- å®ç°100%è®¾å¤‡çš„å®æ—¶ç›‘æ§ï¼Œæ•…éšœå‘ç°æ—¶é—´ä»2å°æ—¶ç¼©çŸ­åˆ°30ç§’ä»¥å†…
- æ„å»ºæ™ºèƒ½æ•…éšœå®šä½ç³»ç»Ÿï¼Œè·¨å‚å•†æ•…éšœå®šä½æ—¶é—´ä»3-4å°æ—¶ç¼©çŸ­åˆ°15åˆ†é’Ÿä»¥å†…
- å®ç°é…ç½®å˜æ›´è‡ªåŠ¨åŒ–ï¼Œé…ç½®é”™è¯¯ç‡é™ä½90%ï¼Œå˜æ›´å›æ»šæ—¶é—´æ§åˆ¶åœ¨5åˆ†é’Ÿå†…
- å»ºç«‹åˆè§„å®¡è®¡è‡ªåŠ¨åŒ–èƒ½åŠ›ï¼Œç›‘ç®¡æ£€æŸ¥ææ–™å‡†å¤‡æ—¶é—´ä»20äººå¤©ç¼©çŸ­åˆ°1å°æ—¶

### 2.2 æŠ€æœ¯æŒ‘æˆ˜

1. **å¤§è§„æ¨¡è®¾å¤‡å¹¶å‘ç®¡ç†**ï¼šéœ€è¦åŒæ—¶ç®¡ç†15ä¸‡å°å¼‚æ„è®¾å¤‡ï¼Œæ”¯æŒSNMP v2/v3ã€NETCONFã€SSHç­‰å¤šç§ç®¡ç†åè®®ï¼Œè®¾å¤‡å¹¶å‘è¿æ¥ç®¡ç†æ˜¯æ ¸å¿ƒæŒ‘æˆ˜ã€‚

2. **è·¨å‚å•†æ•°æ®æ ‡å‡†åŒ–**ï¼šåä¸ºã€H3Cã€æ€ç§‘ç­‰å‚å•†çš„SNMP MIBã€å‘½ä»¤è¡Œæ¥å£å·®å¼‚å·¨å¤§ï¼Œéœ€è¦æ„å»ºç»Ÿä¸€çš„æ•°æ®æ¨¡å‹ï¼ˆåŸºäºRFCæ ‡å‡†ï¼‰å®ç°æ•°æ®å½’ä¸€åŒ–ã€‚

3. **ç½‘ç»œæ‹“æ‰‘è‡ªåŠ¨å‘ç°**ï¼šéœ€è¦åŸºäºSNMPã€CDP/LLDPã€è·¯ç”±åè®®ç­‰å¤šç§æŠ€æœ¯ï¼Œå®ç°å…¨ç½‘æ‹“æ‰‘è‡ªåŠ¨å‘ç°ï¼Œæ”¯æŒäºŒå±‚ã€ä¸‰å±‚æ‹“æ‰‘å±•ç¤ºï¼Œå¹¶å®æ—¶æ›´æ–°æ‹“æ‰‘å˜åŒ–ã€‚

4. **æµå¼æ•°æ®å¤„ç†ä¸å­˜å‚¨**ï¼šå…¨ç½‘è®¾å¤‡æ¯ç§’äº§ç”Ÿè¶…è¿‡500ä¸‡æ¡æ€§èƒ½æŒ‡æ ‡ï¼ˆKPIï¼‰å’Œæ—¥å¿—ï¼Œéœ€è¦æ„å»ºé«˜ååæµå¤„ç†ï¼ˆKafka+Flinkï¼‰å’Œæ—¶åºæ•°æ®åº“ï¼ˆInfluxDBï¼‰æ¶æ„ã€‚

5. **æ™ºèƒ½æ•…éšœå…³è”åˆ†æ**ï¼šéœ€è¦å°†å‘Šè­¦ã€æ€§èƒ½æŒ‡æ ‡ã€æ‹“æ‰‘ã€å˜æ›´è®°å½•ç­‰å¤šç»´æ•°æ®å…³è”ï¼Œåˆ©ç”¨æœºå™¨å­¦ä¹ ï¼ˆå¼‚å¸¸æ£€æµ‹ã€æ ¹å› åˆ†æï¼‰å®ç°æ™ºèƒ½æ•…éšœå®šä½ã€‚

### 2.3 è§£å†³æ–¹æ¡ˆ

**åŸºäºSNMP/NETCONFåè®®æ„å»ºç»Ÿä¸€çš„ç½‘ç»œè®¾å¤‡ç®¡ç†å¹³å°ï¼ˆIPAM/DCIMï¼‰ï¼Œå®ç°è®¾å¤‡å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€å®æ—¶ç›‘æ§ã€æ™ºèƒ½å‘Šè­¦ã€é…ç½®ç®¡ç†ã€æ‹“æ‰‘å¯è§†åŒ–ç­‰åŠŸèƒ½**ã€‚

æ ¸å¿ƒæŠ€æœ¯æ¶æ„ï¼š
- é‡‡é›†å±‚ï¼šSNMP Collectoré›†ç¾¤ï¼ˆæ”¯æŒv1/v2c/v3ï¼‰+ NETCONF Agent + SSH/Telneté€‚é…
- æ•°æ®å±‚ï¼šPostgreSQLï¼ˆèµ„äº§æ•°æ®ï¼‰+ InfluxDBï¼ˆæ—¶åºæ•°æ®ï¼‰+ Elasticsearchï¼ˆæ—¥å¿—ï¼‰+ Neo4jï¼ˆæ‹“æ‰‘ï¼‰
- è®¡ç®—å±‚ï¼šKafkaï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰+ Flinkï¼ˆæµå¤„ç†ï¼‰+ Spark MLï¼ˆæ™ºèƒ½åˆ†æï¼‰
- åº”ç”¨å±‚ï¼šSpring Cloudå¾®æœåŠ¡ + Vue.jså‰ç«¯ + EChartsæ‹“æ‰‘å¯è§†åŒ–

### 2.4 å®Œæ•´ä»£ç å®ç°

**ç½‘ç»œè®¾å¤‡ç®¡ç†Schemaï¼ˆå®Œæ•´ç¤ºä¾‹ï¼‰**ï¼š

```python
#!/usr/bin/env python3
"""
ç½‘ç»œç®¡ç†Schemaå®ç° - åå¤é“¶è¡Œç½‘ç»œè®¾å¤‡ç®¡ç†ç³»ç»Ÿ
"""

from typing import Dict, List, Optional, Set, Tuple
from datetime import datetime, timedelta
from dataclasses import dataclass, field
from enum import Enum
from decimal import Decimal
import hashlib
import json


class DeviceType(str, Enum):
    """è®¾å¤‡ç±»å‹"""
    ROUTER = "Router"
    SWITCH = "Switch"
    FIREWALL = "Firewall"
    LOAD_BALANCER = "LoadBalancer"
    ACCESS_POINT = "AccessPoint"
    OPTICAL = "Optical"
    SERVER = "Server"


class DeviceStatus(str, Enum):
    """è®¾å¤‡çŠ¶æ€"""
    UP = "Up"
    DOWN = "Down"
    WARNING = "Warning"
    UNKNOWN = "Unknown"
    MAINTENANCE = "Maintenance"


class VendorType(str, Enum):
    """å‚å•†ç±»å‹"""
    HUAWEI = "Huawei"
    H3C = "H3C"
    CISCO = "Cisco"
    RUIJIE = "Ruijie"
    ZTE = "ZTE"
    F5 = "F5"
    PALO_ALTO = "PaloAlto"


class SNMPVersion(str, Enum):
    """SNMPç‰ˆæœ¬"""
    V1 = "v1"
    V2C = "v2c"
    V3 = "v3"


class AlertSeverity(str, Enum):
    """å‘Šè­¦çº§åˆ«"""
    CRITICAL = "Critical"
    MAJOR = "Major"
    MINOR = "Minor"
    WARNING = "Warning"
    INFO = "Info"


@dataclass
class DeviceLocation:
    """è®¾å¤‡ä½ç½®"""
    site_id: str
    site_name: str
    city: str
    province: str
    datacenter: str
    room: str
    rack: str
    position: str  # Uä½


@dataclass
class NetworkInterface:
    """ç½‘ç»œæ¥å£"""
    interface_id: str
    interface_name: str
    interface_type: str  # Ethernet, Loopback, VLANç­‰
    mac_address: Optional[str] = None
    ip_address: Optional[str] = None
    netmask: Optional[str] = None
    speed_mbps: int = 1000
    admin_status: str = "up"
    oper_status: str = "down"
    in_octets: int = 0
    out_octets: int = 0
    in_errors: int = 0
    out_errors: int = 0
    description: Optional[str] = None
    connected_to: Optional[str] = None  # å¯¹ç«¯è®¾å¤‡
    last_change: Optional[datetime] = None


@dataclass
class NetworkDevice:
    """ç½‘ç»œè®¾å¤‡"""
    device_id: str
    device_name: str
    device_type: DeviceType
    vendor: VendorType
    model: str
    serial_number: str
    ip_address: str
    location: DeviceLocation
    snmp_community: str = "public"
    snmp_version: SNMPVersion = SNMPVersion.V2C
    snmp_port: int = 161
    ssh_port: int = 22
    username: Optional[str] = None
    password_hash: Optional[str] = None
    status: DeviceStatus = DeviceStatus.UNKNOWN
    uptime_seconds: int = 0
    cpu_usage: float = 0.0
    memory_usage: float = 0.0
    interfaces: Dict[str, NetworkInterface] = field(default_factory=dict)
    last_seen: Optional[datetime] = None
    last_poll: Optional[datetime] = None
    created_date: datetime = field(default_factory=datetime.now)
    tags: List[str] = field(default_factory=list)
    
    def add_interface(self, interface: NetworkInterface):
        """æ·»åŠ æ¥å£"""
        self.interfaces[interface.interface_id] = interface
    
    def update_status(self, status: DeviceStatus):
        """æ›´æ–°çŠ¶æ€"""
        self.status = status
        if status == DeviceStatus.UP:
            self.last_seen = datetime.now()
    
    def get_sys_oid(self) -> str:
        """è·å–ç³»ç»ŸOIDï¼ˆæ ¹æ®å‚å•†ï¼‰"""
        oid_map = {
            VendorType.HUAWEI: "1.3.6.1.4.1.2011",
            VendorType.H3C: "1.3.6.1.4.1.25506",
            VendorType.CISCO: "1.3.6.1.4.1.9",
            VendorType.RUIJIE: "1.3.6.1.4.1.4881",
            VendorType.ZTE: "1.3.6.1.4.1.3902"
        }
        return oid_map.get(self.vendor, "1.3.6.1.2.1.1")


@dataclass
class SNMPData:
    """SNMPæ•°æ®"""
    data_id: str
    device_id: str
    timestamp: datetime
    oid: str
    value: str
    value_type: str  # Integer, String, Counter, Gaugeç­‰
    metric_name: Optional[str] = None


@dataclass
class NetworkAlert:
    """ç½‘ç»œå‘Šè­¦"""
    alert_id: str
    device_id: str
    alert_type: str
    severity: AlertSeverity
    message: str
    timestamp: datetime
    source: str  # å‘Šè­¦æ¥æºï¼šSNMP Trapã€é˜ˆå€¼æ£€æµ‹ã€æ‹“æ‰‘åˆ†æç­‰
    is_acknowledged: bool = False
    acknowledged_by: Optional[str] = None
    acknowledged_time: Optional[datetime] = None
    cleared: bool = False
    cleared_time: Optional[datetime] = None
    root_cause_device: Optional[str] = None  # æ ¹å› è®¾å¤‡ï¼ˆç”¨äºå…³è”åˆ†æï¼‰


@dataclass
class TopologyLink:
    """æ‹“æ‰‘è¿æ¥"""
    link_id: str
    source_device: str
    source_interface: str
    target_device: str
    target_interface: str
    link_type: str  # Layer2, Layer3, Trunkç­‰
    bandwidth_mbps: int = 1000
    is_active: bool = True
    last_verified: Optional[datetime] = None


@dataclass
class ConfigurationBackup:
    """é…ç½®å¤‡ä»½"""
    backup_id: str
    device_id: str
    config_content: str
    backup_time: datetime
    config_hash: str
    backup_type: str = "Automatic"  # Automatic, Manual
    change_description: Optional[str] = None


@dataclass
class NetworkManagementStorage:
    """ç½‘ç»œç®¡ç†æ•°æ®å­˜å‚¨"""
    devices: Dict[str, NetworkDevice] = field(default_factory=dict)
    snmp_data: List[SNMPData] = field(default_factory=list)
    alerts: Dict[str, NetworkAlert] = field(default_factory=dict)
    topology_links: Dict[str, TopologyLink] = field(default_factory=dict)
    config_backups: Dict[str, List[ConfigurationBackup]] = field(default_factory=lambda: defaultdict(list))
    
    def store_device(self, device: NetworkDevice):
        """å­˜å‚¨è®¾å¤‡"""
        self.devices[device.device_id] = device
    
    def get_device(self, device_id: str) -> Optional[NetworkDevice]:
        """è·å–è®¾å¤‡"""
        return self.devices.get(device_id)
    
    def store_snmp_data(self, data: SNMPData):
        """å­˜å‚¨SNMPæ•°æ®"""
        self.snmp_data.append(data)
        
        # æ›´æ–°è®¾å¤‡æœ€ååœ¨çº¿æ—¶é—´
        device = self.devices.get(data.device_id)
        if device:
            device.last_seen = data.timestamp
            device.last_poll = data.timestamp
            if device.status == DeviceStatus.UNKNOWN:
                device.status = DeviceStatus.UP
    
    def get_device_snmp_data(self, device_id: str, 
                            oid: Optional[str] = None,
                            start_time: Optional[datetime] = None,
                            end_time: Optional[datetime] = None) -> List[SNMPData]:
        """è·å–è®¾å¤‡SNMPæ•°æ®"""
        data = [d for d in self.snmp_data if d.device_id == device_id]
        if oid:
            data = [d for d in data if d.oid == oid]
        if start_time:
            data = [d for d in data if d.timestamp >= start_time]
        if end_time:
            data = [d for d in data if d.timestamp <= end_time]
        return data
    
    def check_device_status(self, device_id: str) -> DeviceStatus:
        """æ£€æŸ¥è®¾å¤‡çŠ¶æ€ï¼ˆåŸºäºæœ€å seen æ—¶é—´ï¼‰"""
        device = self.devices.get(device_id)
        if not device:
            return DeviceStatus.UNKNOWN
        
        if device.last_seen:
            time_diff = (datetime.now() - device.last_seen).total_seconds()
            if time_diff > 300:  # 5åˆ†é’Ÿæœªæ”¶åˆ°æ•°æ®
                device.status = DeviceStatus.DOWN
            elif time_diff > 120:  # 2åˆ†é’Ÿæœªæ”¶åˆ°æ•°æ®
                device.status = DeviceStatus.WARNING
        
        return device.status
    
    def create_alert(self, device_id: str, alert_type: str, 
                    severity: AlertSeverity, message: str,
                    source: str = "System") -> NetworkAlert:
        """åˆ›å»ºå‘Šè­¦"""
        alert = NetworkAlert(
            alert_id=f"ALERT-{hashlib.sha256(f'{device_id}{message}{datetime.now()}'.encode()).hexdigest()[:12]}",
            device_id=device_id,
            alert_type=alert_type,
            severity=severity,
            message=message,
            timestamp=datetime.now(),
            source=source
        )
        self.alerts[alert.alert_id] = alert
        return alert
    
    def acknowledge_alert(self, alert_id: str, user: str):
        """ç¡®è®¤å‘Šè­¦"""
        alert = self.alerts.get(alert_id)
        if alert:
            alert.is_acknowledged = True
            alert.acknowledged_by = user
            alert.acknowledged_time = datetime.now()
    
    def clear_alert(self, alert_id: str):
        """æ¸…é™¤å‘Šè­¦"""
        alert = self.alerts.get(alert_id)
        if alert:
            alert.cleared = True
            alert.cleared_time = datetime.now()
    
    def get_active_alerts(self, severity: Optional[AlertSeverity] = None) -> List[NetworkAlert]:
        """è·å–æ´»åŠ¨å‘Šè­¦"""
        alerts = [a for a in self.alerts.values() if not a.cleared]
        if severity:
            alerts = [a for a in alerts if a.severity == severity]
        return sorted(alerts, key=lambda x: x.timestamp, reverse=True)
    
    def add_topology_link(self, link: TopologyLink):
        """æ·»åŠ æ‹“æ‰‘è¿æ¥"""
        self.topology_links[link.link_id] = link
    
    def discover_topology(self, device_id: str) -> List[TopologyLink]:
        """æ‹“æ‰‘å‘ç°ï¼ˆåŸºäºCDP/LLDPï¼‰"""
        device = self.devices.get(device_id)
        if not device:
            return []
        
        discovered_links = []
        for interface in device.interfaces.values():
            if interface.connected_to:
                # æŸ¥æ‰¾å¯¹ç«¯è®¾å¤‡
                peer_device = None
                for d in self.devices.values():
                    if d.ip_address == interface.connected_to or d.device_name == interface.connected_to:
                        peer_device = d
                        break
                
                if peer_device:
                    link = TopologyLink(
                        link_id=f"LINK-{device_id}-{interface.interface_id}",
                        source_device=device_id,
                        source_interface=interface.interface_id,
                        target_device=peer_device.device_id,
                        target_interface="unknown",  # éœ€è¦SNMPæŸ¥è¯¢è·å–
                        link_type="Layer2",
                        bandwidth_mbps=interface.speed_mbps
                    )
                    self.add_topology_link(link)
                    discovered_links.append(link)
        
        return discovered_links
    
    def backup_configuration(self, device_id: str, config_content: str,
                            description: str = "") -> ConfigurationBackup:
        """å¤‡ä»½é…ç½®"""
        config_hash = hashlib.sha256(config_content.encode()).hexdigest()
        
        backup = ConfigurationBackup(
            backup_id=f"BKUP-{device_id}-{datetime.now().strftime('%Y%m%d%H%M%S')}",
            device_id=device_id,
            config_content=config_content,
            backup_time=datetime.now(),
            config_hash=config_hash,
            change_description=description
        )
        
        self.config_backups[device_id].append(backup)
        return backup
    
    def compare_configurations(self, device_id: str, 
                              backup_id1: str, 
                              backup_id2: str) -> List[str]:
        """æ¯”è¾ƒé…ç½®å·®å¼‚"""
        backups = self.config_backups.get(device_id, [])
        config1 = next((b.config_content for b in backups if b.backup_id == backup_id1), "")
        config2 = next((b.config_content for b in backups if b.backup_id == backup_id2), "")
        
        # ç®€å•è¡Œå¯¹æ¯”
        lines1 = set(config1.split('\n'))
        lines2 = set(config2.split('\n'))
        
        added = lines2 - lines1
        removed = lines1 - lines2
        
        diff = []
        for line in removed:
            diff.append(f"- {line}")
        for line in added:
            diff.append(f"+ {line}")
        
        return diff
    
    def get_network_summary(self) -> Dict:
        """è·å–ç½‘ç»œæ‘˜è¦"""
        total_devices = len(self.devices)
        up_devices = len([d for d in self.devices.values() if d.status == DeviceStatus.UP])
        down_devices = len([d for d in self.devices.values() if d.status == DeviceStatus.DOWN])
        warning_devices = len([d for d in self.devices.values() if d.status == DeviceStatus.WARNING])
        
        # æŒ‰ç±»å‹ç»Ÿè®¡
        by_type = {}
        for device in self.devices.values():
            by_type[device.device_type.value] = by_type.get(device.device_type.value, 0) + 1
        
        # æŒ‰å‚å•†ç»Ÿè®¡
        by_vendor = {}
        for device in self.devices.values():
            by_vendor[device.vendor.value] = by_vendor.get(device.vendor.value, 0) + 1
        
        # å‘Šè­¦ç»Ÿè®¡
        active_alerts = self.get_active_alerts()
        critical_alerts = len([a for a in active_alerts if a.severity == AlertSeverity.CRITICAL])
        major_alerts = len([a for a in active_alerts if a.severity == AlertSeverity.MAJOR])
        
        return {
            "total_devices": total_devices,
            "up_devices": up_devices,
            "down_devices": down_devices,
            "warning_devices": warning_devices,
            "availability": f"{(up_devices / total_devices * 100):.3f}%" if total_devices > 0 else "0%",
            "by_type": by_type,
            "by_vendor": by_vendor,
            "total_links": len(self.topology_links),
            "active_alerts": len(active_alerts),
            "critical_alerts": critical_alerts,
            "major_alerts": major_alerts
        }
    
    def get_device_performance(self, device_id: str) -> Dict:
        """è·å–è®¾å¤‡æ€§èƒ½"""
        device = self.devices.get(device_id)
        if not device:
            return {}
        
        # è·å–æœ€è¿‘1å°æ—¶çš„SNMPæ•°æ®
        end_time = datetime.now()
        start_time = end_time - timedelta(hours=1)
        snmp_data = self.get_device_snmp_data(device_id, start_time=start_time, end_time=end_time)
        
        return {
            "device_id": device_id,
            "device_name": device.device_name,
            "status": device.status.value,
            "uptime_seconds": device.uptime_seconds,
            "cpu_usage": device.cpu_usage,
            "memory_usage": device.memory_usage,
            "interface_count": len(device.interfaces),
            "snmp_samples_1h": len(snmp_data),
            "last_seen": device.last_seen.isoformat() if device.last_seen else None
        }


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == '__main__':
    # åˆ›å»ºç½‘ç»œç®¡ç†å­˜å‚¨
    storage = NetworkManagementStorage()
    
    # åˆ›å»ºè®¾å¤‡ä½ç½®
    location = DeviceLocation(
        site_id="SITE-BJ-001",
        site_name="åå¤é“¶è¡ŒåŒ—äº¬æ€»è¡Œ",
        city="åŒ—äº¬",
        province="åŒ—äº¬",
        datacenter="DC-PRIMARY",
        room="æœºæˆ¿A",
        rack="RACK-A01",
        position="U15-U16"
    )
    
    # æ³¨å†Œæ ¸å¿ƒäº¤æ¢æœº
    core_switch = NetworkDevice(
        device_id="DEV-CORE-BJ-001",
        device_name="BJ-CORE-SW-01",
        device_type=DeviceType.SWITCH,
        vendor=VendorType.HUAWEI,
        model="CE12808",
        serial_number="210235G7GJ1234567890",
        ip_address="10.1.1.1",
        location=location,
        snmp_community="HxBank2024!",
        snmp_version=SNMPVersion.V3,
        tags=["Core", "Production", "Beijing"]
    )
    
    # æ·»åŠ æ¥å£
    core_switch.add_interface(NetworkInterface(
        interface_id="if-0/0/1",
        interface_name="GigabitEthernet0/0/1",
        interface_type="Ethernet",
        mac_address="00:1a:2b:3c:4d:5e",
        ip_address="10.1.1.1",
        netmask="255.255.255.0",
        speed_mbps=10000,
        admin_status="up",
        oper_status="up",
        description="è¿æ¥æ ¸å¿ƒè·¯ç”±å™¨"
    ))
    
    core_switch.add_interface(NetworkInterface(
        interface_id="if-0/0/2",
        interface_name="GigabitEthernet0/0/2",
        interface_type="Ethernet",
        speed_mbps=10000,
        admin_status="up",
        oper_status="up",
        connected_to="10.1.1.2"
    ))
    
    storage.store_device(core_switch)
    
    # å­˜å‚¨SNMPæ•°æ®
    for i in range(5):
        snmp_data = SNMPData(
            data_id=f"SNMP-{i}",
            device_id="DEV-CORE-BJ-001",
            timestamp=datetime.now() - timedelta(minutes=i*5),
            oid="1.3.6.1.2.1.1.3.0",
            value=str(3600 * 24 * 30 + i * 300),  # ç³»ç»Ÿè¿è¡Œæ—¶é—´
            value_type="TimeTicks",
            metric_name="sysUpTime"
        )
        storage.store_snmp_data(snmp_data)
    
    # åˆ›å»ºå‘Šè­¦
    alert = storage.create_alert(
        device_id="DEV-CORE-BJ-001",
        alert_type="HighCPU",
        severity=AlertSeverity.MAJOR,
        message="CPUä½¿ç”¨ç‡è¶…è¿‡80%ï¼Œå½“å‰85%",
        source="ThresholdMonitor"
    )
    print(f"åˆ›å»ºå‘Šè­¦: {alert.alert_id}")
    
    # æ‹“æ‰‘å‘ç°
    links = storage.discover_topology("DEV-CORE-BJ-001")
    print(f"å‘ç°æ‹“æ‰‘è¿æ¥: {len(links)}")
    
    # é…ç½®å¤‡ä»½
    config = """
! Configuration for BJ-CORE-SW-01
hostname BJ-CORE-SW-01
vlan 10
 name Management
vlan 20
 name Production
interface Vlanif10
 ip address 10.1.1.1 255.255.255.0
"""
    backup = storage.backup_configuration("DEV-CORE-BJ-001", config, "æ—¥å¸¸å¤‡ä»½")
    print(f"é…ç½®å¤‡ä»½: {backup.backup_id}")
    
    # è·å–ç½‘ç»œæ‘˜è¦
    summary = storage.get_network_summary()
    print(f"\nç½‘ç»œæ‘˜è¦: {json.dumps(summary, indent=2, ensure_ascii=False)}")
    
    # è·å–è®¾å¤‡æ€§èƒ½
    performance = storage.get_device_performance("DEV-CORE-BJ-001")
    print(f"\nè®¾å¤‡æ€§èƒ½: {json.dumps(performance, indent=2, ensure_ascii=False)}")
```

### 2.5 æ•ˆæœè¯„ä¼°

**æ€§èƒ½æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| è®¾å¤‡çº³ç®¡ç‡ | 65% | 100% | 35%æå‡ |
| è®¾å¤‡å°è´¦å‡†ç¡®ç‡ | 85% | 99.5% | 14.5%æå‡ |
| æ•…éšœå‘ç°æ—¶é—´ | 2å°æ—¶ | 25ç§’ | 99.7%ç¼©çŸ­ |
| æ•…éšœå®šä½æ—¶é—´ | 3-4å°æ—¶ | 12åˆ†é’Ÿ | 95%ç¼©çŸ­ |
| é…ç½®é”™è¯¯ç‡ | 15% | 1.2% | 92%é™ä½ |
| ç½‘ç»œå¯ç”¨æ€§ | 99.9% | 99.995% | 0.095%æå‡ |

**ä¸šåŠ¡ä»·å€¼ä¸ROI**ï¼š

1. **ç›´æ¥ç»æµæ•ˆç›Š**ï¼š
   - ç³»ç»ŸæŠ•èµ„ï¼šè½¯ä»¶å¹³å°500ä¸‡å…ƒï¼Œç¡¬ä»¶è®¾å¤‡300ä¸‡å…ƒï¼Œå®æ–½è´¹ç”¨200ä¸‡å…ƒï¼Œåˆè®¡1000ä¸‡å…ƒ
   - è¿ç»´æ•ˆç‡æå‡ï¼šè‡ªåŠ¨åŒ–å‡å°‘äººå·¥å·¡æ£€å·¥ä½œé‡70%ï¼Œå¹´èŠ‚çœäººåŠ›æˆæœ¬400ä¸‡å…ƒ
   - æ•…éšœæŸå¤±é™ä½ï¼šç½‘ç»œæ•…éšœå‡å°‘60%ï¼Œå¹´é¿å…ä¸šåŠ¡ä¸­æ–­æŸå¤±çº¦1500ä¸‡å…ƒ
   - åˆè§„æˆæœ¬é™ä½ï¼šè‡ªåŠ¨åŒ–å®¡è®¡æŠ¥è¡¨ç”Ÿæˆï¼Œå¹´èŠ‚çœåˆè§„å‡†å¤‡æˆæœ¬100ä¸‡å…ƒ

2. **ROIè®¡ç®—**ï¼š
   - é¦–å¹´ROI = (400 + 1500 + 100 - 1000) / 1000 Ã— 100% = **100%**
   - ä¸‰å¹´ç´¯è®¡ROI = (1200 + 4500 + 300 - 1000) / 1000 Ã— 100% = **500%**

3. **æˆ˜ç•¥æ•ˆç›Š**ï¼š
   - é€šè¿‡é“¶ä¿ç›‘ä¼šä¿¡æ¯ç§‘æŠ€ç›‘ç®¡è¯„çº§ï¼Œè·å¾—"ä¼˜ç§€"ç­‰çº§
   - å…¥é€‰äººæ°‘é“¶è¡Œé‡‘èç§‘æŠ€è¯•ç‚¹é¡¹ç›®
   - å½¢æˆé‡‘èè¡Œä¸šç½‘ç»œç®¡ç†æœ€ä½³å®è·µï¼Œå¯¹å¤–è¾“å‡ºè§£å†³æ–¹æ¡ˆ
   - è·å¾—"é‡‘èç§‘æŠ€åº”ç”¨åˆ›æ–°å¥–"

**ç»éªŒæ•™è®­**ï¼š

1. è®¾å¤‡å‘ç°åè®®è¦ç»Ÿä¸€ï¼Œå»ºè®®ä¼˜å…ˆä½¿ç”¨SNMP v3å’ŒNETCONF
2. æ—¶åºæ•°æ®åº“é€‰å‹å¾ˆé‡è¦ï¼ŒInfluxDBé€‚åˆä¸­å°è§„æ¨¡ï¼Œå¤§è§„æ¨¡å»ºè®®ä½¿ç”¨TDengine
3. å‘Šè­¦é™å™ªæ˜¯å…³é”®ï¼Œéœ€è¦åˆç†è®¾ç½®é˜ˆå€¼å’Œå‘Šè­¦æ”¶æ•›è§„åˆ™
4. é…ç½®å˜æ›´è¦ä¸¥æ ¼æ‰§è¡Œå®¡æ‰¹æµç¨‹ï¼ŒåŒäººå¤æ ¸æœºåˆ¶å¿…ä¸å¯å°‘

**å‚è€ƒæ¡ˆä¾‹**ï¼š

- [SNMPåè®®æ ‡å‡†](https://www.ietf.org/rfc/rfc3411.txt)
- [NETCONFåè®®](https://datatracker.ietf.org/doc/html/rfc6241)

---

**å‚è€ƒæ–‡æ¡£**ï¼š

- `01_Overview.md` - æ¦‚è¿°
- `02_Formal_Definition.md` - å½¢å¼åŒ–å®šä¹‰
- `03_Standards.md` - æ ‡å‡†å¯¹æ ‡
- `04_Transformation.md` - è½¬æ¢ä½“ç³»

**åˆ›å»ºæ—¶é—´**ï¼š2025-01-21
**æœ€åæ›´æ–°**ï¼š2025-01-21
