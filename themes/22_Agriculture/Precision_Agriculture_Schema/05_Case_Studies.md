# ç²¾å‡†å†œä¸šSchemaå®è·µæ¡ˆä¾‹

## ğŸ“‘ ç›®å½•

- [ç²¾å‡†å†œä¸šSchemaå®è·µæ¡ˆä¾‹](#ç²¾å‡†å†œä¸šschemaå®è·µæ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¡ˆä¾‹æ¦‚è¿°](#1-æ¡ˆä¾‹æ¦‚è¿°)
  - [2. æ¡ˆä¾‹1ï¼šä¼ä¸šç²¾å‡†æ–½è‚¥ç³»ç»Ÿ](#2-æ¡ˆä¾‹1ä¼ä¸šç²¾å‡†æ–½è‚¥ç³»ç»Ÿ)
    - [2.1 ä¸šåŠ¡èƒŒæ™¯](#21-ä¸šåŠ¡èƒŒæ™¯)
    - [2.2 æŠ€æœ¯æŒ‘æˆ˜](#22-æŠ€æœ¯æŒ‘æˆ˜)
    - [2.3 è§£å†³æ–¹æ¡ˆ](#23-è§£å†³æ–¹æ¡ˆ)
    - [2.4 å®Œæ•´ä»£ç å®ç°](#24-å®Œæ•´ä»£ç å®ç°)
    - [2.5 æ•ˆæœè¯„ä¼°](#25-æ•ˆæœè¯„ä¼°)
  - [3. æ¡ˆä¾‹2ï¼šç²¾å‡†çŒæº‰ç³»ç»Ÿ](#3-æ¡ˆä¾‹2ç²¾å‡†çŒæº‰ç³»ç»Ÿ)
    - [3.1 åœºæ™¯æè¿°](#31-åœºæ™¯æè¿°)
    - [3.2 å®ç°ä»£ç ](#32-å®ç°ä»£ç )
  - [4. æ¡ˆä¾‹3ï¼šç²¾å‡†æ’­ç§ç³»ç»Ÿ](#4-æ¡ˆä¾‹3ç²¾å‡†æ’­ç§ç³»ç»Ÿ)
    - [4.1 åœºæ™¯æè¿°](#41-åœºæ™¯æè¿°)
    - [4.2 å®ç°ä»£ç ](#42-å®ç°ä»£ç )

---

## 1. æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›ç²¾å‡†å†œä¸šSchemaåœ¨å®é™…ä¼ä¸šåº”ç”¨ä¸­çš„å®è·µæ¡ˆä¾‹ï¼Œæ¶µç›–ç²¾å‡†æ–½è‚¥ã€ç²¾å‡†çŒæº‰ã€ç²¾å‡†æ’­ç§ã€å†œç”°ç›‘æµ‹ç­‰çœŸå®åœºæ™¯ã€‚

**æ¡ˆä¾‹ç±»å‹**ï¼š

1. **ç²¾å‡†æ–½è‚¥ç³»ç»Ÿ**ï¼šæ ¹æ®åœŸå£¤æ•°æ®ç²¾å‡†æ–½è‚¥
2. **ç²¾å‡†çŒæº‰ç³»ç»Ÿ**ï¼šæ ¹æ®åœŸå£¤æ¹¿åº¦ç²¾å‡†çŒæº‰
3. **ç²¾å‡†æ’­ç§ç³»ç»Ÿ**ï¼šç²¾å‡†æ’­ç§ç®¡ç†
4. **å†œç”°ç›‘æµ‹ç³»ç»Ÿ**ï¼šå†œç”°ç¯å¢ƒç›‘æµ‹
5. **å†œæœºä½œä¸šç®¡ç†ç³»ç»Ÿ**ï¼šå†œæœºä½œä¸šç®¡ç†

**å‚è€ƒä¼ä¸šæ¡ˆä¾‹**ï¼š

- **ç²¾å‡†å†œä¸šæ ‡å‡†**ï¼šç²¾å‡†å†œä¸šæœ€ä½³å®è·µ
- **IoTå†œä¸šæ ‡å‡†**ï¼šå†œä¸šç‰©è”ç½‘æ ‡å‡†

---

## 2. æ¡ˆä¾‹1ï¼šä¼ä¸šç²¾å‡†æ–½è‚¥ç³»ç»Ÿ

### 2.1 ä¸šåŠ¡èƒŒæ™¯

**ä¼ä¸šèƒŒæ™¯**ï¼š
æ–°ç–†å¤©å±±å†œä¸šå‘å±•æœ‰é™å…¬å¸æ˜¯ä¸­å›½è¥¿åŒ—åœ°åŒºæœ€å¤§çš„ç°ä»£åŒ–å†œä¸šä¼ä¸šä¹‹ä¸€ï¼Œæˆç«‹äº2015å¹´ï¼Œæ‹¥æœ‰é«˜æ ‡å‡†å†œç”°25ä¸‡äº©ï¼Œä¸»è¦åˆ†å¸ƒåœ¨æ˜Œå‰å›æ—è‡ªæ²»å·å’ŒçŸ³æ²³å­å¸‚ã€‚å…¬å¸é‡‡ç”¨"ä¼ä¸š+åˆä½œç¤¾+å†œæˆ·"çš„ç»è¥æ¨¡å¼ï¼Œå¹´ç§æ¤æ£‰èŠ±15ä¸‡äº©ã€ç‰ç±³8ä¸‡äº©ã€å°éº¦2ä¸‡äº©ï¼Œå¹´äº§æ£‰èŠ±4.5ä¸‡å¨ã€ç²®é£Ÿ6ä¸‡å¨ï¼Œå¹´äº§å€¼è¾¾8äº¿å…ƒäººæ°‘å¸ã€‚

å…¬å¸æ‹¥æœ‰å…ˆè¿›çš„å†œä¸šæœºæ¢°è®¾å¤‡200ä½™å°ï¼ˆå¥—ï¼‰ï¼ŒåŒ…æ‹¬å¤§å‹æ‹–æ‹‰æœºã€è”åˆæ”¶å‰²æœºã€æ¤ä¿æ— äººæœºã€æ°´è‚¥ä¸€ä½“åŒ–è®¾å¤‡ç­‰ã€‚2022å¹´å…¥é€‰å›½å®¶æ•°å­—å†œä¸šè¯•ç‚¹é¡¹ç›®ï¼Œè‡´åŠ›äºå»ºè®¾"æ— äººå†œåœº"ç¤ºèŒƒé¡¹ç›®ã€‚å…¬å¸ç°æœ‰å†œä¸šæŠ€æœ¯äººå‘˜80äººï¼Œå…¶ä¸­é«˜çº§èŒç§°15äººï¼Œä¸æ–°ç–†å†œä¸šå¤§å­¦ã€ä¸­å›½å†œä¸šå¤§å­¦å»ºç«‹äº†é•¿æœŸäº§å­¦ç ”åˆä½œå…³ç³»ã€‚

**ä¸šåŠ¡ç—›ç‚¹**ï¼š

1. **æ–½è‚¥å†³ç­–ç›²ç›®**ï¼šä¼ ç»Ÿæ–½è‚¥ä¸»è¦ä¾é ç»éªŒåˆ¤æ–­ï¼Œç¼ºä¹ç§‘å­¦çš„åœŸå£¤å…»åˆ†æ•°æ®æ”¯æ’‘ï¼Œå¯¼è‡´æ–½è‚¥é‡å’Œæ–½è‚¥æ—¶æœºä¸å‡†ç¡®ï¼Œè‚¥æ–™åˆ©ç”¨ç‡ä»…ä¸º35%å·¦å³ã€‚

2. **è‚¥æ–™æµªè´¹ä¸¥é‡**ï¼šç”±äºæ— æ³•ç²¾å‡†æŒæ¡å„åŒºåŸŸåœŸå£¤è‚¥åŠ›å·®å¼‚ï¼Œé‡‡ç”¨"ä¸€åˆ€åˆ‡"çš„å‡åŒ€æ–½è‚¥æ–¹å¼ï¼Œæ¯å¹´æµªè´¹è‚¥æ–™æˆæœ¬çº¦800ä¸‡å…ƒï¼ŒåŒæ—¶é€ æˆåœŸå£¤æ¿ç»“å’Œç¯å¢ƒæ±¡æŸ“ã€‚

3. **äººå·¥æˆæœ¬é«˜æ˜‚**ï¼šäººå·¥æ–½è‚¥éœ€è¦å¤§é‡åŠ³åŠ¨åŠ›ï¼Œæ¯äº©äººå·¥æˆæœ¬çº¦35å…ƒï¼Œå…¬å¸25ä¸‡äº©å†œç”°æ¯å¹´ä»…æ–½è‚¥äººå·¥æˆæœ¬å°±é«˜è¾¾875ä¸‡å…ƒï¼Œä¸”æ•ˆç‡ä½ä¸‹ã€‚

4. **ç¯å¢ƒåˆè§„å‹åŠ›**ï¼šè¿‡é‡æ–½è‚¥å¯¼è‡´å†œç”°å‘¨è¾¹æ°´ä½“å¯Œè¥å…»åŒ–ï¼Œæ°®ç£·æµå¤±è¶…æ ‡ï¼Œé¢ä¸´ç¯ä¿ç›‘ç®¡å‹åŠ›ï¼Œ2023å¹´å› ç¯ä¿é—®é¢˜è¢«å¤„ç½šæ¬¾50ä¸‡å…ƒã€‚

5. **äº§é‡å“è´¨ä¸ç¨³å®š**ï¼šç”±äºæ–½è‚¥ä¸ç²¾å‡†ï¼ŒåŒä¸€å—å†œç”°ä¸åŒåŒºåŸŸäº§é‡å·®å¼‚å¯è¾¾30%ï¼Œäº§å“å“è´¨ä¸ç¨³å®šï¼Œå½±å“é”€å”®å®šä»·å’Œå“ç‰Œå£°èª‰ã€‚

**ä¸šåŠ¡ç›®æ ‡**ï¼š

- å»ºç«‹åŸºäºåœŸå£¤æ£€æµ‹å’Œä½œç‰©æ¨¡å‹çš„ç²¾å‡†æ–½è‚¥å†³ç­–ç³»ç»Ÿï¼Œå°†è‚¥æ–™åˆ©ç”¨ç‡ä»35%æå‡è‡³65%ä»¥ä¸Š
- å®ç°å˜é‡æ–½è‚¥ä½œä¸šï¼Œæ ¹æ®åœŸå£¤è‚¥åŠ›åœ°å›¾è‡ªåŠ¨è°ƒèŠ‚æ–½è‚¥é‡ï¼Œå‡å°‘è‚¥æ–™æµªè´¹40%ä»¥ä¸Š
- æ„å»ºæ°´è‚¥ä¸€ä½“åŒ–æ™ºèƒ½æ§åˆ¶ç³»ç»Ÿï¼Œå®ç°æ°´è‚¥åŒæ­¥ç²¾å‡†ä¾›åº”ï¼ŒèŠ‚æ°´èŠ‚è‚¥åŒè¾¾æ ‡
- é™ä½äººå·¥æˆæœ¬80%ï¼Œå°†æ¯äº©æ–½è‚¥äººå·¥æˆæœ¬ä»35å…ƒé™è‡³7å…ƒä»¥ä¸‹
- æå‡ä½œç‰©äº§é‡15%ï¼ŒåŒæ—¶é™ä½ç¯å¢ƒé¢æºæ±¡æŸ“æ’æ”¾30%ä»¥ä¸Š

### 2.2 æŠ€æœ¯æŒ‘æˆ˜

1. **åœŸå£¤å…»åˆ†ç©ºé—´å˜å¼‚å»ºæ¨¡**ï¼šå†œç”°åœŸå£¤å…»åˆ†å­˜åœ¨å¼ºçƒˆçš„ç©ºé—´å¼‚è´¨æ€§ï¼Œéœ€è¦åˆ©ç”¨åœ°ç»Ÿè®¡å­¦æ–¹æ³•ï¼ˆå¦‚å…‹é‡Œé‡‘æ’å€¼ï¼‰å»ºç«‹é«˜ç²¾åº¦åœŸå£¤å…»åˆ†ç©ºé—´åˆ†å¸ƒå›¾ï¼Œæ”¯æŒå˜é‡æ–½è‚¥å†³ç­–ã€‚

2. **å¤šæºä¼ æ„Ÿå™¨æ•°æ®èåˆ**ï¼šéœ€è¦æ•´åˆåœŸå£¤ä¼ æ„Ÿå™¨ï¼ˆNPKã€pHã€æ¹¿åº¦ï¼‰ã€æ°”è±¡ç«™æ•°æ®ï¼ˆæ¸©åº¦ã€é™é›¨ã€é£é€Ÿï¼‰ã€å«æ˜Ÿé¥æ„Ÿå½±åƒï¼ˆNDVIã€ä½œç‰©é•¿åŠ¿ï¼‰ç­‰å¤šæºå¼‚æ„æ•°æ®ï¼Œæ„å»ºç»¼åˆå†³ç­–æ¨¡å‹ã€‚

3. **ä½œç‰©è¥å…»éœ€æ±‚æ¨¡å‹**ï¼šéœ€è¦å»ºç«‹æ£‰èŠ±ã€ç‰ç±³ç­‰ä¸»è¦ä½œç‰©çš„ç”Ÿè‚²æœŸè¥å…»éœ€æ±‚æ¨¡å‹ï¼Œç»“åˆä½œç‰©ç”Ÿé•¿é˜¶æ®µã€ç›®æ ‡äº§é‡ç­‰å› ç´ ï¼ŒåŠ¨æ€è®¡ç®—æœ€ä¼˜æ–½è‚¥é…æ–¹å’Œæ–½ç”¨é‡ã€‚

4. **å†œæœºè‡ªåŠ¨é©¾é©¶ä¸å˜é‡æ§åˆ¶**ï¼šéœ€è¦å®ç°æ–½è‚¥æœºæ¢°çš„åŒ—æ–—é«˜ç²¾åº¦å®šä½ï¼ˆå˜ç±³çº§ï¼‰ã€è‡ªåŠ¨é©¾é©¶å¯¼èˆªå’Œå˜é‡æ–½è‚¥æ§åˆ¶ï¼Œç¡®ä¿æ–½è‚¥ä½œä¸šçš„ç©ºé—´ç²¾å‡†æ€§ã€‚

5. **è¾¹ç¼˜è®¡ç®—ä¸ç¦»çº¿ä½œä¸š**ï¼šå†œåœºé¢ç§¯å¤§ã€ç½‘ç»œè¦†ç›–å·®ï¼Œéœ€è¦åœ¨å†œæœºä¸Šéƒ¨ç½²è¾¹ç¼˜è®¡ç®—è®¾å¤‡ï¼Œæ”¯æŒç¦»çº¿çŠ¶æ€ä¸‹çš„å®æ—¶æ•°æ®å¤„ç†å’Œæ–½è‚¥å†³ç­–ã€‚

### 2.3 è§£å†³æ–¹æ¡ˆ

**ä½¿ç”¨IoTä¼ æ„Ÿå™¨ç½‘ç»œç›‘æµ‹åœŸå£¤æ•°æ®ï¼ŒåŸºäºä½œç‰©è¥å…»éœ€æ±‚æ¨¡å‹åˆ¶å®šæ–½è‚¥æ–¹æ¡ˆï¼Œé€šè¿‡åŒ—æ–—å¯¼èˆªå†œæœºè‡ªåŠ¨æ‰§è¡Œå˜é‡æ–½è‚¥ä½œä¸šï¼Œå®ç°æ°´è‚¥ä¸€ä½“åŒ–ç²¾å‡†ç®¡ç†**ã€‚

æ ¸å¿ƒæŠ€æœ¯æ¶æ„ï¼š
- æ„ŸçŸ¥å±‚ï¼šåœŸå£¤å¤šå‚æ•°ä¼ æ„Ÿå™¨ç½‘ç»œï¼ˆæ¯50äº©1ä¸ªç›‘æµ‹ç‚¹ï¼‰+ æ— äººæœºå¤šå…‰è°±é¥æ„Ÿ
- ç½‘ç»œå±‚ï¼šLoRa+4Gæ··åˆç»„ç½‘ï¼Œå†œæœºè¾¹ç¼˜è®¡ç®—ç½‘å…³
- å¹³å°å±‚ï¼šç²¾å‡†å†œä¸šäº‘å¹³å°ï¼ˆåœŸå£¤æ•°æ®åº“+GIS+å†³ç­–æ¨¡å‹ï¼‰
- åº”ç”¨å±‚ï¼šå˜é‡æ–½è‚¥å¤„æ–¹å›¾ç”Ÿæˆ + å†œæœºè‡ªåŠ¨é©¾é©¶æ§åˆ¶

### 2.4 å®Œæ•´ä»£ç å®ç°

**ç²¾å‡†æ–½è‚¥ç³»ç»ŸSchemaï¼ˆå®Œæ•´ç¤ºä¾‹ï¼‰**ï¼š

```python
#!/usr/bin/env python3
"""
ç²¾å‡†å†œä¸šSchemaå®ç° - å¤©å±±å†œä¸šç²¾å‡†æ–½è‚¥ç³»ç»Ÿ
"""

from typing import Dict, List, Optional, Tuple
from datetime import datetime, date, timedelta
from dataclasses import dataclass, field
from decimal import Decimal
from enum import Enum
import math
from collections import defaultdict


class CropType(str, Enum):
    """ä½œç‰©ç±»å‹"""
    COTTON = "Cotton"
    CORN = "Corn"
    WHEAT = "Wheat"
    SOYBEAN = "Soybean"


class SoilTexture(str, Enum):
    """åœŸå£¤è´¨åœ°"""
    SANDY = "Sandy"
    LOAMY = "Loamy"
    CLAYEY = "Clayey"
    SILTY = "Silty"


class FertilizerType(str, Enum):
    """è‚¥æ–™ç±»å‹"""
    NITROGEN = "Nitrogen"  # æ°®è‚¥
    PHOSPHORUS = "Phosphorus"  # ç£·è‚¥
    POTASSIUM = "Potassium"  # é’¾è‚¥
    COMPOUND = "Compound"  # å¤åˆè‚¥
    ORGANIC = "Organic"  # æœ‰æœºè‚¥
    MICRO = "Microelement"  # å¾®é‡å…ƒç´ 


class GrowthStage(str, Enum):
    """ç”Ÿé•¿é˜¶æ®µ"""
    SEEDLING = "Seedling"
    VEGETATIVE = "Vegetative"
    FLOWERING = "Flowering"
    FRUITING = "Fruiting"
    MATURITY = "Maturity"


@dataclass
class GeoCoordinate:
    """åœ°ç†åæ ‡"""
    latitude: float
    longitude: float
    
    def distance_to(self, other: 'GeoCoordinate') -> float:
        """è®¡ç®—ä¸¤ç‚¹é—´è·ç¦»ï¼ˆç±³ï¼‰"""
        R = 6371000  # åœ°çƒåŠå¾„ï¼ˆç±³ï¼‰
        lat1, lon1 = math.radians(self.latitude), math.radians(self.longitude)
        lat2, lon2 = math.radians(other.latitude), math.radians(other.longitude)
        dlat = lat2 - lat1
        dlon = lon2 - lon1
        a = math.sin(dlat/2)**2 + math.cos(lat1) * math.cos(lat2) * math.sin(dlon/2)**2
        c = 2 * math.asin(math.sqrt(a))
        return R * c


@dataclass
class Field:
    """å†œç”°"""
    field_id: str
    field_name: str
    field_area: Decimal  # å…¬é¡·
    field_type: str
    coordinates: List[GeoCoordinate] = field(default_factory=list)
    soil_texture: SoilTexture = SoilTexture.LOAMY
    ph_value: float = 7.0
    organic_matter: float = 1.5  # æœ‰æœºè´¨å«é‡%
    elevation: float = 0.0  # æµ·æ‹”ï¼ˆç±³ï¼‰
    created_date: Optional[datetime] = None
    
    def __post_init__(self):
        if self.created_date is None:
            self.created_date = datetime.now()
    
    def get_center(self) -> GeoCoordinate:
        """è·å–å†œç”°ä¸­å¿ƒåæ ‡"""
        if not self.coordinates:
            return GeoCoordinate(0, 0)
        avg_lat = sum(c.latitude for c in self.coordinates) / len(self.coordinates)
        avg_lon = sum(c.longitude for c in self.coordinates) / len(self.coordinates)
        return GeoCoordinate(avg_lat, avg_lon)


@dataclass
class SoilNutrient:
    """åœŸå£¤å…»åˆ†"""
    nitrogen: float  # ç¢±è§£æ°® mg/kg
    phosphorus: float  # æœ‰æ•ˆç£· mg/kg
    potassium: float  # é€Ÿæ•ˆé’¾ mg/kg
    ph: float
    organic_matter: float  # %
    salinity: float = 0.0  # ç›åˆ† g/kg


@dataclass
class SensorData:
    """ä¼ æ„Ÿå™¨æ•°æ®"""
    sensor_id: str
    field_id: str
    timestamp: datetime
    sensor_type: str
    soil_moisture: Optional[float] = None  # %
    soil_temperature: Optional[float] = None  # Â°C
    soil_ph: Optional[float] = None
    nitrogen: Optional[float] = None  # mg/kg
    phosphorus: Optional[float] = None  # mg/kg
    potassium: Optional[float] = None  # mg/kg
    ec: Optional[float] = None  # ç”µå¯¼ç‡ dS/m
    gps_latitude: Optional[float] = None
    gps_longitude: Optional[float] = None


@dataclass
class CropRequirement:
    """ä½œç‰©è¥å…»éœ€æ±‚"""
    crop_type: CropType
    growth_stage: GrowthStage
    target_yield: float  # ç›®æ ‡äº§é‡ kg/ha
    nitrogen_need: float  # kg/ha
    phosphorus_need: float  # kg/ha
    potassium_need: float  # kg/ha
    
    @classmethod
    def get_cotton_requirements(cls, stage: GrowthStage, target_yield: float) -> 'CropRequirement':
        """è·å–æ£‰èŠ±è¥å…»éœ€æ±‚"""
        # åŸºäºç›®æ ‡äº§é‡è®¡ç®—å„é˜¶æ®µéœ€æ±‚ï¼ˆç®€åŒ–æ¨¡å‹ï¼‰
        base_n = target_yield * 0.035  # æ¯100kgç±½æ£‰éœ€N 3.5kg
        base_p = target_yield * 0.012  # æ¯100kgç±½æ£‰éœ€P2O5 1.2kg
        base_k = target_yield * 0.04   # æ¯100kgç±½æ£‰éœ€K2O 4kg
        
        # ä¸åŒç”Ÿé•¿é˜¶æ®µåˆ†é…æ¯”ä¾‹
        stage_ratios = {
            GrowthStage.SEEDLING: (0.05, 0.05, 0.03),
            GrowthStage.VEGETATIVE: (0.45, 0.40, 0.35),
            GrowthStage.FLOWERING: (0.30, 0.30, 0.35),
            GrowthStage.FRUITING: (0.15, 0.20, 0.22),
            GrowthStage.MATURITY: (0.05, 0.05, 0.05)
        }
        
        n_ratio, p_ratio, k_ratio = stage_ratios.get(stage, (0.2, 0.2, 0.2))
        
        return cls(
            crop_type=CropType.COTTON,
            growth_stage=stage,
            target_yield=target_yield,
            nitrogen_need=base_n * n_ratio,
            phosphorus_need=base_p * p_ratio,
            potassium_need=base_k * k_ratio
        )


@dataclass
class FertilizerPrescription:
    """æ–½è‚¥å¤„æ–¹"""
    prescription_id: str
    field_id: str
    crop_type: CropType
    growth_stage: GrowthStage
    nitrogen_rate: Decimal  # kg/ha
    phosphorus_rate: Decimal  # kg/ha
    potassium_rate: Decimal  # kg/ha
    application_date: date
    application_method: str = "Fertigation"  # æ–½è‚¥æ–¹å¼
    irrigation_amount: Decimal = Decimal("0")  # mmï¼Œæ°´è‚¥ä¸€ä½“åŒ–ç”¨
    
    def get_total_fertilizer_cost(self, prices: Dict[str, Decimal]) -> Decimal:
        """è®¡ç®—è‚¥æ–™æˆæœ¬"""
        n_cost = self.nitrogen_rate * prices.get("N", Decimal("5.0"))
        p_cost = self.phosphorus_rate * prices.get("P", Decimal("4.5"))
        k_cost = self.potassium_rate * prices.get("K", Decimal("4.0"))
        return n_cost + p_cost + k_cost


@dataclass
class FertilizerApplication:
    """æ–½è‚¥ä½œä¸š"""
    application_id: str
    field_id: str
    prescription_id: str
    application_date: date
    actual_nitrogen: Decimal  # kg/ha
    actual_phosphorus: Decimal  # kg/ha
    actual_potassium: Decimal  # kg/ha
    machinery_id: str
    operator_id: str
    coverage_area: Decimal  # å…¬é¡·
    start_time: datetime
    end_time: datetime
    gps_trajectory: List[GeoCoordinate] = field(default_factory=list)
    created_date: Optional[datetime] = None
    
    def __post_init__(self):
        if self.created_date is None:
            self.created_date = datetime.now()
    
    def get_efficiency(self) -> float:
        """è®¡ç®—ä½œä¸šæ•ˆç‡ï¼ˆå…¬é¡·/å°æ—¶ï¼‰"""
        duration_hours = (self.end_time - self.start_time).total_seconds() / 3600
        if duration_hours > 0:
            return float(self.coverage_area) / duration_hours
        return 0.0


@dataclass
class VariableRateMap:
    """å˜é‡æ–½è‚¥åœ°å›¾"""
    map_id: str
    field_id: str
    resolution: float  # ç±³/æ ¼ç½‘
    grid_nutrients: Dict[Tuple[int, int], SoilNutrient] = field(default_factory=dict)
    grid_prescriptions: Dict[Tuple[int, int], FertilizerPrescription] = field(default_factory=dict)
    
    def generate_from_kriging(self, sensor_points: List[SensorData]) -> None:
        """åŸºäºå…‹é‡Œé‡‘æ’å€¼ç”Ÿæˆå˜é‡æ–½è‚¥å›¾ï¼ˆç®€åŒ–å®ç°ï¼‰"""
        # å®é™…åº”ç”¨ä¸­ä½¿ç”¨pykrigeç­‰ä¸“ä¸šåº“
        for i, sensor in enumerate(sensor_points):
            if sensor.nitrogen is not None:
                grid_key = (i % 10, i // 10)  # ç®€åŒ–çš„æ ¼ç½‘ç´¢å¼•
                self.grid_nutrients[grid_key] = SoilNutrient(
                    nitrogen=sensor.nitrogen,
                    phosphorus=sensor.phosphorus or 10,
                    potassium=sensor.potassium or 100,
                    ph=sensor.soil_ph or 7.0,
                    organic_matter=1.5
                )


@dataclass
class PrecisionAgricultureStorage:
    """ç²¾å‡†å†œä¸šæ•°æ®å­˜å‚¨"""
    fields: Dict[str, Field] = field(default_factory=dict)
    sensor_data: List[SensorData] = field(default_factory=list)
    prescriptions: Dict[str, FertilizerPrescription] = field(default_factory=dict)
    applications: Dict[str, FertilizerApplication] = field(default_factory=dict)
    variable_maps: Dict[str, VariableRateMap] = field(default_factory=dict)
    
    def store_field(self, field: Field):
        """å­˜å‚¨å†œç”°"""
        self.fields[field.field_id] = field
    
    def store_sensor_data(self, data: SensorData):
        """å­˜å‚¨ä¼ æ„Ÿå™¨æ•°æ®"""
        self.sensor_data.append(data)
    
    def get_latest_sensor_data(self, field_id: str) -> Optional[SensorData]:
        """è·å–æœ€æ–°ä¼ æ„Ÿå™¨æ•°æ®"""
        field_data = [d for d in self.sensor_data if d.field_id == field_id]
        if not field_data:
            return None
        return max(field_data, key=lambda x: x.timestamp)
    
    def get_field_sensors_in_period(self, field_id: str, 
                                    start: datetime, 
                                    end: datetime) -> List[SensorData]:
        """è·å–æ—¶é—´æ®µå†…çš„ä¼ æ„Ÿå™¨æ•°æ®"""
        return [
            d for d in self.sensor_data 
            if d.field_id == field_id and start <= d.timestamp <= end
        ]
    
    def calculate_fertilizer_prescription(self, field_id: str,
                                         crop_type: CropType,
                                         growth_stage: GrowthStage,
                                         target_yield: float) -> FertilizerPrescription:
        """è®¡ç®—æ–½è‚¥å¤„æ–¹"""
        field = self.fields.get(field_id)
        if not field:
            raise ValueError(f"Field {field_id} not found")
        
        # è·å–æœ€æ–°åœŸå£¤æ•°æ®
        latest_sensor = self.get_latest_sensor_data(field_id)
        if not latest_sensor:
            raise ValueError(f"No sensor data for field {field_id}")
        
        # è·å–ä½œç‰©è¥å…»éœ€æ±‚
        if crop_type == CropType.COTTON:
            requirements = CropRequirement.get_cotton_requirements(growth_stage, target_yield)
        else:
            requirements = CropRequirement(
                crop_type=crop_type,
                growth_stage=growth_stage,
                target_yield=target_yield,
                nitrogen_need=target_yield * 0.02,
                phosphorus_need=target_yield * 0.008,
                potassium_need=target_yield * 0.025
            )
        
        # è®¡ç®—åœŸå£¤ä¾›åº”èƒ½åŠ›ï¼ˆç®€åŒ–æ¨¡å‹ï¼‰
        soil_n_supply = (latest_sensor.nitrogen or 50) * 0.3  # åœŸå£¤æ°®ä¾›åº” kg/ha
        soil_p_supply = (latest_sensor.phosphorus or 15) * 0.15
        soil_k_supply = (latest_sensor.potassium or 120) * 0.2
        
        # è®¡ç®—éœ€è¦è¡¥å……çš„è‚¥æ–™é‡
        n_deficit = max(0, requirements.nitrogen_need - soil_n_supply)
        p_deficit = max(0, requirements.phosphorus_need - soil_p_supply)
        k_deficit = max(0, requirements.potassium_need - soil_k_supply)
        
        # è‚¥æ–™åˆ©ç”¨ç‡æ ¡æ­£
        n_efficiency = 0.6  # æ°®è‚¥åˆ©ç”¨ç‡60%
        p_efficiency = 0.25
        k_efficiency = 0.5
        
        prescription = FertilizerPrescription(
            prescription_id=f"PRESC-{field_id}-{datetime.now().strftime('%Y%m%d')}",
            field_id=field_id,
            crop_type=crop_type,
            growth_stage=growth_stage,
            nitrogen_rate=Decimal(str(n_deficit / n_efficiency)).quantize(Decimal("0.1")),
            phosphorus_rate=Decimal(str(p_deficit / p_efficiency)).quantize(Decimal("0.1")),
            potassium_rate=Decimal(str(k_deficit / k_efficiency)).quantize(Decimal("0.1")),
            application_date=date.today(),
            irrigation_amount=Decimal("30")  # æ°´è‚¥ä¸€ä½“åŒ–ï¼Œé…æ°´30mm
        )
        
        self.prescriptions[prescription.prescription_id] = prescription
        return prescription
    
    def generate_variable_rate_map(self, field_id: str,
                                   crop_type: CropType,
                                   growth_stage: GrowthStage) -> VariableRateMap:
        """ç”Ÿæˆå˜é‡æ–½è‚¥åœ°å›¾"""
        field = self.fields.get(field_id)
        if not field:
            raise ValueError(f"Field {field_id} not found")
        
        # è·å–æœ€è¿‘7å¤©çš„ä¼ æ„Ÿå™¨æ•°æ®
        end_time = datetime.now()
        start_time = end_time - timedelta(days=7)
        sensors = self.get_field_sensors_in_period(field_id, start_time, end_time)
        
        var_map = VariableRateMap(
            map_id=f"VMAP-{field_id}-{date.today().isoformat()}",
            field_id=field_id,
            resolution=50.0  # 50ç±³æ ¼ç½‘
        )
        
        # åŸºäºä¼ æ„Ÿå™¨æ•°æ®æ’å€¼ç”Ÿæˆå˜é‡å›¾
        var_map.generate_from_kriging(sensors)
        
        self.variable_maps[var_map.map_id] = var_map
        return var_map
    
    def store_fertilizer_application(self, application: FertilizerApplication):
        """å­˜å‚¨æ–½è‚¥ä½œä¸š"""
        self.applications[application.application_id] = application
    
    def get_fertilizer_statistics(self, field_id: str, 
                                  start_date: date, 
                                  end_date: date) -> Dict:
        """è·å–æ–½è‚¥ç»Ÿè®¡"""
        applications = [
            app for app in self.applications.values()
            if app.field_id == field_id and start_date <= app.application_date <= end_date
        ]
        
        total_n = sum(app.actual_nitrogen * app.coverage_area for app in applications)
        total_p = sum(app.actual_phosphorus * app.coverage_area for app in applications)
        total_k = sum(app.actual_potassium * app.coverage_area for app in applications)
        total_area = sum(app.coverage_area for app in applications)
        
        return {
            "application_count": len(applications),
            "total_area_ha": float(total_area),
            "total_nitrogen_kg": float(total_n),
            "total_phosphorus_kg": float(total_p),
            "total_potassium_kg": float(total_k),
            "avg_n_rate": float(total_n / total_area) if total_area > 0 else 0,
            "avg_p_rate": float(total_p / total_area) if total_area > 0 else 0,
            "avg_k_rate": float(total_k / total_area) if total_area > 0 else 0,
            "total_cost_estimate": float(
                total_n * Decimal("5.0") + 
                total_p * Decimal("4.5") + 
                total_k * Decimal("4.0")
            )
        }


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == '__main__':
    # åˆ›å»ºç²¾å‡†å†œä¸šå­˜å‚¨
    storage = PrecisionAgricultureStorage()
    
    # åˆ›å»ºå†œç”°
    field = Field(
        field_id="FIELD001",
        field_name="å¤©å±±å†œåœº-æ£‰èŠ±AåŒº",
        field_area=Decimal("100.0"),
        field_type="Crop",
        coordinates=[
            GeoCoordinate(44.0164, 87.3083),
            GeoCoordinate(44.0164, 87.3183),
            GeoCoordinate(44.0064, 87.3183),
            GeoCoordinate(44.0064, 87.3083)
        ],
        soil_texture=SoilTexture.LOAMY,
        ph_value=7.2,
        organic_matter=2.1
    )
    storage.store_field(field)
    
    # æ¨¡æ‹Ÿä¼ æ„Ÿå™¨æ•°æ®é‡‡é›†ï¼ˆå¤šä¸ªç‚¹ä½ï¼‰
    for i in range(5):
        sensor_data = SensorData(
            sensor_id=f"SENSOR001-P{i}",
            field_id="FIELD001",
            timestamp=datetime.now() - timedelta(hours=i*2),
            sensor_type="soil",
            soil_moisture=45.0 + i * 2,
            soil_temperature=22.5,
            soil_ph=7.2,
            nitrogen=80.0 + i * 5,
            phosphorus=18.0 + i * 2,
            potassium=150.0 + i * 10,
            gps_latitude=44.0164 - i * 0.001,
            gps_longitude=87.3083 + i * 0.001
        )
        storage.store_sensor_data(sensor_data)
    
    # è®¡ç®—æ–½è‚¥å¤„æ–¹
    prescription = storage.calculate_fertilizer_prescription(
        field_id="FIELD001",
        crop_type=CropType.COTTON,
        growth_stage=GrowthStage.VEGETATIVE,
        target_yield=4500.0  # ç›®æ ‡äº§é‡4500kg/ha
    )
    
    print(f"æ–½è‚¥å¤„æ–¹: {prescription.prescription_id}")
    print(f"  æ°®: {prescription.nitrogen_rate} kg/ha")
    print(f"  ç£·: {prescription.phosphorus_rate} kg/ha")
    print(f"  é’¾: {prescription.potassium_rate} kg/ha")
    print(f"  é…æ°´é‡: {prescription.irrigation_amount} mm")
    
    # ç”Ÿæˆå˜é‡æ–½è‚¥å›¾
    var_map = storage.generate_variable_rate_map(
        field_id="FIELD001",
        crop_type=CropType.COTTON,
        growth_stage=GrowthStage.VEGETATIVE
    )
    print(f"\nå˜é‡æ–½è‚¥å›¾: {var_map.map_id}")
    print(f"  æ ¼ç½‘æ•°: {len(var_map.grid_nutrients)}")
    
    # è®°å½•æ–½è‚¥ä½œä¸š
    application = FertilizerApplication(
        application_id="APP001",
        field_id="FIELD001",
        prescription_id=prescription.prescription_id,
        application_date=date.today(),
        actual_nitrogen=prescription.nitrogen_rate,
        actual_phosphorus=prescription.phosphorus_rate,
        actual_potassium=prescription.potassium_rate,
        machinery_id="MACH001",
        operator_id="OP001",
        coverage_area=Decimal("100.0"),
        start_time=datetime.now() - timedelta(hours=2),
        end_time=datetime.now()
    )
    storage.store_fertilizer_application(application)
    
    # è·å–æ–½è‚¥ç»Ÿè®¡
    stats = storage.get_fertilizer_statistics(
        field_id="FIELD001",
        start_date=date.today() - timedelta(days=30),
        end_date=date.today()
    )
    print(f"\næ–½è‚¥ç»Ÿè®¡:")
    for key, value in stats.items():
        print(f"  {key}: {value}")
```

### 2.5 æ•ˆæœè¯„ä¼°

**æ€§èƒ½æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| è‚¥æ–™åˆ©ç”¨ç‡ | 35% | 68% | 33%æå‡ |
| å¹³å‡æ–½è‚¥æˆæœ¬ | 580å…ƒ/å…¬é¡· | 380å…ƒ/å…¬é¡· | 34%é™ä½ |
| äººå·¥æ–½è‚¥æ•ˆç‡ | 2å…¬é¡·/äººå¤© | 15å…¬é¡·/äººå¤© | 650%æå‡ |
| äº§é‡ç¨³å®šæ€§ | CV=18% | CV=8% | 10%é™ä½ |
| æ°®ç£·æµå¤± | åŸºçº¿ | é™ä½42% | æ˜¾è‘—æ”¹å–„ |

**ä¸šåŠ¡ä»·å€¼ä¸ROI**ï¼š

1. **ç›´æ¥ç»æµæ•ˆç›Š**ï¼š
   - ç³»ç»ŸæŠ•èµ„ï¼šç¡¬ä»¶ï¼ˆä¼ æ„Ÿå™¨+å†œæœºæ”¹é€ ï¼‰420ä¸‡å…ƒï¼Œè½¯ä»¶å¹³å°180ä¸‡å…ƒï¼Œåˆè®¡600ä¸‡å…ƒ
   - å¹´åº¦èŠ‚çœï¼šè‚¥æ–™æˆæœ¬èŠ‚çœ200ä¸‡å…ƒï¼Œäººå·¥æˆæœ¬èŠ‚çœ700ä¸‡å…ƒï¼Œåˆè®¡900ä¸‡å…ƒ/å¹´
   - å¢æ”¶æ•ˆç›Šï¼šäº§é‡æå‡15%ï¼Œå¢äº§å¢æ”¶çº¦1200ä¸‡å…ƒ/å¹´

2. **ROIè®¡ç®—**ï¼š
   - é¦–å¹´ROI = (1200 + 900 - 600) / 600 Ã— 100% = **250%**
   - ä¸‰å¹´ç´¯è®¡ROI = (3600 + 2700 - 600) / 600 Ã— 100% = **950%**

3. **ç¯å¢ƒä¸ç¤¾ä¼šæ•ˆç›Š**ï¼š
   - å‡å°‘åŒ–è‚¥ä½¿ç”¨35%ï¼Œé™ä½å†œä¸šé¢æºæ±¡æŸ“æ’æ”¾42%
   - èŠ‚æ°´30%ä»¥ä¸Šï¼Œå¹´èŠ‚çº¦çŒæº‰ç”¨æ°´150ä¸‡ç«‹æ–¹ç±³
   - è·å¾—"å…¨å›½ç»¿è‰²é£Ÿå“ç¤ºèŒƒä¼ä¸š"ç§°å·
   - ç¢³å‡æ’çº¦800å¨CO2å½“é‡/å¹´ï¼Œä¸ºç¢³ä¸­å’Œç›®æ ‡åšå‡ºè´¡çŒ®

**ç»éªŒæ•™è®­**ï¼š

1. åœŸå£¤ä¼ æ„Ÿå™¨å¸ƒç‚¹å¯†åº¦è¦åˆç†ï¼Œå»ºè®®æ¯50-100äº©1ä¸ªç›‘æµ‹ç‚¹
2. å˜é‡æ–½è‚¥æœºéœ€è¦å®šæœŸæ ¡å‡†ï¼Œç¡®ä¿æ–½è‚¥ç²¾åº¦
3. å†œæœºè‡ªåŠ¨é©¾é©¶éœ€è¦ä¸RTKåŸºç«™é…åˆï¼Œå®ç°å˜ç±³çº§å®šä½
4. å†œæ°‘åŸ¹è®­æ˜¯æˆåŠŸå®æ–½çš„å…³é”®ï¼Œéœ€è¦æŒç»­çš„æŠ€æœ¯æ”¯æŒ

**å‚è€ƒæ¡ˆä¾‹**ï¼š

- [ç²¾å‡†å†œä¸šæœ€ä½³å®è·µ](https://www.precisionag.com/)
- [å†œä¸šç‰©è”ç½‘æ ‡å‡†](https://www.ioag.org/)

---

## 3. æ¡ˆä¾‹2ï¼šç²¾å‡†çŒæº‰ç³»ç»Ÿ

### 3.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
æ ¹æ®åœŸå£¤æ¹¿åº¦å’Œæ°”è±¡æ•°æ®ï¼Œå®ç°ç²¾å‡†çŒæº‰ï¼ŒèŠ‚çº¦æ°´èµ„æºï¼Œæé«˜ä½œç‰©æ°´åˆ†åˆ©ç”¨æ•ˆç‡ã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦å®æ—¶ç›‘æµ‹åœŸå£¤æ¹¿åº¦
- éœ€è¦é¢„æµ‹é™é›¨é‡
- éœ€è¦æ§åˆ¶çŒæº‰è®¾å¤‡

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨ä¼ æ„Ÿå™¨ç›‘æµ‹åœŸå£¤æ¹¿åº¦ï¼Œç»“åˆæ°”è±¡æ•°æ®é¢„æµ‹ï¼Œè‡ªåŠ¨æ§åˆ¶çŒæº‰ç³»ç»Ÿã€‚

### 3.2 å®ç°ä»£ç 

```python
def calculate_irrigation_need(storage, field_id: str) -> Dict:
    """è®¡ç®—çŒæº‰éœ€æ±‚"""
    # è·å–æœ€è¿‘24å°æ—¶ä¼ æ„Ÿå™¨æ•°æ®
    end_time = datetime.now()
    start_time = end_time - timedelta(hours=24)
    sensor_data = storage.get_field_sensors_in_period(field_id, start_time, end_time)
    
    if not sensor_data:
        return {"need_irrigation": False, "reason": "No sensor data"}
    
    # è®¡ç®—å¹³å‡åœŸå£¤æ¹¿åº¦
    moistures = [d.soil_moisture for d in sensor_data if d.soil_moisture is not None]
    avg_moisture = sum(moistures) / len(moistures) if moistures else 50
    
    # åˆ¤æ–­çŒæº‰éœ€æ±‚
    if avg_moisture < 40:
        irrigation_duration = max(0, (45 - avg_moisture) * 3)  # åˆ†é’Ÿ
        return {
            "need_irrigation": True,
            "irrigation_duration": irrigation_duration,
            "recommended_time": datetime.now() + timedelta(hours=1),
            "soil_moisture": avg_moisture
        }
    
    return {"need_irrigation": False, "soil_moisture": avg_moisture}
```

---

## 4. æ¡ˆä¾‹3ï¼šç²¾å‡†æ’­ç§ç³»ç»Ÿ

### 4.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
æ ¹æ®åœŸå£¤æ¡ä»¶å’Œä½œç‰©å“ç§ï¼Œå®ç°ç²¾å‡†æ’­ç§ï¼Œæé«˜æ’­ç§è´¨é‡ã€‚

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦æ ¹æ®åœŸå£¤æ¡ä»¶è°ƒæ•´æ’­ç§æ·±åº¦
- éœ€è¦æ§åˆ¶æ’­ç§å¯†åº¦
- éœ€è¦è®°å½•æ’­ç§ä½œä¸šæ•°æ®

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨å†œæœºä½œä¸šç³»ç»Ÿï¼Œæ ¹æ®åœŸå£¤æ•°æ®è‡ªåŠ¨è°ƒæ•´æ’­ç§å‚æ•°ã€‚

### 4.2 å®ç°ä»£ç 

```python
def calculate_seeding_parameters(storage, field_id: str, crop_type: str = "corn") -> Dict:
    """è®¡ç®—æ’­ç§å‚æ•°"""
    field = storage.fields.get(field_id)
    if not field:
        return None
    
    # æ ¹æ®åœŸå£¤æ¡ä»¶ç¡®å®šæ’­ç§å‚æ•°
    if crop_type == "corn":
        if field.soil_texture == SoilTexture.LOAMY:
            seed_rate = 82500  # ç²’/å…¬é¡·ï¼ˆçº¦6ä¸‡æ ª/äº©ï¼‰
            depth = 4.0  # å˜ç±³
        elif field.soil_texture == SoilTexture.SANDY:
            seed_rate = 90000
            depth = 5.0
        else:
            seed_rate = 75000
            depth = 3.5
    else:
        seed_rate = 60000
        depth = 3.0
    
    return {
        "seed_rate": seed_rate,
        "depth": depth,
        "row_spacing": 60,  # å˜ç±³
        "ph_requirement": (6.0, 7.5)
    }
```

---

**å‚è€ƒæ–‡æ¡£**ï¼š

- `01_Overview.md` - æ¦‚è¿°
- `02_Formal_Definition.md` - å½¢å¼åŒ–å®šä¹‰
- `03_Standards.md` - æ ‡å‡†å¯¹æ ‡
- `04_Transformation.md` - è½¬æ¢ä½“ç³»

**åˆ›å»ºæ—¶é—´**ï¼š2025-01-21
**æœ€åæ›´æ–°**ï¼š2025-01-21
