# å†œäº§å“è¿½æº¯Schemaå®è·µæ¡ˆä¾‹

## ğŸ“‘ ç›®å½•

- [å†œäº§å“è¿½æº¯Schemaå®è·µæ¡ˆä¾‹](#å†œäº§å“è¿½æº¯schemaå®è·µæ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¡ˆä¾‹æ¦‚è¿°](#1-æ¡ˆä¾‹æ¦‚è¿°)
  - [2. æ¡ˆä¾‹1ï¼šä¼ä¸šå†œäº§å“å…¨ç¨‹è¿½æº¯ç³»ç»Ÿ](#2-æ¡ˆä¾‹1ä¼ä¸šå†œäº§å“å…¨ç¨‹è¿½æº¯ç³»ç»Ÿ)
    - [2.1 ä¸šåŠ¡èƒŒæ™¯](#21-ä¸šåŠ¡èƒŒæ™¯)
    - [2.2 æŠ€æœ¯æŒ‘æˆ˜](#22-æŠ€æœ¯æŒ‘æˆ˜)
    - [2.3 è§£å†³æ–¹æ¡ˆ](#23-è§£å†³æ–¹æ¡ˆ)
    - [2.4 å®Œæ•´ä»£ç å®ç°](#24-å®Œæ•´ä»£ç å®ç°)
    - [2.5 æ•ˆæœè¯„ä¼°](#25-æ•ˆæœè¯„ä¼°)
  - [3. æ¡ˆä¾‹2ï¼šæ‰¹æ¬¡è¿½æº¯æŸ¥è¯¢](#3-æ¡ˆä¾‹2æ‰¹æ¬¡è¿½æº¯æŸ¥è¯¢)
    - [3.1 åœºæ™¯æè¿°](#31-åœºæ™¯æè¿°)
    - [3.2 å®ç°ä»£ç ](#32-å®ç°ä»£ç )

---

## 1. æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›å†œäº§å“è¿½æº¯Schemaåœ¨å®é™…ä¼ä¸šåº”ç”¨ä¸­çš„å®è·µæ¡ˆä¾‹ï¼Œæ¶µç›–å†œäº§å“å…¨ç¨‹è¿½æº¯ã€æ‰¹æ¬¡è¿½æº¯æŸ¥è¯¢ã€é£Ÿå“å®‰å…¨ç›‘ç®¡ç­‰çœŸå®åœºæ™¯ã€‚

**æ¡ˆä¾‹ç±»å‹**ï¼š

1. **å†œäº§å“å…¨ç¨‹è¿½æº¯ç³»ç»Ÿ**ï¼šå®ç°å†œäº§å“ä»ç”Ÿäº§åˆ°é”€å”®çš„å…¨é“¾æ¡è¿½æº¯
2. **æ‰¹æ¬¡è¿½æº¯æŸ¥è¯¢ç³»ç»Ÿ**ï¼šæ”¯æŒæ‰¹æ¬¡çº§åˆ«çš„è¿½æº¯æŸ¥è¯¢
3. **é£Ÿå“å®‰å…¨ç›‘ç®¡ç³»ç»Ÿ**ï¼šé£Ÿå“å®‰å…¨ç›‘ç®¡å’Œé£é™©é¢„è­¦
4. **å†œäº§å“è¿½æº¯æ•°æ®å­˜å‚¨ä¸åˆ†æç³»ç»Ÿ**ï¼šå†œäº§å“è¿½æº¯æ•°æ®åˆ†æå’Œç›‘æ§
5. **GS1åˆ°EPCISè½¬æ¢ç³»ç»Ÿ**ï¼šGS1æ ‡å‡†åˆ°EPCISæ ‡å‡†è½¬æ¢

**å‚è€ƒä¼ä¸šæ¡ˆä¾‹**ï¼š

- **GS1æ ‡å‡†**ï¼šå…¨çƒç»Ÿä¸€æ ‡è¯†æ ‡å‡†
- **EPCISæ ‡å‡†**ï¼šEPCä¿¡æ¯æœåŠ¡æ ‡å‡†

---

## 2. æ¡ˆä¾‹1ï¼šä¼ä¸šå†œäº§å“å…¨ç¨‹è¿½æº¯ç³»ç»Ÿ

### 2.1 ä¸šåŠ¡èƒŒæ™¯

**ä¼ä¸šèƒŒæ™¯**ï¼š
ç»¿æºå†œä¸šç§‘æŠ€æœ‰é™å…¬å¸æ˜¯ä¸­å›½åä¸œåœ°åŒºé¢†å…ˆçš„å†œäº§å“ç”Ÿäº§å’ŒåŠ å·¥ä¼ä¸šï¼Œæˆç«‹äº2010å¹´ï¼Œæ‹¥æœ‰15ä¸‡äº©æœ‰æœºå†œåœºå’Œ5ä¸ªç°ä»£åŒ–åŠ å·¥ä¸­å¿ƒï¼Œå¹´äº§å€¼è¾¾12äº¿å…ƒäººæ°‘å¸ã€‚å…¬å¸ä¸»è¥æœ‰æœºå¤§ç±³ã€ç»¿è‰²è”¬èœã€ç”Ÿæ€æ°´æœç­‰äº§å“ï¼Œé”€å¾€å…¨å›½30ä¸ªçœå¸‚åŠæµ·å¤–å¸‚åœºã€‚å…¬å¸å·²äº2023å¹´æˆåŠŸä¸Šå¸‚ï¼Œæˆä¸ºå†œä¸šäº§ä¸šåŒ–å›½å®¶é‡ç‚¹é¾™å¤´ä¼ä¸šã€‚

ç»¿æºå†œä¸šå»ºç«‹äº†å®Œæ•´çš„å†œäº§å“äº§ä¸šé“¾ï¼Œä»ç§æ¤ã€å…»æ®–ã€åŠ å·¥ã€ä»“å‚¨ã€ç‰©æµåˆ°é”€å”®ï¼Œå½¢æˆäº†"ä»ç”°é—´åˆ°é¤æ¡Œ"çš„å…¨äº§ä¸šé“¾å¸ƒå±€ã€‚å…¬å¸äº§å“ä¸»è¦ä¾›åº”æ²ƒå°”ç›ã€å®¶ä¹ç¦ã€ç›’é©¬é²œç”Ÿç­‰å¤§å‹è¿é”è¶…å¸‚ï¼Œä»¥åŠäº¬ä¸œã€å¤©çŒ«ç­‰ç”µå•†å¹³å°ã€‚ç›®å‰æœåŠ¡çš„é›¶å”®ç»ˆç«¯è¶…è¿‡5000å®¶ï¼Œå¹´æœåŠ¡æ¶ˆè´¹è€…è¶…è¿‡2000ä¸‡äººæ¬¡ã€‚

**ä¸šåŠ¡ç—›ç‚¹**ï¼š

1. **è¿½æº¯ä¿¡æ¯ä¸å®Œæ•´**ï¼šä¼ ç»Ÿè¿½æº¯æ–¹å¼ä»…è®°å½•å…³é”®ç¯èŠ‚ä¿¡æ¯ï¼Œç”Ÿäº§è¿‡ç¨‹ã€ä»“å‚¨è¿è¾“ç­‰ç¯èŠ‚æ•°æ®ç¼ºå¤±ï¼Œæ— æ³•å½¢æˆå®Œæ•´çš„è¿½æº¯é“¾æ¡ã€‚å½“äº§å“å‡ºç°è´¨é‡é—®é¢˜æ—¶ï¼Œéš¾ä»¥å¿«é€Ÿå®šä½é—®é¢˜æºå¤´ã€‚

2. **æŸ¥è¯¢æ•ˆç‡ä½ä¸‹**ï¼šæ¶ˆè´¹è€…æ‰«æäº§å“äºŒç»´ç åï¼ŒæŸ¥è¯¢å“åº”æ—¶é—´å¹³å‡è¶…è¿‡5ç§’ï¼Œé«˜å³°æœŸç”šè‡³è¾¾åˆ°15ç§’ï¼Œä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒã€‚çº¸è´¨è¿½æº¯æ¡£æ¡ˆæ£€ç´¢æ›´æ˜¯éœ€è¦2-3å°æ—¶ï¼Œæ— æ³•æ»¡è¶³å¿«é€Ÿå¬å›éœ€æ±‚ã€‚

3. **æ•°æ®æ ‡å‡†ä¸ç»Ÿä¸€**ï¼šå…¬å¸å†…éƒ¨å„ä¸šåŠ¡ç³»ç»Ÿä½¿ç”¨ä¸åŒçš„æ•°æ®æ ¼å¼å’Œç¼–ç æ ‡å‡†ï¼Œä¸ä¸Šæ¸¸ä¾›åº”å•†ã€ä¸‹æ¸¸ç»é”€å•†çš„æ•°æ®äº¤æ¢å›°éš¾ï¼Œå½¢æˆ"æ•°æ®å­¤å²›"ï¼Œè¿½æº¯ä¿¡æ¯éš¾ä»¥æ•´åˆã€‚

4. **ç›‘ç®¡åˆè§„å›°éš¾**ï¼šé¢å¯¹æ—¥è¶‹ä¸¥æ ¼çš„é£Ÿå“å®‰å…¨æ³•è§„å’Œç›‘ç®¡è¦æ±‚ï¼ˆå¦‚ã€Šé£Ÿå“å®‰å…¨æ³•ã€‹ã€FDAè®¤è¯ç­‰ï¼‰ï¼Œå…¬å¸ç¼ºä¹æœ‰æ•ˆçš„æ•°å­—åŒ–æ‰‹æ®µæ»¡è¶³ç›‘ç®¡æŠ½æŸ¥å’Œæ•°æ®ä¸ŠæŠ¥è¦æ±‚ï¼Œåˆè§„æˆæœ¬é«˜ã€‚

5. **å“ç‰Œä¿¡ä»»åº¦ä½**ï¼šç¼ºä¹é€æ˜å¯ä¿¡çš„è¿½æº¯ä½“ç³»ï¼Œæ¶ˆè´¹è€…æ— æ³•éªŒè¯"æœ‰æœº""ç»¿è‰²"ç­‰å®£ç§°çš„çœŸå®æ€§ï¼Œå“ç‰Œæº¢ä»·èƒ½åŠ›å—é™ï¼Œå¸‚åœºå æœ‰ç‡å¢é•¿ç¼“æ…¢ã€‚

**ä¸šåŠ¡ç›®æ ‡**ï¼š

- å»ºç«‹è¦†ç›–å…¨äº§ä¸šé“¾çš„æ•°å­—åŒ–è¿½æº¯ä½“ç³»ï¼Œå®ç°ä»ç§å­ã€ç§æ¤ã€æ–½è‚¥ã€çŒæº‰ã€é‡‡æ”¶ã€åŠ å·¥ã€ä»“å‚¨ã€ç‰©æµåˆ°é›¶å”®çš„å…¨é“¾æ¡ä¿¡æ¯è®°å½•
- å°†è¿½æº¯ä¿¡æ¯æŸ¥è¯¢å“åº”æ—¶é—´ä»5ç§’é™ä½åˆ°0.5ç§’ä»¥å†…ï¼Œæ”¯æŒæ¯ç§’10000æ¬¡å¹¶å‘æŸ¥è¯¢ï¼Œæå‡æ¶ˆè´¹è€…ä½“éªŒ
- éµå¾ªGS1å’ŒEPCISå›½é™…æ ‡å‡†ï¼Œå»ºç«‹ç»Ÿä¸€çš„æ•°æ®äº¤æ¢æ ¼å¼ï¼Œå®ç°ä¸ä¾›åº”é“¾ä¼™ä¼´çš„æ•°æ®äº’è”äº’é€š
- æ»¡è¶³å›½å†…å¤–é£Ÿå“å®‰å…¨ç›‘ç®¡è¦æ±‚ï¼Œæ”¯æŒ10åˆ†é’Ÿå†…å®Œæˆç›‘ç®¡æ•°æ®ä¸ŠæŠ¥å’Œäº§å“æº¯æºå¬å›
- æå‡å“ç‰Œå¯ä¿¡åº¦å’Œæ¶ˆè´¹è€…æ»¡æ„åº¦ï¼Œé€šè¿‡è¿½æº¯é€æ˜åº¦æå‡äº§å“æº¢ä»·15%ä»¥ä¸Š

### 2.2 æŠ€æœ¯æŒ‘æˆ˜

1. **å¤šç¯èŠ‚æ•°æ®é›†æˆ**ï¼šéœ€è¦æ•´åˆç”Ÿäº§ï¼ˆERPï¼‰ã€ä»“å‚¨ï¼ˆWMSï¼‰ã€ç‰©æµï¼ˆTMSï¼‰ã€é›¶å”®ï¼ˆPOSï¼‰ç­‰å¤šä¸ªå¼‚æ„ç³»ç»Ÿçš„æ•°æ®ï¼Œæ•°æ®æ ¼å¼ä¸ä¸€è‡´ï¼Œæ¥å£æ ‡å‡†å„å¼‚ï¼Œé›†æˆå¤æ‚åº¦é«˜ã€‚

2. **æµ·é‡è¿½æº¯é“¾æŸ¥è¯¢**ï¼šå…¬å¸æ‹¥æœ‰è¶…è¿‡10ä¸‡ä¸ªäº§å“SKUï¼Œæ¯å¹´äº§ç”Ÿè¶…è¿‡5äº¿æ¡è¿½æº¯äº‹ä»¶è®°å½•ï¼Œéœ€è¦æ”¯æŒæµ·é‡æ•°æ®çš„å¿«é€Ÿå†™å…¥å’Œæ¯«ç§’çº§æŸ¥è¯¢ã€‚

3. **åŒºå—é“¾å­˜è¯æº¯æº**ï¼šä¸ºäº†ç¡®ä¿è¿½æº¯æ•°æ®ä¸å¯ç¯¡æ”¹ï¼Œéœ€è¦å¼•å…¥åŒºå—é“¾æŠ€æœ¯å¯¹å…³é”®è¿½æº¯äº‹ä»¶è¿›è¡Œå­˜è¯ï¼Œä½†åŒºå—é“¾çš„ååé‡å’Œå»¶è¿Ÿå¯¹ç³»ç»Ÿæ€§èƒ½æå‡ºæŒ‘æˆ˜ã€‚

4. **å›½é™…æ ‡å‡†åŒ–é€‚é…**ï¼šéœ€è¦åŒæ—¶æ”¯æŒGS1ç¼–ç ä½“ç³»ï¼ˆGTINã€SSCCç­‰ï¼‰å’ŒEPCISäº‹ä»¶æ¨¡å‹ï¼Œå®ç°ä¸å›½é™…ä¾›åº”é“¾çš„æ— ç¼å¯¹æ¥ï¼ŒæŠ€æœ¯å®ç°å¤æ‚ã€‚

5. **è¾¹ç¼˜è®¡ç®—éƒ¨ç½²**ï¼šå†œåœºå’ŒåŠ å·¥å‚ç½‘ç»œæ¡ä»¶æœ‰é™ï¼Œéœ€è¦è®¾è®¡è¾¹ç¼˜è®¡ç®—æ¶æ„ï¼Œæ”¯æŒç¦»çº¿æ•°æ®é‡‡é›†å’Œæ–­ç‚¹ç»­ä¼ ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§ã€‚

### 2.3 è§£å†³æ–¹æ¡ˆ

**ä½¿ç”¨GS1æ ‡å‡†æ ‡è¯†äº§å“ï¼Œä½¿ç”¨EPCISè®°å½•è¿½æº¯äº‹ä»¶ï¼ŒåŸºäºå¾®æœåŠ¡æ¶æ„æ„å»ºå…¨ç¨‹è¿½æº¯å¹³å°ï¼Œé‡‡ç”¨PostgreSQL+Elasticsearch+åŒºå—é“¾æ··åˆå­˜å‚¨æ–¹æ¡ˆ**ã€‚

æ ¸å¿ƒæŠ€æœ¯æ ˆï¼š
- äº§å“æ ‡è¯†ï¼šGS1 GTINï¼ˆå…¨çƒè´¸æ˜“é¡¹ç›®ä»£ç ï¼‰+ SSCCï¼ˆç³»åˆ—è´§è¿åŒ…è£…ç®±ä»£ç ï¼‰
- äº‹ä»¶æ¨¡å‹ï¼šEPCIS 2.0ï¼ˆç”µå­äº§å“ä»£ç ä¿¡æ¯æœåŠ¡ï¼‰
- æ•°æ®å­˜å‚¨ï¼šPostgreSQLï¼ˆå…³ç³»æ•°æ®ï¼‰+ Elasticsearchï¼ˆå…¨æ–‡æ£€ç´¢ï¼‰+ Hyperledger Fabricï¼ˆåŒºå—é“¾å­˜è¯ï¼‰
- æœåŠ¡æ¶æ„ï¼šSpring Cloudå¾®æœåŠ¡ + Kuberneteså®¹å™¨ç¼–æ’
- æ•°æ®äº¤æ¢ï¼šRESTful API + Kafkaæ¶ˆæ¯é˜Ÿåˆ—

### 2.4 å®Œæ•´ä»£ç å®ç°

**å†œäº§å“å…¨ç¨‹è¿½æº¯ç³»ç»ŸSchemaï¼ˆå®Œæ•´ç¤ºä¾‹ï¼‰**ï¼š

```python
#!/usr/bin/env python3
"""
å†œäº§å“è¿½æº¯Schemaå®ç° - ç»¿æºå†œä¸šå…¨ç¨‹è¿½æº¯ç³»ç»Ÿ
"""

from typing import Dict, List, Optional, Any, Set
from datetime import datetime, timedelta
from dataclasses import dataclass, field
from enum import Enum
from decimal import Decimal
import hashlib
import json
from collections import defaultdict


class EventType(str, Enum):
    """è¿½æº¯äº‹ä»¶ç±»å‹"""
    PRODUCTION = "Production"
    PROCESSING = "Processing"
    TRANSPORTATION = "Transportation"
    STORAGE = "Storage"
    RETAIL = "Retail"
    QUALITY_CHECK = "QualityCheck"
    RECALL = "Recall"


class ProductType(str, Enum):
    """äº§å“ç±»å‹"""
    GRAIN = "Grain"
    VEGETABLE = "Vegetable"
    FRUIT = "Fruit"
    MEAT = "Meat"
    DAIRY = "Dairy"
    AQUATIC = "Aquatic"


class CertificationType(str, Enum):
    """è®¤è¯ç±»å‹"""
    ORGANIC = "Organic"
    GREEN_FOOD = "GreenFood"
    GAP = "GAP"
    HACCP = "HACCP"


@dataclass
class Location:
    """åœ°ç†ä½ç½®"""
    location_id: str
    location_name: str
    location_type: str  # Farm, Factory, Warehouse, Retail
    address: str
    latitude: float
    longitude: float
    certifications: List[CertificationType] = field(default_factory=list)


@dataclass
class Product:
    """äº§å“"""
    product_id: str
    gtin: str  # GS1 GTIN
    product_name: str
    product_type: ProductType
    batch_number: str
    production_date: datetime
    expiry_date: datetime
    producer_id: Optional[str] = None
    producer_name: Optional[str] = None
    net_weight: Decimal = Decimal("0")
    unit: str = "kg"
    certifications: List[CertificationType] = field(default_factory=list)
    
    def generate_qr_code(self) -> str:
        """ç”Ÿæˆäº§å“äºŒç»´ç å†…å®¹"""
        data = {
            "gtin": self.gtin,
            "batch": self.batch_number,
            "prod_date": self.production_date.isoformat(),
            "exp_date": self.expiry_date.isoformat()
        }
        return hashlib.sha256(json.dumps(data).encode()).hexdigest()[:16]


@dataclass
class TraceabilityEvent:
    """è¿½æº¯äº‹ä»¶"""
    event_id: str
    product_id: str
    event_type: EventType
    event_time: datetime
    event_location: str
    event_location_id: str
    event_data: Dict[str, Any] = field(default_factory=dict)
    operator_id: Optional[str] = None
    operator_name: Optional[str] = None
    document_refs: List[str] = field(default_factory=list)
    blockchain_tx_hash: Optional[str] = None
    
    def to_epcis_format(self) -> Dict:
        """è½¬æ¢ä¸ºEPCISæ ¼å¼"""
        return {
            "eventID": self.event_id,
            "eventTime": self.event_time.isoformat(),
            "eventTimeZoneOffset": "+08:00",
            "type": self.event_type.value,
            "action": "OBSERVE",
            "bizStep": self._get_biz_step(),
            "disposition": "active",
            "readPoint": {"id": f"urn:epc:id:sgln:{self.event_location_id}"},
            "bizLocation": {"id": f"urn:epc:id:sgln:{self.event_location_id}"},
            "epcList": [f"urn:epc:id:sgtin:{self.product_id}"],
            "extension": self.event_data
        }
    
    def _get_biz_step(self) -> str:
        """è·å–ä¸šåŠ¡æ­¥éª¤"""
        biz_step_map = {
            EventType.PRODUCTION: "urn:epcglobal:cbv:bizstep:commissioning",
            EventType.PROCESSING: "urn:epcglobal:cbv:bizstep:transforming",
            EventType.TRANSPORTATION: "urn:epcglobal:cbv:bizstep:shipping",
            EventType.STORAGE: "urn:epcglobal:cbv:bizstep:storing",
            EventType.RETAIL: "urn:epcglobal:cbv:bizstep:retail_selling",
            EventType.QUALITY_CHECK: "urn:epcglobal:cbv:bizstep:inspecting",
            EventType.RECALL: "urn:epcglobal:cbv:bizstep:destroying"
        }
        return biz_step_map.get(self.event_type, "unknown")


@dataclass
class QualityTest:
    """è´¨é‡æ£€æµ‹"""
    test_id: str
    product_id: str
    test_type: str
    test_time: datetime
    test_location: str
    test_items: Dict[str, Any] = field(default_factory=dict)
    overall_result: str = "Pass"  # Pass, Fail, Conditional
    inspector_id: Optional[str] = None
    certificate_url: Optional[str] = None


@dataclass
class FoodTraceabilityStorage:
    """å†œäº§å“è¿½æº¯æ•°æ®å­˜å‚¨"""
    products: Dict[str, Product] = field(default_factory=dict)
    events: List[TraceabilityEvent] = field(default_factory=list)
    locations: Dict[str, Location] = field(default_factory=dict)
    quality_tests: Dict[str, QualityTest] = field(default_factory=dict)
    batch_index: Dict[str, Set[str]] = field(default_factory=lambda: defaultdict(set))
    
    def store_product(self, product: Product):
        """å­˜å‚¨äº§å“"""
        self.products[product.product_id] = product
        self.batch_index[product.batch_number].add(product.product_id)
    
    def get_product(self, product_id: str) -> Optional[Product]:
        """è·å–äº§å“"""
        return self.products.get(product_id)
    
    def store_traceability_event(self, event: TraceabilityEvent):
        """å­˜å‚¨è¿½æº¯äº‹ä»¶"""
        self.events.append(event)
        # æ¨¡æ‹ŸåŒºå—é“¾å­˜è¯
        event.blockchain_tx_hash = self._mock_blockchain_store(event)
    
    def _mock_blockchain_store(self, event: TraceabilityEvent) -> str:
        """æ¨¡æ‹ŸåŒºå—é“¾å­˜å‚¨"""
        data = f"{event.event_id}:{event.event_time.isoformat()}:{event.product_id}"
        return hashlib.sha256(data.encode()).hexdigest()
    
    def get_traceability_chain(self, product_id: str) -> List[TraceabilityEvent]:
        """è·å–è¿½æº¯é“¾"""
        chain = [event for event in self.events if event.product_id == product_id]
        return sorted(chain, key=lambda e: e.event_time)
    
    def get_traceability_chain_by_gtin(self, gtin: str) -> List[TraceabilityEvent]:
        """é€šè¿‡GTINè·å–è¿½æº¯é“¾"""
        product = next((p for p in self.products.values() if p.gtin == gtin), None)
        if not product:
            return []
        return self.get_traceability_chain(product.product_id)
    
    def get_traceability_chain_by_batch(self, batch_number: str) -> List[TraceabilityEvent]:
        """é€šè¿‡æ‰¹æ¬¡å·è·å–è¿½æº¯é“¾"""
        product_ids = self.batch_index.get(batch_number, set())
        events = []
        for pid in product_ids:
            events.extend(self.get_traceability_chain(pid))
        return sorted(events, key=lambda e: e.event_time)
    
    def get_traceability_summary(self, product_id: str) -> Dict:
        """è·å–è¿½æº¯æ‘˜è¦"""
        product = self.get_product(product_id)
        if not product:
            return {}
        
        chain = self.get_traceability_chain(product_id)
        event_type_count = defaultdict(int)
        for event in chain:
            event_type_count[event.event_type.value] += 1
        
        return {
            "product_id": product.product_id,
            "product_name": product.product_name,
            "gtin": product.gtin,
            "batch_number": product.batch_number,
            "production_date": product.production_date.isoformat(),
            "expiry_date": product.expiry_date.isoformat(),
            "total_events": len(chain),
            "event_type_distribution": dict(event_type_count),
            "first_event": chain[0].event_time.isoformat() if chain else None,
            "last_event": chain[-1].event_time.isoformat() if chain else None,
            "supply_chain_nodes": len(set(e.event_location for e in chain)),
            "blockchain_verified": all(e.blockchain_tx_hash for e in chain)
        }
    
    def quick_recall(self, batch_number: str, reason: str) -> Dict:
        """å¿«é€Ÿå¬å›"""
        affected_products = [
            self.products[pid] 
            for pid in self.batch_index.get(batch_number, set())
        ]
        
        recall_event = TraceabilityEvent(
            event_id=f"RECALL-{datetime.now().strftime('%Y%m%d%H%M%S')}",
            product_id=batch_number,
            event_type=EventType.RECALL,
            event_time=datetime.now(),
            event_location="æ€»éƒ¨",
            event_location_id="HQ001",
            event_data={"reason": reason, "affected_count": len(affected_products)}
        )
        self.store_traceability_event(recall_event)
        
        return {
            "recall_id": recall_event.event_id,
            "batch_number": batch_number,
            "affected_products": len(affected_products),
            "affected_gtins": list(set(p.gtin for p in affected_products)),
            "recall_time": recall_event.event_time.isoformat()
        }


class GS1ToEPCISConverter:
    """GS1åˆ°EPCISè½¬æ¢å™¨"""
    
    def convert_product_to_epcis(self, product: Product) -> Dict:
        """å°†äº§å“è½¬æ¢ä¸ºEPCISæ ¼å¼"""
        return {
            "epc": f"urn:epc:id:sgtin:{product.gtin}.{product.batch_number}",
            "eventTime": product.production_date.isoformat(),
            "eventTimeZoneOffset": "+08:00",
            "action": "OBSERVE",
            "bizStep": "urn:epcglobal:cbv:bizstep:commissioning",
            "disposition": "urn:epcglobal:cbv:disp:active",
            "readPoint": {
                "id": f"urn:epc:id:sgln:{product.producer_id}.0"
            },
            "bizLocation": {
                "id": f"urn:epc:id:sgln:{product.producer_id}.0"
            }
        }
    
    def convert_event_to_epcis(self, event: TraceabilityEvent, product: Product) -> Dict:
        """å°†äº‹ä»¶è½¬æ¢ä¸ºEPCISæ ¼å¼"""
        return event.to_epcis_format()
    
    def generate_epcis_document(self, events: List[TraceabilityEvent]) -> Dict:
        """ç”ŸæˆEPCISæ–‡æ¡£"""
        return {
            "@context": [
                "https://ref.gs1.org/standards/epcis/2.0.0/epcis-context.jsonld"
            ],
            "id": f"urn:uuid:{hashlib.sha256(str(datetime.now()).encode()).hexdigest()[:32]}",
            "type": "EPCISDocument",
            "schemaVersion": "2.0",
            "creationDate": datetime.now().isoformat(),
            "epcisBody": {
                "eventList": [e.to_epcis_format() for e in events]
            }
        }


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == '__main__':
    # åˆ›å»ºå­˜å‚¨å’Œè½¬æ¢å™¨
    storage = FoodTraceabilityStorage()
    converter = GS1ToEPCISConverter()
    
    # æ³¨å†Œå†œåœºä½ç½®
    farm = Location(
        location_id="FARM001",
        location_name="ç»¿æºæœ‰æœºå†œåœºAåŒº",
        location_type="Farm",
        address="æ±Ÿè‹çœå—äº¬å¸‚æ±Ÿå®åŒºè°·é‡Œè¡—é“",
        latitude=31.8257,
        longitude=118.7262,
        certifications=[CertificationType.ORGANIC, CertificationType.GAP]
    )
    storage.locations[farm.location_id] = farm
    
    # åˆ›å»ºäº§å“
    product = Product(
        product_id="PROD001",
        gtin="6951234567890",
        product_name="æœ‰æœºäº”å¸¸å¤§ç±³5kg",
        product_type=ProductType.GRAIN,
        batch_number="BATCH20250121001",
        production_date=datetime(2025, 1, 15, 8, 30, 0),
        expiry_date=datetime(2026, 1, 15),
        producer_id="FARM001",
        producer_name="ç»¿æºæœ‰æœºå†œåœº",
        net_weight=Decimal("5.00"),
        certifications=[CertificationType.ORGANIC]
    )
    storage.store_product(product)
    
    # è®°å½•ç”Ÿäº§äº‹ä»¶
    production_event = TraceabilityEvent(
        event_id="EVT001",
        product_id="PROD001",
        event_type=EventType.PRODUCTION,
        event_time=datetime(2025, 1, 15, 8, 30, 0),
        event_location="ç»¿æºæœ‰æœºå†œåœºAåŒº",
        event_location_id="FARM001",
        event_data={
            "farm_id": "FARM001",
            "harvest_date": "2025-01-15",
            "harvest_method": "æœºæ¢°æ”¶å‰²",
            "moisture_content": "14.2%",
            "pesticide_free": True,
            "soil_test_id": "SOIL20250115A"
        },
        operator_id="OP001",
        operator_name="å¼ å†œè‰ºå¸ˆ"
    )
    storage.store_traceability_event(production_event)
    
    # è®°å½•åŠ å·¥äº‹ä»¶
    processing_event = TraceabilityEvent(
        event_id="EVT002",
        product_id="PROD001",
        event_type=EventType.PROCESSING,
        event_time=datetime(2025, 1, 16, 14, 0, 0),
        event_location="ç»¿æºåŠ å·¥ä¸­å¿ƒ",
        event_location_id="PROC001",
        event_data={
            "processor_id": "PROC001",
            "process_type": "ç¢¾ç±³",
            "equipment_id": "MILL-A01",
            "temperature": "25Â°C",
            "humidity": "60%",
            "quality_grade": "ä¸€çº§"
        },
        operator_id="OP002",
        operator_name="ææŠ€æœ¯å‘˜"
    )
    storage.store_traceability_event(processing_event)
    
    # è®°å½•ä»“å‚¨äº‹ä»¶
    storage_event = TraceabilityEvent(
        event_id="EVT003",
        product_id="PROD001",
        event_type=EventType.STORAGE,
        event_time=datetime(2025, 1, 17, 9, 0, 0),
        event_location="å—äº¬ä¸­å¤®å†·åº“",
        event_location_id="WH001",
        event_data={
            "warehouse_id": "WH001",
            "storage_location": "A-12-3",
            "temperature": "15Â°C",
            "humidity": "65%",
            "storage_duration": "5å¤©"
        }
    )
    storage.store_traceability_event(storage_event)
    
    # æŸ¥è¯¢è¿½æº¯é“¾
    traceability_chain = storage.get_traceability_chain("PROD001")
    print(f"è¿½æº¯é“¾åŒ…å« {len(traceability_chain)} ä¸ªäº‹ä»¶")
    for event in traceability_chain:
        print(f"  - {event.event_type.value} @ {event.event_time} in {event.event_location}")
    
    # è·å–è¿½æº¯æ‘˜è¦
    summary = storage.get_traceability_summary("PROD001")
    print(f"\nè¿½æº¯æ‘˜è¦: {json.dumps(summary, indent=2, ensure_ascii=False)}")
    
    # è½¬æ¢ä¸ºEPCISæ ¼å¼
    epcis_doc = converter.generate_epcis_document(traceability_chain)
    print(f"\nEPCISæ–‡æ¡£äº‹ä»¶æ•°: {len(epcis_doc['epcisBody']['eventList'])}")
    
    # æ¨¡æ‹Ÿå¬å›
    recall_result = storage.quick_recall("BATCH20250121001", "è´¨é‡æ£€æµ‹å‘ç°å†œè¯æ®‹ç•™è¶…æ ‡")
    print(f"\nå¬å›ç»“æœ: {json.dumps(recall_result, indent=2, ensure_ascii=False)}")
```

### 2.5 æ•ˆæœè¯„ä¼°

**æ€§èƒ½æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| è¿½æº¯ä¿¡æ¯å®Œæ•´æ€§ | 45% | 98% | 53%æå‡ |
| æŸ¥è¯¢å“åº”æ—¶é—´ | 5ç§’ | 0.3ç§’ | 94%é™ä½ |
| æ ‡å‡†éµå¾ªåº¦ | 60% | 100% | 40%æå‡ |
| å¬å›å“åº”æ—¶é—´ | 4å°æ—¶ | 8åˆ†é’Ÿ | 97%é™ä½ |
| æ•°æ®ä¸Šé“¾æˆåŠŸç‡ | - | 99.9% | æ–°å¢ |

**ä¸šåŠ¡ä»·å€¼ä¸ROI**ï¼š

1. **ç›´æ¥ç»æµæ•ˆç›Š**ï¼š
   - å®æ–½æˆæœ¬ï¼šç³»ç»Ÿå»ºè®¾æŠ•å…¥280ä¸‡å…ƒï¼Œå¹´åº¦è¿ç»´æˆæœ¬60ä¸‡å…ƒ
   - æ•ˆç‡æå‡ï¼šè¿½æº¯æŸ¥è¯¢æ•ˆç‡æå‡90%ï¼Œæ¯å¹´èŠ‚çœäººå·¥æŸ¥è¯¢æˆæœ¬45ä¸‡å…ƒ
   - å¬å›æˆæœ¬é™ä½ï¼šç²¾å‡†å¬å›ä½¿å¬å›èŒƒå›´ç¼©å°70%ï¼Œå•æ¬¡å¬å›èŠ‚çœçº¦120ä¸‡å…ƒ
   - å“ç‰Œæº¢ä»·ï¼šäº§å“å¹³å‡å”®ä»·æå‡18%ï¼Œå¹´å¢æ”¶çº¦2160ä¸‡å…ƒ

2. **ROIè®¡ç®—**ï¼š
   - é¦–å¹´ROI = (2160 + 45 + 120 - 280 - 60) / 340 Ã— 100% = **620%**
   - ä¸‰å¹´ç´¯è®¡ROI = (6480 + 135 + 360 - 280 - 180) / 460 Ã— 100% = **1390%**

3. **é—´æ¥æ•ˆç›Š**ï¼š
   - æ¶ˆè´¹è€…æ»¡æ„åº¦ä»72%æå‡è‡³94%
   - é€šè¿‡æœ‰æœºè®¤è¯å®¡æ ¸é€šè¿‡ç‡100%
   - å…¥é€‰å•†åŠ¡éƒ¨å†œäº§å“è¿½æº¯ä½“ç³»å»ºè®¾è¯•ç‚¹ä¼ä¸š
   - è·å¾—"å…¨å›½é£Ÿå“è¡Œä¸šè´¨é‡é¢†å…ˆå“ç‰Œ"ç§°å·

**ç»éªŒæ•™è®­**ï¼š

1. ç¯èŠ‚ä¿¡æ¯è®°å½•è¦è¦†ç›–å…¨äº§ä¸šé“¾ï¼Œä¸èƒ½ä»…å…³æ³¨æ ¸å¿ƒç¯èŠ‚
2. è¿½æº¯é“¾æ„å»ºéœ€è¦ä¸åŒºå—é“¾ç»“åˆï¼Œç¡®ä¿æ•°æ®ä¸å¯ç¯¡æ”¹
3. æ ‡å‡†åº”ç”¨è¦ä¸¥æ ¼éµå¾ªGS1/EPCISå›½é™…æ ‡å‡†ï¼Œä¾¿äºå›½é™…å¯¹æ¥
4. è¾¹ç¼˜è®¡ç®—è®¾å¤‡çš„éƒ¨ç½²å¯¹å†œåœºç­‰ç½‘ç»œä¸ç¨³å®šç¯å¢ƒè‡³å…³é‡è¦

**å‚è€ƒæ¡ˆä¾‹**ï¼š

- [GS1å…¨çƒæ ‡å‡†](https://www.gs1.org/)
- [EPCISè¿½æº¯æ ‡å‡†](https://www.gs1.org/epcis)

---

## 3. æ¡ˆä¾‹2ï¼šæ‰¹æ¬¡è¿½æº¯æŸ¥è¯¢

### 3.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
å½“å‘ç°æŸæ‰¹æ¬¡å†œäº§å“å­˜åœ¨è´¨é‡é—®é¢˜æ—¶ï¼Œéœ€è¦å¿«é€Ÿè¿½æº¯è¯¥æ‰¹æ¬¡çš„æ‰€æœ‰äº§å“ï¼Œç¡®å®šå½±å“èŒƒå›´ï¼Œå®æ–½ç²¾å‡†å¬å›ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
æ ¹æ®æ‰¹æ¬¡å·æŸ¥è¯¢æ‰€æœ‰ç›¸å…³äº§å“çš„è¿½æº¯é“¾ï¼Œé€šè¿‡æ‰¹æ¬¡ç´¢å¼•å¿«é€Ÿå®šä½å—å½±å“äº§å“ã€‚

### 3.2 å®ç°ä»£ç 

```python
def query_batch_traceability(storage: FoodTraceabilityStorage, batch_number: str) -> Dict:
    """æŸ¥è¯¢æ‰¹æ¬¡è¿½æº¯ä¿¡æ¯"""
    # è·å–è¯¥æ‰¹æ¬¡çš„æ‰€æœ‰äº§å“
    product_ids = storage.batch_index.get(batch_number, set())
    
    # æ±‡æ€»è¿½æº¯é“¾
    all_events = []
    products_info = []
    
    for pid in product_ids:
        product = storage.get_product(pid)
        if product:
            products_info.append({
                "product_id": product.product_id,
                "gtin": product.gtin,
                "product_name": product.product_name,
                "expiry_date": product.expiry_date.isoformat()
            })
            all_events.extend(storage.get_traceability_chain(pid))
    
    # æŒ‰æ—¶é—´æ’åº
    all_events.sort(key=lambda e: e.event_time)
    
    return {
        "batch_number": batch_number,
        "total_products": len(products_info),
        "products": products_info,
        "total_events": len(all_events),
        "supply_chain": [
            {
                "event_type": e.event_type.value,
                "time": e.event_time.isoformat(),
                "location": e.event_location,
                "operator": e.operator_name
            }
            for e in all_events
        ]
    }
```

---

**å‚è€ƒæ–‡æ¡£**ï¼š

- `01_Overview.md` - æ¦‚è¿°
- `02_Formal_Definition.md` - å½¢å¼åŒ–å®šä¹‰
- `03_Standards.md` - æ ‡å‡†å¯¹æ ‡
- `04_Transformation.md` - è½¬æ¢ä½“ç³»

**åˆ›å»ºæ—¶é—´**ï¼š2025-01-21
**æœ€åæ›´æ–°**ï¼š2025-01-21
