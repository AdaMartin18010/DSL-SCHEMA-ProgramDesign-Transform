# å†œäº§å“è¿½æº¯Schemaå®è·µæ¡ˆä¾‹

## ğŸ“‘ ç›®å½•

- [å†œäº§å“è¿½æº¯Schemaå®è·µæ¡ˆä¾‹](#å†œäº§å“è¿½æº¯schemaå®è·µæ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¡ˆä¾‹æ¦‚è¿°](#1-æ¡ˆä¾‹æ¦‚è¿°)
  - [2. æ¡ˆä¾‹1ï¼šä¼ä¸šå†œäº§å“å…¨ç¨‹è¿½æº¯ç³»ç»Ÿ](#2-æ¡ˆä¾‹1ä¼ä¸šå†œäº§å“å…¨ç¨‹è¿½æº¯ç³»ç»Ÿ)
    - [2.1 ä¸šåŠ¡èƒŒæ™¯](#21-ä¸šåŠ¡èƒŒæ™¯)
    - [2.2 æŠ€æœ¯æŒ‘æˆ˜](#22-æŠ€æœ¯æŒ‘æˆ˜)
    - [2.3 è§£å†³æ–¹æ¡ˆ](#23-è§£å†³æ–¹æ¡ˆ)
    - [2.4 å®Œæ•´ä»£ç å®ç°](#24-å®Œæ•´ä»£ç å®ç°)
    - [2.5 æ•ˆæœè¯„ä¼°](#25-æ•ˆæœè¯„ä¼°)
  - [3. æ¡ˆä¾‹2ï¼šæ‰¹æ¬¡è¿½æº¯æŸ¥è¯¢](#3-æ¡ˆä¾‹2æ‰¹æ¬¡è¿½æº¯æŸ¥è¯¢)
    - [3.1 åœºæ™¯æè¿°](#31-åœºæ™¯æè¿°)
    - [3.2 å®ç°ä»£ç ](#32-å®ç°ä»£ç )

---

## 1. æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›å†œäº§å“è¿½æº¯Schemaåœ¨å®é™…ä¼ä¸šåº”ç”¨ä¸­çš„å®è·µæ¡ˆä¾‹ï¼Œæ¶µç›–å†œäº§å“å…¨ç¨‹è¿½æº¯ã€æ‰¹æ¬¡è¿½æº¯æŸ¥è¯¢ã€é£Ÿå“å®‰å…¨ç›‘ç®¡ç­‰çœŸå®åœºæ™¯ã€‚

**æ¡ˆä¾‹ç±»å‹**ï¼š

1. **å†œäº§å“å…¨ç¨‹è¿½æº¯ç³»ç»Ÿ**ï¼šå®ç°å†œäº§å“ä»ç”Ÿäº§åˆ°é”€å”®çš„å…¨é“¾æ¡è¿½æº¯
2. **æ‰¹æ¬¡è¿½æº¯æŸ¥è¯¢ç³»ç»Ÿ**ï¼šæ”¯æŒæ‰¹æ¬¡çº§åˆ«çš„è¿½æº¯æŸ¥è¯¢
3. **é£Ÿå“å®‰å…¨ç›‘ç®¡ç³»ç»Ÿ**ï¼šé£Ÿå“å®‰å…¨ç›‘ç®¡å’Œé£é™©é¢„è­¦
4. **å†œäº§å“è¿½æº¯æ•°æ®å­˜å‚¨ä¸åˆ†æç³»ç»Ÿ**ï¼šå†œäº§å“è¿½æº¯æ•°æ®åˆ†æå’Œç›‘æ§
5. **GS1åˆ°EPCISè½¬æ¢ç³»ç»Ÿ**ï¼šGS1æ ‡å‡†åˆ°EPCISæ ‡å‡†è½¬æ¢

**å‚è€ƒä¼ä¸šæ¡ˆä¾‹**ï¼š

- **GS1æ ‡å‡†**ï¼šå…¨çƒç»Ÿä¸€æ ‡è¯†æ ‡å‡†
- **EPCISæ ‡å‡†**ï¼šEPCä¿¡æ¯æœåŠ¡æ ‡å‡†

---

## 2. æ¡ˆä¾‹1ï¼šä¼ä¸šå†œäº§å“å…¨ç¨‹è¿½æº¯ç³»ç»Ÿ

### 2.1 ä¸šåŠ¡èƒŒæ™¯

**ä¼ä¸šèƒŒæ™¯**ï¼š
æŸå†œäº§å“ä¼ä¸šéœ€è¦æ„å»ºå…¨ç¨‹è¿½æº¯ç³»ç»Ÿï¼Œå®ç°å†œäº§å“ä»ç”Ÿäº§åˆ°é”€å”®çš„å…¨é“¾æ¡è¿½æº¯ï¼Œç¡®ä¿é£Ÿå“å®‰å…¨ï¼Œæ»¡è¶³ç›‘ç®¡è¦æ±‚å’Œæ¶ˆè´¹è€…éœ€æ±‚ã€‚

**ä¸šåŠ¡ç—›ç‚¹**ï¼š

1. **è¿½æº¯ä¿¡æ¯ä¸å®Œæ•´**ï¼šè¿½æº¯ä¿¡æ¯è®°å½•ä¸å®Œæ•´
2. **æŸ¥è¯¢æ•ˆç‡ä½**ï¼šè¿½æº¯é“¾æŸ¥è¯¢æ•ˆç‡ä½
3. **æ ‡å‡†ä¸ç»Ÿä¸€**ï¼šç¼ºä¹ç»Ÿä¸€çš„æ ‡å‡†
4. **ç›‘ç®¡å›°éš¾**ï¼šé£Ÿå“å®‰å…¨ç›‘ç®¡å›°éš¾

**ä¸šåŠ¡ç›®æ ‡**ï¼š

- å®ç°å…¨ç¨‹è¿½æº¯
- æé«˜æŸ¥è¯¢æ•ˆç‡
- ç»Ÿä¸€è¿½æº¯æ ‡å‡†
- æ»¡è¶³ç›‘ç®¡è¦æ±‚

### 2.2 æŠ€æœ¯æŒ‘æˆ˜

1. **ä¿¡æ¯è®°å½•**ï¼šè®°å½•ç”Ÿäº§ã€åŠ å·¥ã€è¿è¾“ã€å­˜å‚¨ã€é›¶å”®å„ç¯èŠ‚ä¿¡æ¯
2. **è¿½æº¯é“¾æŸ¥è¯¢**ï¼šæ”¯æŒè¿½æº¯é“¾æŸ¥è¯¢
3. **æ ‡å‡†ç¬¦åˆ**ï¼šç¬¦åˆGS1å’ŒEPCISæ ‡å‡†
4. **æ•°æ®å­˜å‚¨**ï¼šå­˜å‚¨å¤§é‡è¿½æº¯æ•°æ®

### 2.3 è§£å†³æ–¹æ¡ˆ

**ä½¿ç”¨GS1æ ‡å‡†æ ‡è¯†äº§å“ï¼Œä½¿ç”¨EPCISè®°å½•è¿½æº¯äº‹ä»¶ï¼Œå­˜å‚¨åˆ°PostgreSQL**ï¼š

### 2.4 å®Œæ•´ä»£ç å®ç°

**å†œäº§å“å…¨ç¨‹è¿½æº¯ç³»ç»ŸSchemaï¼ˆå®Œæ•´ç¤ºä¾‹ï¼‰**ï¼š

```python
#!/usr/bin/env python3
"""
å†œäº§å“è¿½æº¯Schemaå®ç°
"""

from typing import Dict, List, Optional, Any
from datetime import datetime
from dataclasses import dataclass, field
from enum import Enum

class EventType(str, Enum):
    """äº‹ä»¶ç±»å‹"""
    PRODUCTION = "Production"
    PROCESSING = "Processing"
    TRANSPORTATION = "Transportation"
    STORAGE = "Storage"
    RETAIL = "Retail"

class ProductType(str, Enum):
    """äº§å“ç±»å‹"""
    GRAIN = "Grain"
    VEGETABLE = "Vegetable"
    FRUIT = "Fruit"
    MEAT = "Meat"
    DAIRY = "Dairy"

@dataclass
class Product:
    """äº§å“"""
    product_id: str
    gtin: str
    product_name: str
    product_type: ProductType
    batch_number: str
    production_date: datetime
    expiry_date: datetime
    producer_id: Optional[str] = None

@dataclass
class TraceabilityEvent:
    """è¿½æº¯äº‹ä»¶"""
    event_id: str
    product_id: str
    event_type: EventType
    event_time: datetime
    event_location: str
    event_data: Dict[str, Any] = field(default_factory=dict)
    operator_id: Optional[str] = None

@dataclass
class FoodTraceabilityStorage:
    """å†œäº§å“è¿½æº¯æ•°æ®å­˜å‚¨"""
    products: Dict[str, Product] = field(default_factory=dict)
    events: List[TraceabilityEvent] = field(default_factory=list)

    def store_product(self, product: Product):
        """å­˜å‚¨äº§å“"""
        self.products[product.product_id] = product

    def get_product(self, product_id: str) -> Optional[Product]:
        """è·å–äº§å“"""
        return self.products.get(product_id)

    def store_traceability_event(self, event: TraceabilityEvent):
        """å­˜å‚¨è¿½æº¯äº‹ä»¶"""
        self.events.append(event)

    def get_traceability_chain(self, product_id: str) -> List[TraceabilityEvent]:
        """è·å–è¿½æº¯é“¾"""
        return sorted(
            [event for event in self.events if event.product_id == product_id],
            key=lambda e: e.event_time
        )

    def get_traceability_chain_by_gtin(self, gtin: str) -> List[TraceabilityEvent]:
        """é€šè¿‡GTINè·å–è¿½æº¯é“¾"""
        product = next((p for p in self.products.values() if p.gtin == gtin), None)
        if not product:
            return []
        return self.get_traceability_chain(product.product_id)

    def get_traceability_chain_by_batch(self, batch_number: str) -> List[TraceabilityEvent]:
        """é€šè¿‡æ‰¹æ¬¡å·è·å–è¿½æº¯é“¾"""
        products = [p for p in self.products.values() if p.batch_number == batch_number]
        events = []
        for product in products:
            events.extend(self.get_traceability_chain(product.product_id))
        return sorted(events, key=lambda e: e.event_time)

    def get_traceability_summary(self, product_id: str) -> Dict:
        """è·å–è¿½æº¯æ‘˜è¦"""
        product = self.get_product(product_id)
        if not product:
            return {}

        chain = self.get_traceability_chain(product_id)

        return {
            "product_id": product.product_id,
            "product_name": product.product_name,
            "gtin": product.gtin,
            "batch_number": product.batch_number,
            "total_events": len(chain),
            "event_types": list(set(e.event_type.value for e in chain)),
            "first_event": chain[0].event_time if chain else None,
            "last_event": chain[-1].event_time if chain else None
        }

class GS1ToEPCISConverter:
    """GS1åˆ°EPCISè½¬æ¢å™¨"""

    def convert_product_to_epcis(self, product: Product) -> Dict:
        """å°†äº§å“è½¬æ¢ä¸ºEPCISæ ¼å¼"""
        return {
            "epc": f"urn:epc:id:sgtin:{product.gtin}.{product.batch_number}",
            "eventTime": product.production_date.isoformat(),
            "eventTimeZoneOffset": "+08:00",
            "action": "OBSERVE",
            "bizStep": "commissioning",
            "disposition": "active",
            "readPoint": {
                "id": f"urn:epc:id:sgln:{product.producer_id}.0"
            },
            "bizLocation": {
                "id": f"urn:epc:id:sgln:{product.producer_id}.0"
            }
        }

    def convert_event_to_epcis(self, event: TraceabilityEvent, product: Product) -> Dict:
        """å°†äº‹ä»¶è½¬æ¢ä¸ºEPCISæ ¼å¼"""
        biz_step_map = {
            EventType.PRODUCTION: "commissioning",
            EventType.PROCESSING: "transforming",
            EventType.TRANSPORTATION: "shipping",
            EventType.STORAGE: "storing",
            EventType.RETAIL: "selling"
        }

        return {
            "epc": f"urn:epc:id:sgtin:{product.gtin}.{product.batch_number}",
            "eventTime": event.event_time.isoformat(),
            "eventTimeZoneOffset": "+08:00",
            "action": "OBSERVE",
            "bizStep": biz_step_map.get(event.event_type, "unknown"),
            "disposition": "active",
            "readPoint": {
                "id": f"urn:epc:id:sgln:{event.event_location}.0"
            },
            "bizLocation": {
                "id": f"urn:epc:id:sgln:{event.event_location}.0"
            },
            "extension": event.event_data
        }

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == '__main__':
    # åˆ›å»ºå­˜å‚¨å’Œè½¬æ¢å™¨
    storage = FoodTraceabilityStorage()
    converter = GS1ToEPCISConverter()

    # åˆ›å»ºäº§å“
    product = Product(
        product_id="PROD001",
        gtin="1234567890123",
        product_name="æœ‰æœºå¤§ç±³",
        product_type=ProductType.GRAIN,
        batch_number="BATCH20250121",
        production_date=datetime(2025, 1, 15),
        expiry_date=datetime(2026, 1, 15),
        producer_id="FARM001"
    )
    storage.store_product(product)

    # è®°å½•ç”Ÿäº§äº‹ä»¶
    production_event = TraceabilityEvent(
        event_id="EVT001",
        product_id="PROD001",
        event_type=EventType.PRODUCTION,
        event_time=datetime(2025, 1, 15),
        event_location="å†œåœºA",
        event_data={"farm_id": "FARM001", "harvest_date": "2025-01-15"}
    )
    storage.store_traceability_event(production_event)

    # è®°å½•åŠ å·¥äº‹ä»¶
    processing_event = TraceabilityEvent(
        event_id="EVT002",
        product_id="PROD001",
        event_type=EventType.PROCESSING,
        event_time=datetime(2025, 1, 16),
        event_location="åŠ å·¥å‚B",
        event_data={"processor_id": "PROC001"}
    )
    storage.store_traceability_event(processing_event)

    # æŸ¥è¯¢è¿½æº¯é“¾
    traceability_chain = storage.get_traceability_chain("PROD001")
    print(f"è¿½æº¯é“¾åŒ…å« {len(traceability_chain)} ä¸ªäº‹ä»¶")
    for event in traceability_chain:
        print(f"{event.event_type.value} at {event.event_time} in {event.event_location}")

    # è·å–è¿½æº¯æ‘˜è¦
    summary = storage.get_traceability_summary("PROD001")
    print(f"è¿½æº¯æ‘˜è¦: {summary}")

    # è½¬æ¢ä¸ºEPCISæ ¼å¼
    epcis_product = converter.convert_product_to_epcis(product)
    print(f"EPCISäº§å“: {epcis_product['epc']}")
```

### 2.5 æ•ˆæœè¯„ä¼°

**æ€§èƒ½æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| è¿½æº¯ä¿¡æ¯å®Œæ•´æ€§ | 70% | 95% | 25%æå‡ |
| æŸ¥è¯¢å“åº”æ—¶é—´ | 5ç§’ | 0.5ç§’ | 90%é™ä½ |
| æ ‡å‡†éµå¾ªåº¦ | 75% | 98% | 23%æå‡ |
| æ¶ˆè´¹è€…ä¿¡ä»»åº¦ | ä½ | é«˜ | æ˜¾è‘—æå‡ |

**ä¸šåŠ¡ä»·å€¼**ï¼š

1. **ä¿¡æ¯å®Œæ•´**ï¼šå®Œæ•´è®°å½•è¿½æº¯ä¿¡æ¯
2. **ç¯èŠ‚æ•´åˆ**ï¼šæ•´åˆå„ç¯èŠ‚ä¿¡æ¯
3. **æŸ¥è¯¢æ•ˆç‡æé«˜**ï¼šæé«˜æŸ¥è¯¢æ•ˆç‡
4. **æ ‡å‡†ç»Ÿä¸€**ï¼šç»Ÿä¸€è¿½æº¯æ ‡å‡†

**ç»éªŒæ•™è®­**ï¼š

1. ç¯èŠ‚ä¿¡æ¯è®°å½•å¾ˆé‡è¦
2. è¿½æº¯é“¾æ„å»ºéœ€è¦å®Œæ•´
3. æ ‡å‡†åº”ç”¨éœ€è¦å‡†ç¡®
4. æŸ¥è¯¢ä¼˜åŒ–éœ€è¦æŒç»­

**å‚è€ƒæ¡ˆä¾‹**ï¼š

- [GS1å…¨çƒæ ‡å‡†](https://www.gs1.org/)
- [EPCISè¿½æº¯æ ‡å‡†](https://www.gs1.org/epcis)

---

## 3. æ¡ˆä¾‹2ï¼šæ‰¹æ¬¡è¿½æº¯æŸ¥è¯¢

### 3.1 åœºæ™¯æè¿°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
å½“å‘ç°æŸæ‰¹æ¬¡å†œäº§å“å­˜åœ¨è´¨é‡é—®é¢˜æ—¶ï¼Œéœ€è¦å¿«é€Ÿè¿½æº¯è¯¥æ‰¹æ¬¡çš„æ‰€æœ‰äº§å“ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
æ ¹æ®æ‰¹æ¬¡å·æŸ¥è¯¢æ‰€æœ‰ç›¸å…³äº§å“çš„è¿½æº¯é“¾ã€‚

### 3.2 å®ç°ä»£ç 

```python
def query_batch_traceability(storage: FoodTraceabilityStorage, batch_number: str):
    """æŸ¥è¯¢æ‰¹æ¬¡è¿½æº¯ä¿¡æ¯"""
    storage.cur.execute("""
        SELECT p.product_id, p.product_name, p.gtin,
               te.event_type, te.event_time, te.event_location
        FROM products p
        JOIN traceability_events te ON p.product_id = te.product_id
        WHERE p.batch_number = %s
        ORDER BY te.event_time ASC
    """, (batch_number,))

    results = []
    for row in storage.cur.fetchall():
        results.append({
            "product_id": row[0],
            "product_name": row[1],
            "gtin": row[2],
            "event_type": row[3],
            "event_time": row[4],
            "event_location": row[5]
        })
    return results
```

---

**å‚è€ƒæ–‡æ¡£**ï¼š

- `01_Overview.md` - æ¦‚è¿°
- `02_Formal_Definition.md` - å½¢å¼åŒ–å®šä¹‰
- `03_Standards.md` - æ ‡å‡†å¯¹æ ‡
- `04_Transformation.md` - è½¬æ¢ä½“ç³»

**åˆ›å»ºæ—¶é—´**ï¼š2025-01-21
**æœ€åæ›´æ–°**ï¼š2025-01-21
