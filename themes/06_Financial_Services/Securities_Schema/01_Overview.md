# 证券业务Schema概述

## 📑 目录

- [证券业务Schema概述](#证券业务schema概述)
  - [📑 目录](#-目录)
  - [1. 核心结论](#1-核心结论)
    - [1.1 证券业务Schema定义](#11-证券业务schema定义)
    - [1.2 标准依据](#12-标准依据)
  - [2. 概念定义](#2-概念定义)
    - [2.1 证券业务Schema](#21-证券业务schema)
    - [2.2 核心特征](#22-核心特征)
    - [2.3 Schema分类](#23-schema分类)
  - [3. 证券核心业务Schema](#3-证券核心业务schema)
    - [3.1 证券发行Schema](#31-证券发行schema)
    - [3.2 证券交易Schema](#32-证券交易schema)
    - [3.3 证券结算Schema](#33-证券结算schema)
    - [3.4 证券托管Schema](#34-证券托管schema)
    - [3.5 市场数据Schema](#35-市场数据schema)
  - [4. 标准对标](#4-标准对标)
    - [4.1 FIX协议](#41-fix协议)
    - [4.2 ISO 10383 (MIC)](#42-iso-10383-mic)
    - [4.3 T+1结算标准](#43-t1结算标准)
    - [4.4 其他相关标准](#44-其他相关标准)
  - [5. 应用场景](#5-应用场景)
    - [5.1 交易系统](#51-交易系统)
    - [5.2 行情系统](#52-行情系统)
    - [5.3 结算系统](#53-结算系统)
    - [5.4 风控系统](#54-风控系统)
    - [5.5 证券数据存储与分析](#55-证券数据存储与分析)
  - [6. 思维导图](#6-思维导图)
  - [7. 证券业务流程](#7-证券业务流程)
    - [7.1 交易流程](#71-交易流程)
    - [7.2 结算流程](#72-结算流程)
    - [7.3 清算流程](#73-清算流程)
  - [8. 行业最佳实践](#8-行业最佳实践)
    - [8.1 低延迟交易](#81-低延迟交易)
    - [8.2 风险管理](#82-风险管理)
    - [8.3 合规监控](#83-合规监控)

---

## 1. 核心结论

**证券业务存在强制性的Schema体系，涵盖证券发行、交易、结算、托管等多个业务领域**。

### 1.1 证券业务Schema定义

```text
Securities_Schema = (Issuance ⊕ Trading ⊕ Settlement ⊕ Custody) × Regulatory_Profile
```

其中：
- `Issuance`：证券发行Schema
- `Trading`：证券交易Schema
- `Settlement`：证券结算Schema
- `Custody`：证券托管Schema
- `Regulatory_Profile`：监管合规配置

### 1.2 标准依据

- **FIX协议**：金融信息交换协议
- **ISO 10383 (MIC)**：市场识别码标准
- **T+1结算标准**：结算周期标准
- **SWIFT ISO 15022**：证券报文标准

---

## 2. 概念定义

### 2.1 证券业务Schema

**证券业务Schema**是描述证券业务数据的形式化规范，包括证券信息、订单信息、交易信息、持仓信息、市场数据等核心业务数据实体。

### 2.2 核心特征

1. **实时性**：证券交易需要毫秒级响应
2. **准确性**：交易数据必须准确无误
3. **完整性**：结算需要完整的交易链条
4. **安全性**：资金和证券安全是首要任务
5. **合规性**：受多重监管要求约束

### 2.3 Schema分类

- **发行Schema**：IPO、增发、配股、可转债
- **交易Schema**：股票、债券、基金、衍生品
- **结算Schema**：T+0、T+1、DVP结算
- **托管Schema**：证券存管、资金存管
- **市场数据Schema**：行情、指数、板块

---

## 3. 证券核心业务Schema

### 3.1 证券发行Schema

**定义**：描述证券发行信息的数据结构。

**包含内容**：

- **IPO发行**：首次公开发行
- **增发**：定向增发、公开增发
- **配股**：向现有股东配售
- **可转债**：可转换公司债券

**核心属性**：

| 属性 | 类型 | 说明 | 约束 |
|------|------|------|------|
| issuance_id | String(30) | 发行ID | 唯一，必填 |
| security_code | String(20) | 证券代码 | 唯一，必填 |
| security_name | String(200) | 证券名称 | 必填 |
| issuance_type | Enum | 发行类型 | IPO, SEO, RIGHTS, CB |
| issue_price | Decimal(15,4) | 发行价格 | > 0 |
| issue_quantity | Decimal(15,0) | 发行数量 | > 0 |
| total_amount | Decimal(18,2) | 募集资金总额 | > 0 |
| listing_date | Date | 上市日期 | 必填 |
| exchange | String(10) | 上市交易所 | 必填 |

**发行类型对比**：

| 发行类型 | 代码 | 对象 | 定价方式 | 锁定期 |
|----------|------|------|----------|--------|
| 首次公开发行 | IPO | 公众投资者 | 询价/定价 | 原始股东36个月 |
| 定向增发 | SEO-P | 特定对象 | 不低于定价基准日前20日均价的80% | 6个月/18个月 |
| 公开增发 | SEO-Public | 公众投资者 | 不低于招股意向书前20均价或前1日均价 | 无 |
| 配股 | Rights | 现有股东 | 市场价折扣 | 无 |
| 可转债 | CB | 公众投资者 | 询价 | 6个月 |

### 3.2 证券交易Schema

**定义**：描述证券交易订单和成交的数据结构。

**包含内容**：

- **股票交易**：A股、B股、港股通
- **债券交易**：国债、企业债、可转债
- **基金交易**：ETF、LOF、封闭式基金
- **衍生品交易**：期权、期货

**订单核心属性**：

| 属性 | 类型 | 说明 | 约束 |
|------|------|------|------|
| order_id | String(30) | 订单ID | 唯一，必填 |
| client_id | String(20) | 客户ID | 必填 |
| account_id | String(30) | 资金账户 | 必填 |
| security_code | String(20) | 证券代码 | 必填 |
| order_type | Enum | 订单类型 | MARKET, LIMIT, STOP |
| side | Enum | 买卖方向 | BUY, SELL |
| order_quantity | Decimal(15,0) | 订单数量 | > 0 |
| order_price | Decimal(15,4) | 订单价格 | ≥ 0 |
| order_status | Enum | 订单状态 | PENDING, PARTIAL, FILLED |

**订单类型对比**：

| 订单类型 | 代码 | 执行方式 | 适用场景 |
|----------|------|----------|----------|
| 市价单 | MARKET | 以市场最优价格立即成交 | 追求成交速度 |
| 限价单 | LIMIT | 以指定价格或更优价格成交 | 控制成交价格 |
| 止损单 | STOP | 价格触及止损价时转为市价单 | 风险控制 |
| 止损限价 | STOP_LIMIT | 价格触及止损价时转为限价单 | 精确控制 |
| 冰山单 | ICEBERG | 只显示部分数量 | 隐藏交易意图 |

**成交核心属性**：

| 属性 | 类型 | 说明 | 约束 |
|------|------|------|------|
| trade_id | String(30) | 成交ID | 唯一，必填 |
| order_id | String(30) | 订单ID | 必填 |
| execution_id | String(30) | 执行ID | 必填 |
| trade_quantity | Decimal(15,0) | 成交数量 | > 0 |
| trade_price | Decimal(15,4) | 成交价格 | > 0 |
| trade_amount | Decimal(18,2) | 成交金额 | > 0 |
| trade_time | DateTime | 成交时间 | 必填 |
| counterparty | String(20) | 对手方 | 必填 |

### 3.3 证券结算Schema

**定义**：描述证券结算和交收的数据结构。

**包含内容**：

- **清算**：交易确认、净额计算
- **结算**：证券过户、资金交收
- **DVP**：券款对付结算

**结算核心属性**：

| 属性 | 类型 | 说明 | 约束 |
|------|------|------|------|
| settlement_id | String(30) | 结算ID | 唯一，必填 |
| trade_id | String(30) | 交易ID | 必填 |
| settlement_date | Date | 结算日期 | 必填 |
| settlement_type | Enum | 结算类型 | DVP, DVP_FREE |
| delivery_status | Enum | 交割状态 | PENDING, SETTLED, FAILED |
| payment_status | Enum | 支付状态 | PENDING, PAID, FAILED |
| securities_amount | Decimal(15,0) | 证券数量 | > 0 |
| cash_amount | Decimal(18,2) | 资金金额 | > 0 |

**结算周期对比**：

| 市场 | 股票结算 | 债券结算 | 基金结算 |
|------|----------|----------|----------|
| A股 | T+1 | T+0/T+1 | T+1 |
| 港股 | T+2 | T+2 | T+2 |
| 美股 | T+1 | T+1 | T+1 |
| 债券通 | - | T+0/T+1 | - |

### 3.4 证券托管Schema

**定义**：描述证券托管和存管的数据结构。

**包含内容**：

- **证券账户**：股东账户、基金账户
- **资金账户**：保证金账户、信用账户
- **持仓管理**：证券持仓、资金余额

**持仓核心属性**：

| 属性 | 类型 | 说明 | 约束 |
|------|------|------|------|
| position_id | String(30) | 持仓ID | 唯一，必填 |
| account_id | String(30) | 账户ID | 必填 |
| security_code | String(20) | 证券代码 | 必填 |
| position_type | Enum | 持仓类型 | LONG, SHORT |
| total_quantity | Decimal(15,0) | 总持仓 | ≥ 0 |
| available_quantity | Decimal(15,0) | 可用持仓 | ≥ 0 |
| frozen_quantity | Decimal(15,0) | 冻结持仓 | ≥ 0 |
| cost_price | Decimal(15,4) | 成本价 | ≥ 0 |
| market_value | Decimal(18,2) | 市值 | ≥ 0 |

**资金账户属性**：

| 属性 | 类型 | 说明 | 约束 |
|------|------|------|------|
| balance | Decimal(18,2) | 资金余额 | ≥ 0 |
| available_balance | Decimal(18,2) | 可用资金 | ≥ 0 |
| frozen_balance | Decimal(18,2) | 冻结资金 | ≥ 0 |
| margin_balance | Decimal(18,2) | 保证金 | ≥ 0 |
| buying_power | Decimal(18,2) | 购买力 | ≥ 0 |

### 3.5 市场数据Schema

**定义**：描述市场行情和指数的数据结构。

**包含内容**：

- **行情数据**：报价、成交、五档盘口
- **指数数据**：综合指数、行业指数
- **参考数据**：基础信息、财务数据

**行情核心属性**：

| 属性 | 类型 | 说明 | 约束 |
|------|------|------|------|
| security_code | String(20) | 证券代码 | 必填 |
| timestamp | DateTime | 时间戳 | 必填 |
| last_price | Decimal(15,4) | 最新价 | > 0 |
| open_price | Decimal(15,4) | 开盘价 | > 0 |
| high_price | Decimal(15,4) | 最高价 | > 0 |
| low_price | Decimal(15,4) | 最低价 | > 0 |
| close_price | Decimal(15,4) | 收盘价 | > 0 |
| volume | Decimal(15,0) | 成交量 | ≥ 0 |
| turnover | Decimal(18,2) | 成交额 | ≥ 0 |
| bid_prices | List | 买一到买五 | 5档 |
| ask_prices | List | 卖一到卖五 | 5档 |
| bid_volumes | List | 买量 | 5档 |
| ask_volumes | List | 卖量 | 5档 |

---

## 4. 标准对标

### 4.1 FIX协议

**标准名称**：Financial Information eXchange (FIX) Protocol

**当前版本**：FIX.5.0 SP2

**核心内容**：

- **消息结构**：Header、Body、Trailer
- **消息类型**：
  - **D** = New Order Single（新订单）
  - **8** = Execution Report（成交报告）
  - **F** = Order Cancel Request（撤单请求）
  - **9** = Order Cancel Reject（撤单拒绝）
  - **3** = Reject（拒绝）
  - **W** = Market Data Snapshot（行情快照）

**FIX消息示例**：

```
# 新订单消息
8=FIX.5.0|9=123|35=D|49=SENDER|56=TARGET|34=1|52=20250121-10:30:00.000|
11=ORDER001|55=600000|54=1|38=100|40=2|44=10.50|59=0|10=123|

# 成交报告
8=FIX.5.0|9=150|35=8|49=TARGET|56=SENDER|34=2|52=20250121-10:30:01.000|
6=10.50|11=ORDER001|14=100|17=EXEC001|31=10.50|32=100|37=ORDER001|
39=2|54=1|55=600000|150=2|151=0|10=234|
```

**Schema支持**：完整支持

**参考链接**：
[FIX Trading Community](https://www.fixtrading.org/)

### 4.2 ISO 10383 (MIC)

**标准名称**：ISO 10383 - Market Identifier Code (MIC)

**核心内容**：

- **MIC格式**：4位字母代码
- **主要MIC**：
  - **XSHG**：上海证券交易所
  - **XSHE**：深圳证券交易所
  - **XHKG**：香港交易所
  - **XNAS**：纳斯达克
  - **XNYS**：纽约证券交易所
  - **XLON**：伦敦证券交易所

**MIC结构**：

| 位置 | 含义 | 示例 |
|------|------|------|
| 第1位 | 操作系统 | X = MIC, Y = 待分配 |
| 第2-4位 | 市场标识 | SHG = 上海, SHE = 深圳 |

### 4.3 T+1结算标准

**标准名称**：T+1 Settlement Cycle

**背景**：美国SEC于2024年5月28日实施T+1结算

**结算周期对比**：

| 周期 | 结算日 | 市场 | 状态 |
|------|--------|------|------|
| T+0 | 当日 | 部分债券市场 | 已实施 |
| T+1 | 次日 | 美国、加拿大、墨西哥、阿根廷 | 2024年实施 |
| T+2 | 第2日 | 欧洲、香港 | 现行 |
| T+3 | 第3日 | 历史标准 | 已淘汰 |

**T+1影响**：

1. **外汇风险降低**：减少跨周末风险敞口
2. **流动性需求**：需要更快的资金调配
3. **操作风险**：压缩错误处理时间
4. **系统要求**：需要更高效的结算系统

### 4.4 其他相关标准

| 标准 | 说明 | 适用范围 |
|------|------|----------|
| **ISO 15022** | 证券报文标准 | 全球证券结算 |
| **ISO 20022** | 证券交易和结算 | 逐渐取代ISO 15022 |
| **SWIFT MT548** | 结算确认 | 证券结算 |
| **FpML** | 衍生品标记语言 | 场外衍生品 |
| **SICOVAM** | 法国证券编码 | 法国市场 |
| **CUSIP** | 美国证券编码 | 北美市场 |
| **ISIN** | 国际证券编码 | 全球市场 |

---

## 5. 应用场景

### 5.1 交易系统

- **订单管理**：订单录入、修改、撤销
- **撮合引擎**：订单撮合、价格优先、时间优先
- **交易确认**：成交确认、交易回执
- **交易监控**：异常交易监控、市场操纵检测

### 5.2 行情系统

- **行情接入**：交易所行情接入、行情解析
- **行情分发**：行情分发、Level 1/2行情
- **行情存储**：历史行情存储、K线生成
- **行情分析**：技术指标计算、趋势分析

### 5.3 结算系统

- **清算处理**：交易确认、净额计算
- **结算交收**：证券过户、资金交收
- **DVP处理**：券款对付、结算担保
- **失败处理**：结算失败处理、补券补款

### 5.4 风控系统

- **事前风控**：订单风控、持仓风控
- **事中风控**：实时风险监控、预警
- **事后风控**：交易分析、风险报告
- **合规监控**：异常交易监控、报告

### 5.5 证券数据存储与分析

**数据库存储应用场景**：

- **PostgreSQL证券数据存储**：
  - 订单数据存储（委托、成交）
  - 持仓数据存储（证券持仓、资金余额）
  - 行情数据存储（分笔、分钟、日K）
  - 结算数据存储（清算、交收）
  - 风控数据存储（风险指标、预警）

**应用价值**：

- 高效存储大规模证券交易数据
- 支持证券业务分析和报表生成
- 提供证券交易追踪和审计
- 支持证券合规性检查

---

## 6. 思维导图

```text
Securities Schema
│
├─ 证券发行
│   ├─ IPO
│   ├─ 定向增发
│   ├─ 公开增发
│   ├─ 配股
│   └─ 可转债
│
├─ 证券交易
│   ├─ 股票交易
│   │   ├─ A股
│   │   ├─ B股
│   │   └─ 港股通
│   ├─ 债券交易
│   ├─ 基金交易
│   └─ 衍生品交易
│       ├─ 期权
│       └─ 期货
│
├─ 证券结算
│   ├─ T+0结算
│   ├─ T+1结算
│   ├─ T+2结算
│   └─ DVP结算
│
├─ 证券托管
│   ├─ 证券账户
│   ├─ 资金账户
│   ├─ 持仓管理
│   └─ 质押管理
│
├─ 市场数据
│   ├─ 行情数据
│   ├─ 指数数据
│   └─ 参考数据
│
└─ 合规监管
    ├─ FIX协议
    ├─ ISO 10383
    └─ T+1标准
```

---

## 7. 证券业务流程

### 7.1 交易流程

```text
客户下单 → 订单校验 → 风控检查 → 订单路由 → 撮合成交 → 成交回报 → 交易确认
   │           │           │           │           │           │           │
   ▼           ▼           ▼           ▼           ▼           ▼           ▼
输入订单     格式校验    资金/持仓   选择交易    价格优先    发送成交    客户确认
            价格检查    检查        所/方式    时间优先    报告
            数量检查
```

**流程说明**：

1. **客户下单**：客户输入交易指令
2. **订单校验**：格式、价格、数量检查
3. **风控检查**：资金、持仓、合规检查
4. **订单路由**：路由到合适的交易所/市场
5. **撮合成交**：交易所撮合引擎撮合
6. **成交回报**：返回成交结果
7. **交易确认**：客户确认成交

### 7.2 结算流程

```text
交易确认 → 清算处理 → 净额计算 → 结算指令 → 证券过户 → 资金交收 → 结算完成
   │           │           │           │           │           │           │
   ▼           ▼           ▼           ▼           ▼           ▼           ▼
确认交易    确认应收    计算净额    发送结算    证券转入    资金划转    发送结算
要素        应付        应收应付    指令        转出账户    收付账户    报告
```

**流程说明**：

1. **交易确认**：确认交易要素
2. **清算处理**：计算应收应付
3. **净额计算**：多边净额计算
4. **结算指令**：发送结算指令
5. **证券过户**：证券从卖方过户到买方
6. **资金交收**：资金从买方交收到卖方
7. **结算完成**：发送结算报告

### 7.3 清算流程

```text
日初 → 交易处理 → 清算预处理 → 清算计算 → 清算复核 → 清算确认 → 日终
 │        │            │            │            │            │        │
 ▼        ▼            ▼            ▼            ▼            ▼        ▼
资金     撮合引擎     交易配对     应收应付     清算数据     清算结果   资金
证券     接收订单     数据汇总     计算         复核         确认       证券
初始化   处理交易     数据检查     保证金       异常处理     发送结算   对账
                                                      所
```

---

## 8. 行业最佳实践

### 8.1 低延迟交易

**低延迟架构**：

```
┌─────────────────────────────────────────────────────────────────┐
│                      低延迟交易架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐  │
│  │ 客户    │────►│ 网关    │────►│ 风控    │────►│ 订单    │  │
│  │         │     │ Gateway │     │ Engine  │     │ Engine  │  │
│  │ <1ms    │     │  <10μs  │     │  <50μs  │     │  <20μs  │  │
│  └─────────┘     └─────────┘     └─────────┘     └────┬────┘  │
│                                                        │        │
│  ┌─────────────────────────────────────────────────────┘        │
│  │                                                              │
│  ▼                                                              │
│  ┌─────────┐     ┌─────────┐     ┌─────────┐                   │
│  │ 撮合    │◄────│ 交易所  │◄────│ 网关    │                   │
│  │ Engine  │     │ API     │     │ Exchange│                   │
│  │  <100μs │     │  <1ms   │     │  <50μs  │                   │
│  └────┬────┘     └─────────┘     └─────────┘                   │
│       │                                                         │
│       ▼                                                         │
│  ┌─────────┐                                                    │
│  │ 行情    │                                                    │
│  │ 回馈    │                                                    │
│  └─────────┘                                                    │
│                                                                 │
│  总延迟目标: < 1ms (客户端到交易所)                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**优化技术**：

- **FPGA加速**：订单处理、风控检查
- **内核旁路**：DPDK、RDMA
- **内存数据库**：行情、持仓缓存
- **无锁队列**：线程间通信

### 8.2 风险管理

**风险管理体系**：

```
┌─────────────────────────────────────────────────────────────────┐
│                      风险管理体系                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    事前风控                               │  │
│  │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐│  │
│  │   │ 客户风险 │  │ 订单风险 │  │ 持仓风险 │  │ 合规检查 ││  │
│  │   │ 评级     │  │ 价格检查 │  │ 限额检查 │  │ 异常检测 ││  │
│  │   └──────────┘  └──────────┘  └──────────┘  └──────────┘│  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    事中风控                               │  │
│  │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐│  │
│  │   │ 实时监控 │  │ 风险预警 │  │ 自动处置 │  │ 熔断机制 ││  │
│  │   │ 持仓监控 │  │ 价格预警 │  │ 强制平仓 │  │ 暂停交易 ││  │
│  │   └──────────┘  └──────────┘  └──────────┘  └──────────┘│  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    事后风控                               │  │
│  │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐│  │
│  │   │ 交易分析 │  │ 风险报告 │  │ 压力测试 │  │ 审计追踪 ││  │
│  │   │ 盈亏分析 │  │ 日报月报 │  │ 情景分析 │  │ 留痕备查 ││  │
│  │   └──────────┘  └──────────┘  └──────────┘  └──────────┘│  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.3 合规监控

**监控规则示例**：

| 规则类型 | 规则描述 | 阈值 | 处置 |
|----------|----------|------|------|
| **价格异动** | 涨跌幅超过限制 | ±10% | 临时停牌 |
| **交易量异常** | 交易量超过近期平均 | 5倍 | 重点监控 |
| **频繁报撤** | 报单后立即撤销 | 80% | 限制交易 |
| **对倒交易** | 自买自卖 | 检测到 | 调查处置 |
| **虚假申报** | 大额申报后撤单 | 检测到 | 警告/处罚 |

---

**参考文档**：

- `../README.md` - 主题概览
- `02_Formal_Definition.md` - 形式化定义
- `03_Standards.md` - 标准对标

**创建时间**：2025-01-21
**最后更新**：2025-01-21
