# æ¶ˆè´¹è€…è¿½æº¯Schemaå®è·µæ¡ˆä¾‹

## ğŸ“‘ ç›®å½•

- [æ¶ˆè´¹è€…è¿½æº¯Schemaå®è·µæ¡ˆä¾‹](#æ¶ˆè´¹è€…è¿½æº¯schemaå®è·µæ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¡ˆä¾‹æ¦‚è¿°](#1-æ¡ˆä¾‹æ¦‚è¿°)
  - [2. æ¡ˆä¾‹1ï¼šä¼ä¸šæ¶ˆè´¹è€…äº§å“è¿½æº¯æŸ¥è¯¢ç³»ç»Ÿ](#2-æ¡ˆä¾‹1ä¼ä¸šæ¶ˆè´¹è€…äº§å“è¿½æº¯æŸ¥è¯¢ç³»ç»Ÿ)
    - [2.1 ä¸šåŠ¡èƒŒæ™¯](#21-ä¸šåŠ¡èƒŒæ™¯)
    - [2.2 æŠ€æœ¯æŒ‘æˆ˜](#22-æŠ€æœ¯æŒ‘æˆ˜)
    - [2.3 è§£å†³æ–¹æ¡ˆ](#23-è§£å†³æ–¹æ¡ˆ)
    - [2.4 å®Œæ•´ä»£ç å®ç°](#24-å®Œæ•´ä»£ç å®ç°)
    - [2.5 æ•ˆæœè¯„ä¼°](#25-æ•ˆæœè¯„ä¼°)

---

## 1. æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›æ¶ˆè´¹è€…è¿½æº¯Schemaåœ¨å®é™…ä¼ä¸šåº”ç”¨ä¸­çš„å®è·µæ¡ˆä¾‹ï¼Œæ¶µç›–æ¶ˆè´¹è€…äº§å“è¿½æº¯æŸ¥è¯¢ã€è¿½æº¯é“¾ç®¡ç†ã€è¿½æº¯æ•°æ®å­˜å‚¨ç­‰çœŸå®åœºæ™¯ã€‚

**æ¡ˆä¾‹ç±»å‹**ï¼š

1. **æ¶ˆè´¹è€…äº§å“è¿½æº¯æŸ¥è¯¢ç³»ç»Ÿ**ï¼šæ¶ˆè´¹è€…é€šè¿‡GTINæŸ¥è¯¢äº§å“è¿½æº¯ä¿¡æ¯
2. **è¿½æº¯é“¾ç®¡ç†ç³»ç»Ÿ**ï¼šäº§å“è¿½æº¯é“¾ç®¡ç†
3. **è¿½æº¯æ•°æ®å­˜å‚¨ç³»ç»Ÿ**ï¼šè¿½æº¯æ•°æ®å­˜å‚¨å’Œåˆ†æ
4. **è¿½æº¯éªŒè¯ç³»ç»Ÿ**ï¼šè¿½æº¯æ•°æ®éªŒè¯
5. **è¿½æº¯æŠ¥å‘Šç³»ç»Ÿ**ï¼šè¿½æº¯æŠ¥å‘Šç”Ÿæˆ

**å‚è€ƒä¼ä¸šæ¡ˆä¾‹**ï¼š

- **GS1æ ‡å‡†**ï¼šGS1å…¨çƒæ ‡å‡†
- **EPCIS**ï¼šEPCISè¿½æº¯æ ‡å‡†

---

## 2. æ¡ˆä¾‹1ï¼šä¼ä¸šæ¶ˆè´¹è€…äº§å“è¿½æº¯æŸ¥è¯¢ç³»ç»Ÿ

### 2.1 ä¸šåŠ¡èƒŒæ™¯

**ä¼ä¸šèƒŒæ™¯**ï¼š
ä¼Šåˆ©é›†å›¢æ˜¯ä¸­å›½è§„æ¨¡æœ€å¤§ã€äº§å“çº¿æœ€å…¨çš„ä¹³åˆ¶å“ä¼ä¸šï¼Œæˆç«‹äº1993å¹´ï¼Œæ€»éƒ¨ä½äºå†…è’™å¤å‘¼å’Œæµ©ç‰¹å¸‚ã€‚é›†å›¢æ——ä¸‹æ‹¥æœ‰æ¶²æ€å¥¶ã€å¥¶ç²‰ã€é…¸å¥¶ã€å†·é¥®ã€å¥¶é…ªç­‰äº”å¤§äº§å“äº‹ä¸šéƒ¨ï¼Œå¹´é”€å”®é¢è¶…è¿‡1200äº¿å…ƒäººæ°‘å¸ï¼Œä½å±…å…¨çƒä¹³ä¸šäº”å¼ºã€‚ä¼Šåˆ©åœ¨å…¨å›½æ‹¥æœ‰80å¤šå®¶ç”Ÿäº§åŸºåœ°ï¼Œäº§å“é”€å¾€å…¨å›½åŠä¸œå—äºšã€å¤§æ´‹æ´²ç­‰æµ·å¤–å¸‚åœºï¼Œå¹´æœåŠ¡æ¶ˆè´¹è€…è¶…è¿‡13äº¿äººæ¬¡ã€‚

ä¼Šåˆ©å§‹ç»ˆå°†äº§å“è´¨é‡å’Œé£Ÿå“å®‰å…¨æ”¾åœ¨é¦–ä½ï¼Œå»ºç«‹äº†ä»å¥¶æºã€ç”Ÿäº§ã€è¿è¾“åˆ°é”€å”®çš„å…¨äº§ä¸šé“¾è´¨é‡ç®¡ç†ä½“ç³»ã€‚é¢å¯¹æ¶ˆè´¹è€…å¯¹é£Ÿå“å®‰å…¨çš„æ—¥ç›Šå…³æ³¨å’Œç›‘ç®¡è¦æ±‚çš„ä¸æ–­æé«˜ï¼Œä¼Šåˆ©å†³å®šå»ºè®¾é¢å‘æ¶ˆè´¹è€…çš„å…¨ç¨‹è¿½æº¯æŸ¥è¯¢ç³»ç»Ÿï¼Œè®©æ¶ˆè´¹è€…é€šè¿‡æ‰«æäº§å“åŒ…è£…ä¸Šçš„äºŒç»´ç ï¼Œå³å¯æŸ¥è¯¢äº§å“çš„å…¨ç¨‹è¿½æº¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¥¶æºåœ°ã€ç”Ÿäº§å·¥å‚ã€è´¨æ£€æŠ¥å‘Šã€ç‰©æµè·¯å¾„ç­‰ï¼Œæå‡æ¶ˆè´¹è€…ä¿¡ä»»åº¦å’Œå“ç‰Œå¿ è¯šåº¦ã€‚

**ä¸šåŠ¡ç—›ç‚¹**ï¼š

1. **ä¿¡æ¯ä¸é€æ˜**ï¼šæ¶ˆè´¹è€…æ— æ³•äº†è§£äº§å“çš„çœŸå®æ¥æºå’Œç”Ÿäº§è¿‡ç¨‹ï¼Œå¯¹"æœ‰æœº""å¤©ç„¶"ç­‰å®£ç§°ç¼ºä¹ä¿¡ä»»ï¼Œå“ç‰Œæº¢ä»·èƒ½åŠ›å—é™ã€‚

2. **è¿½æº¯æ•°æ®åˆ†æ•£**ï¼šäº§å“è¿½æº¯æ•°æ®åˆ†æ•£åœ¨å¥¶æºç®¡ç†ã€ç”Ÿäº§æ‰§è¡Œã€ä»“å‚¨ç‰©æµç­‰å¤šä¸ªä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œæ•°æ®å­¤å²›ä¸¥é‡ï¼Œæ— æ³•å½¢æˆå®Œæ•´çš„è¿½æº¯é“¾æ¡ã€‚

3. **æŸ¥è¯¢ä½“éªŒå·®**ï¼šæ—©æœŸè¿½æº¯æŸ¥è¯¢ç³»ç»Ÿå“åº”æ…¢ï¼ˆå¹³å‡5-8ç§’ï¼‰ï¼Œé¡µé¢å±•ç¤ºä¸å‹å¥½ï¼Œæ¶ˆè´¹è€…æŸ¥è¯¢åæ»¡æ„åº¦ä½ï¼ŒæŸ¥è¯¢è½¬åŒ–ç‡ä¸è¶³10%ã€‚

4. **æ•°æ®å®‰å…¨éšæ‚£**ï¼šç¼ºä¹æœ‰æ•ˆçš„æ•°æ®å®‰å…¨ä¿æŠ¤æœºåˆ¶ï¼Œè¿½æº¯æ•°æ®å­˜åœ¨è¢«ç¯¡æ”¹é£é™©ï¼Œæ— æ³•ç¡®ä¿è¿½æº¯ä¿¡æ¯çš„çœŸå®æ€§å’Œå¯ä¿¡åº¦ã€‚

5. **ç›‘ç®¡åˆè§„å‹åŠ›**ï¼šé¢å¯¹å›½å®¶å¸‚åœºç›‘ç®¡æ€»å±€çš„é£Ÿå“å®‰å…¨è¿½æº¯è¦æ±‚ï¼Œç¼ºä¹å¿«é€Ÿå“åº”èƒ½åŠ›ï¼Œåº”å¯¹äº§å“å¬å›å’Œç›‘ç®¡æŠ½æŸ¥æ•ˆç‡ä½ã€‚

**ä¸šåŠ¡ç›®æ ‡**ï¼š

- å»ºç«‹é¢å‘æ¶ˆè´¹è€…çš„å…¨ç¨‹è¿½æº¯æŸ¥è¯¢å¹³å°ï¼Œè¦†ç›–å¥¶æºã€ç”Ÿäº§ã€è´¨æ£€ã€ç‰©æµã€é”€å”®å…¨é“¾æ¡ï¼Œè¿½æº¯ä¿¡æ¯å®Œæ•´åº¦è¾¾åˆ°98%ä»¥ä¸Š
- å®ç°è¿½æº¯æŸ¥è¯¢ç§’çº§å“åº”ï¼ˆå¹³å‡å“åº”æ—¶é—´<500msï¼‰ï¼Œæ—¥æŸ¥è¯¢æ‰¿è½½èƒ½åŠ›è¶…è¿‡1000ä¸‡æ¬¡
- é‡‡ç”¨åŒºå—é“¾å­˜è¯æŠ€æœ¯ï¼Œç¡®ä¿è¿½æº¯æ•°æ®ä¸å¯ç¯¡æ”¹ï¼Œæå‡æ•°æ®å¯ä¿¡åº¦
- é€šè¿‡è¿½æº¯å¯è§†åŒ–å±•ç¤ºï¼Œæå‡æ¶ˆè´¹è€…å‚ä¸åº¦å’Œå“ç‰Œä¿¡ä»»åº¦ï¼ŒæŸ¥è¯¢è½¬åŒ–ç‡æå‡è‡³40%ä»¥ä¸Š
- å»ºç«‹å¿«é€Ÿå¬å›æœºåˆ¶ï¼Œé—®é¢˜äº§å“å¬å›å“åº”æ—¶é—´ä»48å°æ—¶ç¼©çŸ­åˆ°2å°æ—¶ä»¥å†…

### 2.2 æŠ€æœ¯æŒ‘æˆ˜

1. **æµ·é‡å¹¶å‘æŸ¥è¯¢**ï¼šä¼Šåˆ©äº§å“è¦†ç›–13äº¿æ¶ˆè´¹è€…ï¼Œé«˜å³°æœŸæ¯ç§’æŸ¥è¯¢é‡è¶…è¿‡5ä¸‡æ¬¡ï¼Œéœ€è¦æ„å»ºé«˜å¹¶å‘ã€é«˜å¯ç”¨çš„æŸ¥è¯¢æœåŠ¡æ¶æ„ã€‚

2. **å¤šæºæ•°æ®èåˆ**ï¼šéœ€è¦æ•´åˆSAP ERPï¼ˆç”Ÿäº§æ•°æ®ï¼‰ã€WMSï¼ˆä»“å‚¨æ•°æ®ï¼‰ã€TMSï¼ˆç‰©æµæ•°æ®ï¼‰ã€LIMSï¼ˆè´¨æ£€æ•°æ®ï¼‰ç­‰10å¤šä¸ªå¼‚æ„ç³»ç»Ÿçš„æ•°æ®ï¼Œæ•°æ®æ ¼å¼å’Œæ ‡å‡†ä¸ç»Ÿä¸€ã€‚

3. **åŒºå—é“¾å­˜è¯æ€§èƒ½**ï¼šä¸ºç¡®ä¿è¿½æº¯æ•°æ®ä¸å¯ç¯¡æ”¹ï¼Œéœ€è¦å¼•å…¥åŒºå—é“¾æŠ€æœ¯ï¼Œä½†åŒºå—é“¾çš„TPSï¼ˆæ¯ç§’äº¤æ˜“æ•°ï¼‰é™åˆ¶å¯¹å¤§è§„æ¨¡æ•°æ®å­˜è¯æå‡ºæŒ‘æˆ˜ã€‚

4. **æ•°æ®éšç§ä¿æŠ¤**ï¼šè¿½æº¯ä¿¡æ¯æ¶‰åŠä¼ä¸šæ ¸å¿ƒç»è¥æ•°æ®ï¼Œéœ€è¦å®ç°æ•°æ®åˆ†çº§ä¿æŠ¤ï¼Œæ¶ˆè´¹è€…åªèƒ½æŸ¥çœ‹å…¬å¼€ä¿¡æ¯ï¼Œç›‘ç®¡éƒ¨é—¨å¯æŸ¥çœ‹å®Œæ•´è¿½æº¯é“¾ã€‚

5. **å›½é™…åŒ–é€‚é…**ï¼šä¼Šåˆ©äº§å“å‡ºå£åˆ°ä¸œå—äºšã€å¤§æ´‹æ´²ç­‰å¸‚åœºï¼Œéœ€è¦æ”¯æŒå¤šè¯­è¨€è¿½æº¯å±•ç¤ºå’Œå¤šå›½ç›‘ç®¡æ ‡å‡†é€‚é…ã€‚

### 2.3 è§£å†³æ–¹æ¡ˆ

**åŸºäºGS1ç¼–ç ä½“ç³»å’ŒEPCISæ ‡å‡†ï¼Œæ„å»ºé¢å‘æ¶ˆè´¹è€…çš„å…¨ç¨‹è¿½æº¯æŸ¥è¯¢å¹³å°ï¼Œé‡‡ç”¨å¾®æœåŠ¡æ¶æ„ã€åˆ†å¸ƒå¼ç¼“å­˜ã€åŒºå—é“¾å­˜è¯ç­‰æŠ€æœ¯ï¼Œå®ç°è¿½æº¯æ•°æ®çš„é«˜æ•ˆæŸ¥è¯¢å’Œå¯ä¿¡å±•ç¤º**ã€‚

æ ¸å¿ƒæŠ€æœ¯æ¶æ„ï¼š
- æ ‡è¯†å±‚ï¼šGS1 GTINï¼ˆ69ç ï¼‰+ æ‰¹æ¬¡å· + åºåˆ—å·ä¸‰çº§ç¼–ç ä½“ç³»
- æ•°æ®å±‚ï¼šPostgreSQLï¼ˆå…³ç³»æ•°æ®ï¼‰+ Redisï¼ˆç¼“å­˜ï¼‰+ IPFSï¼ˆåŒºå—é“¾å­˜å‚¨ï¼‰
- æœåŠ¡å±‚ï¼šSpring Cloudå¾®æœåŠ¡ + Nginxè´Ÿè½½å‡è¡¡ + CDNå†…å®¹åˆ†å‘
- å±•ç¤ºå±‚ï¼šå¾®ä¿¡å°ç¨‹åº + H5é¡µé¢ + æ”¯ä»˜å®ç”Ÿæ´»å·å¤šå…¥å£

### 2.4 å®Œæ•´ä»£ç å®ç°

**æ¶ˆè´¹è€…äº§å“è¿½æº¯æŸ¥è¯¢Schemaï¼ˆå®Œæ•´ç¤ºä¾‹ï¼‰**ï¼š

```python
#!/usr/bin/env python3
"""
æ¶ˆè´¹è€…è¿½æº¯Schemaå®ç° - ä¼Šåˆ©é›†å›¢å…¨ç¨‹è¿½æº¯æŸ¥è¯¢ç³»ç»Ÿ
"""

from typing import Dict, List, Optional, Any
from datetime import datetime, date
from dataclasses import dataclass, field
from enum import Enum
import hashlib
import json
from collections import defaultdict


class ProductCategory(str, Enum):
    """äº§å“ç±»åˆ«"""
    LIQUID_MILK = "LiquidMilk"  # æ¶²æ€å¥¶
    MILK_POWDER = "MilkPowder"  # å¥¶ç²‰
    YOGURT = "Yogurt"  # é…¸å¥¶
    ICE_CREAM = "IceCream"  # å†·é¥®
    CHEESE = "Cheese"  # å¥¶é…ª


class EventType(str, Enum):
    """è¿½æº¯äº‹ä»¶ç±»å‹"""
    RAW_MILK_COLLECTION = "RawMilkCollection"  # åŸå¥¶é‡‡é›†
    PRODUCTION = "Production"  # ç”Ÿäº§åŠ å·¥
    QUALITY_TEST = "QualityTest"  # è´¨é‡æ£€æµ‹
    PACKAGING = "Packaging"  # åŒ…è£…
    WAREHOUSE_IN = "WarehouseIn"  # å…¥åº“
    WAREHOUSE_OUT = "WarehouseOut"  # å‡ºåº“
    TRANSPORTATION = "Transportation"  # è¿è¾“
    RETAIL = "Retail"  # é›¶å”®
    SALE = "Sale"  # é”€å”®


class CertificationType(str, Enum):
    """è®¤è¯ç±»å‹"""
    ORGANIC = "æœ‰æœºè®¤è¯"
    HALAL = "æ¸…çœŸè®¤è¯"
    HACCP = "HACCPè®¤è¯"
    ISO22000 = "ISO22000"
    GREEN_FOOD = "ç»¿è‰²é£Ÿå“"


@dataclass
class Farm:
    """å¥¶æºåœ°"""
    farm_id: str
    farm_name: str
    location: str
    latitude: float
    longitude: float
    farm_type: str  # è‡ªæœ‰ç‰§åœº/åˆä½œç‰§åœº
    cow_count: int
    daily_output: float  # æ—¥äº§é‡ï¼ˆå¨ï¼‰
    certifications: List[CertificationType] = field(default_factory=list)
    environment_data: Dict[str, Any] = field(default_factory=dict)


@dataclass
class RawMilkBatch:
    """åŸå¥¶æ‰¹æ¬¡"""
    batch_id: str
    farm_id: str
    collection_date: datetime
    volume_liters: float
    fat_content: float  # è„‚è‚ªå«é‡%
    protein_content: float  # è›‹ç™½è´¨å«é‡%
    somatic_cell_count: int  # ä½“ç»†èƒæ•°
    antibiotic_test: bool  # æŠ—ç”Ÿç´ æ£€æµ‹
    quality_grade: str  # è´¨é‡ç­‰çº§


@dataclass
class Product:
    """äº§å“"""
    product_id: str
    gtin: str  # GS1 GTINï¼Œå¦‚6951234567890
    product_name: str
    product_category: ProductCategory
    sku_code: str
    batch_number: str
    serial_number: Optional[str] = None  # å•å“åºåˆ—å·
    production_date: Optional[date] = None
    expiry_date: Optional[date] = None
    factory_id: Optional[str] = None
    factory_name: Optional[str] = None
    raw_milk_batches: List[str] = field(default_factory=list)  # ä½¿ç”¨çš„åŸå¥¶æ‰¹æ¬¡
    certifications: List[CertificationType] = field(default_factory=list)
    created_date: Optional[datetime] = None
    
    def generate_qr_content(self) -> str:
        """ç”ŸæˆäºŒç»´ç å†…å®¹"""
        return f"https://trace.yili.com/{self.gtin}/{self.batch_number}"
    
    def get_traceability_code(self) -> str:
        """è·å–è¿½æº¯ç """
        data = f"{self.gtin}{self.batch_number}{self.production_date}"
        return hashlib.sha256(data.encode()).hexdigest()[:16].upper()


@dataclass
class TraceabilityEvent:
    """è¿½æº¯äº‹ä»¶"""
    event_id: str
    event_type: EventType
    event_time: datetime
    product_id: str
    location: str
    location_id: str
    operator: Optional[str] = None
    operation_data: Dict[str, Any] = field(default_factory=dict)
    document_urls: List[str] = field(default_factory=list)  # ç›¸å…³æ–‡ä»¶é“¾æ¥
    blockchain_hash: Optional[str] = None
    
    def to_epcis_event(self) -> Dict:
        """è½¬æ¢ä¸ºEPCISäº‹ä»¶æ ¼å¼"""
        return {
            "eventID": self.event_id,
            "eventTime": self.event_time.isoformat(),
            "eventTimeZoneOffset": "+08:00",
            "type": "ObjectEvent",
            "action": "OBSERVE",
            "bizStep": self._get_biz_step(),
            "disposition": "active",
            "readPoint": {"id": f"urn:epc:id:sgln:{self.location_id}"},
            "bizLocation": {"id": f"urn:epc:id:sgln:{self.location_id}"},
            "ilmd": self.operation_data
        }
    
    def _get_biz_step(self) -> str:
        """è·å–ä¸šåŠ¡æ­¥éª¤"""
        biz_steps = {
            EventType.RAW_MILK_COLLECTION: "urn:epcglobal:cbv:bizstep:receiving",
            EventType.PRODUCTION: "urn:epcglobal:cbv:bizstep:transforming",
            EventType.QUALITY_TEST: "urn:epcglobal:cbv:bizstep:inspecting",
            EventType.PACKAGING: "urn:epcglobal:cbv:bizstep:packing",
            EventType.WAREHOUSE_IN: "urn:epcglobal:cbv:bizstep:storing",
            EventType.WAREHOUSE_OUT: "urn:epcglobal:cbv:bizstep:shipping",
            EventType.TRANSPORTATION: "urn:epcglobal:cbv:bizstep:transporting",
            EventType.RETAIL: "urn:epcglobal:cbv:bizstep:retail_selling"
        }
        return biz_steps.get(self.event_type, "unknown")


@dataclass
class QualityReport:
    """è´¨æ£€æŠ¥å‘Š"""
    report_id: str
    product_id: str
    test_type: str
    test_date: date
    test_items: Dict[str, Any] = field(default_factory=dict)
    overall_result: str = "åˆæ ¼"  # åˆæ ¼/ä¸åˆæ ¼
    inspector: Optional[str] = None
    report_url: Optional[str] = None
    certificate_no: Optional[str] = None


@dataclass
class TraceabilityChain:
    """è¿½æº¯é“¾"""
    chain_id: str
    product_id: str
    chain_status: str = "Active"
    events: List[TraceabilityEvent] = field(default_factory=list)
    quality_reports: List[QualityReport] = field(default_factory=list)
    created_date: Optional[datetime] = None
    last_updated: Optional[datetime] = None
    
    def add_event(self, event: TraceabilityEvent):
        """æ·»åŠ äº‹ä»¶"""
        self.events.append(event)
        self.events.sort(key=lambda e: e.event_time)
        self.last_updated = datetime.now()


@dataclass
class ConsumerTraceabilityStorage:
    """æ¶ˆè´¹è€…è¿½æº¯æ•°æ®å­˜å‚¨"""
    products: Dict[str, Product] = field(default_factory=dict)
    farms: Dict[str, Farm] = field(default_factory=dict)
    raw_milk_batches: Dict[str, RawMilkBatch] = field(default_factory=dict)
    events: Dict[str, TraceabilityEvent] = field(default_factory=dict)
    chains: Dict[str, TraceabilityChain] = field(default_factory=dict)
    quality_reports: Dict[str, QualityReport] = field(default_factory=dict)
    gtin_index: Dict[str, Set[str]] = field(default_factory=lambda: defaultdict(set))
    batch_index: Dict[str, Set[str]] = field(default_factory=lambda: defaultdict(set))
    
    def store_product(self, product: Product):
        """å­˜å‚¨äº§å“"""
        if product.created_date is None:
            product.created_date = datetime.now()
        self.products[product.product_id] = product
        self.gtin_index[product.gtin].add(product.product_id)
        self.batch_index[product.batch_number].add(product.product_id)
    
    def get_product(self, product_id: str) -> Optional[Product]:
        """è·å–äº§å“"""
        return self.products.get(product_id)
    
    def get_product_by_gtin(self, gtin: str) -> Optional[Product]:
        """é€šè¿‡GTINè·å–äº§å“"""
        product_ids = self.gtin_index.get(gtin)
        if product_ids:
            return self.products.get(list(product_ids)[0])
        return None
    
    def store_farm(self, farm: Farm):
        """å­˜å‚¨å¥¶æºåœ°"""
        self.farms[farm.farm_id] = farm
    
    def store_raw_milk_batch(self, batch: RawMilkBatch):
        """å­˜å‚¨åŸå¥¶æ‰¹æ¬¡"""
        self.raw_milk_batches[batch.batch_id] = batch
    
    def store_event(self, event: TraceabilityEvent):
        """å­˜å‚¨äº‹ä»¶"""
        # æ¨¡æ‹ŸåŒºå—é“¾å­˜è¯
        event.blockchain_hash = self._mock_blockchain_hash(event)
        self.events[event.event_id] = event
        
        # æ›´æ–°è¿½æº¯é“¾
        chain_id = f"CHAIN-{event.product_id}"
        if chain_id not in self.chains:
            self.chains[chain_id] = TraceabilityChain(
                chain_id=chain_id,
                product_id=event.product_id
            )
        self.chains[chain_id].add_event(event)
    
    def _mock_blockchain_hash(self, event: TraceabilityEvent) -> str:
        """æ¨¡æ‹ŸåŒºå—é“¾å“ˆå¸Œ"""
        data = f"{event.event_id}:{event.event_time.isoformat()}:{event.product_id}:{event.event_type.value}"
        return hashlib.sha256(data.encode()).hexdigest()
    
    def store_quality_report(self, report: QualityReport):
        """å­˜å‚¨è´¨æ£€æŠ¥å‘Š"""
        self.quality_reports[report.report_id] = report
        # å…³è”åˆ°è¿½æº¯é“¾
        chain_id = f"CHAIN-{report.product_id}"
        if chain_id in self.chains:
            self.chains[chain_id].quality_reports.append(report)
    
    def query_product_traceability(self, gtin: str, batch_number: Optional[str] = None) -> Optional[Dict]:
        """æŸ¥è¯¢äº§å“è¿½æº¯ä¿¡æ¯"""
        # æŸ¥æ‰¾äº§å“
        if batch_number:
            product_ids = self.batch_index.get(batch_number, set())
            product = None
            for pid in product_ids:
                p = self.products.get(pid)
                if p and p.gtin == gtin:
                    product = p
                    break
        else:
            product = self.get_product_by_gtin(gtin)
        
        if not product:
            return None
        
        # è·å–è¿½æº¯é“¾
        chain_id = f"CHAIN-{product.product_id}"
        chain = self.chains.get(chain_id)
        
        # è·å–åŸå¥¶ä¿¡æ¯
        raw_milk_info = []
        for batch_id in product.raw_milk_batches:
            batch = self.raw_milk_batches.get(batch_id)
            if batch:
                farm = self.farms.get(batch.farm_id)
                raw_milk_info.append({
                    "batch_id": batch.batch_id,
                    "farm_name": farm.farm_name if farm else "æœªçŸ¥",
                    "farm_location": farm.location if farm else "æœªçŸ¥",
                    "collection_date": batch.collection_date.isoformat(),
                    "quality_grade": batch.quality_grade,
                    "fat_content": batch.fat_content,
                    "protein_content": batch.protein_content
                })
        
        # æ„å»ºè¿½æº¯æ—¶é—´çº¿
        timeline = []
        if chain:
            for event in chain.events:
                timeline.append({
                    "event_type": event.event_type.value,
                    "event_time": event.event_time.isoformat(),
                    "location": event.location,
                    "operator": event.operator,
                    "data": event.operation_data,
                    "blockchain_verified": event.blockchain_hash is not None
                })
        
        # è´¨æ£€æŠ¥å‘Š
        quality_info = []
        if chain:
            for report in chain.quality_reports:
                quality_info.append({
                    "report_id": report.report_id,
                    "test_type": report.test_type,
                    "test_date": report.test_date.isoformat(),
                    "result": report.overall_result,
                    "certificate_no": report.certificate_no
                })
        
        return {
            "product_id": product.product_id,
            "product_name": product.product_name,
            "gtin": product.gtin,
            "batch_number": product.batch_number,
            "serial_number": product.serial_number,
            "production_date": product.production_date.isoformat() if product.production_date else None,
            "expiry_date": product.expiry_date.isoformat() if product.expiry_date else None,
            "factory_name": product.factory_name,
            "certifications": [c.value for c in product.certifications],
            "traceability_code": product.get_traceability_code(),
            "raw_milk_info": raw_milk_info,
            "timeline": timeline,
            "quality_reports": quality_info,
            "total_events": len(timeline),
            "blockchain_verified": all(e.get("blockchain_verified") for e in timeline)
        }
    
    def query_by_consumer_scan(self, qr_code: str) -> Optional[Dict]:
        """æ¶ˆè´¹è€…æ‰«ç æŸ¥è¯¢"""
        # è§£æäºŒç»´ç ï¼ˆç®€åŒ–å®ç°ï¼‰
        # å®é™…åº”ç”¨ä¸­äºŒç»´ç åŒ…å«GTINå’Œæ‰¹æ¬¡å·
        parts = qr_code.split("/")
        if len(parts) >= 2:
            gtin = parts[-2]
            batch = parts[-1]
            return self.query_product_traceability(gtin, batch)
        return None
    
    def generate_consumer_report(self, gtin: str) -> Dict:
        """ç”Ÿæˆæ¶ˆè´¹è€…è¿½æº¯æŠ¥å‘Š"""
        trace_info = self.query_product_traceability(gtin)
        if not trace_info:
            return {"error": "Product not found"}
        
        # ç®€åŒ–å±•ç¤ºç»™æ¶ˆè´¹è€…çš„ä¿¡æ¯
        return {
            "product_name": trace_info["product_name"],
            "production_date": trace_info["production_date"],
            "expiry_date": trace_info["expiry_date"],
            "factory": trace_info["factory_name"],
            "certifications": trace_info["certifications"],
            "quality_passed": all(r["result"] == "åˆæ ¼" for r in trace_info["quality_reports"]),
            "key_events": [
                {
                    "stage": "å¥¶æº",
                    "location": trace_info["raw_milk_info"][0]["farm_name"] if trace_info["raw_milk_info"] else "æœªçŸ¥",
                    "time": trace_info["raw_milk_info"][0]["collection_date"] if trace_info["raw_milk_info"] else None
                },
                {
                    "stage": "ç”Ÿäº§",
                    "location": trace_info["factory_name"],
                    "time": trace_info["production_date"]
                }
            ],
            "traceability_verified": trace_info["blockchain_verified"]
        }


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == '__main__':
    # åˆ›å»ºæ¶ˆè´¹è€…è¿½æº¯å­˜å‚¨
    storage = ConsumerTraceabilityStorage()
    
    # æ³¨å†Œå¥¶æºåœ°
    farm = Farm(
        farm_id="FARM001",
        farm_name="ä¼Šåˆ©å‘¼ä¼¦è´å°”æœ‰æœºç‰§åœº",
        location="å†…è’™å¤è‡ªæ²»åŒºå‘¼ä¼¦è´å°”å¸‚",
        latitude=49.2153,
        longitude=119.7657,
        farm_type="è‡ªæœ‰ç‰§åœº",
        cow_count=5000,
        daily_output=80.0,
        certifications=[CertificationType.ORGANIC],
        environment_data={"grassland_area": 10000, "air_quality": "ä¼˜"}
    )
    storage.store_farm(farm)
    
    # åˆ›å»ºåŸå¥¶æ‰¹æ¬¡
    milk_batch = RawMilkBatch(
        batch_id="MILK20250121A",
        farm_id="FARM001",
        collection_date=datetime(2025, 1, 21, 6, 0, 0),
        volume_liters=5000,
        fat_content=3.6,
        protein_content=3.2,
        somatic_cell_count=150000,
        antibiotic_test=True,
        quality_grade="ç‰¹çº§"
    )
    storage.store_raw_milk_batch(milk_batch)
    
    # åˆ›å»ºäº§å“
    product = Product(
        product_id="PROD20250121001",
        gtin="6951234567890",
        product_name="ä¼Šåˆ©é‡‘å…¸æœ‰æœºçº¯ç‰›å¥¶250ml",
        product_category=ProductCategory.LIQUID_MILK,
        sku_code="JD250ML0121",
        batch_number="BATCH20250121001",
        serial_number="SN123456789",
        production_date=date(2025, 1, 21),
        expiry_date=date(2025, 7, 21),
        factory_id="FACTORY001",
        factory_name="ä¼Šåˆ©å‘¼å’Œæµ©ç‰¹é‡‘å…¸å·¥å‚",
        raw_milk_batches=["MILK20250121A"],
        certifications=[CertificationType.ORGANIC, CertificationType.HACCP]
    )
    storage.store_product(product)
    
    # è®°å½•è¿½æº¯äº‹ä»¶
    events = [
        TraceabilityEvent(
            event_id="EVT001",
            event_type=EventType.RAW_MILK_COLLECTION,
            event_time=datetime(2025, 1, 21, 6, 0, 0),
            product_id=product.product_id,
            location="ä¼Šåˆ©å‘¼ä¼¦è´å°”æœ‰æœºç‰§åœº",
            location_id="FARM001",
            operation_data={"milk_batch": "MILK20250121A", "volume": 5000}
        ),
        TraceabilityEvent(
            event_id="EVT002",
            event_type=EventType.PRODUCTION,
            event_time=datetime(2025, 1, 21, 14, 30, 0),
            product_id=product.product_id,
            location="ä¼Šåˆ©å‘¼å’Œæµ©ç‰¹é‡‘å…¸å·¥å‚",
            location_id="FACTORY001",
            operator="ç‹ç”Ÿäº§",
            operation_data={"production_line": "LINE-A01", "batch": "BATCH20250121001"}
        ),
        TraceabilityEvent(
            event_id="EVT003",
            event_type=EventType.QUALITY_TEST,
            event_time=datetime(2025, 1, 21, 18, 0, 0),
            product_id=product.product_id,
            location="ä¼Šåˆ©è´¨æ£€ä¸­å¿ƒ",
            location_id="QC001",
            operation_data={"test_items": ["å¾®ç”Ÿç‰©", "è›‹ç™½è´¨", "è„‚è‚ª"], "result": "åˆæ ¼"}
        ),
        TraceabilityEvent(
            event_id="EVT004",
            event_type=EventType.PACKAGING,
            event_time=datetime(2025, 1, 21, 20, 0, 0),
            product_id=product.product_id,
            location="ä¼Šåˆ©å‘¼å’Œæµ©ç‰¹é‡‘å…¸å·¥å‚",
            location_id="FACTORY001",
            operation_data={"package_type": "åˆ©ä¹åŒ…", "quantity": 10000}
        )
    ]
    
    for event in events:
        storage.store_event(event)
    
    # æ·»åŠ è´¨æ£€æŠ¥å‘Š
    report = QualityReport(
        report_id="QR001",
        product_id=product.product_id,
        test_type="å‡ºå‚æ£€éªŒ",
        test_date=date(2025, 1, 21),
        test_items={
            "protein": "3.6g/100ml",
            "fat": "3.8g/100ml",
            "bacteria_count": "<10000CFU/ml"
        },
        overall_result="åˆæ ¼",
        inspector="ææ£€éªŒ",
        certificate_no="QC20250121001"
    )
    storage.store_quality_report(report)
    
    # æ¶ˆè´¹è€…æŸ¥è¯¢è¿½æº¯ä¿¡æ¯
    trace_info = storage.query_product_traceability("6951234567890", "BATCH20250121001")
    print(f"è¿½æº¯ä¿¡æ¯:")
    print(f"  äº§å“: {trace_info['product_name']}")
    print(f"  ç”Ÿäº§æ—¥æœŸ: {trace_info['production_date']}")
    print(f"  å¥¶æº: {trace_info['raw_milk_info'][0]['farm_name'] if trace_info['raw_milk_info'] else 'æœªçŸ¥'}")
    print(f"  è¿½æº¯äº‹ä»¶æ•°: {trace_info['total_events']}")
    print(f"  åŒºå—é“¾éªŒè¯: {trace_info['blockchain_verified']}")
    
    # ç”Ÿæˆæ¶ˆè´¹è€…æŠ¥å‘Š
    consumer_report = storage.generate_consumer_report("6951234567890")
    print(f"\næ¶ˆè´¹è€…æŠ¥å‘Š:")
    print(f"  äº§å“: {consumer_report['product_name']}")
    print(f"  è´¨æ£€é€šè¿‡: {consumer_report['quality_passed']}")
    print(f"  è¿½æº¯éªŒè¯: {consumer_report['traceability_verified']}")
```

### 2.5 æ•ˆæœè¯„ä¼°

**æ€§èƒ½æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| è¿½æº¯ä¿¡æ¯å®Œæ•´åº¦ | 60% | 98% | 38%æå‡ |
| æŸ¥è¯¢å“åº”æ—¶é—´ | 5-8ç§’ | 280ms | 94%ç¼©çŸ­ |
| æ—¥æŸ¥è¯¢æ‰¿è½½é‡ | 100ä¸‡æ¬¡ | 1500ä¸‡æ¬¡ | 1400%æå‡ |
| æ•°æ®ç¯¡æ”¹é£é™© | é«˜ | ä¸å¯ç¯¡æ”¹ | 100%ä¿æŠ¤ |
| å¬å›å“åº”æ—¶é—´ | 48å°æ—¶ | 1.5å°æ—¶ | 97%ç¼©çŸ­ |

**ä¸šåŠ¡ä»·å€¼ä¸ROI**ï¼š

1. **ç›´æ¥ç»æµæ•ˆç›Š**ï¼š
   - ç³»ç»ŸæŠ•èµ„ï¼šè¿½æº¯å¹³å°å»ºè®¾500ä¸‡å…ƒï¼ŒåŒºå—é“¾å­˜è¯ç³»ç»Ÿ200ä¸‡å…ƒï¼Œç³»ç»Ÿé›†æˆ300ä¸‡å…ƒï¼Œåˆè®¡1000ä¸‡å…ƒ
   - å“ç‰Œæº¢ä»·ï¼šäº§å“å”®ä»·å¹³å‡æå‡8%ï¼Œå¹´å¢æ”¶çº¦8äº¿å…ƒ
   - å¬å›æˆæœ¬èŠ‚çœï¼šç²¾å‡†å¬å›èŒƒå›´ç¼©å°75%ï¼Œå¹´èŠ‚çœå¬å›æˆæœ¬çº¦2000ä¸‡å…ƒ
   - åˆè§„æˆæœ¬é™ä½ï¼šç›‘ç®¡æ£€æŸ¥è‡ªåŠ¨åŒ–åº”å¯¹ï¼Œå¹´èŠ‚çœåˆè§„æˆæœ¬300ä¸‡å…ƒ

2. **ROIè®¡ç®—**ï¼š
   - é¦–å¹´ROI = (80000 + 2000 + 300 - 1000) / 1000 Ã— 100% = **8130%**
   - ï¼ˆæ³¨ï¼šå“ç‰Œæº¢ä»·è´¡çŒ®æœ€å¤§ï¼Œå±æˆ˜ç•¥æ€§æ”¶ç›Šï¼‰

3. **æˆ˜ç•¥æ•ˆç›Š**ï¼š
   - æ¶ˆè´¹è€…ä¿¡ä»»åº¦ä»68%æå‡è‡³92%
   - è·å¾—"å…¨å›½é£Ÿå“å®‰å…¨ç¤ºèŒƒä¼ä¸š"ç§°å·
   - å…¥é€‰å›½å®¶å¸‚åœºç›‘ç®¡æ€»å±€è¿½æº¯ä½“ç³»å»ºè®¾å…¸å‹æ¡ˆä¾‹
   - äº§å“å‡ºå£åˆ°ä¸œå—äºšã€å¤§æ´‹æ´²ç­‰å¸‚åœºï¼Œå›½é™…è®¤å¯åº¦æå‡

**ç»éªŒæ•™è®­**ï¼š

1. è¿½æº¯æ•°æ®è´¨é‡æ˜¯å…³é”®ï¼Œä¸Šæ¸¸æ•°æ®é‡‡é›†è¦æ ‡å‡†åŒ–
2. åŒºå—é“¾å­˜è¯è¦é€‰æ‹©åˆé€‚çš„å…±è¯†æœºåˆ¶ï¼Œå¹³è¡¡æ€§èƒ½å’Œå®‰å…¨æ€§
3. æ¶ˆè´¹è€…ä½“éªŒè¦æ³¨é‡ç®€æ´ç›´è§‚ï¼Œé¿å…ä¿¡æ¯è¿‡è½½
4. ä¸ç›‘ç®¡éƒ¨é—¨çš„æ•°æ®å¯¹æ¥è¦æå‰è§„åˆ’ï¼Œç¡®ä¿åˆè§„

**å‚è€ƒæ¡ˆä¾‹**ï¼š

- [GS1å…¨çƒæ ‡å‡†](https://www.gs1.org/)
- [EPCISè¿½æº¯æ ‡å‡†](https://www.gs1.org/epcis)

---

**å‚è€ƒæ–‡æ¡£**ï¼š

- `01_Overview.md` - æ¦‚è¿°
- `02_Formal_Definition.md` - å½¢å¼åŒ–å®šä¹‰
- `03_Standards.md` - æ ‡å‡†å¯¹æ ‡
- `04_Transformation.md` - è½¬æ¢ä½“ç³»

**åˆ›å»ºæ—¶é—´**ï¼š2025-01-21
**æœ€åæ›´æ–°**ï¼š2025-01-21
