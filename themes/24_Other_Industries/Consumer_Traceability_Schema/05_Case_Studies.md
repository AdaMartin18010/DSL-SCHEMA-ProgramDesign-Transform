# æ¶ˆè´¹è€…è¿½æº¯Schemaå®è·µæ¡ˆä¾‹

## ğŸ“‘ ç›®å½•

- [æ¶ˆè´¹è€…è¿½æº¯Schemaå®è·µæ¡ˆä¾‹](#æ¶ˆè´¹è€…è¿½æº¯schemaå®è·µæ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¡ˆä¾‹æ¦‚è¿°](#1-æ¡ˆä¾‹æ¦‚è¿°)
  - [2. æ¡ˆä¾‹1ï¼šä¼ä¸šæ¶ˆè´¹è€…äº§å“è¿½æº¯æŸ¥è¯¢ç³»ç»Ÿ](#2-æ¡ˆä¾‹1ä¼ä¸šæ¶ˆè´¹è€…äº§å“è¿½æº¯æŸ¥è¯¢ç³»ç»Ÿ)
    - [2.1 ä¸šåŠ¡èƒŒæ™¯](#21-ä¸šåŠ¡èƒŒæ™¯)
    - [2.2 æŠ€æœ¯æŒ‘æˆ˜](#22-æŠ€æœ¯æŒ‘æˆ˜)
    - [2.3 è§£å†³æ–¹æ¡ˆ](#23-è§£å†³æ–¹æ¡ˆ)
    - [2.4 å®Œæ•´ä»£ç å®ç°](#24-å®Œæ•´ä»£ç å®ç°)
    - [2.5 æ•ˆæœè¯„ä¼°](#25-æ•ˆæœè¯„ä¼°)

---

## 1. æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›æ¶ˆè´¹è€…è¿½æº¯Schemaåœ¨å®é™…ä¼ä¸šåº”ç”¨ä¸­çš„å®è·µæ¡ˆä¾‹ï¼Œæ¶µç›–æ¶ˆè´¹è€…äº§å“è¿½æº¯æŸ¥è¯¢ã€è¿½æº¯é“¾ç®¡ç†ã€è¿½æº¯æ•°æ®å­˜å‚¨ç­‰çœŸå®åœºæ™¯ã€‚

**æ¡ˆä¾‹ç±»å‹**ï¼š

1. **æ¶ˆè´¹è€…äº§å“è¿½æº¯æŸ¥è¯¢ç³»ç»Ÿ**ï¼šæ¶ˆè´¹è€…é€šè¿‡GTINæŸ¥è¯¢äº§å“è¿½æº¯ä¿¡æ¯
2. **è¿½æº¯é“¾ç®¡ç†ç³»ç»Ÿ**ï¼šäº§å“è¿½æº¯é“¾ç®¡ç†
3. **è¿½æº¯æ•°æ®å­˜å‚¨ç³»ç»Ÿ**ï¼šè¿½æº¯æ•°æ®å­˜å‚¨å’Œåˆ†æ
4. **è¿½æº¯éªŒè¯ç³»ç»Ÿ**ï¼šè¿½æº¯æ•°æ®éªŒè¯
5. **è¿½æº¯æŠ¥å‘Šç³»ç»Ÿ**ï¼šè¿½æº¯æŠ¥å‘Šç”Ÿæˆ

**å‚è€ƒä¼ä¸šæ¡ˆä¾‹**ï¼š

- **GS1æ ‡å‡†**ï¼šGS1å…¨çƒæ ‡å‡†
- **EPCIS**ï¼šEPCISè¿½æº¯æ ‡å‡†

---

## 2. æ¡ˆä¾‹1ï¼šä¼ä¸šæ¶ˆè´¹è€…äº§å“è¿½æº¯æŸ¥è¯¢ç³»ç»Ÿ

### 2.1 ä¸šåŠ¡èƒŒæ™¯

**ä¼ä¸šèƒŒæ™¯**ï¼š
æŸé£Ÿå“ä¼ä¸šéœ€è¦æ„å»ºæ¶ˆè´¹è€…äº§å“è¿½æº¯æŸ¥è¯¢ç³»ç»Ÿï¼Œæ¶ˆè´¹è€…é€šè¿‡äº§å“GTINæŸ¥è¯¢äº§å“è¿½æº¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç”Ÿäº§æ—¥æœŸã€æ‰¹æ¬¡å·ã€ä¾›åº”é“¾ä¿¡æ¯ç­‰ï¼Œæé«˜äº§å“é€æ˜åº¦å’Œæ¶ˆè´¹è€…ä¿¡ä»»åº¦ã€‚

**ä¸šåŠ¡ç—›ç‚¹**ï¼š

1. **è¿½æº¯ä¿¡æ¯ä¸é€æ˜**ï¼šæ¶ˆè´¹è€…æ— æ³•æŸ¥è¯¢äº§å“è¿½æº¯ä¿¡æ¯
2. **æ•°æ®åˆ†æ•£**ï¼šè¿½æº¯æ•°æ®åˆ†æ•£åœ¨å„ä¸ªç³»ç»Ÿä¸­
3. **æŸ¥è¯¢æ•ˆç‡ä½**ï¼šæŸ¥è¯¢æ•ˆç‡ä½
4. **æ•°æ®ä¸å®Œæ•´**ï¼šè¿½æº¯æ•°æ®ä¸å®Œæ•´

**ä¸šåŠ¡ç›®æ ‡**ï¼š

- æä¾›è¿½æº¯æŸ¥è¯¢æœåŠ¡
- æ•´åˆè¿½æº¯æ•°æ®
- æé«˜æŸ¥è¯¢æ•ˆç‡
- å®Œå–„è¿½æº¯æ•°æ®

### 2.2 æŠ€æœ¯æŒ‘æˆ˜

1. **GS1æ ‡å‡†åº”ç”¨**ï¼šä½¿ç”¨GS1æ ‡å‡†æ ‡è¯†äº§å“
2. **EPCISäº‹ä»¶è®°å½•**ï¼šä½¿ç”¨EPCISè®°å½•è¿½æº¯äº‹ä»¶
3. **æŸ¥è¯¢æ¥å£è®¾è®¡**ï¼šè®¾è®¡æ¶ˆè´¹è€…æŸ¥è¯¢æ¥å£
4. **æ•°æ®æ•´åˆ**ï¼šæ•´åˆåˆ†æ•£çš„è¿½æº¯æ•°æ®

### 2.3 è§£å†³æ–¹æ¡ˆ

**ä½¿ç”¨GS1æ ‡å‡†æ ‡è¯†äº§å“ï¼Œä½¿ç”¨EPCISè®°å½•è¿½æº¯äº‹ä»¶ï¼Œæä¾›æ¶ˆè´¹è€…æŸ¥è¯¢æ¥å£**ï¼š

### 2.4 å®Œæ•´ä»£ç å®ç°

**æ¶ˆè´¹è€…äº§å“è¿½æº¯æŸ¥è¯¢Schemaï¼ˆå®Œæ•´ç¤ºä¾‹ï¼‰**ï¼š

```python
#!/usr/bin/env python3
"""
æ¶ˆè´¹è€…è¿½æº¯Schemaå®ç°
"""

from typing import Dict, List, Optional
from datetime import datetime, date
from dataclasses import dataclass, field

@dataclass
class Product:
    """äº§å“"""
    product_id: str
    gtin: str  # Global Trade Item Number
    product_name: str
    batch_number: str
    production_date: date
    expiry_date: Optional[date] = None
    manufacturer: Optional[str] = None
    created_date: Optional[datetime] = None

@dataclass
class TraceabilityEvent:
    """è¿½æº¯äº‹ä»¶"""
    event_id: str
    event_type: str  # ObjectEvent, AggregationEvent, TransactionEvent, TransformationEvent
    event_time: datetime
    product_id: str
    location: Optional[str] = None
    business_step: Optional[str] = None
    disposition: Optional[str] = None
    read_point: Optional[str] = None
    created_date: Optional[datetime] = None

@dataclass
class TraceabilityChain:
    """è¿½æº¯é“¾"""
    chain_id: str
    product_id: str
    chain_status: str
    events: List[TraceabilityEvent] = field(default_factory=list)
    created_date: Optional[datetime] = None

@dataclass
class ConsumerTraceabilityStorage:
    """æ¶ˆè´¹è€…è¿½æº¯æ•°æ®å­˜å‚¨"""
    products: Dict[str, Product] = field(default_factory=dict)
    events: Dict[str, TraceabilityEvent] = field(default_factory=dict)
    chains: Dict[str, TraceabilityChain] = field(default_factory=dict)

    def store_product(self, product: Product):
        """å­˜å‚¨äº§å“"""
        if product.created_date is None:
            product.created_date = datetime.now()
        self.products[product.product_id] = product

    def store_event(self, event: TraceabilityEvent):
        """å­˜å‚¨äº‹ä»¶"""
        if event.created_date is None:
            event.created_date = datetime.now()
        self.events[event.event_id] = event

        # æ›´æ–°è¿½æº¯é“¾
        if event.product_id in self.products:
            chain_id = f"CHAIN-{event.product_id}"
            if chain_id not in self.chains:
                chain = TraceabilityChain(
                    chain_id=chain_id,
                    product_id=event.product_id,
                    chain_status="Active"
                )
                self.chains[chain_id] = chain
            self.chains[chain_id].events.append(event)

    def query_product_traceability(self, gtin: str) -> Optional[Dict]:
        """æŸ¥è¯¢äº§å“è¿½æº¯ä¿¡æ¯"""
        # æŸ¥æ‰¾äº§å“
        product = None
        for p in self.products.values():
            if p.gtin == gtin:
                product = p
                break

        if not product:
            return None

        # è·å–è¿½æº¯é“¾
        chain_id = f"CHAIN-{product.product_id}"
        chain = self.chains.get(chain_id)

        return {
            "product_id": product.product_id,
            "product_name": product.product_name,
            "gtin": product.gtin,
            "batch_number": product.batch_number,
            "production_date": product.production_date.isoformat(),
            "expiry_date": product.expiry_date.isoformat() if product.expiry_date else None,
            "manufacturer": product.manufacturer,
            "chain_status": chain.chain_status if chain else None,
            "events": [
                {
                    "event_type": event.event_type,
                    "event_time": event.event_time.isoformat(),
                    "location": event.location,
                    "business_step": event.business_step
                }
                for event in (chain.events if chain else [])
            ]
        }

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == '__main__':
    # åˆ›å»ºæ¶ˆè´¹è€…è¿½æº¯å­˜å‚¨
    storage = ConsumerTraceabilityStorage()

    # åˆ›å»ºäº§å“
    product = Product(
        product_id="PROD001",
        gtin="1234567890123",
        product_name="æœ‰æœºå¤§ç±³",
        batch_number="BATCH20250121",
        production_date=date(2025, 1, 15),
        expiry_date=date(2026, 1, 15),
        manufacturer="ABCé£Ÿå“å…¬å¸"
    )
    storage.store_product(product)

    # åˆ›å»ºè¿½æº¯äº‹ä»¶
    event = TraceabilityEvent(
        event_id="EVT001",
        event_type="ObjectEvent",
        event_time=datetime(2025, 1, 15, 10, 0, 0),
        product_id="PROD001",
        location="ç”Ÿäº§å·¥å‚A",
        business_step="ç”Ÿäº§",
        disposition="ç”Ÿäº§å®Œæˆ"
    )
    storage.store_event(event)

    # æŸ¥è¯¢äº§å“è¿½æº¯ä¿¡æ¯
    traceability = storage.query_product_traceability("1234567890123")
    print(f"äº§å“è¿½æº¯ä¿¡æ¯: {traceability}")
```

### 2.5 æ•ˆæœè¯„ä¼°

**æ€§èƒ½æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| è¿½æº¯ä¿¡æ¯é€æ˜åº¦ | 0% | 100% | 100%æå‡ |
| æŸ¥è¯¢å“åº”æ—¶é—´ | é«˜ | ä½ | æ˜¾è‘—é™ä½ |
| æ•°æ®å®Œæ•´æ€§ | 70% | 95% | 25%æå‡ |
| æ¶ˆè´¹è€…æ»¡æ„åº¦ | ä½ | é«˜ | æ˜¾è‘—æå‡ |

**ä¸šåŠ¡ä»·å€¼**ï¼š

1. **é€æ˜åº¦æé«˜**ï¼šæé«˜äº§å“è¿½æº¯ä¿¡æ¯é€æ˜åº¦
2. **æ•°æ®æ•´åˆ**ï¼šæ•´åˆåˆ†æ•£çš„è¿½æº¯æ•°æ®
3. **æŸ¥è¯¢æ•ˆç‡æé«˜**ï¼šæé«˜æŸ¥è¯¢æ•ˆç‡
4. **ä¿¡ä»»åº¦æå‡**ï¼šæå‡æ¶ˆè´¹è€…ä¿¡ä»»åº¦

**ç»éªŒæ•™è®­**ï¼š

1. GS1æ ‡å‡†åº”ç”¨å¾ˆé‡è¦
2. EPCISäº‹ä»¶è®°å½•éœ€è¦å®Œæ•´
3. æŸ¥è¯¢æ¥å£è®¾è®¡éœ€è¦å‹å¥½
4. æ•°æ®æ•´åˆéœ€è¦åŠæ—¶

**å‚è€ƒæ¡ˆä¾‹**ï¼š

- [GS1å…¨çƒæ ‡å‡†](https://www.gs1.org/)
- [EPCISè¿½æº¯æ ‡å‡†](https://www.gs1.org/epcis)
