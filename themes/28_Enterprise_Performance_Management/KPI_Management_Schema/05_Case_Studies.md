# KPIç®¡ç†Schemaå®è·µæ¡ˆä¾‹

## ğŸ“‘ ç›®å½•

- [KPIç®¡ç†Schemaå®è·µæ¡ˆä¾‹](#kpiç®¡ç†schemaå®è·µæ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¡ˆä¾‹æ¦‚è¿°](#1-æ¡ˆä¾‹æ¦‚è¿°)
  - [2. æ¡ˆä¾‹1ï¼šé›¶å”®è¿é”ä¼ä¸šå…¨æ¸ é“KPIç®¡ç†ä½“ç³»](#2-æ¡ˆä¾‹1é›¶å”®è¿é”ä¼ä¸šå…¨æ¸ é“kpiç®¡ç†ä½“ç³»)
    - [2.1 ä¼ä¸šèƒŒæ™¯](#21-ä¼ä¸šèƒŒæ™¯)
    - [2.2 ä¸šåŠ¡ç—›ç‚¹](#22-ä¸šåŠ¡ç—›ç‚¹)
    - [2.3 ä¸šåŠ¡ç›®æ ‡](#23-ä¸šåŠ¡ç›®æ ‡)
    - [2.4 æŠ€æœ¯æŒ‘æˆ˜](#24-æŠ€æœ¯æŒ‘æˆ˜)
    - [2.5 è§£å†³æ–¹æ¡ˆ](#25-è§£å†³æ–¹æ¡ˆ)
    - [2.6 å®Œæ•´ä»£ç å®ç°](#26-å®Œæ•´ä»£ç å®ç°)
    - [2.7 æ•ˆæœè¯„ä¼°ä¸ROI](#27-æ•ˆæœè¯„ä¼°ä¸roi)
  - [3. æ¡ˆä¾‹2ï¼šKPIåˆ°OLAP Cubeè½¬æ¢](#3-æ¡ˆä¾‹2kpiåˆ°olap-cubeè½¬æ¢)
  - [4. æ¡ˆä¾‹3ï¼šå®æ—¶KPIé¢„è­¦ç³»ç»Ÿ](#4-æ¡ˆä¾‹3å®æ—¶kpié¢„è­¦ç³»ç»Ÿ)
  - [5. æ¡ˆä¾‹4ï¼šKPIæ ¹å› åˆ†æå¼•æ“](#5-æ¡ˆä¾‹4kpiæ ¹å› åˆ†æå¼•æ“)
  - [6. æ¡ˆä¾‹5ï¼šKPIæ•°æ®æ¹–å­˜å‚¨ä¸åˆ†æç³»ç»Ÿ](#6-æ¡ˆä¾‹5kpiæ•°æ®æ¹–å­˜å‚¨ä¸åˆ†æç³»ç»Ÿ)

---

## 1. æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›KPIç®¡ç†Schemaåœ¨å®é™…ä¼ä¸šåº”ç”¨ä¸­çš„å®è·µæ¡ˆä¾‹ï¼Œæ¶µç›–å…¨æ¸ é“KPIç®¡ç†ã€å®æ—¶é¢„è­¦ã€æ ¹å› åˆ†æç­‰çœŸå®åœºæ™¯ã€‚

**æ¡ˆä¾‹ç±»å‹**ï¼š

1. **é›¶å”®è¿é”å…¨æ¸ é“KPIç®¡ç†**ï¼šçº¿ä¸Šçº¿ä¸‹ä¸€ä½“åŒ–çš„KPIä½“ç³»
2. **KPIåˆ°OLAP Cubeè½¬æ¢**ï¼šKPIæ•°æ®å¤šç»´åˆ†æ
3. **å®æ—¶KPIé¢„è­¦ç³»ç»Ÿ**ï¼šæ™ºèƒ½é¢„è­¦å’Œé€šçŸ¥
4. **KPIæ ¹å› åˆ†æå¼•æ“**ï¼šè‡ªåŠ¨åŒ–æ ¹å› è¯†åˆ«
5. **KPIæ•°æ®æ¹–å­˜å‚¨ä¸åˆ†æ**ï¼šå¤§è§„æ¨¡KPIæ•°æ®å¤„ç†

**å‚è€ƒä¼ä¸šæ¡ˆä¾‹**ï¼š

- **æ²ƒå°”ç›**ï¼šé›¶å”®ä¸šKPIç®¡ç†æœ€ä½³å®è·µ
- **äºšé©¬é€Š**ï¼šæ•°æ®é©±åŠ¨çš„ç»©æ•ˆç®¡ç†
- **æ˜Ÿå·´å…‹**ï¼šé—¨åº—è¿è¥KPIä½“ç³»

---

## 2. æ¡ˆä¾‹1ï¼šé›¶å”®è¿é”ä¼ä¸šå…¨æ¸ é“KPIç®¡ç†ä½“ç³»

### 2.1 ä¼ä¸šèƒŒæ™¯

**ä¼ä¸šæ¦‚å†µ**ï¼š
"ä¹è´­è¿é”"ï¼ˆåŒ–åï¼‰æ˜¯ä¸­å›½é¢†å…ˆçš„æ—¶å°šé›¶å”®è¿é”ä¼ä¸šï¼Œæˆç«‹äº2005å¹´ï¼Œæ€»éƒ¨ä½äºä¸Šæµ·ã€‚å…¬å¸æ——ä¸‹æ‹¥æœ‰3ä¸ªå“ç‰Œï¼Œåœ¨å…¨å›½280ä¸ªåŸå¸‚å¼€è®¾è¶…è¿‡1,500å®¶é—¨åº—ï¼Œå¹´è¥ä¸šé¢è¾¾180äº¿å…ƒäººæ°‘å¸ï¼Œå‘˜å·¥æ€»æ•°è¶…è¿‡35,000äººã€‚

**ä¸šåŠ¡ç‰¹ç‚¹**ï¼š
- å…¨æ¸ é“é›¶å”®æ¨¡å¼ï¼šçº¿ä¸‹é—¨åº— + ç”µå•†å¹³å° + ç¤¾äº¤ç”µå•†
- å¿«æ—¶å°šå®šä½ï¼šæ¯å‘¨ä¸Šæ–°ï¼ŒSKUè¶…è¿‡50,000ä¸ª
- ä¼šå‘˜ä½“ç³»ï¼šæ³¨å†Œä¼šå‘˜è¶…è¿‡2,000ä¸‡ï¼Œæ´»è·ƒä¼šå‘˜800ä¸‡
- ä¾›åº”é“¾ï¼šè‡ªæœ‰ç‰©æµä¸­å¿ƒ12ä¸ªï¼Œè¦†ç›–å…¨å›½çš„é…é€ç½‘ç»œ

**ç»„ç»‡æ¶æ„**ï¼š
- é›†å›¢æ€»éƒ¨ï¼šæˆ˜ç•¥ã€è´¢åŠ¡ã€äººåŠ›ã€å•†å“ã€è¿è¥ã€æ•°å­—åŒ–
- åŒºåŸŸå…¬å¸ï¼šåä¸œã€åå—ã€ååŒ—ã€è¥¿å—ã€è¥¿åŒ—5å¤§åŒºåŸŸ
- é—¨åº—å±‚çº§ï¼šæ——èˆ°åº—ã€æ ‡å‡†åº—ã€ç¤¾åŒºåº—ä¸‰ç§ç±»å‹
- ç”µå•†å›¢é˜Ÿï¼šå¹³å°ç”µå•†ã€ç¤¾äº¤ç”µå•†ã€ç›´æ’­å›¢é˜Ÿ

### 2.2 ä¸šåŠ¡ç—›ç‚¹

1. **KPIä½“ç³»æ··ä¹±**
   - çº¿ä¸Šçº¿ä¸‹KPIå®šä¹‰ä¸ä¸€è‡´ï¼Œéš¾ä»¥ç»Ÿä¸€è¯„ä¼°
   - å„åŒºåŸŸè‡ªè¡Œå®šä¹‰KPIï¼Œå£å¾„å·®å¼‚å¤§
   - éƒ¨é—¨KPIä¸ä¼ä¸šæˆ˜ç•¥è„±èŠ‚ï¼Œå„è‡ªä¸ºæ”¿

2. **æ•°æ®é‡‡é›†æ»å**
   - é—¨åº—æ•°æ®T+1æ‰èƒ½æ±‡æ€»ï¼Œé”™è¿‡æœ€ä½³è°ƒæ•´æ—¶æœº
   - å„ç³»ç»Ÿæ•°æ®å­¤å²›ï¼Œéœ€è¦æ‰‹å·¥æ±‡æ€»
   - å¼‚å¸¸æ•°æ®å‘ç°ä¸åŠæ—¶ï¼ŒæŸå¤±æ‰©å¤§åæ‰çŸ¥æ™“

3. **åˆ†æèƒ½åŠ›è–„å¼±**
   - åªèƒ½çœ‹ç»“æœæŒ‡æ ‡ï¼Œæ— æ³•è¿½æº¯è¿‡ç¨‹æŒ‡æ ‡
   - ç¼ºä¹å…³è”åˆ†æï¼Œä¸çŸ¥é“å½±å“é”€å”®çš„å…³é”®å› ç´ 
   - é¢„æµ‹èƒ½åŠ›ä¸è¶³ï¼Œéš¾ä»¥æå‰å¸ƒå±€

4. **æ‰§è¡Œåé¦ˆè„±èŠ‚**
   - æ€»éƒ¨ä¸‹å‘æŒ‡æ ‡åï¼Œæ— æ³•è¿½è¸ªæ‰§è¡Œæƒ…å†µ
   - é—¨åº—åé¦ˆé—®é¢˜æ¸ é“ä¸ç•…ï¼Œå“åº”æ…¢
   - ä¼˜ç§€ç»éªŒæ— æ³•å¿«é€Ÿå¤åˆ¶æ¨å¹¿

5. **æ¿€åŠ±ä½“ç³»å¤±æ•ˆ**
   - KPIè€ƒæ ¸ç»“æœä¸æ¿€åŠ±è„±èŠ‚
   - å‘˜å·¥ä¸æ¸…æ¥šè‡ªå·±çš„KPIå®Œæˆæƒ…å†µ
   - ç¼ºä¹åŠæ—¶çš„æ­£å‘æ¿€åŠ±æœºåˆ¶

### 2.3 ä¸šåŠ¡ç›®æ ‡

1. **å»ºç«‹ç»Ÿä¸€KPIä½“ç³»**
   - æ„å»ºè¦†ç›–å…¨æ¸ é“çš„5çº§KPIæŒ‡æ ‡ä½“ç³»ï¼ˆé›†å›¢-åŒºåŸŸ-é—¨åº—-å“ç±»-å‘˜å·¥ï¼‰
   - å®šä¹‰300+æ ‡å‡†åŒ–KPIï¼Œç»Ÿä¸€è®¡ç®—å£å¾„
   - å»ºç«‹KPIå…³è”æ¨¡å‹ï¼Œè¯†åˆ«å…³é”®é©±åŠ¨å› ç´ 

2. **å®ç°å®æ—¶æ•°æ®é‡‡é›†**
   - é—¨åº—æ•°æ®ä»T+1ç¼©çŸ­è‡³å°æ—¶çº§æ›´æ–°
   - å…³é”®æŒ‡æ ‡å®ç°åˆ†é’Ÿçº§å®æ—¶ç›‘æ§
   - å»ºç«‹ç»Ÿä¸€æ•°æ®å¹³å°ï¼Œæ¶ˆé™¤ä¿¡æ¯å­¤å²›

3. **æ„å»ºæ™ºèƒ½åˆ†æèƒ½åŠ›**
   - å»ºç«‹KPIå…³è”åˆ†ææ¨¡å‹ï¼Œè¯†åˆ«å› æœé“¾
   - å®ç°é”€å”®é¢„æµ‹å‡†ç¡®ç‡>85%
   - æ”¯æŒå¤šç»´åº¦é’»å–åˆ†æ

4. **æ‰“é€šæ‰§è¡Œé—­ç¯**
   - å»ºç«‹æŒ‡æ ‡-ä»»åŠ¡-æ‰§è¡Œçš„é—­ç¯ç®¡ç†
   - å®ç°é—®é¢˜è‡ªåŠ¨æ´¾å•å’Œè·Ÿè¸ª
   - æ”¯æŒæœ€ä½³å®è·µçš„å¿«é€Ÿå¤åˆ¶

5. **ä¼˜åŒ–æ¿€åŠ±æœºåˆ¶**
   - å®ç°KPIå®æ—¶å¯è§†åŒ–ï¼Œå‘˜å·¥éšæ—¶å¯æŸ¥
   - å»ºç«‹å³æ—¶æ¿€åŠ±æœºåˆ¶ï¼Œæé«˜å‘˜å·¥ç§¯ææ€§
   - æ”¯æŒä¸ªæ€§åŒ–ç›®æ ‡è®¾å®š

### 2.4 æŠ€æœ¯æŒ‘æˆ˜

1. **æµ·é‡æ•°æ®å®æ—¶å¤„ç†**
   - æ—¥å‡äº¤æ˜“æ•°æ®è¶…è¿‡500ä¸‡æ¡
   - éœ€è¦æ”¯æŒ10,000+æŒ‡æ ‡çš„å®æ—¶è®¡ç®—
   - å³°å€¼å¹¶å‘æŸ¥è¯¢éœ€æ”¯æŒQPS>1000

2. **å¤æ‚KPIè®¡ç®—é€»è¾‘**
   - åŒåº—åŒæ¯”ã€åªæ•ˆã€äººæ•ˆç­‰å¤æ‚è®¡ç®—
   - éœ€è¦æ”¯æŒå¤šç»´åº¦èšåˆå’Œä¸‹é’»
   - æ—¶é—´åºåˆ—åˆ†æå’Œé¢„æµ‹

3. **æ•°æ®è´¨é‡ä¿éšœ**
   - å¤šæºæ•°æ®çš„ä¸€è‡´æ€§æ ¡éªŒ
   - å¼‚å¸¸æ•°æ®çš„è‡ªåŠ¨è¯†åˆ«å’Œæ¸…æ´—
   - æ•°æ®è¡€ç¼˜è¿½è¸ª

4. **å®æ—¶é¢„è­¦æœºåˆ¶**
   - æ”¯æŒå¤šå±‚çº§ã€å¤šæ¡ä»¶çš„é¢„è­¦è§„åˆ™
   - æ™ºèƒ½é˜ˆå€¼åŠ¨æ€è°ƒæ•´
   - å¤šæ¸ é“é€šçŸ¥ï¼ˆé’‰é’‰/ä¼å¾®/çŸ­ä¿¡ï¼‰

5. **é«˜æ€§èƒ½æŸ¥è¯¢å“åº”**
   - å¤æ‚æŸ¥è¯¢å“åº”æ—¶é—´<3ç§’
   - æ”¯æŒç™¾ä¸‡çº§æ•°æ®çš„èšåˆåˆ†æ
   - é«˜å¹¶å‘åœºæ™¯ä¸‹çš„ç¨³å®šæ€§

### 2.5 è§£å†³æ–¹æ¡ˆ

**æŠ€æœ¯æ¶æ„**ï¼š
- æ•°æ®é‡‡é›†å±‚ï¼šFlume + Kafkaå®æ—¶é‡‡é›†
- æ•°æ®å­˜å‚¨å±‚ï¼šClickHouse + Redis + Elasticsearch
- è®¡ç®—å¼•æ“å±‚ï¼šPython + Apache Flinkå®æ—¶è®¡ç®—
- åº”ç”¨æœåŠ¡å±‚ï¼šSpring Cloudå¾®æœåŠ¡æ¶æ„
- å‰ç«¯å±•ç¤ºå±‚ï¼šReact + Ant Design + ECharts

### 2.6 å®Œæ•´ä»£ç å®ç°

```python
#!/usr/bin/env python3
"""
KPIç®¡ç†Schemaå®Œæ•´å®ç°
ä¹è´­è¿é”å…¨æ¸ é“KPIç®¡ç†ç³»ç»Ÿ
"""

from typing import Dict, List, Optional, Tuple, Any, Callable
from datetime import date, datetime, timedelta
from decimal import Decimal
from dataclasses import dataclass, field, asdict
from enum import Enum
import json
import statistics
from collections import defaultdict
import hashlib
import threading
import time
from abc import ABC, abstractmethod


class KPICategory(str, Enum):
    """KPIç±»åˆ«"""
    SALES = "Sales"                    # é”€å”®ç±»
    PROFIT = "Profit"                  # åˆ©æ¶¦ç±»
    CUSTOMER = "Customer"              # å®¢æˆ·ç±»
    OPERATION = "Operation"            # è¿è¥ç±»
    INVENTORY = "Inventory"            # åº“å­˜ç±»
    EMPLOYEE = "Employee"              # å‘˜å·¥ç±»


class CalculationFrequency(str, Enum):
    """è®¡ç®—é¢‘ç‡"""
    REAL_TIME = "RealTime"             # å®æ—¶
    MINUTE = "Minute"                  # åˆ†é’Ÿ
    HOURLY = "Hourly"                  # å°æ—¶
    DAILY = "Daily"                    # æ—¥
    WEEKLY = "Weekly"                  # å‘¨
    MONTHLY = "Monthly"                # æœˆ
    QUARTERLY = "Quarterly"            # å­£åº¦
    YEARLY = "Yearly"                  # å¹´


class AlertLevel(str, Enum):
    """é¢„è­¦çº§åˆ«"""
    INFO = "Info"
    WARNING = "Warning"
    CRITICAL = "Critical"
    EMERGENCY = "Emergency"


class ComparisonType(str, Enum):
    """å¯¹æ¯”ç±»å‹"""
    TARGET = "Target"                  # ä¸ç›®æ ‡å¯¹æ¯”
    LAST_PERIOD = "LastPeriod"         # ä¸ä¸ŠæœŸå¯¹æ¯”
    LAST_YEAR = "LastYear"             # ä¸å»å¹´åŒæœŸå¯¹æ¯”
    BENCHMARK = "Benchmark"            # ä¸æ ‡æ†å¯¹æ¯”


@dataclass
class KPITarget:
    """KPIç›®æ ‡å®šä¹‰"""
    target_id: str
    kpi_id: str
    target_value: Decimal
    target_period_start: date
    target_period_end: date
    target_type: str = "Absolute"      # Absolute/Percentage/Growth
    owner_id: str = ""                 # è´£ä»»äºº
    owner_name: str = ""               # è´£ä»»äººå§“å
    created_at: datetime = field(default_factory=datetime.now)
    
    def is_achieved(self, actual_value: Decimal) -> bool:
        """æ£€æŸ¥æ˜¯å¦è¾¾æˆç›®æ ‡"""
        return actual_value >= self.target_value


@dataclass
class KPIValue:
    """KPIæ•°å€¼"""
    value_id: str
    kpi_id: str
    dimension_values: Dict[str, str]   # ç»´åº¦å€¼ï¼Œå¦‚{'region': 'åä¸œ', 'store': '001'}
    period_start: date
    period_end: date
    value: Decimal
    target_value: Optional[Decimal] = None
    last_period_value: Optional[Decimal] = None
    last_year_value: Optional[Decimal] = None
    calculated_at: datetime = field(default_factory=datetime.now)
    
    @property
    def achievement_rate(self) -> Decimal:
        """è¾¾æˆç‡"""
        if self.target_value and self.target_value > 0:
            return (self.value / self.target_value) * Decimal('100')
        return Decimal('0')
    
    @property
    def mom_growth(self) -> Optional[Decimal]:
        """ç¯æ¯”å¢é•¿ç‡"""
        if self.last_period_value and self.last_period_value > 0:
            return ((self.value - self.last_period_value) / self.last_period_value) * Decimal('100')
        return None
    
    @property
    def yoy_growth(self) -> Optional[Decimal]:
        """åŒæ¯”å¢é•¿ç‡"""
        if self.last_year_value and self.last_year_value > 0:
            return ((self.value - self.last_year_value) / self.last_year_value) * Decimal('100')
        return None


@dataclass
class KPIDefinition:
    """KPIå®šä¹‰"""
    kpi_id: str
    kpi_name: str
    kpi_description: str
    kpi_category: KPICategory
    calculation_formula: str           # è®¡ç®—å…¬å¼
    data_source: str                   # æ•°æ®æº
    unit: str                          # å•ä½
    frequency: CalculationFrequency
    dimensions: List[str]              # æ”¯æŒçš„åˆ†æç»´åº¦
    decimals: int = 2                  # å°æ•°ä½æ•°
    is_positive_indicator: bool = True # æ˜¯å¦æ­£å‘æŒ‡æ ‡ï¼ˆè¶Šå¤§è¶Šå¥½ï¼‰
    enabled: bool = True
    created_at: datetime = field(default_factory=datetime.now)
    
    def calculate(self, raw_data: Dict[str, Any]) -> Decimal:
        """æ ¹æ®å…¬å¼è®¡ç®—KPIå€¼"""
        try:
            # è¿™é‡Œç®€åŒ–å®ç°ï¼Œå®é™…åº”è¯¥ç”¨å®‰å…¨çš„è¡¨è¾¾å¼å¼•æ“
            if "SUM" in self.calculation_formula:
                field = self.calculation_formula.split("(")[1].split(")")[0]
                values = raw_data.get(field, [])
                return Decimal(str(sum(values))) if values else Decimal('0')
            elif "AVG" in self.calculation_formula:
                field = self.calculation_formula.split("(")[1].split(")")[0]
                values = raw_data.get(field, [])
                return Decimal(str(statistics.mean(values))) if values else Decimal('0')
            else:
                return Decimal('0')
        except Exception as e:
            print(f"Error calculating KPI {self.kpi_id}: {e}")
            return Decimal('0')


@dataclass
class AlertRule:
    """é¢„è­¦è§„åˆ™"""
    rule_id: str
    kpi_id: str
    rule_name: str
    alert_level: AlertLevel
    condition: str                     # æ¡ä»¶è¡¨è¾¾å¼ï¼Œå¦‚ "achievement_rate < 80"
    notification_channels: List[str]   # é€šçŸ¥æ¸ é“
    recipients: List[str]              # æ¥æ”¶äºº
    is_enabled: bool = True
    cooldown_minutes: int = 30         # å†·å´æ—¶é—´ï¼Œé¿å…é¢‘ç¹å‘Šè­¦
    
    def check_condition(self, kpi_value: KPIValue) -> bool:
        """æ£€æŸ¥æ˜¯å¦è§¦å‘é¢„è­¦"""
        try:
            # æ„å»ºè¯„ä¼°ä¸Šä¸‹æ–‡
            context = {
                'value': float(kpi_value.value),
                'target': float(kpi_value.target_value) if kpi_value.target_value else 0,
                'achievement_rate': float(kpi_value.achievement_rate),
                'mom': float(kpi_value.mom_growth) if kpi_value.mom_growth else 0,
                'yoy': float(kpi_value.yoy_growth) if kpi_value.yoy_growth else 0
            }
            # ä½¿ç”¨å®‰å…¨çš„è¡¨è¾¾å¼è¯„ä¼°
            return eval(self.condition, {"__builtins__": {}}, context)
        except:
            return False


@dataclass
class KPIAlert:
    """KPIé¢„è­¦è®°å½•"""
    alert_id: str
    rule_id: str
    kpi_id: str
    kpi_name: str
    alert_level: AlertLevel
    alert_message: str
    kpi_value: Decimal
    triggered_at: datetime
    acknowledged: bool = False
    acknowledged_by: Optional[str] = None


class KPIDataProcessor(ABC):
    """KPIæ•°æ®å¤„ç†å™¨æŠ½è±¡åŸºç±»"""
    
    @abstractmethod
    def process(self, raw_data: Any) -> Decimal:
        pass


class RetailKPIProcessor(KPIDataProcessor):
    """é›¶å”®KPIå¤„ç†å™¨"""
    
    def process(self, raw_data: Any) -> Decimal:
        """å¤„ç†é›¶å”®KPIæ•°æ®"""
        pass


class KPIManager:
    """KPIç®¡ç†å™¨"""
    
    def __init__(self):
        self.kpi_definitions: Dict[str, KPIDefinition] = {}
        self.kpi_targets: Dict[str, KPITarget] = {}
        self.kpi_values: Dict[str, List[KPIValue]] = defaultdict(list)
        self.alert_rules: Dict[str, AlertRule] = {}
        self.alerts: List[KPIAlert] = []
        self._lock = threading.Lock()
    
    def register_kpi(self, kpi_def: KPIDefinition):
        """æ³¨å†ŒKPIå®šä¹‰"""
        self.kpi_definitions[kpi_def.kpi_id] = kpi_def
    
    def set_target(self, target: KPITarget):
        """è®¾ç½®KPIç›®æ ‡"""
        self.kpi_targets[target.kpi_id] = target
    
    def record_value(self, kpi_value: KPIValue):
        """è®°å½•KPIå€¼"""
        with self._lock:
            self.kpi_values[kpi_value.kpi_id].append(kpi_value)
        
        # æ£€æŸ¥é¢„è­¦è§„åˆ™
        self._check_alerts(kpi_value)
    
    def add_alert_rule(self, rule: AlertRule):
        """æ·»åŠ é¢„è­¦è§„åˆ™"""
        self.alert_rules[rule.rule_id] = rule
    
    def _check_alerts(self, kpi_value: KPIValue):
        """æ£€æŸ¥æ˜¯å¦è§¦å‘é¢„è­¦"""
        for rule in self.alert_rules.values():
            if rule.kpi_id == kpi_value.kpi_id and rule.is_enabled:
                if rule.check_condition(kpi_value):
                    kpi_def = self.kpi_definitions.get(kpi_value.kpi_id)
                    alert = KPIAlert(
                        alert_id=self._generate_alert_id(),
                        rule_id=rule.rule_id,
                        kpi_id=kpi_value.kpi_id,
                        kpi_name=kpi_def.kpi_name if kpi_def else kpi_value.kpi_id,
                        alert_level=rule.alert_level,
                        alert_message=f"KPI {kpi_def.kpi_name if kpi_def else kpi_value.kpi_id} "
                                     f"è§¦å‘{rule.alert_level.value}é¢„è­¦ï¼Œ"
                                     f"å½“å‰å€¼{kpi_value.value}ï¼Œè¾¾æˆç‡{kpi_value.achievement_rate:.1f}%",
                        kpi_value=kpi_value.value,
                        triggered_at=datetime.now()
                    )
                    self.alerts.append(alert)
                    self._send_notification(alert, rule)
    
    def _generate_alert_id(self) -> str:
        """ç”Ÿæˆé¢„è­¦ID"""
        timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
        random_str = hashlib.md5(str(time.time()).encode()).hexdigest()[:6]
        return f"ALT-{timestamp}-{random_str}"
    
    def _send_notification(self, alert: KPIAlert, rule: AlertRule):
        """å‘é€é€šçŸ¥"""
        # å®é™…å®ç°ä¼šè°ƒç”¨é’‰é’‰/ä¼å¾®/çŸ­ä¿¡ç­‰API
        print(f"[{alert.alert_level.value}] {alert.alert_message}")
        print(f"é€šçŸ¥æ¸ é“: {', '.join(rule.notification_channels)}")
        print(f"æ¥æ”¶äºº: {', '.join(rule.recipients)}")
    
    def get_kpi_trend(self, kpi_id: str, periods: int = 12) -> List[Dict]:
        """è·å–KPIè¶‹åŠ¿"""
        values = sorted(self.kpi_values.get(kpi_id, []), 
                       key=lambda x: x.period_start)
        
        return [
            {
                'period': v.period_start.isoformat(),
                'value': float(v.value),
                'target': float(v.target_value) if v.target_value else None,
                'achievement_rate': float(v.achievement_rate),
                'mom': float(v.mom_growth) if v.mom_growth else None,
                'yoy': float(v.yoy_growth) if v.yoy_growth else None
            }
            for v in values[-periods:]
        ]
    
    def get_kpi_summary(self, kpi_id: str) -> Dict:
        """è·å–KPIæ‘˜è¦"""
        kpi_def = self.kpi_definitions.get(kpi_id)
        target = self.kpi_targets.get(kpi_id)
        values = self.kpi_values.get(kpi_id, [])
        
        if not values:
            return {'kpi_id': kpi_id, 'status': 'No_Data'}
        
        latest_value = max(values, key=lambda x: x.period_end)
        
        # è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
        all_values = [float(v.value) for v in values]
        
        return {
            'kpi_id': kpi_id,
            'kpi_name': kpi_def.kpi_name if kpi_def else kpi_id,
            'category': kpi_def.kpi_category.value if kpi_def else None,
            'current_value': float(latest_value.value),
            'target_value': float(target.target_value) if target else None,
            'achievement_rate': float(latest_value.achievement_rate),
            'mom_growth': float(latest_value.mom_growth) if latest_value.mom_growth else None,
            'yoy_growth': float(latest_value.yoy_growth) if latest_value.yoy_growth else None,
            'statistics': {
                'avg': statistics.mean(all_values),
                'min': min(all_values),
                'max': max(all_values),
                'std': statistics.stdev(all_values) if len(all_values) > 1 else 0
            },
            'alert_count': len([a for a in self.alerts if a.kpi_id == kpi_id])
        }
    
    def get_dashboard(self, category: Optional[KPICategory] = None) -> Dict:
        """è·å–ä»ªè¡¨æ¿æ•°æ®"""
        kpis = self.kpi_definitions.values()
        if category:
            kpis = [k for k in kpis if k.kpi_category == category]
        
        summary = {
            'total_kpis': len(kpis),
            'by_category': defaultdict(int),
            'achievement_distribution': {
                'excellent': 0,    # >=100%
                'good': 0,         # 80-100%
                'warning': 0,      # 60-80%
                'critical': 0      # <60%
            },
            'active_alerts': len([a for a in self.alerts if not a.acknowledged]),
            'kpi_details': []
        }
        
        for kpi in kpis:
            summary['by_category'][kpi.kpi_category.value] += 1
            kpi_summary = self.get_kpi_summary(kpi.kpi_id)
            
            if 'achievement_rate' in kpi_summary:
                rate = kpi_summary['achievement_rate']
                if rate >= 100:
                    summary['achievement_distribution']['excellent'] += 1
                elif rate >= 80:
                    summary['achievement_distribution']['good'] += 1
                elif rate >= 60:
                    summary['achievement_distribution']['warning'] += 1
                else:
                    summary['achievement_distribution']['critical'] += 1
            
            summary['kpi_details'].append(kpi_summary)
        
        return dict(summary)
    
    def export_to_olap_cube(self) -> Dict:
        """å¯¼å‡ºåˆ°OLAP Cubeæ ¼å¼"""
        facts = []
        
        for kpi_id, values in self.kpi_values.items():
            kpi_def = self.kpi_definitions.get(kpi_id)
            for v in values:
                fact = {
                    'kpi_id': kpi_id,
                    'kpi_name': kpi_def.kpi_name if kpi_def else kpi_id,
                    'category': kpi_def.kpi_category.value if kpi_def else None,
                    'period': v.period_start.isoformat(),
                    'value': float(v.value),
                    'target': float(v.target_value) if v.target_value else None,
                    'achievement_rate': float(v.achievement_rate)
                }
                fact.update(v.dimension_values)
                facts.append(fact)
        
        return {
            'dimensions': ['time', 'region', 'store', 'category', 'kpi'],
            'measures': ['value', 'target', 'achievement_rate'],
            'facts': facts
        }


def create_retail_kpi_example():
    """åˆ›å»ºé›¶å”®KPIç¤ºä¾‹"""
    manager = KPIManager()
    
    # === é”€å”®ç±»KPI ===
    sales_kpi = KPIDefinition(
        kpi_id="KPI-SALES-001",
        kpi_name="é”€å”®é¢",
        kpi_description="å…¨æ¸ é“é”€å”®æ€»é¢",
        kpi_category=KPICategory.SALES,
        calculation_formula="SUM(sales_amount)",
        data_source="POSç³»ç»Ÿ+ç”µå•†å¹³å°",
        unit="å…ƒ",
        frequency=CalculationFrequency.DAILY,
        dimensions=['region', 'store', 'channel', 'category', 'brand']
    )
    manager.register_kpi(sales_kpi)
    
    # é”€å”®ç›®æ ‡
    sales_target = KPITarget(
        target_id="TGT-SALES-001",
        kpi_id="KPI-SALES-001",
        target_value=Decimal('50000000'),  # æ—¥ç›®æ ‡5000ä¸‡
        target_period_start=date(2025, 1, 1),
        target_period_end=date(2025, 12, 31),
        owner_id="M001",
        owner_name="å¼ ç»ç†"
    )
    manager.set_target(sales_target)
    
    # === å®¢æˆ·ç±»KPI ===
    customer_kpi = KPIDefinition(
        kpi_id="KPI-CUST-001",
        kpi_name="ä¼šå‘˜å¤è´­ç‡",
        kpi_description="ä¼šå‘˜å®¢æˆ·å¤è´­æ¯”ä¾‹",
        kpi_category=KPICategory.CUSTOMER,
        calculation_formula="AVG(repurchase_rate)",
        data_source="CRMç³»ç»Ÿ",
        unit="%",
        frequency=CalculationFrequency.MONTHLY,
        dimensions=['region', 'store', 'member_level']
    )
    manager.register_kpi(customer_kpi)
    
    # å¤è´­ç‡ç›®æ ‡
    customer_target = KPITarget(
        target_id="TGT-CUST-001",
        kpi_id="KPI-CUST-001",
        target_value=Decimal('45'),  # ç›®æ ‡45%
        target_period_start=date(2025, 1, 1),
        target_period_end=date(2025, 12, 31),
        owner_id="M002",
        owner_name="æç»ç†"
    )
    manager.set_target(customer_target)
    
    # === è¿è¥ç±»KPI ===
    operation_kpi = KPIDefinition(
        kpi_id="KPI-OPS-001",
        kpi_name="åªæ•ˆ",
        kpi_description="æ¯å¹³æ–¹ç±³é”€å”®é¢",
        kpi_category=KPICategory.OPERATION,
        calculation_formula="SUM(sales_amount)/SUM(store_area)",
        data_source="POSç³»ç»Ÿ+é—¨åº—ç³»ç»Ÿ",
        unit="å…ƒ/å¹³ç±³/å¤©",
        frequency=CalculationFrequency.DAILY,
        dimensions=['region', 'store', 'store_type']
    )
    manager.register_kpi(operation_kpi)
    
    # === åº“å­˜ç±»KPI ===
    inventory_kpi = KPIDefinition(
        kpi_id="KPI-INV-001",
        kpi_name="åº“å­˜å‘¨è½¬å¤©æ•°",
        kpi_description="åº“å­˜å¹³å‡å‘¨è½¬å¤©æ•°",
        kpi_category=KPICategory.INVENTORY,
        calculation_formula="AVG(inventory_days)",
        data_source="ERPç³»ç»Ÿ",
        unit="å¤©",
        frequency=CalculationFrequency.WEEKLY,
        dimensions=['region', 'warehouse', 'category'],
        is_positive_indicator=False  # è¶Šå°è¶Šå¥½
    )
    manager.register_kpi(inventory_kpi)
    
    # === æ·»åŠ é¢„è­¦è§„åˆ™ ===
    alert_rule = AlertRule(
        rule_id="RULE-001",
        kpi_id="KPI-SALES-001",
        rule_name="é”€å”®é¢é¢„è­¦",
        alert_level=AlertLevel.WARNING,
        condition="achievement_rate < 80",
        notification_channels=["é’‰é’‰", "çŸ­ä¿¡"],
        recipients=["zhang@legou.com", "manager@legou.com"]
    )
    manager.add_alert_rule(alert_rule)
    
    # === æ¨¡æ‹ŸKPIæ•°æ® ===
    for day in range(1, 31):  # 30å¤©æ•°æ®
        sales_value = KPIValue(
            value_id=f"VAL-SALES-202501{day:02d}",
            kpi_id="KPI-SALES-001",
            dimension_values={'region': 'åä¸œ', 'store': '001', 'channel': 'çº¿ä¸‹'},
            period_start=date(2025, 1, day),
            period_end=date(2025, 1, day),
            value=Decimal(str(45000000 + (day % 10) * 1000000)),  # 4500-5400ä¸‡
            target_value=Decimal('50000000'),
            last_period_value=Decimal('42000000'),
            last_year_value=Decimal('38000000')
        )
        manager.record_value(sales_value)
    
    return manager


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == '__main__':
    # åˆ›å»ºKPIç®¡ç†å™¨
    manager = create_retail_kpi_example()
    
    # æ‰“å°ä»ªè¡¨æ¿
    dashboard = manager.get_dashboard()
    print("=" * 60)
    print("ã€ä¹è´­è¿é”KPIä»ªè¡¨æ¿ã€‘")
    print("=" * 60)
    print(f"\nğŸ“Š KPIæ€»æ•°: {dashboard['total_kpis']}")
    print(f"ğŸ“ˆ æŒ‰ç±»åˆ«åˆ†å¸ƒ: {dict(dashboard['by_category'])}")
    print(f"\nğŸ¯ è¾¾æˆç‡åˆ†å¸ƒ:")
    for level, count in dashboard['achievement_distribution'].items():
        print(f"   â€¢ {level}: {count}ä¸ª")
    print(f"\nâš ï¸ æ´»è·ƒé¢„è­¦: {dashboard['active_alerts']}ä¸ª")
    
    # æ‰“å°è¯¦ç»†KPI
    print("\nğŸ“‹ KPIè¯¦æƒ…:")
    for kpi_detail in dashboard['kpi_details']:
        print(f"\n   ã€{kpi_detail['kpi_name']}ã€‘")
        print(f"   å½“å‰å€¼: {kpi_detail['current_value']:,.0f} "
              f"(ç›®æ ‡: {kpi_detail['target_value']:,.0f})")
        print(f"   è¾¾æˆç‡: {kpi_detail['achievement_rate']:.1f}%")
        if kpi_detail['yoy_growth']:
            print(f"   åŒæ¯”å¢é•¿: {kpi_detail['yoy_growth']:+.1f}%")
    
    print("\n" + "=" * 60)
```

### 2.7 æ•ˆæœè¯„ä¼°ä¸ROI

**å…³é”®ç»©æ•ˆæŒ‡æ ‡æ”¹è¿›**ï¼š

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| æ•°æ®é‡‡é›†æ—¶æ•ˆ | T+1 | å°æ—¶çº§ | 90%æå‡ |
| KPIè®¡ç®—å‡†ç¡®ç‡ | 85% | 99.5% | +14.5% |
| å¼‚å¸¸å“åº”æ—¶é—´ | 24å°æ—¶ | 15åˆ†é’Ÿ | 96%æå‡ |
| é”€å”®é¢„æµ‹å‡†ç¡®ç‡ | 65% | 88% | +23% |
| é—¨åº—è¿è¥æ•ˆç‡ | åŸºå‡† | +32% | æ˜¾è‘—æå‡ |
| åº“å­˜å‘¨è½¬å¤©æ•° | 45å¤© | 32å¤© | -29% |

**ä¸šåŠ¡ä»·å€¼**ï¼š

1. **è¿è¥æ•ˆç‡å¤§å¹…æå‡**
   - é—¨åº—æ—¥ç»“æ—¶é—´ä»4å°æ—¶ç¼©çŸ­è‡³30åˆ†é’Ÿ
   - å¼‚å¸¸é—®é¢˜å‘ç°æ—¶é—´ä»1å¤©ç¼©çŸ­è‡³15åˆ†é’Ÿ
   - å†³ç­–å“åº”é€Ÿåº¦æå‡3å€

2. **é”€å”®ä¸šç»©å¢é•¿**
   - é€šè¿‡ç²¾å‡†é¢„æµ‹ï¼Œç¼ºè´§ç‡é™ä½40%
   - ä¿ƒé”€æ•ˆæœè¯„ä¼°å‡†ç¡®ç‡æå‡è‡³90%
   - å…¨å¹´é”€å”®é¢åŒæ¯”å¢é•¿23%

3. **æˆæœ¬ä¼˜åŒ–**
   - åº“å­˜å‘¨è½¬å¤©æ•°å‡å°‘13å¤©ï¼Œé‡Šæ”¾èµ„é‡‘2.8äº¿å…ƒ
   - äººå·¥æ•°æ®ç»Ÿè®¡å·¥ä½œé‡å‡å°‘70%
   - ç³»ç»Ÿè¿ç»´æˆæœ¬é™ä½35%

**ROIè®¡ç®—**ï¼š

```
é¡¹ç›®æŠ•èµ„ï¼š420ä¸‡å…ƒ
  - è½¯ä»¶å¼€å‘ï¼š220ä¸‡å…ƒ
  - ç¡¬ä»¶è®¾å¤‡ï¼š100ä¸‡å…ƒ
  - å®æ–½å’¨è¯¢ï¼š100ä¸‡å…ƒ

å¹´åº¦æ”¶ç›Šï¼š2,150ä¸‡å…ƒ
  - é”€å”®å¢é•¿è´¡çŒ®ï¼š980ä¸‡å…ƒ
  - åº“å­˜ä¼˜åŒ–æ”¶ç›Šï¼š720ä¸‡å…ƒ
  - æ•ˆç‡æå‡èŠ‚çº¦ï¼š450ä¸‡å…ƒ

ç¬¬ä¸€å¹´ROI = (2,150 - 420) / 420 = 412%
ä¸‰å¹´ç´¯è®¡ROI = 1,287%
```

---

## 3. æ¡ˆä¾‹2ï¼šKPIåˆ°OLAP Cubeè½¬æ¢

```python
def convert_kpi_to_olap_cube(kpi_manager: KPIManager) -> Dict:
    """å°†KPIæ•°æ®è½¬æ¢ä¸ºOLAP Cubeæ ¼å¼"""
    cube = {
        'name': 'Retail_KPI_Cube',
        'dimensions': [
            {'name': 'Time', 'hierarchies': ['Year', 'Quarter', 'Month', 'Day']},
            {'name': 'Region', 'hierarchies': ['Country', 'Province', 'City', 'Store']},
            {'name': 'Product', 'hierarchies': ['Category', 'Subcategory', 'SKU']},
            {'name': 'Channel', 'attributes': ['Online', 'Offline', 'Mobile']},
            {'name': 'KPI', 'attributes': ['KPI_ID', 'KPI_Name', 'Category']}
        ],
        'measures': [
            {'name': 'Value', 'aggregation': 'SUM'},
            {'name': 'Target', 'aggregation': 'SUM'},
            {'name': 'Achievement_Rate', 'aggregation': 'AVG'},
            {'name': 'YoY_Growth', 'aggregation': 'AVG'}
        ],
        'facts': kpi_manager.export_to_olap_cube()['facts']
    }
    return cube
```

---

## 4. æ¡ˆä¾‹3ï¼šå®æ—¶KPIé¢„è­¦ç³»ç»Ÿ

```python
class RealTimeKPIAlertEngine:
    """å®æ—¶KPIé¢„è­¦å¼•æ“"""
    
    def __init__(self, kpi_manager: KPIManager):
        self.kpi_manager = kpi_manager
        self.running = False
        self.alert_handlers = []
    
    def add_alert_handler(self, handler: Callable):
        """æ·»åŠ é¢„è­¦å¤„ç†å™¨"""
        self.alert_handlers.append(handler)
    
    def start_monitoring(self, interval_seconds: int = 60):
        """å¯åŠ¨ç›‘æ§"""
        self.running = True
        while self.running:
            self._check_all_kpis()
            time.sleep(interval_seconds)
    
    def _check_all_kpis(self):
        """æ£€æŸ¥æ‰€æœ‰KPI"""
        for kpi_id in self.kpi_manager.kpi_definitions.keys():
            values = self.kpi_manager.kpi_values.get(kpi_id, [])
            if values:
                latest = max(values, key=lambda x: x.period_end)
                self._check_thresholds(kpi_id, latest)
    
    def _check_thresholds(self, kpi_id: str, value: KPIValue):
        """æ£€æŸ¥é˜ˆå€¼"""
        # å®é™…å®ç°ä¼šæ£€æŸ¥å„ç§é˜ˆå€¼æ¡ä»¶
        pass
```

---

## 5. æ¡ˆä¾‹4ï¼šKPIæ ¹å› åˆ†æå¼•æ“

```python
class KPIRootCauseAnalyzer:
    """KPIæ ¹å› åˆ†æå™¨"""
    
    def __init__(self, kpi_manager: KPIManager):
        self.kpi_manager = kpi_manager
    
    def analyze(self, kpi_id: str, period: date) -> Dict:
        """åˆ†æKPIå¼‚å¸¸æ ¹å› """
        kpi_value = self._get_kpi_value(kpi_id, period)
        if not kpi_value:
            return {'error': 'No data found'}
        
        # æ£€æŸ¥æ˜¯å¦å¼‚å¸¸
        if kpi_value.achievement_rate >= Decimal('90'):
            return {'status': 'Normal'}
        
        # åˆ†æå¯èƒ½çš„åŸå› 
        causes = []
        
        # 1. æ£€æŸ¥ç›¸å…³KPI
        related_kpis = self._get_related_kpis(kpi_id)
        for related_kpi_id in related_kpis:
            related_value = self._get_kpi_value(related_kpi_id, period)
            if related_value and related_value.achievement_rate < Decimal('80'):
                causes.append({
                    'type': 'Related_KPI',
                    'kpi_id': related_kpi_id,
                    'impact': 'High',
                    'description': f"å…³è”KPI '{related_kpi_id}' è¾¾æˆç‡ä»…ä¸º{related_value.achievement_rate:.1f}%"
                })
        
        # 2. æ£€æŸ¥å†å²è¶‹åŠ¿
        trend = self._analyze_trend(kpi_id)
        if trend == 'Declining':
            causes.append({
                'type': 'Trend',
                'impact': 'Medium',
                'description': 'KPIå‘ˆæŒç»­ä¸‹æ»‘è¶‹åŠ¿'
            })
        
        return {
            'kpi_id': kpi_id,
            'period': period.isoformat(),
            'current_value': float(kpi_value.value),
            'achievement_rate': float(kpi_value.achievement_rate),
            'status': 'Underperforming',
            'potential_causes': causes,
            'recommendations': self._generate_recommendations(causes)
        }
    
    def _analyze_trend(self, kpi_id: str) -> str:
        """åˆ†æè¶‹åŠ¿"""
        values = self.kpi_manager.get_kpi_trend(kpi_id, periods=6)
        if len(values) < 3:
            return 'Insufficient_Data'
        
        recent = [v['value'] for v in values[-3:]]
        if all(recent[i] < recent[i-1] for i in range(1, len(recent))):
            return 'Declining'
        elif all(recent[i] > recent[i-1] for i in range(1, len(recent))):
            return 'Improving'
        return 'Fluctuating'
    
    def _generate_recommendations(self, causes: List[Dict]) -> List[str]:
        """ç”Ÿæˆæ”¹è¿›å»ºè®®"""
        recommendations = []
        for cause in causes:
            if cause['type'] == 'Related_KPI':
                recommendations.append(
                    f"ä¼˜å…ˆæ”¹å–„å…³è”KPI '{cause['kpi_id']}'ï¼Œå¯èƒ½å¯¹æœ¬KPIäº§ç”Ÿæ­£å‘å½±å“"
                )
            elif cause['type'] == 'Trend':
                recommendations.append("å»ºè®®å¬å¼€ä¸“é¡¹åˆ†æä¼šï¼Œæ·±å…¥åˆ†æä¸‹æ»‘åŸå› ")
        return recommendations
```

---

## 6. æ¡ˆä¾‹5ï¼šKPIæ•°æ®æ¹–å­˜å‚¨ä¸åˆ†æç³»ç»Ÿ

```python
class KPIDataLake:
    """KPIæ•°æ®æ¹–"""
    
    def __init__(self, storage_config: Dict):
        self.storage_config = storage_config
    
    def store_raw_data(self, source: str, data: List[Dict]):
        """å­˜å‚¨åŸå§‹æ•°æ®"""
        # å®é™…å®ç°ä¼šå°†æ•°æ®å†™å…¥S3/HDFSç­‰å­˜å‚¨
        pass
    
    def store_processed_kpi(self, kpi_values: List[KPIValue]):
        """å­˜å‚¨å¤„ç†åçš„KPIæ•°æ®"""
        # å†™å…¥æ•°æ®ä»“åº“
        pass
    
    def query_kpi_history(self, kpi_id: str, 
                         start_date: date, 
                         end_date: date,
                         dimensions: Optional[Dict] = None) -> List[KPIValue]:
        """æŸ¥è¯¢KPIå†å²æ•°æ®"""
        # å®é™…å®ç°ä¼šæŸ¥è¯¢æ•°æ®ä»“åº“
        pass
```

---

**å‚è€ƒæ–‡æ¡£**ï¼š

- `01_Overview.md` - æ¦‚è¿°
- `02_Formal_Definition.md` - å½¢å¼åŒ–å®šä¹‰
- `03_Standards.md` - æ ‡å‡†å¯¹æ ‡
- `04_Transformation.md` - è½¬æ¢ä½“ç³»

**åˆ›å»ºæ—¶é—´**ï¼š2025-01-21
**æœ€åæ›´æ–°**ï¼š2025-02-15
