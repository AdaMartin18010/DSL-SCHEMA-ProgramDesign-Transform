# åº”æ”¶åº”ä»˜Schemaå®è·µæ¡ˆä¾‹

## ğŸ“‘ ç›®å½•

- [åº”æ”¶åº”ä»˜Schemaå®è·µæ¡ˆä¾‹](#åº”æ”¶åº”ä»˜schemaå®è·µæ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¡ˆä¾‹æ¦‚è¿°](#1-æ¡ˆä¾‹æ¦‚è¿°)
  - [2. æ¡ˆä¾‹1ï¼šä¼ä¸šåº”æ”¶è´¦æ¬¾ç®¡ç†ç³»ç»Ÿ](#2-æ¡ˆä¾‹1ä¼ä¸šåº”æ”¶è´¦æ¬¾ç®¡ç†ç³»ç»Ÿ)
    - [2.1 ä¸šåŠ¡èƒŒæ™¯](#21-ä¸šåŠ¡èƒŒæ™¯)
    - [2.2 æŠ€æœ¯æŒ‘æˆ˜](#22-æŠ€æœ¯æŒ‘æˆ˜)
    - [2.3 è§£å†³æ–¹æ¡ˆ](#23-è§£å†³æ–¹æ¡ˆ)
    - [2.4 å®Œæ•´ä»£ç å®ç°](#24-å®Œæ•´ä»£ç å®ç°)
    - [2.5 æ•ˆæœè¯„ä¼°](#25-æ•ˆæœè¯„ä¼°)
  - [3. æ¡ˆä¾‹2ï¼šåº”ä»˜è´¦æ¬¾ç®¡ç†](#3-æ¡ˆä¾‹2åº”ä»˜è´¦æ¬¾ç®¡ç†)
    - [3.1 åœºæ™¯æè¿°](#31-åœºæ™¯æè¿°)
    - [3.2 Schemaå®šä¹‰](#32-schemaå®šä¹‰)
  - [4. æ¡ˆä¾‹3ï¼šè‡ªåŠ¨å¯¹è´¦ç³»ç»Ÿ](#4-æ¡ˆä¾‹3è‡ªåŠ¨å¯¹è´¦ç³»ç»Ÿ)
    - [4.1 åœºæ™¯æè¿°](#41-åœºæ™¯æè¿°)
    - [4.2 å®ç°ä»£ç ](#42-å®ç°ä»£ç )
  - [5. æ¡ˆä¾‹4ï¼šåº”æ”¶åº”ä»˜åˆ°æ€»è´¦è½¬æ¢](#5-æ¡ˆä¾‹4åº”æ”¶åº”ä»˜åˆ°æ€»è´¦è½¬æ¢)
    - [5.1 åœºæ™¯æè¿°](#51-åœºæ™¯æè¿°)
    - [5.2 å®ç°ä»£ç ](#52-å®ç°ä»£ç )
  - [6. æ¡ˆä¾‹5ï¼šåº”æ”¶åº”ä»˜æ•°æ®å­˜å‚¨ä¸åˆ†æç³»ç»Ÿ](#6-æ¡ˆä¾‹5åº”æ”¶åº”ä»˜æ•°æ®å­˜å‚¨ä¸åˆ†æç³»ç»Ÿ)
    - [6.1 åœºæ™¯æè¿°](#61-åœºæ™¯æè¿°)
    - [6.2 å®ç°ä»£ç ](#62-å®ç°ä»£ç )

---

## 1. æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›åº”æ”¶åº”ä»˜Schemaåœ¨å®é™…ä¼ä¸šåº”ç”¨ä¸­çš„å®è·µæ¡ˆä¾‹ï¼Œæ¶µç›–åº”æ”¶è´¦æ¬¾ç®¡ç†ã€åº”ä»˜è´¦æ¬¾ç®¡ç†ã€è‡ªåŠ¨å¯¹è´¦ç­‰çœŸå®åœºæ™¯ã€‚

**æ¡ˆä¾‹ç±»å‹**ï¼š

1. **ä¼ä¸šåº”æ”¶è´¦æ¬¾ç®¡ç†ç³»ç»Ÿ**ï¼šå®¢æˆ·ä¿¡ç”¨ã€å‘ç¥¨ã€æ”¶æ¬¾ç®¡ç†
2. **åº”ä»˜è´¦æ¬¾ç®¡ç†ç³»ç»Ÿ**ï¼šä¾›åº”å•†ã€é‡‡è´­å‘ç¥¨ã€ä»˜æ¬¾ç®¡ç†
3. **è‡ªåŠ¨å¯¹è´¦ç³»ç»Ÿ**ï¼šåº”æ”¶åº”ä»˜è‡ªåŠ¨å¯¹è´¦
4. **åº”æ”¶åº”ä»˜åˆ°æ€»è´¦è½¬æ¢å·¥å…·**ï¼šAR/APåˆ°æ€»è´¦è½¬æ¢
5. **åº”æ”¶åº”ä»˜æ•°æ®å­˜å‚¨ä¸åˆ†æç³»ç»Ÿ**ï¼šAR/APæ•°æ®åˆ†æå’Œç›‘æ§

**å‚è€ƒä¼ä¸šæ¡ˆä¾‹**ï¼š

- **åº”æ”¶è´¦æ¬¾ç®¡ç†**ï¼šCFOåº”æ”¶è´¦æ¬¾ç®¡ç†æŒ‡å—
- **ä¿¡ç”¨ç®¡ç†**ï¼šä¿¡ç”¨ç®¡ç†æœ€ä½³å®è·µ

---

## 2. æ¡ˆä¾‹1ï¼šä¼ä¸šåº”æ”¶è´¦æ¬¾ç®¡ç†ç³»ç»Ÿ

### 2.1 ä¸šåŠ¡èƒŒæ™¯

**ä¼ä¸šèƒŒæ™¯**ï¼š
æŸåˆ¶é€ ä¼ä¸šéœ€è¦æ„å»ºåº”æ”¶è´¦æ¬¾ç®¡ç†ç³»ç»Ÿï¼Œç®¡ç†å®¢æˆ·ä¿¡ç”¨ã€é”€å”®å‘ç¥¨ã€æ”¶æ¬¾å’Œå¯¹è´¦ï¼Œç¡®ä¿åº”æ”¶è´¦æ¬¾åŠæ—¶å›æ”¶ï¼Œé™ä½åè´¦é£é™©ã€‚

**ä¸šåŠ¡ç—›ç‚¹**ï¼š

1. **å®¢æˆ·ä¿¡ç”¨ç®¡ç†ç¼ºå¤±**ï¼šç¼ºä¹å®¢æˆ·ä¿¡ç”¨ç®¡ç†
2. **å‘ç¥¨ç®¡ç†æ··ä¹±**ï¼šå‘ç¥¨ç®¡ç†æ··ä¹±
3. **æ”¶æ¬¾è·Ÿè¸ªå›°éš¾**ï¼šæ”¶æ¬¾è·Ÿè¸ªå›°éš¾
4. **å¯¹è´¦æ•ˆç‡ä½**ï¼šåº”æ”¶è´¦æ¬¾å¯¹è´¦æ•ˆç‡ä½

**ä¸šåŠ¡ç›®æ ‡**ï¼š

- å»ºç«‹å®¢æˆ·ä¿¡ç”¨ç®¡ç†ä½“ç³»
- è§„èŒƒå‘ç¥¨ç®¡ç†æµç¨‹
- åŠ å¼ºæ”¶æ¬¾è·Ÿè¸ª
- æé«˜å¯¹è´¦æ•ˆç‡

### 2.2 æŠ€æœ¯æŒ‘æˆ˜

1. **ä¿¡ç”¨ç®¡ç†**ï¼šå»ºç«‹å®¢æˆ·ä¿¡ç”¨ç®¡ç†ä½“ç³»
2. **å‘ç¥¨ç®¡ç†**ï¼šè§„èŒƒå‘ç¥¨ç”Ÿæˆå’Œç®¡ç†
3. **æ”¶æ¬¾è·Ÿè¸ª**ï¼šå®ç°æ”¶æ¬¾è·Ÿè¸ªå’Œæé†’
4. **è‡ªåŠ¨å¯¹è´¦**ï¼šå®ç°åº”æ”¶è´¦æ¬¾è‡ªåŠ¨å¯¹è´¦

### 2.3 è§£å†³æ–¹æ¡ˆ

**ä½¿ç”¨Schemaå®šä¹‰åº”æ”¶è´¦æ¬¾ç®¡ç†ç³»ç»Ÿ**ï¼š

### 2.4 å®Œæ•´ä»£ç å®ç°

**åº”æ”¶è´¦æ¬¾ç®¡ç†Schemaï¼ˆå®Œæ•´ç¤ºä¾‹ï¼‰**ï¼š

```python
#!/usr/bin/env python3
"""
åº”æ”¶åº”ä»˜Schemaå®ç°
"""

from typing import Dict, List, Optional
from datetime import date, datetime, timedelta
from decimal import Decimal
from dataclasses import dataclass, field
from enum import Enum

class CreditRating(str, Enum):
    """ä¿¡ç”¨ç­‰çº§"""
    AAA = "AAA"
    AA = "AA"
    A = "A"
    BBB = "BBB"
    BB = "BB"
    B = "B"
    C = "C"

class InvoiceStatus(str, Enum):
    """å‘ç¥¨çŠ¶æ€"""
    DRAFT = "Draft"
    ISSUED = "Issued"
    PAID = "Paid"
    PARTIALLY_PAID = "PartiallyPaid"
    OVERDUE = "Overdue"
    CANCELLED = "Cancelled"

class PaymentStatus(str, Enum):
    """ä»˜æ¬¾çŠ¶æ€"""
    UNPAID = "Unpaid"
    PARTIALLY_PAID = "PartiallyPaid"
    PAID = "Paid"
    OVERDUE = "Overdue"

@dataclass
class Customer:
    """å®¢æˆ·"""
    customer_id: str
    customer_code: str
    customer_name: str
    credit_limit: Decimal
    payment_terms: str = "NET30"
    credit_rating: CreditRating = CreditRating.A
    current_balance: Decimal = Decimal('0')
    overdue_amount: Decimal = Decimal('0')

    def check_credit_limit(self, amount: Decimal) -> bool:
        """æ£€æŸ¥ä¿¡ç”¨é¢åº¦"""
        return (self.current_balance + amount) <= self.credit_limit

    @property
    def available_credit(self) -> Decimal:
        """å¯ç”¨ä¿¡ç”¨é¢åº¦"""
        return self.credit_limit - self.current_balance

@dataclass
class SalesInvoice:
    """é”€å”®å‘ç¥¨"""
    invoice_id: str
    invoice_number: str
    invoice_date: date
    customer_id: str
    due_date: date
    invoice_amount: Decimal
    tax_amount: Decimal = Decimal('0')
    total_amount: Decimal = Decimal('0')
    status: InvoiceStatus = InvoiceStatus.DRAFT
    payment_status: PaymentStatus = PaymentStatus.UNPAID
    paid_amount: Decimal = Decimal('0')
    created_at: datetime = field(default_factory=datetime.now)

    def calculate_total(self):
        """è®¡ç®—æ€»é‡‘é¢"""
        self.total_amount = self.invoice_amount + self.tax_amount

    def is_overdue(self) -> bool:
        """æ£€æŸ¥æ˜¯å¦é€¾æœŸ"""
        return date.today() > self.due_date and self.payment_status != PaymentStatus.PAID

    def record_payment(self, amount: Decimal):
        """è®°å½•ä»˜æ¬¾"""
        self.paid_amount += amount
        if self.paid_amount >= self.total_amount:
            self.payment_status = PaymentStatus.PAID
            self.status = InvoiceStatus.PAID
        elif self.paid_amount > Decimal('0'):
            self.payment_status = PaymentStatus.PARTIALLY_PAID
            self.status = InvoiceStatus.PARTIALLY_PAID

        if self.is_overdue():
            self.payment_status = PaymentStatus.OVERDUE

@dataclass
class Receipt:
    """æ”¶æ¬¾"""
    receipt_id: str
    receipt_number: str
    receipt_date: date
    customer_id: str
    invoice_id: str
    receipt_amount: Decimal
    payment_method: str = "Bank Transfer"
    reference_number: Optional[str] = None
    created_at: datetime = field(default_factory=datetime.now)

@dataclass
class AccountsReceivableManagement:
    """åº”æ”¶è´¦æ¬¾ç®¡ç†"""
    customers: Dict[str, Customer] = field(default_factory=dict)
    invoices: Dict[str, SalesInvoice] = field(default_factory=dict)
    receipts: List[Receipt] = field(default_factory=list)

    def add_customer(self, customer: Customer):
        """æ·»åŠ å®¢æˆ·"""
        self.customers[customer.customer_id] = customer

    def create_invoice(self, invoice: SalesInvoice) -> tuple[bool, str]:
        """åˆ›å»ºå‘ç¥¨"""
        if invoice.customer_id not in self.customers:
            return False, "Customer not found"

        customer = self.customers[invoice.customer_id]

        # æ£€æŸ¥ä¿¡ç”¨é¢åº¦
        if not customer.check_credit_limit(invoice.total_amount):
            return False, f"Credit limit exceeded. Available: {customer.available_credit}"

        invoice.calculate_total()
        invoice.status = InvoiceStatus.ISSUED
        self.invoices[invoice.invoice_id] = invoice

        # æ›´æ–°å®¢æˆ·ä½™é¢
        customer.current_balance += invoice.total_amount

        return True, "Invoice created successfully"

    def record_receipt(self, receipt: Receipt) -> tuple[bool, str]:
        """è®°å½•æ”¶æ¬¾"""
        if receipt.invoice_id not in self.invoices:
            return False, "Invoice not found"

        invoice = self.invoices[receipt.invoice_id]

        # è®°å½•ä»˜æ¬¾
        invoice.record_payment(receipt.receipt_amount)

        # æ›´æ–°å®¢æˆ·ä½™é¢
        if receipt.customer_id in self.customers:
            customer = self.customers[receipt.customer_id]
            customer.current_balance -= receipt.receipt_amount

        self.receipts.append(receipt)
        return True, "Receipt recorded successfully"

    def get_overdue_invoices(self) -> List[SalesInvoice]:
        """è·å–é€¾æœŸå‘ç¥¨"""
        return [inv for inv in self.invoices.values() if inv.is_overdue()]

    def get_aging_report(self) -> Dict:
        """è·å–è´¦é¾„æŠ¥å‘Š"""
        aging_buckets = {
            'current': Decimal('0'),
            '1-30_days': Decimal('0'),
            '31-60_days': Decimal('0'),
            '61-90_days': Decimal('0'),
            'over_90_days': Decimal('0')
        }

        today = date.today()
        for invoice in self.invoices.values():
            if invoice.payment_status == PaymentStatus.PAID:
                continue

            outstanding = invoice.total_amount - invoice.paid_amount
            days_overdue = (today - invoice.due_date).days

            if days_overdue <= 0:
                aging_buckets['current'] += outstanding
            elif days_overdue <= 30:
                aging_buckets['1-30_days'] += outstanding
            elif days_overdue <= 60:
                aging_buckets['31-60_days'] += outstanding
            elif days_overdue <= 90:
                aging_buckets['61-90_days'] += outstanding
            else:
                aging_buckets['over_90_days'] += outstanding

        return {k: float(v) for k, v in aging_buckets.items()}

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == '__main__':
    # åˆ›å»ºåº”æ”¶è´¦æ¬¾ç®¡ç†ç³»ç»Ÿ
    ar_mgmt = AccountsReceivableManagement()

    # æ·»åŠ å®¢æˆ·
    customer = Customer(
        customer_id="CUST-20250001",
        customer_code="C001",
        customer_name="ABCå…¬å¸",
        credit_limit=Decimal('100000.00'),
        payment_terms="NET30",
        credit_rating=CreditRating.A
    )
    ar_mgmt.add_customer(customer)

    # åˆ›å»ºå‘ç¥¨
    invoice = SalesInvoice(
        invoice_id="INV-20250001",
        invoice_number="SI-2025-001",
        invoice_date=date(2025, 1, 15),
        customer_id=customer.customer_id,
        due_date=date(2025, 2, 14),
        invoice_amount=Decimal('50000.00'),
        tax_amount=Decimal('6500.00')
    )
    success, message = ar_mgmt.create_invoice(invoice)
    print(f"åˆ›å»ºå‘ç¥¨: {success}, {message}")

    # è®°å½•æ”¶æ¬¾
    receipt = Receipt(
        receipt_id="REC-20250001",
        receipt_number="R-2025-001",
        receipt_date=date(2025, 2, 10),
        customer_id=customer.customer_id,
        invoice_id=invoice.invoice_id,
        receipt_amount=Decimal('56500.00')
    )
    success, message = ar_mgmt.record_receipt(receipt)
    print(f"è®°å½•æ”¶æ¬¾: {success}, {message}")

    # è·å–è´¦é¾„æŠ¥å‘Š
    aging_report = ar_mgmt.get_aging_report()
    print(f"è´¦é¾„æŠ¥å‘Š: {aging_report}")
```

### 2.5 æ•ˆæœè¯„ä¼°

**æ€§èƒ½æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| å®¢æˆ·ä¿¡ç”¨ç®¡ç†å®Œæ•´æ€§ | 40% | 100% | 60%æå‡ |
| å‘ç¥¨ç®¡ç†è§„èŒƒæ€§ | 60% | 100% | 40%æå‡ |
| æ”¶æ¬¾è·Ÿè¸ªåŠæ—¶æ€§ | å»¶è¿Ÿ3å¤© | å®æ—¶ | æ˜¾è‘—æå‡ |
| å¯¹è´¦æ•ˆç‡ | ä½ | é«˜ | æ˜¾è‘—æå‡ |

**ä¸šåŠ¡ä»·å€¼**ï¼š

1. **ä¿¡ç”¨ç®¡ç†å»ºç«‹**ï¼šå»ºç«‹å®¢æˆ·ä¿¡ç”¨ç®¡ç†ä½“ç³»
2. **å‘ç¥¨ç®¡ç†è§„èŒƒ**ï¼šè§„èŒƒå‘ç¥¨ç®¡ç†æµç¨‹
3. **æ”¶æ¬¾è·Ÿè¸ªåŠ å¼º**ï¼šåŠ å¼ºæ”¶æ¬¾è·Ÿè¸ªå’Œæé†’
4. **å¯¹è´¦æ•ˆç‡æé«˜**ï¼šæé«˜åº”æ”¶è´¦æ¬¾å¯¹è´¦æ•ˆç‡

**ç»éªŒæ•™è®­**ï¼š

1. ä¿¡ç”¨ç®¡ç†å¾ˆé‡è¦
2. å‘ç¥¨ç®¡ç†éœ€è¦è§„èŒƒ
3. æ”¶æ¬¾è·Ÿè¸ªéœ€è¦åŠæ—¶
4. è‡ªåŠ¨å¯¹è´¦éœ€è¦å®Œå–„

**å‚è€ƒæ¡ˆä¾‹**ï¼š

- [åº”æ”¶è´¦æ¬¾ç®¡ç†æœ€ä½³å®è·µ](https://www.cfo.com/)
- [ä¿¡ç”¨ç®¡ç†æŒ‡å—](https://www.credit.com/)

---

## 3. æ¡ˆä¾‹2ï¼šåº”ä»˜è´¦æ¬¾ç®¡ç†

### 3.1 åœºæ™¯æè¿°

**åº”ç”¨åœºæ™¯**ï¼š
ä¼ä¸šåº”ä»˜è´¦æ¬¾ç®¡ç†ï¼ŒåŒ…æ‹¬ä¾›åº”å•†ç®¡ç†ã€å‘ç¥¨ç®¡ç†ã€ä»˜æ¬¾ç®¡ç†ã€å¯¹è´¦ç®¡ç†ã€‚

**ä¸šåŠ¡éœ€æ±‚**ï¼š

- æ”¯æŒä¾›åº”å•†ç®¡ç†
- æ”¯æŒé‡‡è´­å‘ç¥¨æ¥æ”¶å’ŒéªŒè¯
- æ”¯æŒä»˜æ¬¾å®¡æ‰¹å’Œæ‰§è¡Œ
- æ”¯æŒåº”ä»˜è´¦æ¬¾å¯¹è´¦

### 3.2 Schemaå®šä¹‰

**åº”ä»˜è´¦æ¬¾ç®¡ç†Schema**ï¼š

```dsl
schema AccountsPayableManagement {
  supplier: Supplier {
    supplier_id: String @value("SUPP-20250001")
    supplier_code: String @value("S001")
    supplier_name: String @value("XYZä¾›åº”å•†")
    payment_terms: String @value("NET30")
    credit_limit: Decimal @value(200000.00)
  }

  purchase_invoice: PurchaseInvoice {
    invoice_id: String @value("INV-20250002")
    invoice_number: String @value("PI-2025-001")
    invoice_date: Date @value("2025-01-20")
    supplier_id: String @value("SUPP-20250001")
    due_date: Date @value("2025-02-19")
    invoice_amount: Decimal @value(30000.00)
    tax_amount: Decimal @value(3900.00)
    total_amount: Decimal @value(33900.00)
    status: Enum @value("Approved")
    payment_status: Enum @value("Unpaid")
  }

  payment: Payment {
    payment_id: String @value("PAY-20250001")
    payment_number: String @value("P-2025-001")
    payment_date: Date @value("2025-02-15")
    supplier_id: String @value("SUPP-20250001")
    invoice_id: String @value("INV-20250002")
    payment_amount: Decimal @value(33900.00)
    payment_method: Enum @value("Bank_Transfer")
    status: Enum @value("Confirmed")
    approval_status: Enum @value("Approved")
  }
}
```

---

## 4. æ¡ˆä¾‹3ï¼šè‡ªåŠ¨å¯¹è´¦ç³»ç»Ÿ

### 4.1 åœºæ™¯æè¿°

**åº”ç”¨åœºæ™¯**ï¼š
è‡ªåŠ¨å¯¹è´¦ç³»ç»Ÿï¼Œè‡ªåŠ¨åŒ¹é…å‘ç¥¨å’Œæ”¶æ¬¾/ä»˜æ¬¾ï¼Œè¯†åˆ«å·®å¼‚ã€‚

**ä¸šåŠ¡éœ€æ±‚**ï¼š

- è‡ªåŠ¨åŒ¹é…å‘ç¥¨å’Œæ”¶æ¬¾/ä»˜æ¬¾
- è¯†åˆ«å¯¹è´¦å·®å¼‚
- ç”Ÿæˆå¯¹è´¦æŠ¥å‘Š

### 4.2 å®ç°ä»£ç 

```python
def auto_reconcile_ar(ar_data: AccountsReceivableSchema):
    """è‡ªåŠ¨å¯¹è´¦åº”æ”¶è´¦æ¬¾"""
    reconciliations = []

    for customer in ar_data.customers:
        invoices = [inv for inv in ar_data.sales_invoices
                   if inv.customer_id == customer.customer_id]
        receipts = [rec for rec in ar_data.receipts
                   if rec.customer_id == customer.customer_id]

        # è®¡ç®—æœŸåˆä½™é¢
        opening_balance = sum([inv.total_amount for inv in invoices
                              if inv.invoice_date < period_start])

        # è®¡ç®—å‘ç¥¨æ€»é¢
        invoice_total = sum([inv.total_amount for inv in invoices
                            if period_start <= inv.invoice_date <= period_end])

        # è®¡ç®—æ”¶æ¬¾æ€»é¢
        receipt_total = sum([rec.receipt_amount for rec in receipts
                            if period_start <= rec.receipt_date <= period_end])

        # è®¡ç®—æœŸæœ«ä½™é¢
        closing_balance = opening_balance + invoice_total - receipt_total

        # åˆ›å»ºå¯¹è´¦è®°å½•
        reconciliation = Reconciliation()
        reconciliation.customer_id = customer.customer_id
        reconciliation.period_start = period_start
        reconciliation.period_end = period_end
        reconciliation.opening_balance = opening_balance
        reconciliation.invoice_total = invoice_total
        reconciliation.receipt_total = receipt_total
        reconciliation.closing_balance = closing_balance
        reconciliation.is_balanced = abs(closing_balance) < 0.01

        reconciliations.append(reconciliation)

    return reconciliations
```

---

## 5. æ¡ˆä¾‹4ï¼šåº”æ”¶åº”ä»˜åˆ°æ€»è´¦è½¬æ¢

### 5.1 åœºæ™¯æè¿°

**åº”ç”¨åœºæ™¯**ï¼š
å°†åº”æ”¶åº”ä»˜æ•°æ®è½¬æ¢ä¸ºæ€»è´¦å‡­è¯ï¼Œå®ç°è´¢åŠ¡æ•°æ®é›†æˆã€‚

**ä¸šåŠ¡éœ€æ±‚**ï¼š

- è‡ªåŠ¨ç”Ÿæˆæ€»è´¦å‡­è¯
- æ”¯æŒæ‰¹é‡è½¬æ¢
- æ”¯æŒè½¬æ¢éªŒè¯

### 5.2 å®ç°ä»£ç 

```python
def convert_ar_ap_to_gl(ar_data: AccountsReceivableSchema,
                        ap_data: AccountsPayableSchema) -> List[GeneralLedgerEntry]:
    """å°†åº”æ”¶åº”ä»˜æ•°æ®è½¬æ¢ä¸ºæ€»è´¦å‡­è¯"""
    gl_entries = []

    # è½¬æ¢åº”æ”¶è´¦æ¬¾
    for invoice in ar_data.sales_invoices:
        if invoice.status == "Issued":
            gl_entry = GeneralLedgerEntry()
            gl_entry.entry_date = invoice.invoice_date
            gl_entry.entry_type = "AR_Invoice"
            gl_entry.description = f"é”€å”®å‘ç¥¨ {invoice.invoice_number}"

            # å€Ÿï¼šåº”æ”¶è´¦æ¬¾
            gl_line_debit = GLLine()
            gl_line_debit.account_code = "1120"
            gl_line_debit.debit_amount = invoice.total_amount
            gl_entry.lines.append(gl_line_debit)

            # è´·ï¼šä¸»è¥ä¸šåŠ¡æ”¶å…¥
            gl_line_credit = GLLine()
            gl_line_credit.account_code = "6001"
            gl_line_credit.credit_amount = invoice.invoice_amount
            gl_entry.lines.append(gl_line_credit)

            # è´·ï¼šåº”äº¤ç¨è´¹
            if invoice.tax_amount > 0:
                gl_line_tax = GLLine()
                gl_line_tax.account_code = "2221"
                gl_line_tax.credit_amount = invoice.tax_amount
                gl_entry.lines.append(gl_line_tax)

            gl_entries.append(gl_entry)

    # è½¬æ¢åº”ä»˜è´¦æ¬¾
    for invoice in ap_data.purchase_invoices:
        if invoice.status == "Approved":
            gl_entry = GeneralLedgerEntry()
            gl_entry.entry_date = invoice.invoice_date
            gl_entry.entry_type = "AP_Invoice"
            gl_entry.description = f"é‡‡è´­å‘ç¥¨ {invoice.invoice_number}"

            # å€Ÿï¼šä¸»è¥ä¸šåŠ¡æˆæœ¬
            gl_line_debit = GLLine()
            gl_line_debit.account_code = "5001"
            gl_line_debit.debit_amount = invoice.invoice_amount
            gl_entry.lines.append(gl_line_debit)

            # å€Ÿï¼šåº”äº¤ç¨è´¹-è¿›é¡¹ç¨é¢
            if invoice.tax_amount > 0:
                gl_line_tax_debit = GLLine()
                gl_line_tax_debit.account_code = "2221"
                gl_line_tax_debit.debit_amount = invoice.tax_amount
                gl_entry.lines.append(gl_line_tax_debit)

            # è´·ï¼šåº”ä»˜è´¦æ¬¾
            gl_line_credit = GLLine()
            gl_line_credit.account_code = "2202"
            gl_line_credit.credit_amount = invoice.total_amount
            gl_entry.lines.append(gl_line_credit)

            gl_entries.append(gl_entry)

    return gl_entries
```

---

## 6. æ¡ˆä¾‹5ï¼šåº”æ”¶åº”ä»˜æ•°æ®å­˜å‚¨ä¸åˆ†æç³»ç»Ÿ

### 6.1 åœºæ™¯æè¿°

**åº”ç”¨åœºæ™¯**ï¼š
åº”æ”¶åº”ä»˜æ•°æ®å­˜å‚¨ä¸åˆ†æç³»ç»Ÿï¼Œæ”¯æŒæ•°æ®å­˜å‚¨ã€æŸ¥è¯¢ã€åˆ†æã€‚

**ä¸šåŠ¡éœ€æ±‚**ï¼š

- æ”¯æŒåº”æ”¶åº”ä»˜æ•°æ®å­˜å‚¨
- æ”¯æŒæ•°æ®æŸ¥è¯¢å’Œåˆ†æ
- æ”¯æŒæŠ¥è¡¨ç”Ÿæˆ

### 6.2 å®ç°ä»£ç 

```python
def store_ar_ap_data(ar_data: AccountsReceivableSchema,
                     ap_data: AccountsPayableSchema, conn):
    """å­˜å‚¨åº”æ”¶åº”ä»˜æ•°æ®åˆ°PostgreSQL"""
    cursor = conn.cursor()

    # å­˜å‚¨å®¢æˆ·æ•°æ®
    for customer in ar_data.customers:
        cursor.execute("""
            INSERT INTO customers
            (customer_id, customer_code, customer_name, credit_limit, payment_terms, credit_rating, is_active)
            VALUES (%s, %s, %s, %s, %s, %s, %s)
            ON CONFLICT (customer_id) DO UPDATE SET
            customer_name = EXCLUDED.customer_name,
            credit_limit = EXCLUDED.credit_limit,
            payment_terms = EXCLUDED.payment_terms,
            credit_rating = EXCLUDED.credit_rating,
            is_active = EXCLUDED.is_active,
            updated_at = CURRENT_TIMESTAMP
        """, (customer.customer_id, customer.customer_code, customer.customer_name,
              customer.credit_limit, customer.payment_terms, customer.credit_rating, customer.is_active))

    # å­˜å‚¨é”€å”®å‘ç¥¨æ•°æ®
    for invoice in ar_data.sales_invoices:
        cursor.execute("""
            INSERT INTO sales_invoices
            (invoice_id, invoice_number, invoice_date, customer_id, due_date,
             invoice_amount, tax_amount, total_amount, status, payment_status, paid_amount, outstanding_amount)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
            ON CONFLICT (invoice_id) DO UPDATE SET
            invoice_amount = EXCLUDED.invoice_amount,
            tax_amount = EXCLUDED.tax_amount,
            total_amount = EXCLUDED.total_amount,
            status = EXCLUDED.status,
            payment_status = EXCLUDED.payment_status,
            paid_amount = EXCLUDED.paid_amount,
            outstanding_amount = EXCLUDED.outstanding_amount,
            updated_at = CURRENT_TIMESTAMP
        """, (invoice.invoice_id, invoice.invoice_number, invoice.invoice_date,
              invoice.customer_id, invoice.due_date, invoice.invoice_amount,
              invoice.tax_amount, invoice.total_amount, invoice.status,
              invoice.payment_status, invoice.paid_amount, invoice.outstanding_amount))

    # å­˜å‚¨ä¾›åº”å•†æ•°æ®
    for supplier in ap_data.suppliers:
        cursor.execute("""
            INSERT INTO suppliers
            (supplier_id, supplier_code, supplier_name, payment_terms, credit_limit, bank_account, is_active)
            VALUES (%s, %s, %s, %s, %s, %s, %s)
            ON CONFLICT (supplier_id) DO UPDATE SET
            supplier_name = EXCLUDED.supplier_name,
            payment_terms = EXCLUDED.payment_terms,
            credit_limit = EXCLUDED.credit_limit,
            bank_account = EXCLUDED.bank_account,
            is_active = EXCLUDED.is_active,
            updated_at = CURRENT_TIMESTAMP
        """, (supplier.supplier_id, supplier.supplier_code, supplier.supplier_name,
              supplier.payment_terms, supplier.credit_limit, supplier.bank_account, supplier.is_active))

    # å­˜å‚¨é‡‡è´­å‘ç¥¨æ•°æ®
    for invoice in ap_data.purchase_invoices:
        cursor.execute("""
            INSERT INTO purchase_invoices
            (invoice_id, invoice_number, invoice_date, supplier_id, due_date,
             invoice_amount, tax_amount, total_amount, status, payment_status, paid_amount, outstanding_amount)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
            ON CONFLICT (invoice_id) DO UPDATE SET
            invoice_amount = EXCLUDED.invoice_amount,
            tax_amount = EXCLUDED.tax_amount,
            total_amount = EXCLUDED.total_amount,
            status = EXCLUDED.status,
            payment_status = EXCLUDED.payment_status,
            paid_amount = EXCLUDED.paid_amount,
            outstanding_amount = EXCLUDED.outstanding_amount,
            updated_at = CURRENT_TIMESTAMP
        """, (invoice.invoice_id, invoice.invoice_number, invoice.invoice_date,
              invoice.supplier_id, invoice.due_date, invoice.invoice_amount,
              invoice.tax_amount, invoice.total_amount, invoice.status,
              invoice.payment_status, invoice.paid_amount, invoice.outstanding_amount))

    conn.commit()

def generate_ar_ap_report(conn, period_start, period_end):
    """ç”Ÿæˆåº”æ”¶åº”ä»˜æŠ¥è¡¨"""
    cursor = conn.cursor()

    # åº”æ”¶è´¦æ¬¾è´¦é¾„åˆ†æ
    cursor.execute("""
        SELECT
            c.customer_name,
            si.invoice_number,
            si.invoice_date,
            si.due_date,
            si.outstanding_amount,
            CASE
                WHEN CURRENT_DATE <= si.due_date THEN 'Current'
                WHEN CURRENT_DATE <= si.due_date + INTERVAL '30 days' THEN '1-30 Days'
                WHEN CURRENT_DATE <= si.due_date + INTERVAL '60 days' THEN '31-60 Days'
                WHEN CURRENT_DATE <= si.due_date + INTERVAL '90 days' THEN '61-90 Days'
                ELSE 'Over 90 Days'
            END as aging_bucket
        FROM sales_invoices si
        JOIN customers c ON si.customer_id = c.customer_id
        WHERE si.payment_status IN ('Unpaid', 'Partially_Paid')
        AND si.invoice_date BETWEEN %s AND %s
        ORDER BY si.due_date
    """, (period_start, period_end))

    ar_aging = cursor.fetchall()

    # åº”ä»˜è´¦æ¬¾è´¦é¾„åˆ†æ
    cursor.execute("""
        SELECT
            s.supplier_name,
            pi.invoice_number,
            pi.invoice_date,
            pi.due_date,
            pi.outstanding_amount,
            CASE
                WHEN CURRENT_DATE <= pi.due_date THEN 'Current'
                WHEN CURRENT_DATE <= pi.due_date + INTERVAL '30 days' THEN '1-30 Days'
                WHEN CURRENT_DATE <= pi.due_date + INTERVAL '60 days' THEN '31-60 Days'
                WHEN CURRENT_DATE <= pi.due_date + INTERVAL '90 days' THEN '61-90 Days'
                ELSE 'Over 90 Days'
            END as aging_bucket
        FROM purchase_invoices pi
        JOIN suppliers s ON pi.supplier_id = s.supplier_id
        WHERE pi.payment_status IN ('Unpaid', 'Partially_Paid')
        AND pi.invoice_date BETWEEN %s AND %s
        ORDER BY pi.due_date
    """, (period_start, period_end))

    ap_aging = cursor.fetchall()

    return {
        "ar_aging": ar_aging,
        "ap_aging": ap_aging
    }
```

---

**å‚è€ƒæ–‡æ¡£**ï¼š

- `01_Overview.md` - æ¦‚è¿°
- `02_Formal_Definition.md` - å½¢å¼åŒ–å®šä¹‰
- `03_Standards.md` - æ ‡å‡†å¯¹æ ‡
- `04_Transformation.md` - è½¬æ¢ä½“ç³»

**åˆ›å»ºæ—¶é—´**ï¼š2025-01-21
**æœ€åæ›´æ–°**ï¼š2025-01-21
